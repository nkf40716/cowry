From lxuemei3000 at gmail.com  Sat Aug  1 18:43:59 2015
From: lxuemei3000 at gmail.com (Xuemei Liu)
Date: Sat, 1 Aug 2015 18:43:59 -0700
Subject: [ovs-discuss] Mininet cannot run with ovs,
	maybe configuration problem
Message-ID: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>

Hi, all,

I find one problem while running ovs in mininet. I guess it should be mininet
/ configuration / dependency issue, but I cannot figure it out.

1. If I install mininet using "install.sh -a", it will install mininet with
all dependencies, including ovs. Then "sudo mn --topo tree,3,3" works
through.
2. If additionally I install OVS by myself (I mean git clone the latest ovs
and install it), "sudo mn --topo tree,3,3" cannot work through, just stalls
in the following step. The process ovs-vswitchd exits as well.
3. In 2, "sudo mn --topo tree,2,3" can work through. It seems with fewer
switches it is ok.

The problem occurs in a machine with ubuntu 14.04.1 and linux kernel
version 3.13.0-35-generic. On my pc there is no such problem with ubuntu
14.04.2 and linux version 3.16.0-41-generic.

This problem blocks me for one day. Does anyone have similar experience?

Thanks,
Xuemei

[image: Inline image 1]
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150801/68f51bde/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image.png
Type: image/png
Size: 69429 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150801/68f51bde/attachment-0001.png>

From lxuemei3000 at gmail.com  Sat Aug  1 18:56:02 2015
From: lxuemei3000 at gmail.com (Xuemei Liu)
Date: Sat, 1 Aug 2015 18:56:02 -0700
Subject: [ovs-discuss] Mininet cannot run with ovs,
	maybe configuration problem
In-Reply-To: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
Message-ID: <CA+oJsLMoux_r2xHRPUpyNBb9tb9mA+_AmGZM0DVr3v+1iqK4hg@mail.gmail.com>

update :

The problem occurs in a machine with ubuntu 14.04.1 and linux kernel
version 3.13.0-35-generic. On another machine there is no such problem with
ubuntu 14.04.1 and linux version 3.13.0-55-generic.


On Sat, Aug 1, 2015 at 6:43 PM, Xuemei Liu <lxuemei3000 at gmail.com> wrote:

> Hi, all,
>
> I find one problem while running ovs in mininet. I guess it should be mininet
> / configuration / dependency issue, but I cannot figure it out.
>
> 1. If I install mininet using "install.sh -a", it will install mininet
> with all dependencies, including ovs. Then "sudo mn --topo tree,3,3" works
> through.
> 2. If additionally I install OVS by myself (I mean git clone the latest
> ovs and install it), "sudo mn --topo tree,3,3" cannot work through, just
> stalls in the following step. The process ovs-vswitchd exits as well.
> 3. In 2, "sudo mn --topo tree,2,3" can work through. It seems with fewer
> switches it is ok.
>
> The problem occurs in a machine with ubuntu 14.04.1 and linux kernel
> version 3.13.0-35-generic. On my pc there is no such problem with ubuntu
> 14.04.2 and linux version 3.16.0-41-generic.
>
> This problem blocks me for one day. Does anyone have similar experience?
>
> Thanks,
> Xuemei
>
> [image: Inline image 1]
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150801/b0da4d41/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image.png
Type: image/png
Size: 69429 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150801/b0da4d41/attachment-0001.png>

From abhishekv.verma at gmail.com  Sat Aug  1 19:19:56 2015
From: abhishekv.verma at gmail.com (Abhishek Verma)
Date: Sun, 2 Aug 2015 07:49:56 +0530
Subject: [ovs-discuss] Drops in OVS
In-Reply-To: <CADDmorRK8=9o-Y_DMFKjsg4C_Mpa2VuP7-8sm2wib4xTMpEXRQ@mail.gmail.com>
References: <CADDmorSbVLx6jQjk9g9V1i_2SWMLjMvtFBnY1qvEWuXm3NOoig@mail.gmail.com>
 <20150730124845.GA2310@x240.home>
 <CADDmorSJneLZdgu_xgEsgL3TStMFJUCONasmMKLEY4vxws+OPA@mail.gmail.com>
 <20150731002014.GA5647@nicira.com>
 <CADDmorRR89dKxJ1VweCq177KiXnWtbjUoPchn9oSTeah0MP6UQ@mail.gmail.com>
 <20150731005729.GB5647@nicira.com>
 <CADDmorQQc6qApj8jEpwKsg5zwoPX3UB17LHDJ-yRNL--derP3w@mail.gmail.com>
 <20150731012200.GD5647@nicira.com>
 <CADDmorSQPJTjNP3T=PED6a7WGVrP-s8=ytKj_y4U404tVAJT=g@mail.gmail.com>
 <20150731043148.GC2310@x240.home>
 <CADDmorRK8=9o-Y_DMFKjsg4C_Mpa2VuP7-8sm2wib4xTMpEXRQ@mail.gmail.com>
Message-ID: <CADDmorR9kEjHAPW_pkxfcEPpUz-4B0F4EScorc0prkaSgtiSYw@mail.gmail.com>

HI,

Is my understanding below correct?


On Fri, Jul 31, 2015 at 10:14 AM, Abhishek Verma <abhishekv.verma at gmail.com>
wrote:

> Hi Flavio,
>
>
>> > Is this correct?
>>
>> No, there is a cache in the kernel which is periodically refreshed or
>> empty at the initialization.  When the first packet comes in the
>> packet is queued to the userspace daemon which will update the
>> kernel's cache.  Next packets matching the cached flow will pass
>> directly.
>>
>
> Aha. So, the of-ctl add-flow really adds a flow only in the User Space and
> nothing in the kernel space. If this flow rule isnt added then all packets
> will hit the default rule where we do normal L2 learning and switching. By
> adding of-ctl add-flow rules we simply over-ride that behavior.
>
> The real flows that get added by the user space daemon that the packets
> actually hit can be viewed by "ovs-dpctl dump-flows".
>
> Is this how it is?
>
>
>> However, depending on how you programmed your flows and the traffic,
>> you could see a burst coming for a flow that isn't cached yet. Since
>> the queue is limited, it can overflow.
>>
>
> Ok, and these drops are visible when i give "ovs-dpctl show" command. Is
> there a way to increase this queue size?
>
> Flows afaik are always timed out after 5 secs. Assume i have an
> application that bursts every 6 secs. In that case i always run the risk of
> losing packets. Is there a way to pin a flow or increase its timeout value?
>
> Thanks, Abhishek
>
>
Thanks, Abhishek
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150802/ce498102/attachment.html>

From exaheart at gmail.com  Sun Aug  2 07:44:51 2015
From: exaheart at gmail.com (yimeng zhao)
Date: Sun, 2 Aug 2015 16:44:51 +0200
Subject: [ovs-discuss] Is there a command to add hidden flows manually?
Message-ID: <CAFMTK9iaqrGQEM6AEtmQVA6hJCCrqFPb7FLTDZvpe2GGxVi0bQ@mail.gmail.com>

Hi all,

When ovs runs in in-band mode, some hidden flows are installed
automatically and be invisible to Openflow controllers. Is it possible to
add more new hidden flows manually for experimental purpose?


Best Regards
Yimeng
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150802/59194cac/attachment.html>

From blp at nicira.com  Sun Aug  2 09:21:34 2015
From: blp at nicira.com (Ben Pfaff)
Date: Sun, 2 Aug 2015 09:21:34 -0700
Subject: [ovs-discuss] Is there a command to add hidden flows manually?
In-Reply-To: <CAFMTK9iaqrGQEM6AEtmQVA6hJCCrqFPb7FLTDZvpe2GGxVi0bQ@mail.gmail.com>
References: <CAFMTK9iaqrGQEM6AEtmQVA6hJCCrqFPb7FLTDZvpe2GGxVi0bQ@mail.gmail.com>
Message-ID: <20150802162134.GA28085@nicira.com>

On Sun, Aug 02, 2015 at 04:44:51PM +0200, yimeng zhao wrote:
> When ovs runs in in-band mode, some hidden flows are installed
> automatically and be invisible to Openflow controllers. Is it possible to
> add more new hidden flows manually for experimental purpose?

OVS doesn't currently have a way to do that.

From exaheart at gmail.com  Sun Aug  2 09:50:56 2015
From: exaheart at gmail.com (yimeng zhao)
Date: Sun, 2 Aug 2015 18:50:56 +0200
Subject: [ovs-discuss] Is there a command to add hidden flows manually?
In-Reply-To: <20150802162134.GA28085@nicira.com>
References: <CAFMTK9iaqrGQEM6AEtmQVA6hJCCrqFPb7FLTDZvpe2GGxVi0bQ@mail.gmail.com>
 <20150802162134.GA28085@nicira.com>
Message-ID: <CAFMTK9jv65_=sARrfpnk1MiMhjsRpm5Tiv=1bKpQDBnbbqBx_A@mail.gmail.com>

If I would like to add some from source code, which file I should refer to?

2015-08-02 18:21 GMT+02:00 Ben Pfaff <blp at nicira.com>:

> On Sun, Aug 02, 2015 at 04:44:51PM +0200, yimeng zhao wrote:
> > When ovs runs in in-band mode, some hidden flows are installed
> > automatically and be invisible to Openflow controllers. Is it possible to
> > add more new hidden flows manually for experimental purpose?
>
> OVS doesn't currently have a way to do that.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150802/1f9fb7a6/attachment.html>

From blp at nicira.com  Sun Aug  2 09:57:41 2015
From: blp at nicira.com (Ben Pfaff)
Date: Sun, 2 Aug 2015 09:57:41 -0700
Subject: [ovs-discuss] Is there a command to add hidden flows manually?
In-Reply-To: <CAFMTK9jv65_=sARrfpnk1MiMhjsRpm5Tiv=1bKpQDBnbbqBx_A@mail.gmail.com>
References: <CAFMTK9iaqrGQEM6AEtmQVA6hJCCrqFPb7FLTDZvpe2GGxVi0bQ@mail.gmail.com>
 <20150802162134.GA28085@nicira.com>
 <CAFMTK9jv65_=sARrfpnk1MiMhjsRpm5Tiv=1bKpQDBnbbqBx_A@mail.gmail.com>
Message-ID: <20150802165741.GB28085@nicira.com>

ofproto/in-band.c

On Sun, Aug 02, 2015 at 06:50:56PM +0200, yimeng zhao wrote:
> If I would like to add some from source code, which file I should refer to?
> 
> 2015-08-02 18:21 GMT+02:00 Ben Pfaff <blp at nicira.com>:
> 
> > On Sun, Aug 02, 2015 at 04:44:51PM +0200, yimeng zhao wrote:
> > > When ovs runs in in-band mode, some hidden flows are installed
> > > automatically and be invisible to Openflow controllers. Is it possible to
> > > add more new hidden flows manually for experimental purpose?
> >
> > OVS doesn't currently have a way to do that.
> >

From blp at nicira.com  Sun Aug  2 12:06:36 2015
From: blp at nicira.com (Ben Pfaff)
Date: Sun, 2 Aug 2015 12:06:36 -0700
Subject: [ovs-discuss] Scaling ovsdb-idl's update notification
In-Reply-To: <8CA204A851B7B14E86E75054661E41750F92FD87@G4W3217.americas.hpqcorp.net>
References: <8CA204A851B7B14E86E75054661E41750F92FD87@G4W3217.americas.hpqcorp.net>
Message-ID: <20150802190636.GF28085@nicira.com>

On Fri, Jul 31, 2015 at 08:03:41PM +0000, Ansari, Shad wrote:
> 
> Ovsdb-idl notifies a client that "something" changed; it does not track "what" changed. The client then typically either reconfigures itself by scanning the idl to determine what changed, or - simply reloads the entire idl. This presumably works since the ovs schema tables aren't typically large.
> 
> In a use-case where ovsdb is used with a schema that can have very large tables (imagine route table), the current ovsdb-idl notification mechanism doesn't appear to scale - clients need to do a lot of processing to determine the exact change delta.
> 
> I would like to hear from others if they have any views/insights on how to handle this scalability use-case. Obviously, this will require changes in ovsdb-idl, possibly on the lines of:
> 
> -        Supporting more granular sequence numbers (table, row, column)
> 
> -        Giving client visibility to the update (so that the client can view both the old, new data)

I'm welcome to discussion and proposals in this area.  I've expected for
years that we'd eventually need something like this for ovs-vswitchd
(although so far it isn't a big deal), and the same could be true for
ovn-controller as OVN begins to scale.

From saurabh at gmail.com  Sun Aug  2 13:08:56 2015
From: saurabh at gmail.com (=?UTF-8?B?U2F1cmFiaCBTaHJpdmFzdGF2YSAo4KS44KWM4KSw4KStIOCktuCljeCksOClgOCkteCkvuCkuA==?= =?UTF-8?B?4KWN4KSk4KS1KQ==?=)
Date: Sun, 2 Aug 2015 13:08:56 -0700
Subject: [ovs-discuss] Scaling ovsdb-idl's update notification
In-Reply-To: <20150802190636.GF28085@nicira.com>
References: <8CA204A851B7B14E86E75054661E41750F92FD87@G4W3217.americas.hpqcorp.net>
 <20150802190636.GF28085@nicira.com>
Message-ID: <CAEgOKCwm3hKbVh7HSxH8ZzBVT1oM+vcKhmWu9Pokhf=MtZWffg@mail.gmail.com>

One approach can be to link all the struct ovsdb_idl_row in a linked list
where nodes are ordered by their time of update ie a newly added node is
put at the end of the linked list, an updated node is removed from its
current position and put at the end of the linked list, a deleted node is
kept in the linked list till it is notified to the idl user. The size of
this linked list will be the number of rows in the table. A new ovsdb-idl
API can be called to iterate over this linked list one at a time, the API
can place a marker node in the linked list to remember till what point the
notifications have been generated. The IDL user should not try to
dereference the pointers in  a "delete" event because the pointers could be
stale, so it should only look at the embedded UUID.

The benefit of this approach is that IDL user gets notified only of the
changes, and also updates get naturally dampened ie large number of
modifications to a single row gets delivered as fewer number of events.


--
Saurabh (सौरभ)

On Sun, Aug 2, 2015 at 12:06 PM, Ben Pfaff <blp at nicira.com> wrote:

> On Fri, Jul 31, 2015 at 08:03:41PM +0000, Ansari, Shad wrote:
> >
> > Ovsdb-idl notifies a client that "something" changed; it does not track
> "what" changed. The client then typically either reconfigures itself by
> scanning the idl to determine what changed, or - simply reloads the entire
> idl. This presumably works since the ovs schema tables aren't typically
> large.
> >
> > In a use-case where ovsdb is used with a schema that can have very large
> tables (imagine route table), the current ovsdb-idl notification mechanism
> doesn't appear to scale - clients need to do a lot of processing to
> determine the exact change delta.
> >
> > I would like to hear from others if they have any views/insights on how
> to handle this scalability use-case. Obviously, this will require changes
> in ovsdb-idl, possibly on the lines of:
> >
> > -        Supporting more granular sequence numbers (table, row, column)
> >
> > -        Giving client visibility to the update (so that the client can
> view both the old, new data)
>
> I'm welcome to discussion and proposals in this area.  I've expected for
> years that we'd eventually need something like this for ovs-vswitchd
> (although so far it isn't a big deal), and the same could be true for
> ovn-controller as OVN begins to scale.
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150802/67ab3849/attachment.html>

From rlantz at cs.stanford.edu  Sun Aug  2 18:52:28 2015
From: rlantz at cs.stanford.edu (Bob Lantz)
Date: Sun, 2 Aug 2015 18:52:28 -0700
Subject: [ovs-discuss] Mininet cannot run with ovs,
	maybe configuration problem
In-Reply-To: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
Message-ID: <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>

I’ve had ovs-vsctl not work as expected when I install multiple, incompatible versions in various locations, as it sounds like you might have done.

I’d recommend carefully following the recommended, documented installation procedure for OVS and/or mininet.

If you think you have found a bug in mininet, please write to mininet-discuss.


> On Aug 1, 2015, at 6:43 PM, Xuemei Liu <lxuemei3000 at gmail.com> wrote:
> 
> Hi, all,
> 
> I find one problem while running ovs in mininet. I guess it should be mininet / configuration / dependency issue, but I cannot figure it out.
> 
> 1. If I install mininet using "install.sh -a", it will install mininet with all dependencies, including ovs. Then "sudo mn --topo tree,3,3" works through. 
> 2. If additionally I install OVS by myself (I mean git clone the latest ovs and install it), "sudo mn --topo tree,3,3" cannot work through, just stalls in the following step. The process ovs-vswitchd exits as well.  
> 3. In 2, "sudo mn --topo tree,2,3" can work through. It seems with fewer switches it is ok.
> 
> The problem occurs in a machine with ubuntu 14.04.1 and linux kernel version 3.13.0-35-generic. On my pc there is no such problem with ubuntu 14.04.2 and linux version 3.16.0-41-generic. 
> 
> This problem blocks me for one day. Does anyone have similar experience?
> 
> Thanks,
> Xuemei
> 
> 
> 
> 
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150802/3bbf4aaa/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image.png
Type: image/png
Size: 69429 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150802/3bbf4aaa/attachment-0001.png>

From wenx05124561 at 163.com  Sun Aug  2 23:48:19 2015
From: wenx05124561 at 163.com (wenxu)
Date: Mon, 3 Aug 2015 14:48:19 +0800 (CST)
Subject: [ovs-discuss]   Vhost-User port not work and always show 'down'
In-Reply-To: <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
 <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
Message-ID: <140efd08.787f.14ef2516be2.Coremail.wenx05124561@163.com>

Hi  all,

I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.

There is a br0 with dpdk0 and vhost-user-0
I build dpdk with 2.0.0 and ovs with branch 2.4
# ovs-vsctl show
ovs-vsctl show
c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
    Bridge "br0"
        Port "br0"
            Interface "br0"
                type: internal
        Port "vhost-user-0"
            Interface "vhost-user-0"
                type: dpdkvhostuser
        Port "dpdk0"
            Interface "dpdk0"
                type: dpdk

I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for vhost-user

# qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa node,memdev=mem -mem-prealloc

qemu-system-x86_64: -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up

I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
But they can't ping each other

# ovs-ofctl dump-flows br0
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204, idle_age=0, hard_age=65534, priority=0 actions=NORMAL

# ovs-vsctl list interface vhost-user-0
_uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
admin_state         : down
bfd                 : {}
bfd_status          : {}
cfm_fault           : []
cfm_fault_status    : []
cfm_flap_count      : []
cfm_health          : []
cfm_mpid            : []
cfm_remote_mpids    : []
cfm_remote_opstate  : []
duplex              : []
error               : []
external_ids        : {}
ifindex             : 0
ingress_policing_burst: 0
ingress_policing_rate: 0
lacp_current        : []
link_resets         : 1
link_speed          : []
link_state          : down
lldp                : {}
mac                 : []
mac_in_use          : "00:00:00:00:00:00"
mtu                 : 1500
name                : "vhost-user-0"
ofport              : 4
ofport_request      : []
options             : {}
other_config        : {}
statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
status              : {}
type                : dpdkvhostuser

I  can see the vhost-user-0 port always show down and there are some dropped packets which are sent from br0.

Are there some wrong with my POC?

BR
Xu Wen






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/d4d6d6bc/attachment.html>

From yalei.wang at intel.com  Mon Aug  3 00:28:55 2015
From: yalei.wang at intel.com (Wang, Yalei)
Date: Mon, 3 Aug 2015 07:28:55 +0000
Subject: [ovs-discuss]  could we mirror the packages of patch port?
Message-ID: <96BE24CF7A0E594E969BA114CF2858572AA87220@BGSMSX102.gar.corp.intel.com>

Hi all,

Just now I tried to mirror the OVS bridge with a patch port, it just get the egress packages, my OVS bridge version is 2.0.2

and I find someone got a similar problem before, http://openvswitch.org/pipermail/discuss/2014-December/016079.html

does this problem fixed in the lastest code?

Thanks!

===================================
On Fri, Dec 12, 2014 at 03:49:54PM -0800, Tom Carroll wrote:
> I'm observing some interesting behavior when mirroring a patch virtual
> device. I have two bridges, br-tun and xapi1 (integration bridge), connected
> via a patch. When I create a mirror on xapi1 to monitor patch-tun (the
> patch's port on xapi1) I observe only egress traffic. With the setup, I
> expect to observe both ingress and egress.
>
> The bridge is created in the following manner:
>
> ip link add name snoop0 type dummy
> ip link set dev snoop0 up
> ovs-vsctl add-port xapi1 snoop0
> ovs-vsctl -- set Bridge xapi1 mirrors=@m \
> -- --id=@snoop get Port snoop0 \
> -- --id=@patch get Port patch-tun \
> -- --id=@n create Bridge name=patchmirror select-dst-port=@patch
> select-src-port=@patch output-port=@snoop
>
> ovs-vsctl list Mirror
> _uuid               : 97e806bc-b12b-45e6-a2bc-65dcf8034a4e
> external_ids        : {}
> name                : patchmirror
> output_port         : 67ef2779-515f-44d6-b2f6-d671d098e5ea
> output_vlan         : []
> select_all          : false
> select_dst_port     : [9403ddee-85c7-44af-bb33-25401ba00126]
> select_src_port     : [9403ddee-85c7-44af-bb33-25401ba00126]
> select_vlan         : []
> statistics          : {tx_bytes=304112, tx_packets=1634}
>
> and when I tcpdump -ni snoop0, I only see traffic destined to the patch, but
> not sourced.

Confirmed.  The OVS logic for patch ports, in compose_output_action__()
in ofproto-dpif-xlate.c, doesn't even try to handle mirroring.  We
should probably fix that sometime (if you're a programmer, then we'd
gratefully accept a fix).



/yalei

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/058d261c/attachment.html>

From jimsonchacko at gmail.com  Mon Aug  3 01:59:23 2015
From: jimsonchacko at gmail.com (jimson chacko)
Date: Mon, 3 Aug 2015 14:29:23 +0530
Subject: [ovs-discuss] Added new field in flow.h. But the xlate_actions
	gives mask value zero.
Message-ID: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>

Hi,

I am using version 2.3.0 of OVS.

I have added a new filed (eg; gtp tunnel id) and changed FLOW_WC_SEQ.
Compiled the code. All the errors given by the compiler were fixed.

I added a flow with ofctl add-flow command and retrieved the same using
ofctl dump-flows. Output shows both value and mask as in the input.

When I sent traffic to the vswitch, the kernel module throws the exception
packet with the NL Key filled in properly with the new attribute along with
other attributes present in the packet.

xlate_actions should identify the flow in the flow table and should give me
the proper mask value for the new field in xout. But the mask value is
coming as zero.


Can you let me know what the issue could be ? Is there any issue with the
minimask etc ?

Awaiting your reply.

Regards
Jimson
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/e6f6577c/attachment-0001.html>

From ywz704064151 at gmail.com  Mon Aug  3 03:50:45 2015
From: ywz704064151 at gmail.com (ywz704064151)
Date: Mon, 03 Aug 2015 10:50:45 -0000
Subject: [ovs-discuss] =?utf-8?b?5Zue5aSN77yaIG92cyBicmlkZ2UgZHJvcHBpbmcg?=
 =?utf-8?q?packages?=
References: <B0FC8B6A85BDD34FA799343D4664C6D61D0D7142@ESESSMB209.ericsson.se>
Message-ID: <n2k3cf610u8vvn1iu3m8u5lm.1428803448442@email.android.com>

An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/b50cc101/attachment.html>

From blp at nicira.com  Mon Aug  3 09:20:12 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 3 Aug 2015 09:20:12 -0700
Subject: [ovs-discuss] Added new field in flow.h. But the xlate_actions
 gives mask value zero.
In-Reply-To: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
Message-ID: <20150803162012.GA31662@nicira.com>

On Mon, Aug 03, 2015 at 02:29:23PM +0530, jimson chacko wrote:
> Hi,
> 
> I am using version 2.3.0 of OVS.
> 
> I have added a new filed (eg; gtp tunnel id) and changed FLOW_WC_SEQ.
> Compiled the code. All the errors given by the compiler were fixed.
> 
> I added a flow with ofctl add-flow command and retrieved the same using
> ofctl dump-flows. Output shows both value and mask as in the input.
> 
> When I sent traffic to the vswitch, the kernel module throws the exception
> packet with the NL Key filled in properly with the new attribute along with
> other attributes present in the packet.
> 
> xlate_actions should identify the flow in the flow table and should give me
> the proper mask value for the new field in xout. But the mask value is
> coming as zero.
> 
> 
> Can you let me know what the issue could be ? Is there any issue with the
> minimask etc ?

It's hard to guess based on such a brief description, but: do your flows
match on the new field?  If not, then translation would generate a mask
of 0.

From blp at nicira.com  Mon Aug  3 09:33:18 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 3 Aug 2015 09:33:18 -0700
Subject: [ovs-discuss] could we mirror the packages of patch port?
In-Reply-To: <96BE24CF7A0E594E969BA114CF2858572AA87220@BGSMSX102.gar.corp.intel.com>
References: <96BE24CF7A0E594E969BA114CF2858572AA87220@BGSMSX102.gar.corp.intel.com>
Message-ID: <20150803163318.GB31662@nicira.com>

On Mon, Aug 03, 2015 at 07:28:55AM +0000, Wang, Yalei wrote:
> Hi all,
> 
> Just now I tried to mirror the OVS bridge with a patch port, it just get the egress packages, my OVS bridge version is 2.0.2
> 
> and I find someone got a similar problem before, http://openvswitch.org/pipermail/discuss/2014-December/016079.html
> 
> does this problem fixed in the lastest code?

It doesn't look like it.

From th1618 at att.com  Mon Aug  3 09:43:00 2015
From: th1618 at att.com (HEARNE, TIMOTHY S)
Date: Mon, 3 Aug 2015 16:43:00 +0000
Subject: [ovs-discuss] Configure SSL on OVS
Message-ID: <00CF4A25E32E204B8968E067CE2BB0D9023C0371@CAFRFD1MSGUSRJB.ITServices.sbc.com>

Hello,

My team is attempting to configure SSL using OVS using ovs-vsctl interface.  I have been attempting to follow the instructions found at http://git.openvswitch.org/cgi-bin/gitweb.cgi?p=openvswitch;f=INSTALL.SSL;hb=HEAD but have not been successful.  We currently have 2 mininet ubuntu 14.04 images implemented using Oracle VirtualBox.  We have done the following:
*       Created a 3rd network interface implemented using NAT (Static IPs:   master - 10.0.3.15; slave: 10.0.4.15) on eth2 of both images
*       Created a bridge on each
o       Master
*       sudo ovs-vsctl add-br br0
*       sudo ovs-vsctl add-port br0 eth2
*       sudo ifconfig br0 10.0.4.15/24 up
o       Slave
*       sudo ovs-vsctl add-br br1
*       sudo ovs-vsctl add-port br0 eth2
*       sudo ifconfig br0 10.0.3.15/24 up
*       Created keys on slave using "CONTROLLER KEY GENERATION" and "SWITCH KEY GENERATION WITH A SWITCH PKI (EASY METHOD)" instructions
o       cd /etc/openvswitch
o       sudo ovs-pki init
o       sudo ovs-pki req+sign ctl controller
o       sudo ovs-pki req+sign sc switch
   Notes on the key creation.  I did think that I ran the "ovs-pki init" statement on the master but the directories are there.
   After this point, I really am not sure what to do.  I have copied the keys from the slave into the same directories on the master.  I have run the following statement on both:
   Sudo ove-vsctl set-ssl \
     /etc/openvswitch/sc-privkey.pem \
     /etc/optnvswitch/sc-cert.pem \
     /var/lib/openvswitch/pki/controllerca/cacert.pem

   I have also tried to run the following statement:
   Sudo ovs-controller -v pssl:6633 \
     -p /etc/openvswitch/ctl-privkey.pem \
     -c /etc/openvswitch/ctl-cert.pem \
     -C /var/lib/openvswitch/pki/switchca/cecert.pem

   We have also tried various controller statements:
   sudo ovs-vsctl set-controller br1 ptcp:10.0.3.15:6633
   sudo ovs-vsctl set-ssl /etc/openvswitch/sc-privkey.pem /etc/openvswitch/sc-cert.pem /var/lib/openvswitch/pki/controllerca/cacert.pem

Other items of note:
*       We can ping the IPs on eth2 and can use ssh to connect if we supply the password.
*       We can get non-OVS SSL to work on eth1 (used Oracle VirtualBox Host-Only Ethernet adapter and static IP) using non-OVS SSL generated using ssh-keygen.
*       We are attempting to minimize the number of images to reduce memory and CPU requirements for students.

Any suggestions / corrections to what we have done above will be greatly appreciated.

Thank you!

Tim Hearne

e-mail:  timothy.hearne at att.com




-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/b27f0855/attachment-0001.html>

From blp at nicira.com  Mon Aug  3 09:50:39 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 3 Aug 2015 09:50:39 -0700
Subject: [ovs-discuss] Scaling ovsdb-idl's update notification
In-Reply-To: <CAEgOKCwm3hKbVh7HSxH8ZzBVT1oM+vcKhmWu9Pokhf=MtZWffg@mail.gmail.com>
References: <8CA204A851B7B14E86E75054661E41750F92FD87@G4W3217.americas.hpqcorp.net>
 <20150802190636.GF28085@nicira.com>
 <CAEgOKCwm3hKbVh7HSxH8ZzBVT1oM+vcKhmWu9Pokhf=MtZWffg@mail.gmail.com>
Message-ID: <20150803165039.GD31662@nicira.com>

That kind of approach might work.

It's important to keep in mind, though, that the IDL isn't just a
collection of unrelated records.  It's a graph: any record can point to
any number of other records, through columns whose types are UUIDs with
refTable constraints.  The IDL maintains tracks these relationships
carefully for memory safety, so that if a record is deleted then the
pointers to it from other records can be dropped.  Any approach to
handling changes may have to take this into account.

On Sun, Aug 02, 2015 at 01:08:56PM -0700, Saurabh Shrivastava (सौरभ श्रीवास्तव) wrote:
> One approach can be to link all the struct ovsdb_idl_row in a linked list
> where nodes are ordered by their time of update ie a newly added node is
> put at the end of the linked list, an updated node is removed from its
> current position and put at the end of the linked list, a deleted node is
> kept in the linked list till it is notified to the idl user. The size of
> this linked list will be the number of rows in the table. A new ovsdb-idl
> API can be called to iterate over this linked list one at a time, the API
> can place a marker node in the linked list to remember till what point the
> notifications have been generated. The IDL user should not try to
> dereference the pointers in  a "delete" event because the pointers could be
> stale, so it should only look at the embedded UUID.
> 
> The benefit of this approach is that IDL user gets notified only of the
> changes, and also updates get naturally dampened ie large number of
> modifications to a single row gets delivered as fewer number of events.
> 
> 
> --
> Saurabh (सौरभ)
> 
> On Sun, Aug 2, 2015 at 12:06 PM, Ben Pfaff <blp at nicira.com> wrote:
> 
> > On Fri, Jul 31, 2015 at 08:03:41PM +0000, Ansari, Shad wrote:
> > >
> > > Ovsdb-idl notifies a client that "something" changed; it does not track
> > "what" changed. The client then typically either reconfigures itself by
> > scanning the idl to determine what changed, or - simply reloads the entire
> > idl. This presumably works since the ovs schema tables aren't typically
> > large.
> > >
> > > In a use-case where ovsdb is used with a schema that can have very large
> > tables (imagine route table), the current ovsdb-idl notification mechanism
> > doesn't appear to scale - clients need to do a lot of processing to
> > determine the exact change delta.
> > >
> > > I would like to hear from others if they have any views/insights on how
> > to handle this scalability use-case. Obviously, this will require changes
> > in ovsdb-idl, possibly on the lines of:
> > >
> > > -        Supporting more granular sequence numbers (table, row, column)
> > >
> > > -        Giving client visibility to the update (so that the client can
> > view both the old, new data)
> >
> > I'm welcome to discussion and proposals in this area.  I've expected for
> > years that we'd eventually need something like this for ovs-vswitchd
> > (although so far it isn't a big deal), and the same could be true for
> > ovn-controller as OVN begins to scale.
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss
> >

From jesse at nicira.com  Mon Aug  3 11:45:58 2015
From: jesse at nicira.com (Jesse Gross)
Date: Mon, 3 Aug 2015 11:45:58 -0700
Subject: [ovs-discuss] [Kernel panic] BUG: unable to handle kernel NULL
 pointer dereference
In-Reply-To: <CAOmrz4U=bs1=xBjtCS=1fgnJ8gA_8Ho5Bmod1fxyKZ23UMH65w@mail.gmail.com>
References: <CAOmrz4U=bs1=xBjtCS=1fgnJ8gA_8Ho5Bmod1fxyKZ23UMH65w@mail.gmail.com>
Message-ID: <CAEP_g=9MFN14yV9oAHoTUOGG9j+Cq_ZqNsG9v53SKKct3L+Zhg@mail.gmail.com>

On Wed, Jul 29, 2015 at 12:38 AM, 徐兆魁 <xuzk1992 at gmail.com> wrote:
> Running ovs-v2.3.2 on ubuntu 12.04-lts with kernel 3.13.0-55-generic, it
> panics like this:
>
> ```
> [195686.613495] BUG: unable to handle kernel NULL pointer dereference at

Pravin, I guess this was one of the local tunnel decap issues that you
were looking at?

From shad.ansari at hp.com  Mon Aug  3 12:10:23 2015
From: shad.ansari at hp.com (Ansari, Shad)
Date: Mon, 3 Aug 2015 19:10:23 +0000
Subject: [ovs-discuss] Scaling ovsdb-idl's update notification
In-Reply-To: <20150803165039.GD31662@nicira.com>
References: <8CA204A851B7B14E86E75054661E41750F92FD87@G4W3217.americas.hpqcorp.net>
 <20150802190636.GF28085@nicira.com>
 <CAEgOKCwm3hKbVh7HSxH8ZzBVT1oM+vcKhmWu9Pokhf=MtZWffg@mail.gmail.com>
 <20150803165039.GD31662@nicira.com>
Message-ID: <8CA204A851B7B14E86E75054661E41750F930D03@G4W3217.americas.hpqcorp.net>

Would it help if, for the deleted record, all fields except uuid, version, and indexes columns are reset to default (after regular deferred processing - unreferenced rows are deleted and dangling weak references are removed)? This ensures that the client does not access invalid references. Typically, the uuid or indexes should be sufficient information for the client to take action.


-----Original Message-----
From: Ben Pfaff [mailto:blp at nicira.com] 
Sent: Monday, August 03, 2015 9:51 AM
To: Saurabh Shrivastava (सौरभ श्रीवास्तव)
Cc: Ansari, Shad; discuss at openvswitch.org
Subject: Re: [ovs-discuss] Scaling ovsdb-idl's update notification

That kind of approach might work.

It's important to keep in mind, though, that the IDL isn't just a collection of unrelated records.  It's a graph: any record can point to any number of other records, through columns whose types are UUIDs with refTable constraints.  The IDL maintains tracks these relationships carefully for memory safety, so that if a record is deleted then the pointers to it from other records can be dropped.  Any approach to handling changes may have to take this into account.

On Sun, Aug 02, 2015 at 01:08:56PM -0700, Saurabh Shrivastava (सौरभ श्रीवास्तव) wrote:
> One approach can be to link all the struct ovsdb_idl_row in a linked 
> list where nodes are ordered by their time of update ie a newly added 
> node is put at the end of the linked list, an updated node is removed 
> from its current position and put at the end of the linked list, a 
> deleted node is kept in the linked list till it is notified to the idl 
> user. The size of this linked list will be the number of rows in the 
> table. A new ovsdb-idl API can be called to iterate over this linked 
> list one at a time, the API can place a marker node in the linked list 
> to remember till what point the notifications have been generated. The 
> IDL user should not try to dereference the pointers in  a "delete" 
> event because the pointers could be stale, so it should only look at the embedded UUID.
> 
> The benefit of this approach is that IDL user gets notified only of 
> the changes, and also updates get naturally dampened ie large number 
> of modifications to a single row gets delivered as fewer number of events.
> 
> 
> --
> Saurabh (सौरभ)
> 
> On Sun, Aug 2, 2015 at 12:06 PM, Ben Pfaff <blp at nicira.com> wrote:
> 
> > On Fri, Jul 31, 2015 at 08:03:41PM +0000, Ansari, Shad wrote:
> > >
> > > Ovsdb-idl notifies a client that "something" changed; it does not 
> > > track
> > "what" changed. The client then typically either reconfigures itself 
> > by scanning the idl to determine what changed, or - simply reloads 
> > the entire idl. This presumably works since the ovs schema tables 
> > aren't typically large.
> > >
> > > In a use-case where ovsdb is used with a schema that can have very 
> > > large
> > tables (imagine route table), the current ovsdb-idl notification 
> > mechanism doesn't appear to scale - clients need to do a lot of 
> > processing to determine the exact change delta.
> > >
> > > I would like to hear from others if they have any views/insights 
> > > on how
> > to handle this scalability use-case. Obviously, this will require 
> > changes in ovsdb-idl, possibly on the lines of:
> > >
> > > -        Supporting more granular sequence numbers (table, row, column)
> > >
> > > -        Giving client visibility to the update (so that the client can
> > view both the old, new data)
> >
> > I'm welcome to discussion and proposals in this area.  I've expected 
> > for years that we'd eventually need something like this for 
> > ovs-vswitchd (although so far it isn't a big deal), and the same 
> > could be true for ovn-controller as OVN begins to scale.
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss
> >

From jimsonchacko at gmail.com  Mon Aug  3 17:46:32 2015
From: jimsonchacko at gmail.com (jimson chacko)
Date: Tue, 4 Aug 2015 00:46:32 +0000
Subject: [ovs-discuss] Added new field in flow.h. But the xlate_actions
 gives mask value zero.
In-Reply-To: <20150803162012.GA31662@nicira.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <20150803162012.GA31662@nicira.com>
Message-ID: <CAF4aouoTF9S0q5NwcakWzOvPqJGH8H68JpoiG=Wwh5Q4+WScfg@mail.gmail.com>

Hi Ben,

Thanks for the quick response.

I am not sure whether the flow matches. But a few observations.

1. There are two flows seen in ofctl dump-flows output before the
traffic starts. First one is a default rule with action as "NORMAL"
(hub mode ?). Second one is the new flow which I added with ofctl
(output is port 2).
There is no flow in dpctl output at this stage.
2. When traffic is started, dpctl output shows only one entry with
action 2,3. (traffic is entering via port 1). I can see the new field
also in the dpctl output with mask as zero. As per my understanding,
this is an evidence that the flow is matched in ovs-vswitchd. But why
is the mask value zero and also why is the action set as 2,3 instead
of 2 alone ?
The packet counters in dpctl and the counters on the added flow in
ofctl match. So statistics part seems to be fine.
3. I added one more flow with a different value for the new field
using ofctl. Started traffic with both the previous value and new
value simultaneously. I still observe that there is only one flow in
dpctl output with the earlier entry. kernel is not able to distinguish
the flows and the counters are incremented on the existing flow. There
is no new flow seen in dpctl output.
4. Suppose the switch has only the "NORMAL" rule. I started the
traffic. The hub mode rule is seen in dpctl. Then a flow is added with
the new field using ofctl. Observed that the dpctl output is updated
with the new field value and the mask still is zero. No change in the
actions part.

I put debug logs just after xlate_actions in the hadle_upcalls
function. The mask value for other fields are printed along with the
new field. Mask is as expected for other fields except the new field.

I suspect the miniflow part. What are the changes required in miniflow
when a new field is introduced in flow ?

Expecting your inputs.

Regards
Jimson

On 8/3/15, Ben Pfaff <blp at nicira.com> wrote:
> On Mon, Aug 03, 2015 at 02:29:23PM +0530, jimson chacko wrote:
>> Hi,
>>
>> I am using version 2.3.0 of OVS.
>>
>> I have added a new filed (eg; gtp tunnel id) and changed FLOW_WC_SEQ.
>> Compiled the code. All the errors given by the compiler were fixed.
>>
>> I added a flow with ofctl add-flow command and retrieved the same using
>> ofctl dump-flows. Output shows both value and mask as in the input.
>>
>> When I sent traffic to the vswitch, the kernel module throws the
>> exception
>> packet with the NL Key filled in properly with the new attribute along
>> with
>> other attributes present in the packet.
>>
>> xlate_actions should identify the flow in the flow table and should give
>> me
>> the proper mask value for the new field in xout. But the mask value is
>> coming as zero.
>>
>>
>> Can you let me know what the issue could be ? Is there any issue with the
>> minimask etc ?
>
> It's hard to guess based on such a brief description, but: do your flows
> match on the new field?  If not, then translation would generate a mask
> of 0.
>

From lxuemei3000 at gmail.com  Mon Aug  3 18:54:28 2015
From: lxuemei3000 at gmail.com (Xuemei Liu)
Date: Mon, 3 Aug 2015 18:54:28 -0700
Subject: [ovs-discuss] Mininet cannot run with ovs,
	maybe configuration problem
In-Reply-To: <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
 <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
Message-ID: <CA+oJsLMSRRsF29Qw5qrqjwWnhTzzud0XAT+SvOA=0iRcxzNUwA@mail.gmail.com>

Hi, Bob,

Thanks for your response. Finally I find the problem, it's the "Open Files
Limit problem". I track the error log of ovs-vswitchd process and get this
error log. After following the steps in
https://rtcamp.com/tutorials/linux/increase-open-files-limit/, the problem
is solved.
@Bob, sorry for annoying you.

Thanks,
Xuemei

On Sun, Aug 2, 2015 at 6:52 PM, Bob Lantz <rlantz at cs.stanford.edu> wrote:

> I’ve had ovs-vsctl not work as expected when I install multiple,
> incompatible versions in various locations, as it sounds like you might
> have done.
>
> I’d recommend carefully following the recommended, documented installation
> procedure for OVS and/or mininet.
>
> If you think you have found a bug in mininet, please write to
> mininet-discuss.
>
>
> On Aug 1, 2015, at 6:43 PM, Xuemei Liu <lxuemei3000 at gmail.com> wrote:
>
> Hi, all,
>
> I find one problem while running ovs in mininet. I guess it should be mininet
> / configuration / dependency issue, but I cannot figure it out.
>
> 1. If I install mininet using "install.sh -a", it will install mininet
> with all dependencies, including ovs. Then "sudo mn --topo tree,3,3" works
> through.
> 2. If additionally I install OVS by myself (I mean git clone the latest
> ovs and install it), "sudo mn --topo tree,3,3" cannot work through, just
> stalls in the following step. The process ovs-vswitchd exits as well.
> 3. In 2, "sudo mn --topo tree,2,3" can work through. It seems with fewer
> switches it is ok.
>
> The problem occurs in a machine with ubuntu 14.04.1 and linux kernel
> version 3.13.0-35-generic. On my pc there is no such problem with ubuntu
> 14.04.2 and linux version 3.16.0-41-generic.
>
> This problem blocks me for one day. Does anyone have similar experience?
>
> Thanks,
> Xuemei
>
> [image: Inline image 1]
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/e2d88a1e/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image.png
Type: image/png
Size: 69429 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/e2d88a1e/attachment-0001.png>

From lxuemei3000 at gmail.com  Mon Aug  3 18:54:47 2015
From: lxuemei3000 at gmail.com (Xuemei Liu)
Date: Mon, 3 Aug 2015 18:54:47 -0700
Subject: [ovs-discuss] Mininet cannot run with ovs,
	maybe configuration problem
In-Reply-To: <CA+oJsLMSRRsF29Qw5qrqjwWnhTzzud0XAT+SvOA=0iRcxzNUwA@mail.gmail.com>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
 <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
 <CA+oJsLMSRRsF29Qw5qrqjwWnhTzzud0XAT+SvOA=0iRcxzNUwA@mail.gmail.com>
Message-ID: <CA+oJsLNVSr6tuMjR0YF52K7WUcZqjLtR7v=mqo3nV74YDhqP6A@mail.gmail.com>

Hi, Bob,

Thanks for your response. Finally I find the problem, it's the "Open Files
Limit problem". I track the error log of ovs-vswitchd process and get this
error log. After following the steps in
https://rtcamp.com/tutorials/linux/increase-open-files-limit/, the problem
is solved.
@Ben, sorry for annoying you.

Thanks,
Xuemei

On Mon, Aug 3, 2015 at 6:54 PM, Xuemei Liu <lxuemei3000 at gmail.com> wrote:

> Hi, Bob,
>
> Thanks for your response. Finally I find the problem, it's the "Open Files
> Limit problem". I track the error log of ovs-vswitchd process and get this
> error log. After following the steps in
> https://rtcamp.com/tutorials/linux/increase-open-files-limit/, the
> problem is solved.
> @Bob, sorry for annoying you.
>
> Thanks,
> Xuemei
>
> On Sun, Aug 2, 2015 at 6:52 PM, Bob Lantz <rlantz at cs.stanford.edu> wrote:
>
>> I’ve had ovs-vsctl not work as expected when I install multiple,
>> incompatible versions in various locations, as it sounds like you might
>> have done.
>>
>> I’d recommend carefully following the recommended, documented
>> installation procedure for OVS and/or mininet.
>>
>> If you think you have found a bug in mininet, please write to
>> mininet-discuss.
>>
>>
>> On Aug 1, 2015, at 6:43 PM, Xuemei Liu <lxuemei3000 at gmail.com> wrote:
>>
>> Hi, all,
>>
>> I find one problem while running ovs in mininet. I guess it should be mininet
>> / configuration / dependency issue, but I cannot figure it out.
>>
>> 1. If I install mininet using "install.sh -a", it will install mininet
>> with all dependencies, including ovs. Then "sudo mn --topo tree,3,3" works
>> through.
>> 2. If additionally I install OVS by myself (I mean git clone the latest
>> ovs and install it), "sudo mn --topo tree,3,3" cannot work through, just
>> stalls in the following step. The process ovs-vswitchd exits as well.
>> 3. In 2, "sudo mn --topo tree,2,3" can work through. It seems with fewer
>> switches it is ok.
>>
>> The problem occurs in a machine with ubuntu 14.04.1 and linux kernel
>> version 3.13.0-35-generic. On my pc there is no such problem with ubuntu
>> 14.04.2 and linux version 3.16.0-41-generic.
>>
>> This problem blocks me for one day. Does anyone have similar experience?
>>
>> Thanks,
>> Xuemei
>>
>> [image: Inline image 1]
>>
>>
>> _______________________________________________
>> discuss mailing list
>> discuss at openvswitch.org
>> http://openvswitch.org/mailman/listinfo/discuss
>>
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/a3c89185/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image.png
Type: image/png
Size: 69429 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/a3c89185/attachment-0001.png>

From fbl at sysclose.org  Mon Aug  3 19:24:59 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Mon, 3 Aug 2015 23:24:59 -0300
Subject: [ovs-discuss] One Issue with IGMP Snooping for OVS2.3.9
In-Reply-To: <SG2PR0301MB13024A7504A540CAA0CD2DE1F18A0@SG2PR0301MB1302.apcprd03.prod.outlook.com>
References: <SG2PR0301MB13024A7504A540CAA0CD2DE1F18A0@SG2PR0301MB1302.apcprd03.prod.outlook.com>
Message-ID: <20150804022459.GA2148@x240.home>

On Fri, Jul 31, 2015 at 09:41:14AM +0000, laxmikanta.behera at wipro.com wrote:
> Hi,
> 
> Age time reset to zero for existing host 1 ( stream from group IP-239.225.255.100) while  join request coming from host2 for different group Ip(239.255.255.250).
> Please find below screen shot.

When things are in sync, it's likely that the querier sent out the
Query and all the hosts had replied with Reports updating the switch.

You might want to check the traffic on host1's port to be sure.

> The information contained in this electronic message and any attachments to this message are intended for the exclusive use of the addressee(s) and may contain proprietary, confidential or privileged information. If you are not the intended recipient, you should not disseminate, distribute or copy this e-mail. Please notify the sender immediately and destroy all copies of this message and any attachments. WARNING: Computer viruses can be transmitted via email. The recipient should check this email and any attachments for the presence of viruses. The company accepts no liability for any damage caused by any virus transmitted by this email. www.wipro.com

The above doesn't fit with public mailing list of an open source
project.

Thanks
fbl


From blp at nicira.com  Mon Aug  3 21:08:28 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 3 Aug 2015 21:08:28 -0700
Subject: [ovs-discuss] Scaling ovsdb-idl's update notification
In-Reply-To: <8CA204A851B7B14E86E75054661E41750F930D03@G4W3217.americas.hpqcorp.net>
References: <8CA204A851B7B14E86E75054661E41750F92FD87@G4W3217.americas.hpqcorp.net>
 <20150802190636.GF28085@nicira.com>
 <CAEgOKCwm3hKbVh7HSxH8ZzBVT1oM+vcKhmWu9Pokhf=MtZWffg@mail.gmail.com>
 <20150803165039.GD31662@nicira.com>
 <8CA204A851B7B14E86E75054661E41750F930D03@G4W3217.americas.hpqcorp.net>
Message-ID: <20150804040828.GK1572@nicira.com>

If that's useful for real applications, and more practical, then I'm all
for it.  I haven't thought about the problem carefully; I'm just trying
to point out a constraint.

On Mon, Aug 03, 2015 at 07:10:23PM +0000, Ansari, Shad wrote:
> Would it help if, for the deleted record, all fields except uuid,
> version, and indexes columns are reset to default (after regular
> deferred processing - unreferenced rows are deleted and dangling weak
> references are removed)? This ensures that the client does not access
> invalid references. Typically, the uuid or indexes should be
> sufficient information for the client to take action.
> 
> 
> -----Original Message-----
> From: Ben Pfaff [mailto:blp at nicira.com] 
> Sent: Monday, August 03, 2015 9:51 AM
> To: Saurabh Shrivastava (सौरभ श्रीवास्तव)
> Cc: Ansari, Shad; discuss at openvswitch.org
> Subject: Re: [ovs-discuss] Scaling ovsdb-idl's update notification
> 
> That kind of approach might work.
> 
> It's important to keep in mind, though, that the IDL isn't just a collection of unrelated records.  It's a graph: any record can point to any number of other records, through columns whose types are UUIDs with refTable constraints.  The IDL maintains tracks these relationships carefully for memory safety, so that if a record is deleted then the pointers to it from other records can be dropped.  Any approach to handling changes may have to take this into account.
> 
> On Sun, Aug 02, 2015 at 01:08:56PM -0700, Saurabh Shrivastava (सौरभ श्रीवास्तव) wrote:
> > One approach can be to link all the struct ovsdb_idl_row in a linked 
> > list where nodes are ordered by their time of update ie a newly added 
> > node is put at the end of the linked list, an updated node is removed 
> > from its current position and put at the end of the linked list, a 
> > deleted node is kept in the linked list till it is notified to the idl 
> > user. The size of this linked list will be the number of rows in the 
> > table. A new ovsdb-idl API can be called to iterate over this linked 
> > list one at a time, the API can place a marker node in the linked list 
> > to remember till what point the notifications have been generated. The 
> > IDL user should not try to dereference the pointers in  a "delete" 
> > event because the pointers could be stale, so it should only look at the embedded UUID.
> > 
> > The benefit of this approach is that IDL user gets notified only of 
> > the changes, and also updates get naturally dampened ie large number 
> > of modifications to a single row gets delivered as fewer number of events.
> > 
> > 
> > --
> > Saurabh (सौरभ)
> > 
> > On Sun, Aug 2, 2015 at 12:06 PM, Ben Pfaff <blp at nicira.com> wrote:
> > 
> > > On Fri, Jul 31, 2015 at 08:03:41PM +0000, Ansari, Shad wrote:
> > > >
> > > > Ovsdb-idl notifies a client that "something" changed; it does not 
> > > > track
> > > "what" changed. The client then typically either reconfigures itself 
> > > by scanning the idl to determine what changed, or - simply reloads 
> > > the entire idl. This presumably works since the ovs schema tables 
> > > aren't typically large.
> > > >
> > > > In a use-case where ovsdb is used with a schema that can have very 
> > > > large
> > > tables (imagine route table), the current ovsdb-idl notification 
> > > mechanism doesn't appear to scale - clients need to do a lot of 
> > > processing to determine the exact change delta.
> > > >
> > > > I would like to hear from others if they have any views/insights 
> > > > on how
> > > to handle this scalability use-case. Obviously, this will require 
> > > changes in ovsdb-idl, possibly on the lines of:
> > > >
> > > > -        Supporting more granular sequence numbers (table, row, column)
> > > >
> > > > -        Giving client visibility to the update (so that the client can
> > > view both the old, new data)
> > >
> > > I'm welcome to discussion and proposals in this area.  I've expected 
> > > for years that we'd eventually need something like this for 
> > > ovs-vswitchd (although so far it isn't a big deal), and the same 
> > > could be true for ovn-controller as OVN begins to scale.
> > > _______________________________________________
> > > discuss mailing list
> > > discuss at openvswitch.org
> > > http://openvswitch.org/mailman/listinfo/discuss
> > >

From blp at nicira.com  Mon Aug  3 21:19:18 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 3 Aug 2015 21:19:18 -0700
Subject: [ovs-discuss] Added new field in flow.h. But the xlate_actions
 gives mask value zero.
In-Reply-To: <CAF4aouoTF9S0q5NwcakWzOvPqJGH8H68JpoiG=Wwh5Q4+WScfg@mail.gmail.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <20150803162012.GA31662@nicira.com>
 <CAF4aouoTF9S0q5NwcakWzOvPqJGH8H68JpoiG=Wwh5Q4+WScfg@mail.gmail.com>
Message-ID: <20150804041918.GB3942@nicira.com>

On Tue, Aug 04, 2015 at 12:46:32AM +0000, jimson chacko wrote:
> Hi Ben,
> 
> Thanks for the quick response.
> 
> I am not sure whether the flow matches. But a few observations.
> 
> 1. There are two flows seen in ofctl dump-flows output before the
> traffic starts. First one is a default rule with action as "NORMAL"
> (hub mode ?). Second one is the new flow which I added with ofctl
> (output is port 2).
> There is no flow in dpctl output at this stage.
> 2. When traffic is started, dpctl output shows only one entry with
> action 2,3. (traffic is entering via port 1). I can see the new field
> also in the dpctl output with mask as zero. As per my understanding,
> this is an evidence that the flow is matched in ovs-vswitchd. But why
> is the mask value zero and also why is the action set as 2,3 instead
> of 2 alone ?
> The packet counters in dpctl and the counters on the added flow in
> ofctl match. So statistics part seems to be fine.
> 3. I added one more flow with a different value for the new field
> using ofctl. Started traffic with both the previous value and new
> value simultaneously. I still observe that there is only one flow in
> dpctl output with the earlier entry. kernel is not able to distinguish
> the flows and the counters are incremented on the existing flow. There
> is no new flow seen in dpctl output.
> 4. Suppose the switch has only the "NORMAL" rule. I started the
> traffic. The hub mode rule is seen in dpctl. Then a flow is added with
> the new field using ofctl. Observed that the dpctl output is updated
> with the new field value and the mask still is zero. No change in the
> actions part.
> 
> I put debug logs just after xlate_actions in the hadle_upcalls
> function. The mask value for other fields are printed along with the
> new field. Mask is as expected for other fields except the new field.
> 
> I suspect the miniflow part. What are the changes required in miniflow
> when a new field is introduced in flow ?

Normally, no changes at all.

I guess your code has a bug.

From mark.d.gray at intel.com  Tue Aug  4 01:15:58 2015
From: mark.d.gray at intel.com (Gray, Mark D)
Date: Tue, 4 Aug 2015 08:15:58 +0000
Subject: [ovs-discuss] Added new field in flow.h. But the
	xlate_actions	gives mask value zero.
In-Reply-To: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
Message-ID: <738D45BC1F695740A983F43CFE1B7EA9437BB4A5@IRSMSX108.ger.corp.intel.com>

> Hi,
> 
> 
> I am using version 2.3.0 of OVS.
> 
> 
> I have added a new filed (eg; gtp tunnel id) and changed FLOW_WC_SEQ.
> Compiled the code. All the errors given by the compiler were fixed.
> 

Are you planning to upstream this?

From wenx05124561 at 163.com  Tue Aug  4 03:02:43 2015
From: wenx05124561 at 163.com (wenxu)
Date: Tue, 4 Aug 2015 18:02:43 +0800 (CST)
Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
In-Reply-To: <738D45BC1F695740A983F43CFE1B7EA9437BB4A5@IRSMSX108.ger.corp.intel.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <738D45BC1F695740A983F43CFE1B7EA9437BB4A5@IRSMSX108.ger.corp.intel.com>
Message-ID: <32bb8e56.1f125.14ef829c4c4.Coremail.wenx05124561@163.com>



Hi  all,

I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.
My host is centos7.0
There is a br0 with dpdk0 and vhost-user-0
I build dpdk with 2.0.0 and ovs with branch 2.4
# ovs-vsctl show
ovs-vsctl show
c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
    Bridge "br0"
        Port "br0"
            Interface "br0"
                type: internal
        Port "vhost-user-0"
            Interface "vhost-user-0"
                type: dpdkvhostuser
        Port "dpdk0"
            Interface "dpdk0"
                type: dpdk

I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for vhost-user

# qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa node,memdev=mem -mem-prealloc

qemu-system-x86_64: -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up

I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
But they can't ping each other

# ovs-ofctl dump-flows br0
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204, idle_age=0, hard_age=65534, priority=0 actions=NORMAL

# ovs-vsctl list interface vhost-user-0
_uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
admin_state         : down
bfd                 : {}
bfd_status          : {}
cfm_fault           : []
cfm_fault_status    : []
cfm_flap_count      : []
cfm_health          : []
cfm_mpid            : []
cfm_remote_mpids    : []
cfm_remote_opstate  : []
duplex              : []
error               : []
external_ids        : {}
ifindex             : 0
ingress_policing_burst: 0
ingress_policing_rate: 0
lacp_current        : []
link_resets         : 1
link_speed          : []
link_state          : down
lldp                : {}
mac                 : []
mac_in_use          : "00:00:00:00:00:00"
mtu                 : 1500
name                : "vhost-user-0"
ofport              : 4
ofport_request      : []
options             : {}
other_config        : {}
statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
status              : {}
type                : dpdkvhostuser

I  can see the vhost-user-0 port always show down and there are some dropped packets which are sent from br0.

Are there some wrong with my POC?

BR
Xu Wen
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/19f64210/attachment-0001.html>

From ravikumar.bhattiprolu at gmail.com  Tue Aug  4 04:04:46 2015
From: ravikumar.bhattiprolu at gmail.com (Bhattiprolu RaviKumar)
Date: Tue, 4 Aug 2015 16:34:46 +0530
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
Message-ID: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>

All,

  Though I have briefly searched through archieves, I have not found many
details and hence posting to the whole group.

1. Does OpenvSwich and SRIOV can work together? If so, how will OVS know
about various VFs and packets switched inside the NIC?
2. If it is not already supported, are there any plans of supporting SRIOV
with OVS?

regards,
Ravi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/c7b1b8fb/attachment.html>

From ychen103103 at 163.com  Tue Aug  4 04:52:23 2015
From: ychen103103 at 163.com (ychen)
Date: Tue, 4 Aug 2015 19:52:23 +0800 (CST)
Subject: [ovs-discuss] a suggestion to improve performance when adding
 lots of ports
In-Reply-To: <5437794e.3ca4.14a18350a93.Coremail.ychen103103@163.com>
References: <777b9663.c978.149e64f369a.Coremail.ychen103103@163.com>
 <20141125154009.GE23168@nicira.com>
 <5437794e.3ca4.14a18350a93.Coremail.ychen103103@163.com>
Message-ID: <3dcc4549.2523f.14ef88e28f9.Coremail.ychen103103@163.com>

I   wanted to know whether ovs community have any suggestions to resolve  this problem.
now this problem also appear on openstack, the error log "Unable to add port tapcfca4a52-37 to OVS bridge br-int" appeared when there is nearly 1000 ports on one compute node.
but with command "add-port --timeout=50" the phenomenon disappeared.





At 2014-12-05 10:08:56, "ychen" <ychen103103 at 163.com> wrote:


hi,
  This a patch for performance optimization when adding lots of ports.
  The patch is based on version 2.3.0, and I have run all the testsuites.
  The main optimize points are :
  1) monitor some special records instead of monitor all the records
  2) remove column "ports" in table "Bridge", replaced with adding "bridges" in table "Port"







At 2014-11-25 23:40:09, "Ben Pfaff" <blp at nicira.com> wrote:
>On Tue, Nov 25, 2014 at 05:36:31PM +0800, ychen wrote:
>>    I have found that when adding lots of ports, system consumes more and more time when ports number increasing.
>>   And the main time is consumed on encapsulation and decapsulation the JSON message between vsctl and ovsdb-server.
>>   when vsctl starts, it will first send monitor request to ovsdb-server, and then db-server send all the records with the related column to vsctl
>>   please notice the word "all records", so that when ports number gets larger, system will need more time to encap and decap the JSON message between vsctl and db-server.
>> 
>> 
>>   I suggest to slightly modify the RPC  method "Monitor" in RFC 7047. The main idea is only monitor specified records when add /del/set/get port.
>>   The original Monitor method is like that:
>>   Each <monitor-request> is an object with the following members:
>> "columns": [<column>*] optional
>> "select": <monitor-select> optional
>> The columns, if present, define the columns within the table to be
>> monitored. <monitor-select> is an object with the following members:
>> "initial": <boolean> optional
>> "insert": <boolean> optional
>> "delete": <boolean> optional
>> 
>> "modify": <boolean> optional
>>   And I want give this method a slight change:
>> <monitor-select> is an object with the following members:
>> "initial": <boolean> optional
>> "insert": <boolean> optional
>> "delete": <boolean> optional
>> 
>> "modify": <boolean> optional
>> "where": [<condition>*] optional
>> for example, when add or del a port p0, first we will send a monitor request like this:
>> method="monitor", params=["Open_vSwitch",null,{"Port":{"columns":["bridges","fake_bridge","interfaces","name","tag"],"select":{"where":[["name","==","p0"]]}},"Interface":{"columns":["name","ofport","type"],"select":{"where":[["name","==","p0"]]}},"Bridge":{"columns":["controller","fail_mode","name"],"select":{"where":[["name","==","br0"]]}},"Controller":{"columns":[]},"Open_vSwitch":{"columns":["bridges","cur_cfg"]}}]
>> then ovsdb-server should only reply with the specified record p0, so that we can save lots of time when monitoring. 
>> I have done a test with this method, with 4000 ports, the time consuming can be decreased from about 2800s to about 500s.
>
>Sounds great, please submit patches when you have them ready.



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/11f53507/attachment.html>

From nick.bastin at gmail.com  Tue Aug  4 05:14:18 2015
From: nick.bastin at gmail.com (Nicholas Bastin)
Date: Tue, 4 Aug 2015 02:14:18 -1000
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
In-Reply-To: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
References: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
Message-ID: <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>

On Tue, Aug 4, 2015 at 1:04 AM, Bhattiprolu RaviKumar <
ravikumar.bhattiprolu at gmail.com> wrote:

> 1. Does OpenvSwich and SRIOV can work together? If so, how will OVS know
> about various VFs and packets switched inside the NIC?
>

You can attach a VF to an OVS instance, but only packets that traverse the
VF will actually reach the OVS instance (of course).  If any filtering and
switching is done inside the NIC you need to treat this as a hop
independent of the OVS instance.


> 2. If it is not already supported, are there any plans of supporting SRIOV
> with OVS?
>

What would you expect "support" to mean?

--
Nick
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/ec670da0/attachment.html>

From ravikumar.bhattiprolu at gmail.com  Tue Aug  4 05:29:38 2015
From: ravikumar.bhattiprolu at gmail.com (Bhattiprolu RaviKumar)
Date: Tue, 4 Aug 2015 17:59:38 +0530
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
In-Reply-To: <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>
References: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
 <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>
Message-ID: <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>

Nick,
  Thanks for the reply. I am more looking from virtualization perspective.
If I have attached VFs to VMs and switching happens in NIC, OVS will not
know what is happening in NIC. Also, the switching inside NIX is based on
ethernet MAC address and VLAN. We will not be able to take the full
advantage of other OVS features like VxLAN encapsulation etc at this moment
with VFs. Also, number of VFs will be limited and ifd we need to switch
between VF and a software interface, it will not be possible. This is what
I mean by support in OVS. Is there any specification whichcal tell HW
requirements so that OVS can work in this situation seamlessly.

regards,
Ravi

On Tue, Aug 4, 2015 at 5:44 PM, Nicholas Bastin <nick.bastin at gmail.com>
wrote:

> On Tue, Aug 4, 2015 at 1:04 AM, Bhattiprolu RaviKumar <
> ravikumar.bhattiprolu at gmail.com> wrote:
>
>> 1. Does OpenvSwich and SRIOV can work together? If so, how will OVS know
>> about various VFs and packets switched inside the NIC?
>>
>
> You can attach a VF to an OVS instance, but only packets that traverse the
> VF will actually reach the OVS instance (of course).  If any filtering and
> switching is done inside the NIC you need to treat this as a hop
> independent of the OVS instance.
>
>
>> 2. If it is not already supported, are there any plans of supporting
>> SRIOV with OVS?
>>
>
> What would you expect "support" to mean?
>
> --
> Nick
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/7cf7a712/attachment-0001.html>

From v.tolstov at selfip.ru  Tue Aug  4 06:01:06 2015
From: v.tolstov at selfip.ru (Vasiliy Tolstov)
Date: Tue, 4 Aug 2015 16:01:06 +0300
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
In-Reply-To: <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>
References: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
 <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>
 <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>
Message-ID: <CACaajQvDibArK2e6dAWzTZ9t3zB6mLiOHVVQY0HamATo9qL3Ug@mail.gmail.com>

2015-08-04 15:29 GMT+03:00 Bhattiprolu RaviKumar
<ravikumar.bhattiprolu at gmail.com>:
> Nick,
>   Thanks for the reply. I am more looking from virtualization perspective.
> If I have attached VFs to VMs and switching happens in NIC, OVS will not
> know what is happening in NIC. Also, the switching inside NIX is based on
> ethernet MAC address and VLAN. We will not be able to take the full
> advantage of other OVS features like VxLAN encapsulation etc at this moment
> with VFs. Also, number of VFs will be limited and ifd we need to switch
> between VF and a software interface, it will not be possible. This is what I
> mean by support in OVS. Is there any specification whichcal tell HW
> requirements so that OVS can work in this situation seamlessly.


You can use mellanox or something like this cards that have internally
openflow support in nic.

-- 
Vasiliy Tolstov,
e-mail: v.tolstov at selfip.ru

From nick.bastin at gmail.com  Tue Aug  4 06:03:23 2015
From: nick.bastin at gmail.com (Nicholas Bastin)
Date: Tue, 4 Aug 2015 03:03:23 -1000
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
In-Reply-To: <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>
References: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
 <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>
 <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>
Message-ID: <CADmMkWe1BM9oLXzZZ=O-f8Rx1XLOV6RgO=Mr0xT=qkHgFkQoFg@mail.gmail.com>

On Tue, Aug 4, 2015 at 2:29 AM, Bhattiprolu RaviKumar <
ravikumar.bhattiprolu at gmail.com> wrote:

>   Thanks for the reply. I am more looking from virtualization perspective.
> If I have attached VFs to VMs and switching happens in NIC, OVS will not
> know what is happening in NIC. Also, the switching inside NIX is based on
> ethernet MAC address and VLAN. We will not be able to take the full
> advantage of other OVS features like VxLAN encapsulation etc at this moment
> with VFs.
>

You can't have mutually exclusive things.  VFs are built to bypass at least
one layer of software forwarding (and often multiple layers), and as such,
they do what they are designed for.  If you want to take advantage of
software features not built into the NIC, you should either not be using
VFs, or attaching those features to the end of the VF.


> Also, number of VFs will be limited and ifd we need to switch between VF
> and a software interface, it will not be possible. This is what I mean by
> support in OVS. Is there any specification whichcal tell HW requirements so
> that OVS can work in this situation seamlessly.
>

You can switch between a VF and a software interface using the rules in the
NIC (by slotting all software interfaces into a single VF in dom0, as is
typical).  I suspect however that you want to *override* a choice the NIC
makes, which you cannot do.  You should view the NIC as an upstream switch
in your topology, and if you want packets to come to your vswitch, you need
to configure the upstream switch appropriately.

--
Nick
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/74f6223d/attachment.html>

From nick.bastin at gmail.com  Tue Aug  4 06:05:53 2015
From: nick.bastin at gmail.com (Nicholas Bastin)
Date: Tue, 4 Aug 2015 03:05:53 -1000
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
In-Reply-To: <CACaajQvDibArK2e6dAWzTZ9t3zB6mLiOHVVQY0HamATo9qL3Ug@mail.gmail.com>
References: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
 <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>
 <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>
 <CACaajQvDibArK2e6dAWzTZ9t3zB6mLiOHVVQY0HamATo9qL3Ug@mail.gmail.com>
Message-ID: <CADmMkWd+yexfRKDVGSanADm8J9avxK5MuneGEMpWtm9zhsm1rw@mail.gmail.com>

On Tue, Aug 4, 2015 at 3:01 AM, Vasiliy Tolstov <v.tolstov at selfip.ru> wrote:

> You can use mellanox or something like this cards that have internally
> openflow support in nic.
>

"Openflow" support or not, the eSwitch in the mellanox NICs still has very
limited support for match and action.  Openflow  just specifies how you
*configure* the NIC, not what it is capable of.  Most modern server NIC
chipsets support similar functionality, if not via Openflow (ethtool,
PF_RING, etc. can configure the on-chip tables in Intel NICs, for example).

--
Nick
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/1c3bd28e/attachment.html>

From v.tolstov at selfip.ru  Tue Aug  4 06:07:46 2015
From: v.tolstov at selfip.ru (Vasiliy Tolstov)
Date: Tue, 4 Aug 2015 16:07:46 +0300
Subject: [ovs-discuss] Question on SRIOV + OpenvSwitch
In-Reply-To: <CADmMkWd+yexfRKDVGSanADm8J9avxK5MuneGEMpWtm9zhsm1rw@mail.gmail.com>
References: <CAL2JCb9tewNiHsGu4wrGqEZS+5hiPZLs+GVUcpG=UwPKmw3zqQ@mail.gmail.com>
 <CADmMkWerfc-+M_8Cr0AD4GNDs542G94q-UCb-RWayJ5GGVPK6g@mail.gmail.com>
 <CAL2JCb-sTFg2s1cc5-W1MbvHgdEBZbHv4cdpge5XARpzU7HcfQ@mail.gmail.com>
 <CACaajQvDibArK2e6dAWzTZ9t3zB6mLiOHVVQY0HamATo9qL3Ug@mail.gmail.com>
 <CADmMkWd+yexfRKDVGSanADm8J9avxK5MuneGEMpWtm9zhsm1rw@mail.gmail.com>
Message-ID: <CACaajQtP3LThXaDGs3BuAfac5QuW5e3TZLptSPjrQ6nrHZZDdw@mail.gmail.com>

2015-08-04 16:05 GMT+03:00 Nicholas Bastin <nick.bastin at gmail.com>:
> "Openflow" support or not, the eSwitch in the mellanox NICs still has very
> limited support for match and action.  Openflow  just specifies how you
> *configure* the NIC, not what it is capable of.  Most modern server NIC
> chipsets support similar functionality, if not via Openflow (ethtool,
> PF_RING, etc. can configure the on-chip tables in Intel NICs, for example).


Yes, i'm understand =)

-- 
Vasiliy Tolstov,
e-mail: v.tolstov at selfip.ru

From chenww at hotmail.com  Mon Aug  3 13:45:35 2015
From: chenww at hotmail.com (Chen Weiwen)
Date: Mon, 3 Aug 2015 20:45:35 +0000
Subject: [ovs-discuss] =?utf-8?q?packet_leaking_across_vswitches?=
Message-ID: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>

Dear all,


see weird things only with openvswitch, even the latest version, that potentially packet will leak from one vswitch to another, even those two vswitches are configured  separately with different physical NICs on different VLAN trunks. No patch/tunnel ports involved. We see looping detection happens to these two uplink ports.


vswitch1: 

      - eth0

      - port with vlan 100


vswitch2:

      - eth1

      - port with vlan 200


Can someone explain if this is possible the packet from vlan 200 on vswitch1 can reach vswitch2?


Thanks & Regards

-weiwen
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150803/95428943/attachment-0001.html>

From abarbadekar at virtela.net  Tue Aug  4 01:28:18 2015
From: abarbadekar at virtela.net (Barbadekar, Anil)
Date: Tue, 4 Aug 2015 08:28:18 +0000
Subject: [ovs-discuss] List of Bugs resolved in OVS 2.3.2
Message-ID: <67F0EF41D350C547AEF9ADA277E1938918D17F4E@VSGSNG3-EX-MB2.virtela.cc>

Dear Admins,

Kindly share list of bugs resolved if we migrate from 2.3.1 to 2.3.2. That will help us to take decision based on resolved items.

Thanks & Regards,
Anil Barbadekar
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/9628c6b2/attachment.html>

From jpettit at nicira.com  Tue Aug  4 09:31:15 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Tue, 4 Aug 2015 09:31:15 -0700
Subject: [ovs-discuss] packet leaking across vswitches
In-Reply-To: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>
References: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>
Message-ID: <3F5F9DF8-3157-4A68-9894-A89DA01C0D34@nicira.com>


> On Aug 3, 2015, at 1:45 PM, Chen Weiwen <chenww at hotmail.com> wrote:
> 
> Dear all,
> 
> see weird things only with openvswitch, even the latest version, that potentially packet will leak from one vswitch to another, even those two vswitches are configured  separately with different physical NICs on different VLAN trunks. No patch/tunnel ports involved. We see looping detection happens to these two uplink ports.
> 
> vswitch1: 
>       - eth0
>       - port with vlan 100
> 
> vswitch2:
>       - eth1
>       - port with vlan 200
> 
> Can someone explain if this is possible the packet from vlan 200 on vswitch1 can reach vswitch2?

That should not be possible and would be an extremely serious bug.  When the traffic is running, you could run "ovs-dpctl dump-flows" to see if packets are being forwarded between the NICs.

--Justin



From ciara.loftus at intel.com  Tue Aug  4 09:34:16 2015
From: ciara.loftus at intel.com (Loftus, Ciara)
Date: Tue, 4 Aug 2015 16:34:16 +0000
Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
In-Reply-To: <140efd08.787f.14ef2516be2.Coremail.wenx05124561@163.com>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
 <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
 <140efd08.787f.14ef2516be2.Coremail.wenx05124561@163.com>
Message-ID: <74F120C019F4A64C9B78E802F6AD4CC23B3AABA4@IRSMSX106.ger.corp.intel.com>

> Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
> 
> Hi  all,
> 
> I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.
> 
> There is a br0 with dpdk0 and vhost-user-0
> I build dpdk with 2.0.0 and ovs with branch 2.4
> # ovs-vsctl show
> ovs-vsctl show
> c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
>     Bridge "br0"
>         Port "br0"
>             Interface "br0"
>                 type: internal
>         Port "vhost-user-0"
>             Interface "vhost-user-0"
>                 type: dpdkvhostuser
>         Port "dpdk0"
>             Interface "dpdk0"
>                 type: dpdk
> 
> I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for
> vhost-user
What kernel is your guest using? Anything above kernel 3.16 unfortunately does not work.

> 
> # qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev
> socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev
> type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-
> pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-
> file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa
> node,memdev=mem -mem-prealloc
> qemu-system-x86_64: -netdev type=vhost-
> user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up
> 
> I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
> But they can't ping each other
> 
> # ovs-ofctl dump-flows br0
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204,
> idle_age=0, hard_age=65534, priority=0 actions=NORMAL
> 
> # ovs-vsctl list interface vhost-user-0
> _uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
> admin_state         : down
> bfd                 : {}
> bfd_status          : {}
> cfm_fault           : []
> cfm_fault_status    : []
> cfm_flap_count      : []
> cfm_health          : []
> cfm_mpid            : []
> cfm_remote_mpids    : []
> cfm_remote_opstate  : []
> duplex              : []
> error               : []
> external_ids        : {}
> ifindex             : 0
> ingress_policing_burst: 0
> ingress_policing_rate: 0
> lacp_current        : []
> link_resets         : 1
> link_speed          : []
> link_state          : down
> lldp                : {}
> mac                 : []
> mac_in_use          : "00:00:00:00:00:00"
> mtu                 : 1500
> name                : "vhost-user-0"
> ofport              : 4
> ofport_request      : []
> options             : {}
> other_config        : {}
> statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
> status              : {}
> type                : dpdkvhostuser
> 
> I  can see the vhost-user-0 port always show down and there are some
> dropped packets which are sent from br0.
The link state reported as "down" is ok and not an indication of an issue.

> 
> Are there some wrong with my POC?
In addition to checking you have a compatible guest kernel version, can you check you have iptables turned off and the 'firewalld' service stopped in the guest.

> 
> BR
> Xu Wen
> 
> 


From fbl at sysclose.org  Tue Aug  4 10:35:17 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Tue, 4 Aug 2015 14:35:17 -0300
Subject: [ovs-discuss] List of Bugs resolved in OVS 2.3.2
In-Reply-To: <67F0EF41D350C547AEF9ADA277E1938918D17F4E@VSGSNG3-EX-MB2.virtela.cc>
References: <67F0EF41D350C547AEF9ADA277E1938918D17F4E@VSGSNG3-EX-MB2.virtela.cc>
Message-ID: <20150804173517.GB2148@x240.home>

On Tue, Aug 04, 2015 at 08:28:18AM +0000, Barbadekar, Anil wrote:
> Dear Admins,
> 
> Kindly share list of bugs resolved if we migrate from 2.3.1 to 2.3.2. That will help us to take decision based on resolved items.

Someone asked the same question few days ago.
Just look at the repository logs.  You will find each change
with a description of what happened.

For 2.3.x, you can look just at branch-2.3.

fbl


From fbl at sysclose.org  Tue Aug  4 10:37:48 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Tue, 4 Aug 2015 14:37:48 -0300
Subject: [ovs-discuss] packet leaking across vswitches
In-Reply-To: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>
References: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>
Message-ID: <20150804173748.GC2148@x240.home>

On Mon, Aug 03, 2015 at 08:45:35PM +0000, Chen Weiwen wrote:
> see weird things only with openvswitch, even the latest version,
> that potentially packet will leak from one vswitch to another, even
> those two vswitches are configured  separately with different
> physical NICs on different VLAN trunks. No patch/tunnel ports
> involved. We see looping detection happens to these two uplink
> ports.
> 
> 
> vswitch1: 
>       - eth0
>       - port with vlan 100
> 
> vswitch2:
>       - eth1
>       - port with vlan 200
> 
> Can someone explain if this is possible the packet from vlan 200 on
> vswitch1 can reach vswitch2?

That's really odd.  Can you provide more info about your setup?
Is it Linux? Do you have configured IP addresses? It is forwarding
between those configured devices?

fbl


From davidjoshuaevans at gmail.com  Tue Aug  4 13:45:42 2015
From: davidjoshuaevans at gmail.com (David Evans)
Date: Tue, 04 Aug 2015 15:45:42 -0500
Subject: [ovs-discuss] recirculation on custom action.
Message-ID: <D1E68EA6.2EA69%davidjoshuaevans@gmail.com>

Hi OVS 

I¹d like to trigger a recirculation based on a packet modifying action.
What¹s the best way to do this?


1. add another custom action?
2. Add a compose_recirculate_action() in do_xlate_actions() for my custom
action?
3. Another way I haven¹t heard of.

Cheers,
Dave.



From jimsonchacko at gmail.com  Tue Aug  4 19:26:33 2015
From: jimsonchacko at gmail.com (jimson chacko)
Date: Wed, 5 Aug 2015 07:56:33 +0530
Subject: [ovs-discuss] Added new field in flow.h. But the xlate_actions
 gives mask value zero.
In-Reply-To: <20150804041918.GB3942@nicira.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <20150803162012.GA31662@nicira.com>
 <CAF4aouoTF9S0q5NwcakWzOvPqJGH8H68JpoiG=Wwh5Q4+WScfg@mail.gmail.com>
 <20150804041918.GB3942@nicira.com>
Message-ID: <CAF4aoupjOoXVoBtDfkVGFyt5Mu8mYME8hxmT9KG8iZH6CK38KQ@mail.gmail.com>

Hi Ben,

Yes, it was really a bug in parsing the flow key from the upcall packet,
precisely a misunderstanding of how the data_try_pull and data_pull work.

The log commands were helpful in displaying the source key and packet
coming from the kernel.

ovs-appctl vlog/list
ovs-appctl vlog/set dpif:ANY:DBG

It would be nice to have the log related commands in the FAQ.

Thanks & Regards
Jimson

On Tue, Aug 4, 2015 at 9:49 AM, Ben Pfaff <blp at nicira.com> wrote:

> On Tue, Aug 04, 2015 at 12:46:32AM +0000, jimson chacko wrote:
> > Hi Ben,
> >
> > Thanks for the quick response.
> >
> > I am not sure whether the flow matches. But a few observations.
> >
> > 1. There are two flows seen in ofctl dump-flows output before the
> > traffic starts. First one is a default rule with action as "NORMAL"
> > (hub mode ?). Second one is the new flow which I added with ofctl
> > (output is port 2).
> > There is no flow in dpctl output at this stage.
> > 2. When traffic is started, dpctl output shows only one entry with
> > action 2,3. (traffic is entering via port 1). I can see the new field
> > also in the dpctl output with mask as zero. As per my understanding,
> > this is an evidence that the flow is matched in ovs-vswitchd. But why
> > is the mask value zero and also why is the action set as 2,3 instead
> > of 2 alone ?
> > The packet counters in dpctl and the counters on the added flow in
> > ofctl match. So statistics part seems to be fine.
> > 3. I added one more flow with a different value for the new field
> > using ofctl. Started traffic with both the previous value and new
> > value simultaneously. I still observe that there is only one flow in
> > dpctl output with the earlier entry. kernel is not able to distinguish
> > the flows and the counters are incremented on the existing flow. There
> > is no new flow seen in dpctl output.
> > 4. Suppose the switch has only the "NORMAL" rule. I started the
> > traffic. The hub mode rule is seen in dpctl. Then a flow is added with
> > the new field using ofctl. Observed that the dpctl output is updated
> > with the new field value and the mask still is zero. No change in the
> > actions part.
> >
> > I put debug logs just after xlate_actions in the hadle_upcalls
> > function. The mask value for other fields are printed along with the
> > new field. Mask is as expected for other fields except the new field.
> >
> > I suspect the miniflow part. What are the changes required in miniflow
> > when a new field is introduced in flow ?
>
> Normally, no changes at all.
>
> I guess your code has a bug.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150805/24cac2da/attachment.html>

From wenx05124561 at 163.com  Tue Aug  4 20:13:00 2015
From: wenx05124561 at 163.com (wenxu)
Date: Wed, 5 Aug 2015 11:13:00 +0800 (CST)
Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
In-Reply-To: <74F120C019F4A64C9B78E802F6AD4CC23B3AABA4@IRSMSX106.ger.corp.intel.com>
References: <CA+oJsLNV+T1uG273m2as_K3MMOrB5DM+W2vR1Rqm7pND8-UqaA@mail.gmail.com>
 <08088ACA-AB89-4D76-A1E0-915BCC685FDB@cs.stanford.edu>
 <140efd08.787f.14ef2516be2.Coremail.wenx05124561@163.com>
 <74F120C019F4A64C9B78E802F6AD4CC23B3AABA4@IRSMSX106.ger.corp.intel.com>
Message-ID: <7f46084b.5eb4.14efbd902a8.Coremail.wenx05124561@163.com>



Hi ，


>In addition to checking you have a compatible guest kernel version, can you check you have iptables turned off and the 'firewalld' service stopped in the guest.

I rebuild my POC with master branch ovs and master branch qemu, but it's the same situation
I think It's not mater with iptables thing.  When I ping from br0 to virtual machine, I can see the vhost-user-1 port dropped tx packets.
My guest os is ubuntu14.04.2, kernel is 3.16. My host os is centos7 with kernel 3.10













At 2015-08-05 00:34:16, "Loftus, Ciara" <ciara.loftus at intel.com> wrote:
>> Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
>> 
>> Hi  all,
>> 
>> I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.
>> 
>> There is a br0 with dpdk0 and vhost-user-0
>> I build dpdk with 2.0.0 and ovs with branch 2.4
>> # ovs-vsctl show
>> ovs-vsctl show
>> c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
>>     Bridge "br0"
>>         Port "br0"
>>             Interface "br0"
>>                 type: internal
>>         Port "vhost-user-0"
>>             Interface "vhost-user-0"
>>                 type: dpdkvhostuser
>>         Port "dpdk0"
>>             Interface "dpdk0"
>>                 type: dpdk
>> 
>> I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for
>> vhost-user
>What kernel is your guest using? Anything above kernel 3.16 unfortunately does not work.
>
>> 
>> # qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev
>> socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev
>> type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-
>> pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-
>> file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa
>> node,memdev=mem -mem-prealloc
>> qemu-system-x86_64: -netdev type=vhost-
>> user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up
>> 
>> I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
>> But they can't ping each other
>> 
>> # ovs-ofctl dump-flows br0
>> NXST_FLOW reply (xid=0x4):
>>  cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204,
>> idle_age=0, hard_age=65534, priority=0 actions=NORMAL
>> 
>> # ovs-vsctl list interface vhost-user-0
>> _uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
>> admin_state         : down
>> bfd                 : {}
>> bfd_status          : {}
>> cfm_fault           : []
>> cfm_fault_status    : []
>> cfm_flap_count      : []
>> cfm_health          : []
>> cfm_mpid            : []
>> cfm_remote_mpids    : []
>> cfm_remote_opstate  : []
>> duplex              : []
>> error               : []
>> external_ids        : {}
>> ifindex             : 0
>> ingress_policing_burst: 0
>> ingress_policing_rate: 0
>> lacp_current        : []
>> link_resets         : 1
>> link_speed          : []
>> link_state          : down
>> lldp                : {}
>> mac                 : []
>> mac_in_use          : "00:00:00:00:00:00"
>> mtu                 : 1500
>> name                : "vhost-user-0"
>> ofport              : 4
>> ofport_request      : []
>> options             : {}
>> other_config        : {}
>> statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
>> status              : {}
>> type                : dpdkvhostuser
>> 
>> I  can see the vhost-user-0 port always show down and there are some
>> dropped packets which are sent from br0.
>The link state reported as "down" is ok and not an indication of an issue.
>
>> 
>> Are there some wrong with my POC?
>In addition to checking you have a compatible guest kernel version, can you check you have iptables turned off and the 'firewalld' service stopped in the guest.
>
>> 
>> BR
>> Xu Wen
>> 
>> 
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150805/662b7e30/attachment-0001.html>

From jpettit at nicira.com  Tue Aug  4 21:23:09 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Tue, 4 Aug 2015 21:23:09 -0700
Subject: [ovs-discuss] Added new field in flow.h. But the xlate_actions
	gives mask value zero.
In-Reply-To: <CAF4aoupjOoXVoBtDfkVGFyt5Mu8mYME8hxmT9KG8iZH6CK38KQ@mail.gmail.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <20150803162012.GA31662@nicira.com>
 <CAF4aouoTF9S0q5NwcakWzOvPqJGH8H68JpoiG=Wwh5Q4+WScfg@mail.gmail.com>
 <20150804041918.GB3942@nicira.com>
 <CAF4aoupjOoXVoBtDfkVGFyt5Mu8mYME8hxmT9KG8iZH6CK38KQ@mail.gmail.com>
Message-ID: <78772D49-5517-4C37-A9AD-FA3D06C6581C@nicira.com>


> On Aug 4, 2015, at 7:26 PM, jimson chacko <jimsonchacko at gmail.com> wrote:
> 
> Hi Ben,
> 
> Yes, it was really a bug in parsing the flow key from the upcall packet, precisely a misunderstanding of how the data_try_pull and data_pull work.
> 
> The log commands were helpful in displaying the source key and packet coming from the kernel.
> 
> ovs-appctl vlog/list
> 
> ovs-appctl vlog/set dpif:ANY:DBG
> 
> It would be nice to have the log related commands in the FAQ.

That's a good suggestion. Is that something you're willing contribute?

--Justin


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150804/92bc1af7/attachment.html>

From pnk003 at naver.com  Wed Aug  5 06:29:36 2015
From: pnk003 at naver.com (=?UTF-8?B?7LWc7J217ISx?=)
Date: Wed, 5 Aug 2015 22:29:36 +0900 (KST)
Subject: [ovs-discuss] =?utf-8?q?If_there_are_any_information/documents_fo?=
 =?utf-8?q?r_the_source_code_of_open_vswitch=2C_May_I_get_them=3F?=
Message-ID: <708c1f94e5b8a8c66f6f5b31672968f@cweb15.nm.nhnsystem.com>

Dear experts.
 
I am Ick-Sung Choi living in South Korea.
 
Thank you very much for your excellent contribution and excellent work for open vswitch.
 
I started to study the source code of open vswitch. I have little knowledge about open vswitch.
 
It is hard for me to study the source code because it has much function pointer calls.
(I can't use static function call analysis due to it).
 
It is very hard for me what sequences the functions are executed.
 
If there are any information/documents for the source code of open vswitch, would you sent them to me?
 
I specially interested in datapath, ovs-vswitchd, and ovs-ofctl.
 
It will be very helpful for my study, and it can save my times.
 
I will really appreciate if I can be given them.
 
 
And I have another question.
 
Usually, the master and slave processes are executed in parallel by using fork() function.
 
The open vswitch seems not to use fork function.
 
Should I run the program multiple times?
 
 
Thank you very much.
 
Sincerely Yours,
 
Ick-Sung Choi.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150805/2daac948/attachment.html>

From gowrishankar.m at linux.vnet.ibm.com  Wed Aug  5 06:47:05 2015
From: gowrishankar.m at linux.vnet.ibm.com (gowrishankar)
Date: Wed, 05 Aug 2015 19:17:05 +0530
Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
In-Reply-To: <32bb8e56.1f125.14ef829c4c4.Coremail.wenx05124561@163.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <738D45BC1F695740A983F43CFE1B7EA9437BB4A5@IRSMSX108.ger.corp.intel.com>
 <32bb8e56.1f125.14ef829c4c4.Coremail.wenx05124561@163.com>
Message-ID: <55C213D9.1080403@linux.vnet.ibm.com>

On Tuesday 04 August 2015 03:32 PM, wenxu wrote:
>
> Hi  all,
>
> I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.
> My host is centos7.0
> There is a br0 with dpdk0 and vhost-user-0
> I build dpdk with 2.0.0 and ovs with branch 2.4
> # ovs-vsctl show
> ovs-vsctl show
> c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
>      Bridge "br0"
>          Port "br0"
>              Interface "br0"
>                  type: internal
>          Port "vhost-user-0"
>              Interface "vhost-user-0"
>                  type: dpdkvhostuser
>          Port "dpdk0"
>              Interface "dpdk0"
>                  type: dpdk
>
> I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for vhost-user
>
> # qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa node,memdev=mem -mem-prealloc
>
> qemu-system-x86_64: -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up

Could you stop network manager in your OS and try again ?

Thanks,
Gowrishankar

> I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
> But they can't ping each other
>
> # ovs-ofctl dump-flows br0
> NXST_FLOW reply (xid=0x4):
>   cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204, idle_age=0, hard_age=65534, priority=0 actions=NORMAL
>
> # ovs-vsctl list interface vhost-user-0
> _uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
> admin_state         : down
> bfd                 : {}
> bfd_status          : {}
> cfm_fault           : []
> cfm_fault_status    : []
> cfm_flap_count      : []
> cfm_health          : []
> cfm_mpid            : []
> cfm_remote_mpids    : []
> cfm_remote_opstate  : []
> duplex              : []
> error               : []
> external_ids        : {}
> ifindex             : 0
> ingress_policing_burst: 0
> ingress_policing_rate: 0
> lacp_current        : []
> link_resets         : 1
> link_speed          : []
> link_state          : down
> lldp                : {}
> mac                 : []
> mac_in_use          : "00:00:00:00:00:00"
> mtu                 : 1500
> name                : "vhost-user-0"
> ofport              : 4
> ofport_request      : []
> options             : {}
> other_config        : {}
> statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
> status              : {}
> type                : dpdkvhostuser
>
> I  can see the vhost-user-0 port always show down and there are some dropped packets which are sent from br0.
>
> Are there some wrong with my POC?
>
> BR
> Xu Wen
>
>
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150805/7a471636/attachment.html>

From blp at nicira.com  Wed Aug  5 11:23:07 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 5 Aug 2015 11:23:07 -0700
Subject: [ovs-discuss] packet leaking across vswitches
In-Reply-To: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>
References: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>
Message-ID: <20150805182307.GA15287@nicira.com>

On Mon, Aug 03, 2015 at 08:45:35PM +0000, Chen Weiwen wrote:
> see weird things only with openvswitch, even the latest version, that
> potentially packet will leak from one vswitch to another, even those
> two vswitches are configured separately with different physical NICs
> on different VLAN trunks. No patch/tunnel ports involved. We see
> looping detection happens to these two uplink ports.

Sounds like the following FAQ.

### Q: I configured one IP address on VLAN 0 and another on VLAN 9, like
   this:

       ovs-vsctl add-br br0
       ovs-vsctl add-port br0 eth0
       ifconfig br0 192.168.0.5
       ovs-vsctl add-port br0 vlan9 tag=9 -- set interface vlan9 type=internal
       ifconfig vlan9 192.168.0.9

   but other hosts that are only on VLAN 0 can reach the IP address
   configured on VLAN 9.  What's going on?

A: RFC 1122 section 3.3.4.2 "Multihoming Requirements" describes two
   approaches to IP address handling in Internet hosts:

   - In the "Strong ES Model", where an ES is a host ("End
     System"), an IP address is primarily associated with a
     particular interface.  The host discards packets that arrive
     on interface A if they are destined for an IP address that is
     configured on interface B.  The host never sends packets from
     interface A using a source address configured on interface B.

   - In the "Weak ES Model", an IP address is primarily associated
     with a host.  The host accepts packets that arrive on any
     interface if they are destined for any of the host's IP
     addresses, even if the address is configured on some
     interface other than the one on which it arrived.  The host
     does not restrict itself to sending packets from an IP
     address associated with the originating interface.

   Linux uses the weak ES model.  That means that when packets
   destined to the VLAN 9 IP address arrive on eth0 and are bridged to
   br0, the kernel IP stack accepts them there for the VLAN 9 IP
   address, even though they were not received on vlan9, the network
   device for vlan9.

   To simulate the strong ES model on Linux, one may add iptables rule
   to filter packets based on source and destination address and
   adjust ARP configuration with sysctls.

   BSD uses the strong ES model.

From wenx05124561 at 163.com  Wed Aug  5 17:07:53 2015
From: wenx05124561 at 163.com (wenxu)
Date: Thu, 6 Aug 2015 08:07:53 +0800 (CST)
Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
In-Reply-To: <55C213D9.1080403@linux.vnet.ibm.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <738D45BC1F695740A983F43CFE1B7EA9437BB4A5@IRSMSX108.ger.corp.intel.com>
 <32bb8e56.1f125.14ef829c4c4.Coremail.wenx05124561@163.com>
 <55C213D9.1080403@linux.vnet.ibm.com>
Message-ID: <6ffed96e.f068.14f0055e6c8.Coremail.wenx05124561@163.com>








At 2015-08-05 21:47:05, "gowrishankar" <gowrishankar.m at linux.vnet.ibm.com> wrote:

On Tuesday 04 August 2015 03:32 PM, wenxu wrote:



Hi  all,

I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.
My host is centos7.0
There is a br0 with dpdk0 and vhost-user-0
I build dpdk with 2.0.0 and ovs with branch 2.4
# ovs-vsctl show
ovs-vsctl show
c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
    Bridge "br0"
        Port "br0"
            Interface "br0"
                type: internal
        Port "vhost-user-0"
            Interface "vhost-user-0"
                type: dpdkvhostuser
        Port "dpdk0"
            Interface "dpdk0"
                type: dpdk

I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for vhost-user

# qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa node,memdev=mem -mem-prealloc

qemu-system-x86_64: -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up


Could you stop network manager in your OS and try again ?

Thanks,
Gowrishankar

It's also not working.
I  think it's not matter with os network manager. It seems the virtio_net is not working.
the virtio.input/output interrupt counter always 0. /proc/interrupt

I think vhost-user and virtio_net don't setup sucessfully.


I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
But they can't ping each other

# ovs-ofctl dump-flows br0
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204, idle_age=0, hard_age=65534, priority=0 actions=NORMAL

# ovs-vsctl list interface vhost-user-0
_uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
admin_state         : down
bfd                 : {}
bfd_status          : {}
cfm_fault           : []
cfm_fault_status    : []
cfm_flap_count      : []
cfm_health          : []
cfm_mpid            : []
cfm_remote_mpids    : []
cfm_remote_opstate  : []
duplex              : []
error               : []
external_ids        : {}
ifindex             : 0
ingress_policing_burst: 0
ingress_policing_rate: 0
lacp_current        : []
link_resets         : 1
link_speed          : []
link_state          : down
lldp                : {}
mac                 : []
mac_in_use          : "00:00:00:00:00:00"
mtu                 : 1500
name                : "vhost-user-0"
ofport              : 4
ofport_request      : []
options             : {}
other_config        : {}
statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
status              : {}
type                : dpdkvhostuser

I  can see the vhost-user-0 port always show down and there are some dropped packets which are sent from br0.

Are there some wrong with my POC?

BR
Xu Wen





_______________________________________________
discuss mailing list
discuss at openvswitch.orghttp://openvswitch.org/mailman/listinfo/discuss

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150806/aad04d6b/attachment.html>

From jpettit at nicira.com  Wed Aug  5 17:43:54 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Wed, 5 Aug 2015 17:43:54 -0700
Subject: [ovs-discuss] Open vSwitch Fall 2015 Conference: Call for
	Participation
Message-ID: <4EB64C7D-20BA-4030-9545-D87F7CAC542A@nicira.com>

The Open vSwitch team will host our second annual conference focused on Open vSwitch and OVN on Nov. 16 and 17, 2015, to be held at the San Jose Doubletree.

Topics that may be considered include:

      * Integrating Open vSwitch into larger systems.

      * Deploying and using OVN.

      * NIC acceleration of Open vSwitch.

      * Using Open vSwitch to realize NFV and service chaining.

      * Porting Open vSwitch to new operating systems, hypervisors,
        or container systems.

      * Troubleshooting and debugging Open vSwitch installations.

      * Open vSwitch development and testing practices.

      * Performance measurements or approaches to improving
        performance.

       * NAT, DPI, and stateful processing with Open vSwitch. 

      * End-user or service provider experiences with Open vSwitch.

      * Hardware ports of Open vSwitch (existing, in progress, or
        speculative).

      * The relationship between OpenFlow and Open vSwitch.

      * Using, developing, or administering OpenFlow controllers in
        conjunction with Open vSwitch.

      * Comparisons to other implementations of features found in
        Open vSwitch (e.g. other OpenFlow implementations, other
        software switches, etc.).

      * The future of Open vSwitch.

      * Increasing the size and diversity of the Open vSwitch user
        and developer base.

      * Tutorials and walkthroughs of use cases.

      * Demos.

      * Other topics likely to be of interest to attendees.

We expect most talks to last 20 minutes, with added time for questions.

Talks will be recorded and made available online.


How to propose a talk
---------------------

We are soliciting proposals for talks and panels on topics related to Open vSwitch.

Please email proposals for talks to ovscon at openvswitch.org by Sep. 14. Proposals should include a title and abstract, plus any other relevant information.  Please put "TALK:" at the beginning of the subject line.

Speakers will be notified of acceptance by Sept. 28.

Speakers should plan to attend the event in person.  Travel to and accommodations in San Jose are the responsibility of attendees.


How to attend
-------------

Attending the conference is free, but we ask that you register to ensure that we can properly prepare for the number of attendees.

Please register at:

 https://www.eventbrite.com/e/open-vswitch-fall-2015-conference-tickets-18029784571

If you register and later find you cannot attend, please cancel your ticket so that we know about the change.


More information
----------------

For more information, please visit the Eventbrite page at:

 https://www.eventbrite.com/e/open-vswitch-fall-2015-conference-tickets-18029784571

To reach the organizers, email ovscon at openvswitch.org.  For general discussion of the conference, please use the ovs-discuss mailing list at discuss at openvswitch.org.

From contact at progbau.de  Thu Aug  6 03:20:43 2015
From: contact at progbau.de (Chris)
Date: Thu, 6 Aug 2015 17:20:43 +0700
Subject: [ovs-discuss] Monitor flapping interface
Message-ID: <03a901d0d031$8ea494f0$abedbed0$@progbau.de>

Hello,

 

We are looking for a way to log an interface flapping between to physical
interfaces bonded in active-passive by openvswitch.

Is it written in /var/log/messages ?

 

Cheers,

Chris

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150806/7319b43e/attachment.html>

From p.horacek94 at gmail.com  Thu Aug  6 05:16:42 2015
From: p.horacek94 at gmail.com (=?UTF-8?B?UGV0ciBIb3LDocSNZWs=?=)
Date: Thu, 6 Aug 2015 14:16:42 +0200
Subject: [ovs-discuss] Run dhclient on vlan attached to untagged nic
Message-ID: <CAGtL9t8hrBfBmA-7hkLZiWDDyjues9ooWU+t+QAjBnKv6rAZ8w@mail.gmail.com>

Hello,

Is it somehow possible to obtain an IP for a tagged fake bridge attached to
an untagged nic? This fails for me:

ifconfig eth0 0
ovs-vsctl add-br br0 -- add-br br0.1 br0 1 -- add-port br0 eth0
ip link set eth0 up
dhclient br0.1

Any solution (except tagging eth0)?

Thanks a lot,
Petr
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150806/f6c3a4dd/attachment-0001.html>

From standulwadka at avaya.com  Thu Aug  6 05:52:55 2015
From: standulwadka at avaya.com (Tandulwadkar, Sanket Ravindra (Sanket Ravindra))
Date: Thu, 6 Aug 2015 12:52:55 +0000
Subject: [ovs-discuss] is_connected parameter absent:
 2015-07-27T16:59:41Z|00016|poll_loop|DBG|wakeup due to 0-ms timeout at
 lib/ovsdb-idl.c:1354
In-Reply-To: <B7B64702-7273-4B20-9D5C-5ABEC2CC205F@nicira.com>
References: <9CE18184B620BC45BF38C3D5361BCDA802BD68@AZ-US1EXMB01.global.avaya.com>
 <6A0F35D6-058E-41B9-8A95-911FD508CCAC@nicira.com>
 <9CE18184B620BC45BF38C3D5361BCDA802BE82@AZ-US1EXMB01.global.avaya.com>
 <7EB44382-4EB8-41FB-944F-29B7B8BC19F9@nicira.com>
 <9CE18184B620BC45BF38C3D5361BCDA802BEB1@AZ-US1EXMB01.global.avaya.com>
 <B7B64702-7273-4B20-9D5C-5ABEC2CC205F@nicira.com>
Message-ID: <9CE18184B620BC45BF38C3D5361BCDA802C51E@AZ-US1EXMB01.global.avaya.com>

Hello Justin,

I just spent a good amount of time figuring out what the issue is here. Yes, you are correct. ODL refuses connection on port 6633 when OvS(OF) sends packets to it. That is because in the packet the OF version seems to be 22, which is very odd since there is no version 22 for the same.

This is the output at ODL:
2015-08-05 13:36:58,642 | WARN  | ntLoopGroup-11-2 | OFVersionDetector                | 243 - org.opendaylight.openflowja   va.openflow-protocol-impl - 0.6.0.SNAPSHOT | detected version: 22 - currently not supported
2015-08-05 13:36:58,642 | WARN  | ntLoopGroup-11-2 | SessionManagerOFImpl             | 246 - org.opendaylight.openflowpl   ugin - 0.1.0.SNAPSHOT | context for invalidation not found

How do I check the version of OF that is sent in a OvS packet from my OvS VM to ODL VM. Is there anything like tcpdump? I did a tcpdump as well, I got this:

sanket at sanket-ubuntu-ovs:~$ sudo tcpdump -n -i eth1 -v
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
08:39:46.032145 IP (tos 0xc0, ttl 64, id 32128, offset 0, flags [DF], proto TCP (6), length 60)
    172.31.1.1.39899 > 172.31.1.2.6633: Flags [S], cksum 0xfe2a (correct), seq 1145388004, win 29200, options [mss 1460,sackOK,TS val 20006500 ecr 0,nop,wscale 7], length 0
08:39:46.032558 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60)
    172.31.1.2.6633 > 172.31.1.1.39899: Flags [S.], cksum 0x29fd (correct), seq 1674324326, ack 1145388005, win 28960, options [mss 1460,sackOK,TS val 20006569 ecr 20006500,nop,wscale 7], length 0
08:39:46.032655 IP (tos 0xc0, ttl 64, id 32129, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39899 > 172.31.1.2.6633: Flags [.], cksum 0x5a68 (incorrect -> 0xc904), ack 1, win 229, options [nop,nop,TS val 20006500 ecr 20006569], length 0
08:39:46.032821 IP (tos 0xc0, ttl 64, id 32130, offset 0, flags [DF], proto TCP (6), length 347)
    172.31.1.1.39899 > 172.31.1.2.6633: Flags [P.], cksum 0x5b8f (incorrect -> 0x6269), seq 1:296, ack 1, win 229, options [nop,nop,TS val 20006500 ecr 20006569], length 295: OpenFlow
        version unknown (0x16), type 0x03, length 257, xid 0x22010001
        version unknown (0x20), type 0x00, length 7686, xid 0x01060206 [|openflow]
08:39:46.033039 IP (tos 0x0, ttl 64, id 28622, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.2.6633 > 172.31.1.1.39899: Flags [.], cksum 0xc7d7 (correct), ack 296, win 235, options [nop,nop,TS val 20006569 ecr 20006500], length 0
08:39:46.039616 IP (tos 0x0, ttl 64, id 28623, offset 0, flags [DF], proto TCP (6), length 68)
    172.31.1.2.6633 > 172.31.1.1.39899: Flags [P.], cksum 0xc37d (correct), seq 1:17, ack 296, win 235, options [nop,nop,TS val 20006571 ecr 20006500], length 16: OpenFlow
        version unknown (0x04), type 0x00, length 16, xid 0x00000015
08:39:46.039630 IP (tos 0xc0, ttl 64, id 32131, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39899 > 172.31.1.2.6633: Flags [.], cksum 0x5a68 (incorrect -> 0xc7c9), ack 17, win 229, options [nop,nop,TS val 20006502 ecr 20006571], length 0
08:39:46.039754 IP (tos 0xc0, ttl 64, id 32132, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39899 > 172.31.1.2.6633: Flags [F.], cksum 0x5a68 (incorrect -> 0xc7c8), seq 296, ack 17, win 229, options [nop,nop,TS val 20006502 ecr 20006571], length 0
08:39:46.039783 IP (tos 0xc0, ttl 64, id 32133, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39899 > 172.31.1.2.6633: Flags [R.], cksum 0x5a68 (incorrect -> 0xc7c4), seq 297, ack 17, win 229, options [nop,nop,TS val 20006502 ecr 20006571], length 0
08:39:54.032267 IP (tos 0xc0, ttl 64, id 20097, offset 0, flags [DF], proto TCP (6), length 60)
    172.31.1.1.39900 > 172.31.1.2.6633: Flags [S], cksum 0x7af1 (correct), seq 4208722101, win 29200, options [mss 1460,sackOK,TS val 20008500 ecr 0,nop,wscale 7], length 0
08:39:54.032661 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60)
    172.31.1.2.6633 > 172.31.1.1.39900: Flags [S.], cksum 0x5b13 (correct), seq 2936873477, ack 4208722102, win 28960, options [mss 1460,sackOK,TS val 20008569 ecr 20008500,nop,wscale 7], length 0
08:39:54.032741 IP (tos 0xc0, ttl 64, id 20098, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39900 > 172.31.1.2.6633: Flags [.], cksum 0x5a68 (incorrect -> 0xfa1a), ack 1, win 229, options [nop,nop,TS val 20008500 ecr 20008569], length 0
08:39:54.032832 IP (tos 0xc0, ttl 64, id 20099, offset 0, flags [DF], proto TCP (6), length 347)
    172.31.1.1.39900 > 172.31.1.2.6633: Flags [P.], cksum 0x5b8f (incorrect -> 0xcc0c), seq 1:296, ack 1, win 229, options [nop,nop,TS val 20008500 ecr 20008569], length 295: OpenFlow
        version unknown (0x16), type 0x03, length 257, xid 0x22010001
        version unknown (0x20), type 0x00, length 7686, xid 0x01060206 [|openflow]
08:39:54.033210 IP (tos 0x0, ttl 64, id 27775, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.2.6633 > 172.31.1.1.39900: Flags [.], cksum 0xf8ed (correct), ack 296, win 235, options [nop,nop,TS val 20008569 ecr 20008500], length 0
08:39:54.035768 IP (tos 0x0, ttl 64, id 27776, offset 0, flags [DF], proto TCP (6), length 68)
    172.31.1.2.6633 > 172.31.1.1.39900: Flags [P.], cksum 0xf494 (correct), seq 1:17, ack 296, win 235, options [nop,nop,TS val 20008570 ecr 20008500], length 16: OpenFlow
        version unknown (0x04), type 0x00, length 16, xid 0x00000015
08:39:54.035801 IP (tos 0xc0, ttl 64, id 20100, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39900 > 172.31.1.2.6633: Flags [.], cksum 0x5a68 (incorrect -> 0xf8e1), ack 17, win 229, options [nop,nop,TS val 20008501 ecr 20008570], length 0
08:39:54.035940 IP (tos 0xc0, ttl 64, id 20101, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39900 > 172.31.1.2.6633: Flags [F.], cksum 0x5a68 (incorrect -> 0xf8e0), seq 296, ack 17, win 229, options [nop,nop,TS val 20008501 ecr 20008570], length 0
08:39:54.035973 IP (tos 0xc0, ttl 64, id 20102, offset 0, flags [DF], proto TCP (6), length 52)
    172.31.1.1.39900 > 172.31.1.2.6633: Flags [R.], cksum 0x5a68 (incorrect -> 0xf8dc), seq 297, ack 17, win 229, options [nop,nop,TS val 20008501 ecr 20008570], length 0

When I do dump-features I get BAD_STAT what is that about?

sudo ovs-ofctl dump-table-features br0 -O OpenFlow13
OFPT_ERROR (OF1.3) (xid=0x2): OFPBRC_BAD_STAT
OFPST_TABLE_FEATURES request (OF1.3) (xid=0x2):

--Sanket




-----Original Message-----
From: Justin Pettit [mailto:jpettit at nicira.com] 
Sent: Tuesday, July 28, 2015 12:34 PM
To: Tandulwadkar, Sanket Ravindra (Sanket Ravindra)
Cc: bugs at openvswitch.org
Subject: Re: [ovs-discuss] is_connected parameter absent: 2015-07-27T16:59:41Z|00016|poll_loop|DBG|wakeup due to 0-ms timeout at lib/ovsdb-idl.c:1354


> On Jul 28, 2015, at 9:26 AM, Tandulwadkar, Sanket Ravindra (Sanket Ravindra) <standulwadka at avaya.com> wrote:
> 
> sanket at sanket-ubuntu-ovs:~$ openssl s_client -connect 172.31.1.2:6633
> CONNECTED(00000003)
> 140381499594384:error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol:s23_clnt.c:795:

It looks like it's reporting unknown protocol.  My guess is that SSL isn't properly configured on the controller.

--Justin



From lxuemei3000 at gmail.com  Thu Aug  6 14:46:03 2015
From: lxuemei3000 at gmail.com (Xuemei Liu)
Date: Thu, 6 Aug 2015 14:46:03 -0700
Subject: [ovs-discuss] How to send all packets to userspace?
In-Reply-To: <CA+oJsLMJD5xsZN=DzbVK-t-zUoG4ug3=fkqRnMvn7hc5d6i77Q@mail.gmail.com>
References: <20150723171359.GG3888@nicira.com>
 <CA+oJsLOh_3d2c60vhVuqq0ds99348D+G5dpOV_AjCvnG0_EhHA@mail.gmail.com>
 <CA+oJsLMw2S30bdvr0Od9fEG++DWBvk-02-RPoFux4XUc1SATWA@mail.gmail.com>
 <20150723231835.GB10520@nicira.com>
 <CA+oJsLOhR6QxcCAb0jcyNjH3cP9b4fR7MREinR8jO-x8mF=Mbg@mail.gmail.com>
 <20150723234657.GD10520@nicira.com>
 <CA+oJsLMsn6qrA-7bHt6jGy7B6QLqCrMbduWiC-OKiWtNECFkWQ@mail.gmail.com>
 <20150724162546.GG20805@nicira.com>
 <CA+oJsLMPCy5Gdro8bsiFH6nufEo7pc2fUBm+RFP0MEpF6GqK3A@mail.gmail.com>
 <CA+oJsLMsZh5mN8-unFGMnqX5uiRhje=H9h7jmV+_WyYZyE9LNA@mail.gmail.com>
 <20150724202409.GE14358@nicira.com>
 <CA+oJsLMJD5xsZN=DzbVK-t-zUoG4ug3=fkqRnMvn7hc5d6i77Q@mail.gmail.com>
Message-ID: <CA+oJsLNJ00ZdEevPyEDftyzGdO6U34ugSxcL7e+zaOi2taHVsw@mail.gmail.com>

Hi, all,

I have one followup question about performance of ovs. I am running my
experiment (12 switches and 12 hosts in Mininet) with a 32 core machine. I
track the CPU/MEM usage of all threads of ovs-vswitchd
(handler/revalidator), all of them are below 60%. However, I find that
there are packets lost in the ovs switches. I am wondering whether that's
because the buffer size of ports is not big enough (How can I configure the
buffer size)?  Or the queue size between kernel and userspace, as I
configure to send all packets from kernel space to userspace (according to
Ben's advice).

Thanks,
Xuemei

On Sat, Jul 25, 2015 at 6:15 PM, Xuemei Liu <lxuemei3000 at gmail.com> wrote:

> I found that problem in the VM of my pc. When I run the experiments on one
> physical server, the CPU usage is not that low.
>
> On Fri, Jul 24, 2015 at 1:24 PM, Ben Pfaff <blp at nicira.com> wrote:
>
>> It doesn't sound like you have a bottleneck, if CPU is less than 10%, so
>> I don't understand the question.
>>
>> On Fri, Jul 24, 2015 at 09:42:05AM -0700, Xuemei Liu wrote:
>> > Hi, Ben,
>> >
>> > I have one follow-up question. I setup a topology with 12 hosts and 12
>> > switches in Mininet. The hosts (acting as the packets generator to the
>> > network) should send packets around 30 pps in order to make the switches
>> > not drop packets. However, I find that the CPU/MEM usage of
>> ovs-vswitchd is
>> > not high (both < 10%). According to your experience, where do you think
>> is
>> > the bottleneck? How can I improve the performance of packet processing
>> > speed in userspace in Mininet?
>> >
>> > Thanks,
>> > Xuemei
>> >
>> > On Fri, Jul 24, 2015 at 9:30 AM, Xuemei Liu <lxuemei3000 at gmail.com>
>> wrote:
>> >
>> > > Thanks very much Ben.
>> > >
>> > > On Fri, Jul 24, 2015 at 9:25 AM, Ben Pfaff <blp at nicira.com> wrote:
>> > >
>> > >> Any SLOW_* constant indicates why a packet can't be processed in the
>> > >> fast path (e.g. in the kernel).  Such packets always have to be
>> handled
>> > >> in userspace.  Thus, tagging all flow translations with any SLOW_*
>> > >> constant causes them all to be sent to userspace.
>> > >>
>> > >> On Thu, Jul 23, 2015 at 05:07:58PM -0700, Xuemei Liu wrote:
>> > >> > Hi, Ben,
>> > >> >
>> > >> > After I decreased the sending rate at h1, I find s1 userspace/h2
>> can
>> > >> > receive all packets. What does SLOW_ACTION mean? Why this will
>> make the
>> > >> > packets forwarded from kernel space to user space?
>> > >> >
>> > >> > Thanks,
>> > >> > Xuemei
>> > >> >
>> > >> > On Thu, Jul 23, 2015 at 4:46 PM, Ben Pfaff <blp at nicira.com> wrote:
>> > >> >
>> > >> > > Well, yes, there are performance problems, as I predicted.
>> > >> > >
>> > >> > > On Thu, Jul 23, 2015 at 04:42:17PM -0700, Xuemei Liu wrote:
>> > >> > > > Let me try to describe it. Suppose the topology is h1-s1-h2,
>> where
>> > >> h1, h2
>> > >> > > > are hosts, and s1 is the ovs switch. I add policy in s1 to
>> forward
>> > >> > > packets
>> > >> > > > with dstip of h2 to h2. Then I test in two scenarios.
>> > >> > > > 1. h1 sends 9 packets (3 packet for each of 3 different flows)
>> to
>> > >> h2.
>> > >> > > With
>> > >> > > > your methods, userspace in s1 can accept all the packets, and
>> h2 can
>> > >> > > > receive all the 9 packets. Work perfect.
>> > >> > > > 2. h1 sends 10000 packets to h2. In this case, h2 receives the
>> same
>> > >> > > packets
>> > >> > > > as userspace in s1 does. However, the number of packets
>> received is
>> > >> much
>> > >> > > > less than 10000. Which means many packets are lost in s1.
>> > >> > > > Is this clear now?
>> > >> > > >
>> > >> > > > Thanks,
>> > >> > > > Xuemei
>> > >> > > >
>> > >> > > > On Thu, Jul 23, 2015 at 4:18 PM, Ben Pfaff <blp at nicira.com>
>> wrote:
>> > >> > > >
>> > >> > > > > That's too vague for me to guess.  What packets are getting
>> lost?
>> > >> > > > >
>> > >> > > > > On Thu, Jul 23, 2015 at 04:10:14PM -0700, Xuemei Liu wrote:
>> > >> > > > > > Hi, Ben,
>> > >> > > > > >
>> > >> > > > > > I tried your method, but the switch seems to drop some
>> packets,
>> > >> as it
>> > >> > > > > does
>> > >> > > > > > not output the expected packets that I forward to send to
>> it.
>> > >> Any
>> > >> > > advice?
>> > >> > > > > >
>> > >> > > > > > Thanks,
>> > >> > > > > > Xuemei
>> > >> > > > > >
>> > >> > > > > > On Thu, Jul 23, 2015 at 10:19 AM, Xuemei Liu <
>> > >> lxuemei3000 at gmail.com>
>> > >> > > > > wrote:
>> > >> > > > > >
>> > >> > > > > > > Hi, Ben,
>> > >> > > > > > >
>> > >> > > > > > > Thanks for your response.
>> > >> > > > > > > "You realize that this will be terrible for performance,
>> > >> right?"
>> > >> > > > > > > In fact, I have not got all packets sent to user space.
>> That
>> > >> is the
>> > >> > > > > > > problem I am facing now. I think performance might be
>> another
>> > >> > > problem
>> > >> > > > > after
>> > >> > > > > > > I can receive all packet in user space.
>> > >> > > > > > >
>> > >> > > > > > > Thanks,
>> > >> > > > > > > Xuemei
>> > >> > > > > > >
>> > >> > > > > > > On Thu, Jul 23, 2015 at 10:13 AM, Ben Pfaff <
>> blp at nicira.com>
>> > >>
>> > >> > > wrote:
>> > >> > > > > > >
>> > >> > > > > > >> On Thu, Jul 23, 2015 at 10:04:23AM -0700, Xuemei Liu
>> wrote:
>> > >> > > > > > >> > I am new to ovs, and I am trying to send all packets
>> from
>> > >> kernel
>> > >> > > > > space
>> > >> > > > > > >> to
>> > >> > > > > > >> > user space. I comment the "unlikely(!flow)" in
>> > >> > > datapath/datapath.c.
>> > >> > > > > > >> > However, it seems I just receive the first packet of
>> each
>> > >> flow
>> > >> > > (the
>> > >> > > > > > >> first
>> > >> > > > > > >> > packet that match one forwarding rule in the bridge)
>> in
>> > >> user
>> > >> > > space.
>> > >> > > > > > >> Could
>> > >> > > > > > >> > anyone tell me why? and is there other way to achieve
>> my
>> > >> goal?
>> > >> > > > > > >>
>> > >> > > > > > >> You realize that this will be terrible for performance,
>> > >> right?
>> > >> > > > > > >>
>> > >> > > > > > >> It's kind of a waste to modify the kernel module for
>> this.
>> > >> I'd
>> > >> > > just
>> > >> > > > > > >> modify userspace to send all packets to userspace,
>> something
>> > >> like
>> > >> > > > > this:
>> > >> > > > > > >>
>> > >> > > > > > >> diff --git a/ofproto/ofproto-dpif-xlate.c
>> > >> > > > > b/ofproto/ofproto-dpif-xlate.c
>> > >> > > > > > >> index 52395a7..a98406a 100644
>> > >> > > > > > >> --- a/ofproto/ofproto-dpif-xlate.c
>> > >> > > > > > >> +++ b/ofproto/ofproto-dpif-xlate.c
>> > >> > > > > > >> @@ -4777,7 +4777,7 @@ xlate_actions(struct xlate_in
>> *xin,
>> > >> struct
>> > >> > > > > > >> xlate_out *xout)
>> > >> > > > > > >>
>> > >> > > > > > >>      ctx.xin = xin;
>> > >> > > > > > >>      ctx.xout = xout;
>> > >> > > > > > >> -    ctx.xout->slow = 0;
>> > >> > > > > > >> +    ctx.xout->slow = SLOW_ACTION;
>> > >> > > > > > >>      ctx.xout->has_learn = false;
>> > >> > > > > > >>      ctx.xout->has_normal = false;
>> > >> > > > > > >>      ctx.xout->has_fin_timeout = false;
>> > >> > > > > > >>
>> > >> > > > > > >
>> > >> > > > > > >
>> > >> > > > >
>> > >> > >
>> > >>
>> > >
>> > >
>>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150806/a03f9de4/attachment.html>

From zhouhan at gmail.com  Thu Aug  6 15:08:16 2015
From: zhouhan at gmail.com (Han Zhou)
Date: Thu, 6 Aug 2015 15:08:16 -0700
Subject: [ovs-discuss] Deleting internal ports takes too long
Message-ID: <CADtzDCnQQh+dNf6yybSaS7NatXbYfnVw=JPMsCDvQStcLNJ+UA@mail.gmail.com>

Hello Folks,

I am facing a problem of internal port deletion.
In neutron dhcp node, it use ovs internal ports for dhcp interfaces
for virtual networks.
During cleanup, it takes around 500ms to delete a port. It is
producation environment, so I cannot do much testing.
But in my testing environment it is 10 times faster.
Is there a quick answer why deleting an internal port would take so
long in that production env?

The command I used was:
ovs-vsctl del-port br-int <port name>

Note:

- the ports are in namespaces.
- there are hundreds of such ports (but in my testing env I created
same number of ports and it was still 10 times faster than the
production env)

Best regards,
Han

From andre_schutze at web.de  Thu Aug  6 13:33:12 2015
From: andre_schutze at web.de (=?UTF-8?Q?Andre_Sch=c3=bctze?=)
Date: Thu, 6 Aug 2015 22:33:12 +0200
Subject: [ovs-discuss] how does the barrier request work exactly
Message-ID: <55C3C488.8020508@web.de>

Hallo openvswitchlers,

I try to implement an OpenFlow controller with a special Update 
algorithm, which is called WayUp and is discribed in this paper: 
https://www.net.t-labs.tu-berlin.de/~stefan/hotnets14update.pdf .
My test environment consists of a mininet VM with ovs as switch and ryu 
as controller.
The update consists of several rounds. Openflow messages of round n have 
to be send to the switches and processed by the switch befor messages of 
round n+1 can be send. That means a switch have to install a rule of 
round n and forward packet according to this rule before the controller 
can send messages of round n+1. The controller have to wait till the 
switches install all rules. Can I use barrier requests to implement this 
behavior? When is a barrier reply send exactly?

Best,
André

From standulwadka at avaya.com  Fri Aug  7 07:55:48 2015
From: standulwadka at avaya.com (Tandulwadkar, Sanket Ravindra (Sanket Ravindra))
Date: Fri, 7 Aug 2015 14:55:48 +0000
Subject: [ovs-discuss] How to install OvS with a specific version number(say
	2.1.3)
Message-ID: <9CE18184B620BC45BF38C3D5361BCDA802C631@AZ-US1EXMB01.global.avaya.com>

Hi,

I want to install a slightly older version of OvS on my Ubuntu VM. When I use

apt-get install openvswitch-controller openvswitch-brcompat \
openvswitch-switch openvswitch-datapath-source

it installs 2.3.1

How can I force it with a version number?


Sincerely,
Sanket Tandulwadkar
standulwadka at avaya.com<mailto:standulwadka at avaya.com>
+19786713205

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150807/6aebff27/attachment.html>

From joestringer at nicira.com  Fri Aug  7 09:44:43 2015
From: joestringer at nicira.com (Joe Stringer)
Date: Fri, 7 Aug 2015 09:44:43 -0700
Subject: [ovs-discuss] How to install OvS with a specific version
 number(say 2.1.3)
In-Reply-To: <9CE18184B620BC45BF38C3D5361BCDA802C631@AZ-US1EXMB01.global.avaya.com>
References: <9CE18184B620BC45BF38C3D5361BCDA802C631@AZ-US1EXMB01.global.avaya.com>
Message-ID: <CANr6G5zXqnpVnz1PozU+EWHMm0nyVi206LEFCL46=n0Ck-BkXQ@mail.gmail.com>

On 7 August 2015 at 07:55, Tandulwadkar, Sanket Ravindra (Sanket
Ravindra) <standulwadka at avaya.com> wrote:
> Hi,
>
>
>
> I want to install a slightly older version of OvS on my Ubuntu VM. When I
> use
>
>
>
> apt-get install openvswitch-controller openvswitch-brcompat \
>
> openvswitch-switch openvswitch-datapath-source
>
>
>
> it installs 2.3.1
>
>
>
> How can I force it with a version number?

Linux distros typically provide a single version of a package. If you
want a different version, you'll need to either obtain the packages
from another location or build your own.

From joestringer at nicira.com  Fri Aug  7 09:57:35 2015
From: joestringer at nicira.com (Joe Stringer)
Date: Fri, 7 Aug 2015 09:57:35 -0700
Subject: [ovs-discuss] recirculation on custom action.
In-Reply-To: <D1E68EA6.2EA69%davidjoshuaevans@gmail.com>
References: <D1E68EA6.2EA69%davidjoshuaevans@gmail.com>
Message-ID: <CANr6G5zyCfeJeM+R35ghpTaXO07zp_KneZwAhpvmzcNOpuUwjw@mail.gmail.com>

On 4 August 2015 at 13:45, David Evans <davidjoshuaevans at gmail.com> wrote:
> Hi OVS
>
> I¹d like to trigger a recirculation based on a packet modifying action.
> What¹s the best way to do this?
>
>
> 1. add another custom action?
> 2. Add a compose_recirculate_action() in do_xlate_actions() for my custom
> action?
> 3. Another way I haven¹t heard of.

In general I believe that we've tried to hide recirculation away from
the OpenFlow interface as it can have complicated repercussions on the
pipeline, so that lends itself to #2. But it depends on what you're
trying to achieve through recirculation.

From joestringer at nicira.com  Fri Aug  7 10:36:46 2015
From: joestringer at nicira.com (Joe Stringer)
Date: Fri, 7 Aug 2015 10:36:46 -0700
Subject: [ovs-discuss] How to install OvS with a specific version
 number(say 2.1.3)
In-Reply-To: <9CE18184B620BC45BF38C3D5361BCDA802C660@AZ-US1EXMB01.global.avaya.com>
References: <9CE18184B620BC45BF38C3D5361BCDA802C631@AZ-US1EXMB01.global.avaya.com>
 <CANr6G5zXqnpVnz1PozU+EWHMm0nyVi206LEFCL46=n0Ck-BkXQ@mail.gmail.com>
 <9CE18184B620BC45BF38C3D5361BCDA802C660@AZ-US1EXMB01.global.avaya.com>
Message-ID: <CANr6G5y20LFLNmASTpaDKwPp+xCzo-VedQN2v=+nPhjABViwvg@mail.gmail.com>

DKMS builds the openvswitch module against each of the kernels that
you have on your system. You have linux-3.16 installed, but
openvswitch-datapath-dkms 2.1 doesn't support it. The alternative is
to use the openvswitch module that is distributed with the kernel (ie,
do not install the dkms package at all).

On 7 August 2015 at 10:32, Tandulwadkar, Sanket Ravindra (Sanket
Ravindra) <standulwadka at avaya.com> wrote:
> Hello Joe,
>
> Thank you!
>
> I am trying to install 2.1.3. When I try to install the Debain for kernel module, I get this error
>
>
> sanket at sanket-ubuntu-ovs:~$ sudo dpkg -i openvswitch-datapath-dkms_2.1.3-1_all.deb
> (Reading database ... 235774 files and directories currently installed.)
> Preparing to unpack openvswitch-datapath-dkms_2.1.3-1_all.deb ...
>
> ------------------------------
> Deleting module version: 2.1.3
> completely from the DKMS tree.
> ------------------------------
> Done.
> Unpacking openvswitch-datapath-dkms (2.1.3-1) over (2.1.3-1) ...
> Setting up openvswitch-datapath-dkms (2.1.3-1) ...
>
> Creating symlink /var/lib/dkms/openvswitch/2.1.3/source ->
>                  /usr/src/openvswitch-2.1.3
>
> DKMS: add completed.
>
> Kernel preparation unnecessary for this kernel.  Skipping...
>
> Building module:
> cleaning build area....(bad exit status: 2)
> ./configure --with-linux='/lib/modules/3.16.0-28-generic/build' && make -C datapath/linux.....(bad exit status: 1)
> Error! Bad return status for module build on kernel: 3.16.0-28-generic (x86_64)
> Consult /var/lib/dkms/openvswitch/2.1.3/build/make.log for more information.
>
> I know that the error is because the ./configure needs linux 3.11.x or earlier. But it automatically looks for 3.16. How do I change this line so it can take 3.11.x instead? I couldn’t locate it.
>
> Thank you.
>
> -----Original Message-----
> From: Joe Stringer [mailto:joestringer at nicira.com]
> Sent: Friday, August 07, 2015 12:45 PM
> To: Tandulwadkar, Sanket Ravindra (Sanket Ravindra)
> Cc: bugs at openvswitch.org
> Subject: Re: [ovs-discuss] How to install OvS with a specific version number(say 2.1.3)
>
> On 7 August 2015 at 07:55, Tandulwadkar, Sanket Ravindra (Sanket
> Ravindra) <standulwadka at avaya.com> wrote:
>> Hi,
>>
>>
>>
>> I want to install a slightly older version of OvS on my Ubuntu VM.
>> When I use
>>
>>
>>
>> apt-get install openvswitch-controller openvswitch-brcompat \
>>
>> openvswitch-switch openvswitch-datapath-source
>>
>>
>>
>> it installs 2.3.1
>>
>>
>>
>> How can I force it with a version number?
>
> Linux distros typically provide a single version of a package. If you want a different version, you'll need to either obtain the packages from another location or build your own.

From davidjoshuaevans at gmail.com  Fri Aug  7 11:35:13 2015
From: davidjoshuaevans at gmail.com (David Evans)
Date: Fri, 07 Aug 2015 13:35:13 -0500
Subject: [ovs-discuss] recirculation on custom action.
In-Reply-To: <CANr6G5zyCfeJeM+R35ghpTaXO07zp_KneZwAhpvmzcNOpuUwjw@mail.gmail.com>
References: <D1E68EA6.2EA69%davidjoshuaevans@gmail.com>
 <CANr6G5zyCfeJeM+R35ghpTaXO07zp_KneZwAhpvmzcNOpuUwjw@mail.gmail.com>
Message-ID: <D1EA6449.2F18D%davidjoshuaevans@gmail.com>

Thank you Joe.

I have muddled around and found that doing it the same way as MPLS does
with a more generalized version of ‘was-mpls’ type flagging seems to do
what I want.

Regards,
Dave.

On 8/7/15, 11:57 AM, "Joe Stringer" <joestringer at nicira.com> wrote:

>On 4 August 2015 at 13:45, David Evans <davidjoshuaevans at gmail.com> wrote:
>> Hi OVS
>>
>> I¹d like to trigger a recirculation based on a packet modifying action.
>> What¹s the best way to do this?
>>
>>
>> 1. add another custom action?
>> 2. Add a compose_recirculate_action() in do_xlate_actions() for my
>>custom
>> action?
>> 3. Another way I haven¹t heard of.
>
>In general I believe that we've tried to hide recirculation away from
>the OpenFlow interface as it can have complicated repercussions on the
>pipeline, so that lends itself to #2. But it depends on what you're
>trying to achieve through recirculation.



From amal.kammoun at supcom.tn  Sat Aug  8 08:45:55 2015
From: amal.kammoun at supcom.tn (Amal KAMMOUN)
Date: Sat, 8 Aug 2015 15:45:55 +0000
Subject: [ovs-discuss] speed of execution.
Message-ID: <AM2PR04MB09144EB51C1961FA8E091D2788720@AM2PR04MB0914.eurprd04.prod.outlook.com>

Dear all,


My question is about the processing speed of packets in OVS.

I mean that when a traffic comes to an OVS, in how much speed the OVS will treat the packets?


Thank you!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150808/f5d831fe/attachment.html>

From mehtaneeraj07 at gmail.com  Mon Aug 10 03:16:45 2015
From: mehtaneeraj07 at gmail.com (neeraj mehta)
Date: Mon, 10 Aug 2015 15:46:45 +0530
Subject: [ovs-discuss] Arguments to memcmp() must be nonnull
Message-ID: <CAHN905JvXVYXFxgA4ZkZYwCOgnBXQ6Drcj=fC5qroGaOhLkEOg@mail.gmail.com>

Hi,

There is a possible defect in "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2.

In ovs-ofctl.c, NULL(in certain conditions) being passed as argument in
memcmp().
ISO C says that the arguments to memcmp() must not be NULL.

---

"lib/ofpbuf.h" 425L, 14598C OVS-2.3.2

static inline void * ofpbuf_l3(const struct ofpbuf *b)
{
    return b->l3_ofs != UINT16_MAX ? (char *)b->frame + b->l3_ofs : NULL;
}
---

---
"utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
if (ofptype_pull(&type, reply)
            || type != OFPTYPE_ECHO_REPLY
            || ofpbuf_size(reply) != payload
            || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
---

One of possible solutions for this can be:

---
"utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
if (ofptype_pull(&type, reply)
             || type != OFPTYPE_ECHO_REPLY
             || ofpbuf_size(reply) != payload
+           || !ofpbuf_l3(request) || !ofpbuf_l3(reply)
             || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
---

Can someone confirm the above understanding?
If this is an issue, I will submit a patch against this.

Regards
Neeraj
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/079d4a0f/attachment.html>

From ychen103103 at 163.com  Mon Aug 10 06:36:51 2015
From: ychen103103 at 163.com (ychen)
Date: Mon, 10 Aug 2015 21:36:51 +0800 (CST)
Subject: [ovs-discuss] tc ingress qdisc of tapB disappeared when
 del-port tapA from bridge
In-Reply-To: <20150723155141.GD3888@nicira.com>
References: <1c0e8fce.1792d.14eb3811fcd.Coremail.ychen103103@163.com>
 <20150722153415.GC28552@nicira.com>
 <5ecd6666.62cd.14eb8e5c3ac.Coremail.ychen103103@163.com>
 <20150723155141.GD3888@nicira.com>
Message-ID: <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>

There are still something puzzled me, can you do some help?
1. what's the meaning of the flag VALID_POLICING?
   I don't see any meaning of the flag VALID_POLICING in function netdev_linux_set_policing().
   you see, whether the parameter "kbits_rate"equals to 0, the clause netdev->cache_valid |= VALID_POLICING; will be executed only if the conditions matches error !=0 


   another strange phenomenon is that, when i set breakpoint on function netdev_linux_set_policing, I found that netdev->cache_valid equals to 0x73 which means VALID_POLICING has set before this function
   but I can't find anywhere to set this flag except in function netdev_linux_set_policing. why?


2. which event triggered message RTM_NEWLINK?
   I found that when use command "add-port br0  tap111", first function netdev_linux_set_policing() will be called, then netdev_linux_update() with message RTM_NEWLINK
   and this message will lead to netdev->cache_valid to clear the flag VALID_POLICING.
   my question is, the port tap111 is a system port, I have created it in kernel before add it to ovs bridge.
   and I didn't to anything like up the port or change the port's namespace or change mtu/mac etc, but why RTM_NEWLINK is trigerred?
  
  At 2015-07-23 23:51:41, "Ben Pfaff" <blp at nicira.com> wrote:
>On Thu, Jul 23, 2015 at 11:12:22AM +0800, ychen wrote:
>> sorry, but how to contribute to this thread: http://openvswitch.org/pipermail/discuss/2015-May/017687.html
>> It seems I can only reply this thread http://openvswitch.org/pipermail/discuss/2015-July/018324.html
>
>I don't see how any of your solutions solve the problem described in
>http://openvswitch.org/pipermail/discuss/2015-May/017687.html.  I don't
>see much value in just tweaking the parameters of the problem.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/08ff8ac7/attachment.html>

From xdzhaoyuanjie at 163.com  Mon Aug 10 06:44:49 2015
From: xdzhaoyuanjie at 163.com (=?GBK?B?1dTUtr3c?=)
Date: Mon, 10 Aug 2015 21:44:49 +0800 (CST)
Subject: [ovs-discuss] issue on ovs port mirror
Message-ID: <21da69fc.1936a.14f17db41db.Coremail.xdzhaoyuanjie@163.com>

hi, all:
 I tried to mirror the OVS bridge with a patch port, it just get the egress packages, my OVS bridge version is 2.0.2, and i found someone 
got a similar problem before, 
http://comments.gmane.org/gmane.linux.network.openvswitch.general/9786 
and
 http://openvswitch.org/pipermail/discuss/2014-December/016079.html

dose this problem is a bug?

my kernel is Linux 3.13.0-45-generic #74-Ubuntu SMP Tue Jan 13 19:36:28 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux
and my ovs version is openvswitch-switch 2.0.2-0ubuntu0.14.04.1


this is my steps for mirroring:
ip link add name snooper0 type dummy 
ip link set dev snooper0 up 
ovs-vsctl add-port br-int snooper0
ovs-vsctl -- set Bridge br-int mirrors=@m -- --id=@ss get Port snooper0 -- --id=@m create Mirror name=mymirror select_all=true output-port=@ss

sorry to touble you. farewell

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/179151cb/attachment.html>

From abhishekv.verma at gmail.com  Mon Aug 10 07:20:58 2015
From: abhishekv.verma at gmail.com (Abhishek Verma)
Date: Mon, 10 Aug 2015 19:50:58 +0530
Subject: [ovs-discuss] UserSpace <-> KernelSpace
Message-ID: <CADDmorReS8+y46EGFdr1KR6cCxOrdLzvCBMSWXgvD2cDhcogPg@mail.gmail.com>

Hi,

Flow entries in the kernel data plane expire every 5 secs. This means that
if i get a packet once every 6 secs then that packet will always get routed
to the user space, since the flow would get expired the next time it comes
again.

Is this correct?

If Yes, then can i set an age with a few selected flow entries so that they
dont time out?

Thanks, Abhishek
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/0790fa5d/attachment-0001.html>

From standulwadka at avaya.com  Fri Aug  7 10:32:11 2015
From: standulwadka at avaya.com (Tandulwadkar, Sanket Ravindra (Sanket Ravindra))
Date: Fri, 7 Aug 2015 17:32:11 +0000
Subject: [ovs-discuss] How to install OvS with a specific version
 number(say 2.1.3)
In-Reply-To: <CANr6G5zXqnpVnz1PozU+EWHMm0nyVi206LEFCL46=n0Ck-BkXQ@mail.gmail.com>
References: <9CE18184B620BC45BF38C3D5361BCDA802C631@AZ-US1EXMB01.global.avaya.com>
 <CANr6G5zXqnpVnz1PozU+EWHMm0nyVi206LEFCL46=n0Ck-BkXQ@mail.gmail.com>
Message-ID: <9CE18184B620BC45BF38C3D5361BCDA802C660@AZ-US1EXMB01.global.avaya.com>

Hello Joe,

Thank you!

I am trying to install 2.1.3. When I try to install the Debain for kernel module, I get this error


sanket at sanket-ubuntu-ovs:~$ sudo dpkg -i openvswitch-datapath-dkms_2.1.3-1_all.deb
(Reading database ... 235774 files and directories currently installed.)
Preparing to unpack openvswitch-datapath-dkms_2.1.3-1_all.deb ...

------------------------------
Deleting module version: 2.1.3
completely from the DKMS tree.
------------------------------
Done.
Unpacking openvswitch-datapath-dkms (2.1.3-1) over (2.1.3-1) ...
Setting up openvswitch-datapath-dkms (2.1.3-1) ...

Creating symlink /var/lib/dkms/openvswitch/2.1.3/source ->
                 /usr/src/openvswitch-2.1.3

DKMS: add completed.

Kernel preparation unnecessary for this kernel.  Skipping...

Building module:
cleaning build area....(bad exit status: 2)
./configure --with-linux='/lib/modules/3.16.0-28-generic/build' && make -C datapath/linux.....(bad exit status: 1)
Error! Bad return status for module build on kernel: 3.16.0-28-generic (x86_64)
Consult /var/lib/dkms/openvswitch/2.1.3/build/make.log for more information.

I know that the error is because the ./configure needs linux 3.11.x or earlier. But it automatically looks for 3.16. How do I change this line so it can take 3.11.x instead? I couldn’t locate it.

Thank you.

-----Original Message-----
From: Joe Stringer [mailto:joestringer at nicira.com] 
Sent: Friday, August 07, 2015 12:45 PM
To: Tandulwadkar, Sanket Ravindra (Sanket Ravindra)
Cc: bugs at openvswitch.org
Subject: Re: [ovs-discuss] How to install OvS with a specific version number(say 2.1.3)

On 7 August 2015 at 07:55, Tandulwadkar, Sanket Ravindra (Sanket
Ravindra) <standulwadka at avaya.com> wrote:
> Hi,
>
>
>
> I want to install a slightly older version of OvS on my Ubuntu VM. 
> When I use
>
>
>
> apt-get install openvswitch-controller openvswitch-brcompat \
>
> openvswitch-switch openvswitch-datapath-source
>
>
>
> it installs 2.3.1
>
>
>
> How can I force it with a version number?

Linux distros typically provide a single version of a package. If you want a different version, you'll need to either obtain the packages from another location or build your own.

From standulwadka at avaya.com  Fri Aug  7 10:39:54 2015
From: standulwadka at avaya.com (Tandulwadkar, Sanket Ravindra (Sanket Ravindra))
Date: Fri, 7 Aug 2015 17:39:54 +0000
Subject: [ovs-discuss] How to install OvS with a specific version
 number(say 2.1.3)
In-Reply-To: <CANr6G5y20LFLNmASTpaDKwPp+xCzo-VedQN2v=+nPhjABViwvg@mail.gmail.com>
References: <9CE18184B620BC45BF38C3D5361BCDA802C631@AZ-US1EXMB01.global.avaya.com>
 <CANr6G5zXqnpVnz1PozU+EWHMm0nyVi206LEFCL46=n0Ck-BkXQ@mail.gmail.com>
 <9CE18184B620BC45BF38C3D5361BCDA802C660@AZ-US1EXMB01.global.avaya.com>
 <CANr6G5y20LFLNmASTpaDKwPp+xCzo-VedQN2v=+nPhjABViwvg@mail.gmail.com>
Message-ID: <9CE18184B620BC45BF38C3D5361BCDA802C677@AZ-US1EXMB01.global.avaya.com>

Ok, so which of these debians should I install?

openvswitch-common_2.1.3-1_amd64.deb
openvswitch-datapath-dkms_2.1.3-1_all.deb(NOT this one)
openvswitch-datapath-source_2.1.3-1_all.deb
openvswitch-dbg_2.1.3-1_amd64.deb
openvswitch-ipsec_2.1.3-1_amd64.deb
openvswitch-pki_2.1.3-1_all.deb
openvswitch-switch_2.1.3-1_amd64.deb
openvswitch-test_2.1.3-1_all.deb
openvswitch-vtep_2.1.3-1_amd64.deb
python-openvswitch_2.1.3-1_all.deb

I don’t see the controller debian. Is it included in the common.deb? 

I am using OF with OvS to connect to ODL.


-----Original Message-----
From: Joe Stringer [mailto:joestringer at nicira.com] 
Sent: Friday, August 07, 2015 1:37 PM
To: Tandulwadkar, Sanket Ravindra (Sanket Ravindra)
Cc: bugs at openvswitch.org
Subject: Re: [ovs-discuss] How to install OvS with a specific version number(say 2.1.3)

DKMS builds the openvswitch module against each of the kernels that you have on your system. You have linux-3.16 installed, but openvswitch-datapath-dkms 2.1 doesn't support it. The alternative is to use the openvswitch module that is distributed with the kernel (ie, do not install the dkms package at all).

On 7 August 2015 at 10:32, Tandulwadkar, Sanket Ravindra (Sanket
Ravindra) <standulwadka at avaya.com> wrote:
> Hello Joe,
>
> Thank you!
>
> I am trying to install 2.1.3. When I try to install the Debain for 
> kernel module, I get this error
>
>
> sanket at sanket-ubuntu-ovs:~$ sudo dpkg -i 
> openvswitch-datapath-dkms_2.1.3-1_all.deb
> (Reading database ... 235774 files and directories currently 
> installed.) Preparing to unpack openvswitch-datapath-dkms_2.1.3-1_all.deb ...
>
> ------------------------------
> Deleting module version: 2.1.3
> completely from the DKMS tree.
> ------------------------------
> Done.
> Unpacking openvswitch-datapath-dkms (2.1.3-1) over (2.1.3-1) ...
> Setting up openvswitch-datapath-dkms (2.1.3-1) ...
>
> Creating symlink /var/lib/dkms/openvswitch/2.1.3/source ->
>                  /usr/src/openvswitch-2.1.3
>
> DKMS: add completed.
>
> Kernel preparation unnecessary for this kernel.  Skipping...
>
> Building module:
> cleaning build area....(bad exit status: 2) ./configure 
> --with-linux='/lib/modules/3.16.0-28-generic/build' && make -C 
> datapath/linux.....(bad exit status: 1) Error! Bad return status for 
> module build on kernel: 3.16.0-28-generic (x86_64) Consult /var/lib/dkms/openvswitch/2.1.3/build/make.log for more information.
>
> I know that the error is because the ./configure needs linux 3.11.x or earlier. But it automatically looks for 3.16. How do I change this line so it can take 3.11.x instead? I couldn’t locate it.
>
> Thank you.
>
> -----Original Message-----
> From: Joe Stringer [mailto:joestringer at nicira.com]
> Sent: Friday, August 07, 2015 12:45 PM
> To: Tandulwadkar, Sanket Ravindra (Sanket Ravindra)
> Cc: bugs at openvswitch.org
> Subject: Re: [ovs-discuss] How to install OvS with a specific version 
> number(say 2.1.3)
>
> On 7 August 2015 at 07:55, Tandulwadkar, Sanket Ravindra (Sanket
> Ravindra) <standulwadka at avaya.com> wrote:
>> Hi,
>>
>>
>>
>> I want to install a slightly older version of OvS on my Ubuntu VM.
>> When I use
>>
>>
>>
>> apt-get install openvswitch-controller openvswitch-brcompat \
>>
>> openvswitch-switch openvswitch-datapath-source
>>
>>
>>
>> it installs 2.3.1
>>
>>
>>
>> How can I force it with a version number?
>
> Linux distros typically provide a single version of a package. If you want a different version, you'll need to either obtain the packages from another location or build your own.

From xdzhaoyuanjie at 163.com  Mon Aug 10 06:35:21 2015
From: xdzhaoyuanjie at 163.com (=?GBK?B?1dTUtr3c?=)
Date: Mon, 10 Aug 2015 21:35:21 +0800 (CST)
Subject: [ovs-discuss] ovs port mirror issue
Message-ID: <73367f8e.191dd.14f17d2987f.Coremail.xdzhaoyuanjie@163.com>

hi, all:
 I tried to mirror the OVS bridge with a patch port, it just get the egress packages, my OVS bridge version is 2.0.2, and i found someone 
got a similar problem before, 
http://comments.gmane.org/gmane.linux.network.openvswitch.general/9786 
and
 http://openvswitch.org/pipermail/discuss/2014-December/016079.html

dose this problem is a bug?

my kernel is Linux 3.13.0-45-generic #74-Ubuntu SMP Tue Jan 13 19:36:28 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux
and my ovs version is openvswitch-switch 2.0.2-0ubuntu0.14.04.1


this is my steps for mirroring:
ip link add name snooper0 type dummy 
ip link set dev snooper0 up 
ovs-vsctl add-port br-int snooper0
ovs-vsctl -- set Bridge br-int mirrors=@m -- --id=@ss get Port snooper0 -- --id=@m create Mirror name=mymirror select_all=true output-port=@ss

sorry to touble you. farewell

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/cf13ba53/attachment.html>

From davewaters1970 at gmail.com  Mon Aug 10 11:16:26 2015
From: davewaters1970 at gmail.com (Dave Waters)
Date: Mon, 10 Aug 2015 23:46:26 +0530
Subject: [ovs-discuss] UserSpace <-> KernelSpace
In-Reply-To: <CADDmorReS8+y46EGFdr1KR6cCxOrdLzvCBMSWXgvD2cDhcogPg@mail.gmail.com>
References: <CADDmorReS8+y46EGFdr1KR6cCxOrdLzvCBMSWXgvD2cDhcogPg@mail.gmail.com>
Message-ID: <CAARSoVyni_UT9PMisKGJ6_BikFmLNDuJP4RVT5G0N53xA1ijDA@mail.gmail.com>

On Mon, Aug 10, 2015 at 7:50 PM, Abhishek Verma <abhishekv.verma at gmail.com>
wrote:

> Hi,
>
> Flow entries in the kernel data plane expire every 5 secs. This means that
> if i get a packet once every 6 secs then that packet will always get routed
> to the user space, since the flow would get expired the next time it comes
> again.
>
> Is this correct?
>

Yes. The idea is that if youre getting a packet that infrequently then you
shouldnt mind paying the user-space tax.


>
> If Yes, then can i set an age with a few selected flow entries so that
> they dont time out?
>

No, you cannot do that. The kernel automatically installs flow entries and
you cannot control that.

Dave



>
> Thanks, Abhishek
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/ffc8c3bf/attachment-0001.html>

From davewaters1970 at gmail.com  Mon Aug 10 11:55:43 2015
From: davewaters1970 at gmail.com (Dave Waters)
Date: Tue, 11 Aug 2015 00:25:43 +0530
Subject: [ovs-discuss] Deep Packet Inspection possible?
Message-ID: <CAARSoVx-trjuM4WRdrUZYTGPHCSxzCEoyNmy2S_dK3zaV4kEZQ@mail.gmail.com>

Hi,

Can i use OVS to deep inspect beyond the L4 headers inside the packet. If i
know the exact encapsulations then can i for example look at say, the 1st
bit in the 110th byte of the incoming packet?

When i say i know the exact encapsulation, i mean that i know that its an
untagged plain IPv4 UDP/TCP packet.

Would DPDK+OVS be more useful in doing this?

Thanks, Dave
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150811/a02fc8c0/attachment.html>

From davidjoshuaevans at gmail.com  Mon Aug 10 12:42:18 2015
From: davidjoshuaevans at gmail.com (David Evans)
Date: Mon, 10 Aug 2015 14:42:18 -0500
Subject: [ovs-discuss] _APPLY_ vs _WRITE_ actions
Message-ID: <CAB8HAh43xyPo+XWKSBX5YDHbfgk6w3g-BxW3-bVBw3UF7UnSPA@mail.gmail.com>

Hi OVS.

I would like to OFPTFPT13_APPLY_ACTIONS and have have subsequent table
matches on the modified packet.
The OpenFlow spec indicates that apply actions are applied immediately, and
the matches defined in subsequent tables are tests against the modified
packet. but this doesn't seem to be so for me.
Packet tests against an inner header are do not discover the inner traffic
unless there has been a recirculation. (forcing an update of the packet
metadata/flow data)
It looks to me that OVS is, for every _APPLY action behaving more like
_WRITE action behaviour of the spec.

Can anyone clarify this understanding of _WRITE vs _APPLY


Regards,

Dave
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/43261159/attachment.html>

From muralispruce at gmail.com  Mon Aug 10 17:09:23 2015
From: muralispruce at gmail.com (Murali Kandula)
Date: Mon, 10 Aug 2015 20:09:23 -0400
Subject: [ovs-discuss] Packet order mismatch between the interfaces
Message-ID: <CADPnoyZwbpAKxSTtjwD4qEGn-6FqtR1rTGVUsVMwTGzvfHmPog@mail.gmail.com>

Hello All,

I am a newbie in openvswitch. I captured the packets at the both the
interfaces eth2 and veth1 and observed that packet order is not same. For
example let's consider the tcp packets (SYN, SYN_ACK, ACK). At the eth2
interface the packet are correct but at the veth1 interface the packet
order is changed to SYN, ACK and SYN_ACK.

ovs-ofctl dump-ports-desc br0

 1(eth2): addr
     config:     0
     state:      0
     current:    1GB-FD COPPER AUTO_NEG
     advertised: 10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
     supported:  10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
     speed: 1000 Mbps now, 1000 Mbps max
 2(veth0): addr:
     config:     0
     state:      0
     current:    10GB-FD COPPER
     speed: 10000 Mbps now, 0 Mbps max
 LOCAL(br0): addr:
     config:     PORT_DOWN
     state:      LINK_DOWN
     speed: 0 Mbps now, 0 Mbps max

cookie=0x0, duration=25551.309s, table=0, n_packets=25485, n_bytes=5694083,
idle_age=319, priority=10,in_port=1 actions=FLOOD

Please let me know what is the issue.

Thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/4fc95ae4/attachment.html>

From abhishekv.verma at gmail.com  Mon Aug 10 17:18:22 2015
From: abhishekv.verma at gmail.com (Abhishek Verma)
Date: Tue, 11 Aug 2015 05:48:22 +0530
Subject: [ovs-discuss] Packet order mismatch between the interfaces
In-Reply-To: <CADPnoyZwbpAKxSTtjwD4qEGn-6FqtR1rTGVUsVMwTGzvfHmPog@mail.gmail.com>
References: <CADPnoyZwbpAKxSTtjwD4qEGn-6FqtR1rTGVUsVMwTGzvfHmPog@mail.gmail.com>
Message-ID: <CADDmorTcWgXXMhf6N4GJ=2EPuG25mJ5AhyQZgJAaO9KBvxhiRQ@mail.gmail.com>

This should ordinarily not happen. Can you mail tcpdump outputs where youre
seeing this?

Can you also send the output of ovs-dpctl dump-flows along with that.

On Tue, Aug 11, 2015 at 5:39 AM, Murali Kandula <muralispruce at gmail.com>
wrote:

> Hello All,
>
> I am a newbie in openvswitch. I captured the packets at the both the
> interfaces eth2 and veth1 and observed that packet order is not same. For
> example let's consider the tcp packets (SYN, SYN_ACK, ACK). At the eth2
> interface the packet are correct but at the veth1 interface the packet
> order is changed to SYN, ACK and SYN_ACK.
>
> ovs-ofctl dump-ports-desc br0
>
>  1(eth2): addr
>      config:     0
>      state:      0
>      current:    1GB-FD COPPER AUTO_NEG
>      advertised: 10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
>      supported:  10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
>      speed: 1000 Mbps now, 1000 Mbps max
>  2(veth0): addr:
>      config:     0
>      state:      0
>      current:    10GB-FD COPPER
>      speed: 10000 Mbps now, 0 Mbps max
>  LOCAL(br0): addr:
>      config:     PORT_DOWN
>      state:      LINK_DOWN
>      speed: 0 Mbps now, 0 Mbps max
>
> cookie=0x0, duration=25551.309s, table=0, n_packets=25485,
> n_bytes=5694083, idle_age=319, priority=10,in_port=1 actions=FLOOD
>
> Please let me know what is the issue.
>
> Thanks
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150811/d97796b2/attachment.html>

From muralispruce at gmail.com  Mon Aug 10 17:39:32 2015
From: muralispruce at gmail.com (Murali Kandula)
Date: Mon, 10 Aug 2015 20:39:32 -0400
Subject: [ovs-discuss] Packet order mismatch between the interfaces
In-Reply-To: <CADDmorTcWgXXMhf6N4GJ=2EPuG25mJ5AhyQZgJAaO9KBvxhiRQ@mail.gmail.com>
References: <CADPnoyZwbpAKxSTtjwD4qEGn-6FqtR1rTGVUsVMwTGzvfHmPog@mail.gmail.com>
 <CADDmorTcWgXXMhf6N4GJ=2EPuG25mJ5AhyQZgJAaO9KBvxhiRQ@mail.gmail.com>
Message-ID: <CADPnoybrRON_HY-8kswzc3cO0vQq+9g+RKANjpu0SkMbQYGsyQ@mail.gmail.com>

The command "ovs-dpctl dump-flows" isn't showing anything. Attached are the
tcpdump pcap files.

ovs-ofctl dump-flows br0
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=51922.609s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_dst=00:0c:29:21:62:f7 actions=drop
 cookie=0x0, duration=51922.540s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_dst=00:0c:29:21:62:15 actions=drop
 cookie=0x0, duration=51922.565s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_dst=00:0c:29:21:62:0b actions=drop
 cookie=0x0, duration=51922.581s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_dst=00:0c:29:21:62:01 actions=drop
 cookie=0x0, duration=51917.693s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, priority=0 actions=drop
 cookie=0x0, duration=51922.553s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_src=00:0c:29:21:62:15 actions=drop
 cookie=0x0, duration=51922.569s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_src=00:0c:29:21:62:0b actions=drop
 cookie=0x0, duration=51922.586s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_src=00:0c:29:21:62:01 actions=drop
 cookie=0x0, duration=51922.620s, table=0, n_packets=0, n_bytes=0,
idle_age=65534, dl_src=00:0c:29:21:62:f7 actions=drop
 cookie=0x0, duration=24652.537s, table=0, n_packets=1307, n_bytes=165936,
idle_age=207, priority=10,in_port=1 actions=FLOOD


On Mon, Aug 10, 2015 at 8:18 PM, Abhishek Verma <abhishekv.verma at gmail.com>
wrote:

> This should ordinarily not happen. Can you mail tcpdump outputs where
> youre seeing this?
>
> Can you also send the output of ovs-dpctl dump-flows along with that.
>
> On Tue, Aug 11, 2015 at 5:39 AM, Murali Kandula <muralispruce at gmail.com>
> wrote:
>
>> Hello All,
>>
>> I am a newbie in openvswitch. I captured the packets at the both the
>> interfaces eth2 and veth1 and observed that packet order is not same. For
>> example let's consider the tcp packets (SYN, SYN_ACK, ACK). At the eth2
>> interface the packet are correct but at the veth1 interface the packet
>> order is changed to SYN, ACK and SYN_ACK.
>>
>> ovs-ofctl dump-ports-desc br0
>>
>>  1(eth2): addr
>>      config:     0
>>      state:      0
>>      current:    1GB-FD COPPER AUTO_NEG
>>      advertised: 10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
>>      supported:  10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
>>      speed: 1000 Mbps now, 1000 Mbps max
>>  2(veth0): addr:
>>      config:     0
>>      state:      0
>>      current:    10GB-FD COPPER
>>      speed: 10000 Mbps now, 0 Mbps max
>>  LOCAL(br0): addr:
>>      config:     PORT_DOWN
>>      state:      LINK_DOWN
>>      speed: 0 Mbps now, 0 Mbps max
>>
>> cookie=0x0, duration=25551.309s, table=0, n_packets=25485,
>> n_bytes=5694083, idle_age=319, priority=10,in_port=1 actions=FLOOD
>>
>> Please let me know what is the issue.
>>
>> Thanks
>>
>> _______________________________________________
>> discuss mailing list
>> discuss at openvswitch.org
>> http://openvswitch.org/mailman/listinfo/discuss
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/eb4c52ed/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: veth1_sample.pcap
Type: application/octet-stream
Size: 49176 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/eb4c52ed/attachment-0002.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: eth2_sample.pcap
Type: application/octet-stream
Size: 49176 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/eb4c52ed/attachment-0003.obj>

From mehtaneeraj07 at gmail.com  Tue Aug 11 00:23:17 2015
From: mehtaneeraj07 at gmail.com (neeraj mehta)
Date: Tue, 11 Aug 2015 12:53:17 +0530
Subject: [ovs-discuss] Arguments to memcmp() must be nonnull
Message-ID: <CAHN905+5hzrB0mF=bb7K5kHz=rBOzvBYe0UCtNZYoDTeMqnfqQ@mail.gmail.com>

Hi,

There is a possible defect in "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2.

In ovs-ofctl.c, NULL(in certain conditions) being passed as argument in
memcmp().
ISO C says that the arguments to memcmp() must not be NULL.

---

"lib/ofpbuf.h" 425L, 14598C OVS-2.3.2

static inline void * ofpbuf_l3(const struct ofpbuf *b)
{
    return b->l3_ofs != UINT16_MAX ? (char *)b->frame + b->l3_ofs : NULL;
}
---

---
"utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
if (ofptype_pull(&type, reply)
            || type != OFPTYPE_ECHO_REPLY
            || ofpbuf_size(reply) != payload
            || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
---

One of possible solutions for this can be:

---
"utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
if (ofptype_pull(&type, reply)
             || type != OFPTYPE_ECHO_REPLY
             || ofpbuf_size(reply) != payload
+           || !ofpbuf_l3(request) || !ofpbuf_l3(reply)
             || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
---

Can someone confirm the above understanding?
If this is an issue, I will submit a patch against this.

Regards
Neeraj
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150811/173a236e/attachment.html>

From ychen103103 at 163.com  Tue Aug 11 02:06:03 2015
From: ychen103103 at 163.com (ychen)
Date: Tue, 11 Aug 2015 17:06:03 +0800 (CST)
Subject: [ovs-discuss] tc ingress qdisc of tapB disappeared when del-port
 tapA from bridge
In-Reply-To: <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
References: <1c0e8fce.1792d.14eb3811fcd.Coremail.ychen103103@163.com>
 <20150722153415.GC28552@nicira.com>
 <5ecd6666.62cd.14eb8e5c3ac.Coremail.ychen103103@163.com>
 <20150723155141.GD3888@nicira.com>
 <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
Message-ID: <2bae4cf4.dcfc.14f1c0265ec.Coremail.ychen103103@163.com>

Hi, I need some help about ovs QOS policing.
I want to know the meaning of the flag VALID_POLICING
In function netdev_linux_set_policing(), whether parameter "kbits_rate"equals to 0 or not, VALID_POLICING flag will be set.
In my opinion, only when users set ingress_policing_rate to none zero, then VALID_POLICING should be set, if ingress_policing_rate is cleared or set to 0, then VALID_POLICING should be unset
am I right? or there is another meaning of this flag?








At 2015-08-10 21:36:51, "ychen" <ychen103103 at 163.com> wrote:

There are still something puzzled me, can you do some help?
1. what's the meaning of the flag VALID_POLICING?
   I don't see any meaning of the flag VALID_POLICING in function netdev_linux_set_policing().
   you see, whether the parameter "kbits_rate"equals to 0, the clause netdev->cache_valid |= VALID_POLICING; will be executed only if the conditions matches error !=0 


   another strange phenomenon is that, when i set breakpoint on function netdev_linux_set_policing, I found that netdev->cache_valid equals to 0x73 which means VALID_POLICING has set before this function
   but I can't find anywhere to set this flag except in function netdev_linux_set_policing. why?


2. which event triggered message RTM_NEWLINK?
   I found that when use command "add-port br0  tap111", first function netdev_linux_set_policing() will be called, then netdev_linux_update() with message RTM_NEWLINK
   and this message will lead to netdev->cache_valid to clear the flag VALID_POLICING.
   my question is, the port tap111 is a system port, I have created it in kernel before add it to ovs bridge.
   and I didn't to anything like up the port or change the port's namespace or change mtu/mac etc, but why RTM_NEWLINK is trigerred?
  
  At 2015-07-23 23:51:41, "Ben Pfaff" <blp at nicira.com> wrote:
>On Thu, Jul 23, 2015 at 11:12:22AM +0800, ychen wrote:
>> sorry, but how to contribute to this thread: http://openvswitch.org/pipermail/discuss/2015-May/017687.html
>> It seems I can only reply this thread http://openvswitch.org/pipermail/discuss/2015-July/018324.html
>
>I don't see how any of your solutions solve the problem described in
>http://openvswitch.org/pipermail/discuss/2015-May/017687.html.  I don't
>see much value in just tweaking the parameters of the problem.



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150811/6866cf27/attachment.html>

From Hariharan_Sethuraman at Dell.com  Tue Aug 11 09:57:25 2015
From: Hariharan_Sethuraman at Dell.com (Hariharan_Sethuraman at Dell.com)
Date: Tue, 11 Aug 2015 22:27:25 +0530
Subject: [ovs-discuss] Multipart request interleaving with individual request
Message-ID: <0E0BB0168B0E284CBB6CFE99BF094A8E071930DFF2@MAAX7MCDC102.APAC.DELL.COM>

Hi OVS team,

I am working in opendaylight. Would like to get the following clarified.


1.       Can a multipart reply mix up with individual reply causing invoking client out of sync with OVS?

For example:
ofp_port_stats_request is a request for individual port statistics. Ofpmp_multipart_request can be a request for more port statistcs.

Lets say the SDN controller, requests ofpmp_multipart_request and ofp_port_stats_request in any order to OVS. When OVS is constructing the replies and a port status flaps (up to down) in between, is there a chance of replies is in the order such that the SDN controller receives the replies and sees the port status as down in first reply (ofp_port_stats) and up in multipart replies? So at the end the controller thinks the port status is up but the port status is down in ovs. Is this possible? Or the mutlipart reply is always the live status and not built on buffered?

Thanks,
Hari
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150811/7102c443/attachment-0001.html>

From jpettit at nicira.com  Tue Aug 11 10:25:05 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Tue, 11 Aug 2015 10:25:05 -0700
Subject: [ovs-discuss] Arguments to memcmp() must be nonnull
In-Reply-To: <CAHN905+5hzrB0mF=bb7K5kHz=rBOzvBYe0UCtNZYoDTeMqnfqQ@mail.gmail.com>
References: <CAHN905+5hzrB0mF=bb7K5kHz=rBOzvBYe0UCtNZYoDTeMqnfqQ@mail.gmail.com>
Message-ID: <80349AF9-32B9-4108-AC74-1E60BBFD99C5@nicira.com>


> On Aug 11, 2015, at 12:23 AM, neeraj mehta <mehtaneeraj07 at gmail.com> wrote:
> 
> Hi,
> 
> There is a possible defect in "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2.
> 
> In ovs-ofctl.c, NULL(in certain conditions) being passed as argument in memcmp().
> ISO C says that the arguments to memcmp() must not be NULL.
> 
> ---
> 
> "lib/ofpbuf.h" 425L, 14598C OVS-2.3.2
> 
> static inline void * ofpbuf_l3(const struct ofpbuf *b)
> {
>     return b->l3_ofs != UINT16_MAX ? (char *)b->frame + b->l3_ofs : NULL;
> }
> ---
> 
> ---
> "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
> if (ofptype_pull(&type, reply)
>             || type != OFPTYPE_ECHO_REPLY
>             || ofpbuf_size(reply) != payload
>             || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
> ---
> 
> One of possible solutions for this can be:
> 
> ---
> "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
> if (ofptype_pull(&type, reply)
>              || type != OFPTYPE_ECHO_REPLY
>              || ofpbuf_size(reply) != payload
> +           || !ofpbuf_l3(request) || !ofpbuf_l3(reply)
>              || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
> ---
> 
> Can someone confirm the above understanding?
> If this is an issue, I will submit a patch against this.

Do you see a way for "l3_ofs" to not bet set?  It looks to me like "request" is set by ofpraw_alloc() and "reply" is set by ofptype_pull().

--Justin



From jesse at nicira.com  Tue Aug 11 16:32:32 2015
From: jesse at nicira.com (Jesse Gross)
Date: Tue, 11 Aug 2015 16:32:32 -0700
Subject: [ovs-discuss] Deep Packet Inspection possible?
In-Reply-To: <CAARSoVx-trjuM4WRdrUZYTGPHCSxzCEoyNmy2S_dK3zaV4kEZQ@mail.gmail.com>
References: <CAARSoVx-trjuM4WRdrUZYTGPHCSxzCEoyNmy2S_dK3zaV4kEZQ@mail.gmail.com>
Message-ID: <CAEP_g=8AmU3LBG4_NbW4G70SGWJOrX9KMDeoowrjpB7h12dhAg@mail.gmail.com>

On Mon, Aug 10, 2015 at 11:55 AM, Dave Waters <davewaters1970 at gmail.com> wrote:
> Hi,
>
> Can i use OVS to deep inspect beyond the L4 headers inside the packet. If i
> know the exact encapsulations then can i for example look at say, the 1st
> bit in the 110th byte of the incoming packet?
>
> When i say i know the exact encapsulation, i mean that i know that its an
> untagged plain IPv4 UDP/TCP packet.

No, OVS doesn't have an ability to grab arbitrary byte offsets into the packet.

In general, I think there are too many corner cases for this to be the
right solution for OVS to expose for most people. I would rather see
an implementation of a flexible parser like P4 as the way to achieve
this.

From shshen0983 at gmail.com  Tue Aug 11 23:23:20 2015
From: shshen0983 at gmail.com (Andy Shen)
Date: Wed, 12 Aug 2015 14:23:20 +0800
Subject: [ovs-discuss] 2.3.2 installation issues
Message-ID: <CAMaPbttB1igA3bn9ntThZ0H3xK21BsFbdRHyBNdT6jGcBGCZPA@mail.gmail.com>

Hi all,

I try to install openvswtich 2.3.2 in my system.
But I get an error.( make: *** [build-arch-stamp] Error 1 )
I have no idea how to resolve this problem.

My system is Debian 8.0 with kernel 3.14.36.
Attached file is my "testsuite.log" file.
Could you please kindly help me to find out the problem?
Thank you.


-- 
Sincerely,

---------------------------------------------
Andy Shen
E-mail: shshen0983 at gmail.com
Don't forget your initial dream !!
---------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150812/107b3cef/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: testsuite.log
Type: application/octet-stream
Size: 290246 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150812/107b3cef/attachment-0001.obj>

From muralispruce at gmail.com  Wed Aug 12 07:39:43 2015
From: muralispruce at gmail.com (Murali Kandula)
Date: Wed, 12 Aug 2015 10:39:43 -0400
Subject: [ovs-discuss] Packet order mismatch between the interfaces
In-Reply-To: <CADPnoybrRON_HY-8kswzc3cO0vQq+9g+RKANjpu0SkMbQYGsyQ@mail.gmail.com>
References: <CADPnoyZwbpAKxSTtjwD4qEGn-6FqtR1rTGVUsVMwTGzvfHmPog@mail.gmail.com>
 <CADDmorTcWgXXMhf6N4GJ=2EPuG25mJ5AhyQZgJAaO9KBvxhiRQ@mail.gmail.com>
 <CADPnoybrRON_HY-8kswzc3cO0vQq+9g+RKANjpu0SkMbQYGsyQ@mail.gmail.com>
Message-ID: <CADPnoybTGr=gMTL1s_LcFtqbvhNUBMKzaWWHD6M9HFud4YMfQA@mail.gmail.com>

Hello,

Is anybody have any idea why is this happening?.

Thanks

On Mon, Aug 10, 2015 at 8:39 PM, Murali Kandula <muralispruce at gmail.com>
wrote:

> The command "ovs-dpctl dump-flows" isn't showing anything. Attached are
> the tcpdump pcap files.
>
> ovs-ofctl dump-flows br0
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=51922.609s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_dst=00:0c:29:21:62:f7 actions=drop
>  cookie=0x0, duration=51922.540s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_dst=00:0c:29:21:62:15 actions=drop
>  cookie=0x0, duration=51922.565s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_dst=00:0c:29:21:62:0b actions=drop
>  cookie=0x0, duration=51922.581s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_dst=00:0c:29:21:62:01 actions=drop
>  cookie=0x0, duration=51917.693s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, priority=0 actions=drop
>  cookie=0x0, duration=51922.553s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_src=00:0c:29:21:62:15 actions=drop
>  cookie=0x0, duration=51922.569s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_src=00:0c:29:21:62:0b actions=drop
>  cookie=0x0, duration=51922.586s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_src=00:0c:29:21:62:01 actions=drop
>  cookie=0x0, duration=51922.620s, table=0, n_packets=0, n_bytes=0,
> idle_age=65534, dl_src=00:0c:29:21:62:f7 actions=drop
>  cookie=0x0, duration=24652.537s, table=0, n_packets=1307, n_bytes=165936,
> idle_age=207, priority=10,in_port=1 actions=FLOOD
>
>
> On Mon, Aug 10, 2015 at 8:18 PM, Abhishek Verma <abhishekv.verma at gmail.com
> > wrote:
>
>> This should ordinarily not happen. Can you mail tcpdump outputs where
>> youre seeing this?
>>
>> Can you also send the output of ovs-dpctl dump-flows along with that.
>>
>> On Tue, Aug 11, 2015 at 5:39 AM, Murali Kandula <muralispruce at gmail.com>
>> wrote:
>>
>>> Hello All,
>>>
>>> I am a newbie in openvswitch. I captured the packets at the both the
>>> interfaces eth2 and veth1 and observed that packet order is not same. For
>>> example let's consider the tcp packets (SYN, SYN_ACK, ACK). At the eth2
>>> interface the packet are correct but at the veth1 interface the packet
>>> order is changed to SYN, ACK and SYN_ACK.
>>>
>>> ovs-ofctl dump-ports-desc br0
>>>
>>>  1(eth2): addr
>>>      config:     0
>>>      state:      0
>>>      current:    1GB-FD COPPER AUTO_NEG
>>>      advertised: 10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
>>>      supported:  10MB-HD 10MB-FD 100MB-HD 100MB-FD 1GB-FD COPPER AUTO_NEG
>>>      speed: 1000 Mbps now, 1000 Mbps max
>>>  2(veth0): addr:
>>>      config:     0
>>>      state:      0
>>>      current:    10GB-FD COPPER
>>>      speed: 10000 Mbps now, 0 Mbps max
>>>  LOCAL(br0): addr:
>>>      config:     PORT_DOWN
>>>      state:      LINK_DOWN
>>>      speed: 0 Mbps now, 0 Mbps max
>>>
>>> cookie=0x0, duration=25551.309s, table=0, n_packets=25485,
>>> n_bytes=5694083, idle_age=319, priority=10,in_port=1 actions=FLOOD
>>>
>>> Please let me know what is the issue.
>>>
>>> Thanks
>>>
>>> _______________________________________________
>>> discuss mailing list
>>> discuss at openvswitch.org
>>> http://openvswitch.org/mailman/listinfo/discuss
>>>
>>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150812/808bdeb3/attachment.html>

From standulwadka at avaya.com  Mon Aug 10 14:41:09 2015
From: standulwadka at avaya.com (Tandulwadkar, Sanket Ravindra (Sanket Ravindra))
Date: Mon, 10 Aug 2015 21:41:09 +0000
Subject: [ovs-discuss] Wakeup due to polling on fd4/ 0-ms timeout at
	ovsdb-idl.c:1344
Message-ID: <9CE18184B620BC45BF38C3D5361BCDA8032130@AZ-US1EXMB01.global.avaya.com>

Hello,

I have been trying to connect OvS2.1.3 to opendaylight. When I set controller, I get this log. What does it mean? Is it timing out because of something?

sanket at sanket-ovs-vm:/var/log/openvswitch$ sudo ovs-vsctl --verbose --retry set-controller br0 ssl:172.31.1.2:6633
2015-08-10T21:32:44Z|00002|reconnect|DBG|unix:/var/run/openvswitch/db.sock: entering BACKOFF
2015-08-10T21:32:44Z|00003|hmap|DBG|../lib/shash.c:112: 6 nodes in bucket (16 nodes, 8 buckets)
2015-08-10T21:32:44Z|00004|reconnect|INFO|unix:/var/run/openvswitch/db.sock: connecting...
2015-08-10T21:32:44Z|00005|reconnect|DBG|unix:/var/run/openvswitch/db.sock: entering CONNECTING
2015-08-10T21:32:44Z|00006|poll_loop|DBG|wakeup due to [POLLOUT] on fd 4 (<->/var/run/openvswitch/db.sock) at ../lib/stream-fd.c:120
2015-08-10T21:32:44Z|00007|reconnect|INFO|unix:/var/run/openvswitch/db.sock: connected
2015-08-10T21:32:44Z|00008|reconnect|DBG|unix:/var/run/openvswitch/db.sock: entering ACTIVE
2015-08-10T21:32:44Z|00009|jsonrpc|DBG|unix:/var/run/openvswitch/db.sock: send request, method="monitor", params=["Open_vSwitch",null,{"Port":{"columns":["fake_bridge","interfaces","name","tag"]},"Interface":{"columns":["name"]},"Bridge":{"columns":["controller","fail_mode","name","ports"]},"Controller":{"columns":["target"]},"Open_vSwitch":{"columns":["bridges","cur_cfg"]}}], id=0
2015-08-10T21:32:44Z|00010|poll_loop|DBG|wakeup due to [POLLIN] on fd 4 (<->/var/run/openvswitch/db.sock) at ../lib/stream-fd.c:124
2015-08-10T21:32:44Z|00011|jsonrpc|DBG|unix:/var/run/openvswitch/db.sock: received reply, result={"Port":{"cf0b0e97-2af8-49a9-af52-57f9f1a6873c":{"new":{"name":"br0","fake_bridge":false,"interfaces":["uuid","be7951a4-f80b-4886-a6d0-2b5227982b73"],"tag":["set",[]]}},"ebce585b-3540-4363-82e6-9bc159c1fdd6":{"new":{"name":"eth1","fake_bridge":false,"interfaces":["uuid","2872462f-89b0-49ad-8537-5577e0c7a158"],"tag":["set",[]]}}},"Interface":{"be7951a4-f80b-4886-a6d0-2b5227982b73":{"new":{"name":"br0"}},"2872462f-89b0-49ad-8537-5577e0c7a158":{"new":{"name":"eth1"}}},"Bridge":{"c9819cd8-1fe1-433e-86ac-e5fb778e744e":{"new":{"fail_mode":["set",[]],"name":"br0","ports":["set",[["uuid","cf0b0e97-2af8-49a9-af52-57f9f1a6873c"],["uuid","ebce585b-3540-4363-82e6-9bc159c1fdd6"]]],"controller":["uuid","da3e5eaa-25d9-4c1b-986a-a7b680790cfa"]}}},"Controller":{"da3e5eaa-25d9-4c1b-986a-a7b680790cfa":{"new":{"target":"ssl:172.31.1.2:6633"}}},"Open_vSwitch":{"863ace31-2111-4898-92b1-774efe9807e9":{"new":{"bridges":["uuid","c9819cd8-1fe1-433e-86ac-e5fb778e744e"],"cur_cfg":21}}}}, id=0
2015-08-10T21:32:44Z|00012|jsonrpc|DBG|unix:/var/run/openvswitch/db.sock: send request, method="transact", params=["Open_vSwitch",{"rows":[{"controller":["uuid","da3e5eaa-25d9-4c1b-986a-a7b680790cfa"]}],"columns":["controller"],"table":"Bridge","until":"==","where":[["_uuid","==",["uuid","c9819cd8-1fe1-433e-86ac-e5fb778e744e"]]],"timeout":0,"op":"wait"},{"rows":[{"bridges":["uuid","c9819cd8-1fe1-433e-86ac-e5fb778e744e"]}],"columns":["bridges"],"table":"Open_vSwitch","until":"==","where":[["_uuid","==",["uuid","863ace31-2111-4898-92b1-774efe9807e9"]]],"timeout":0,"op":"wait"},{"rows":[{"target":"ssl:172.31.1.2:6633"}],"columns":["target"],"table":"Controller","until":"==","where":[["_uuid","==",["uuid","da3e5eaa-25d9-4c1b-986a-a7b680790cfa"]]],"timeout":0,"op":"wait"},{"row":{"controller":["named-uuid","row51211a8f_c1c2_4266_ac60_5a0a140aca4e"]},"table":"Bridge","where":[["_uuid","==",["uuid","c9819cd8-1fe1-433e-86ac-e5fb778e744e"]]],"op":"update"},{"row":{"target":"ssl:172.31.1.2:6633"},"table":"Controller","uuid-name":"row51211a8f_c1c2_4266_ac60_5a0a140aca4e","op":"insert"},{"mutations":[["next_cfg","+=",1]],"table":"Open_vSwitch","where":[["_uuid","==",["uuid","863ace31-2111-4898-92b1-774efe9807e9"]]],"op":"mutate"},{"columns":["next_cfg"],"table":"Open_vSwitch","where":[["_uuid","==",["uuid","863ace31-2111-4898-92b1-774efe9807e9"]]],"op":"select"},{"comment":"ovs-vsctl: ovs-vsctl --verbose --retry set-controller br0 ssl:172.31.1.2:6633","op":"comment"}], id=1
2015-08-10T21:32:44Z|00013|jsonrpc|DBG|unix:/var/run/openvswitch/db.sock: received notification, method="update", params=[null,{"Bridge":{"c9819cd8-1fe1-433e-86ac-e5fb778e744e":{"old":{"controller":["uuid","da3e5eaa-25d9-4c1b-986a-a7b680790cfa"]},"new":{"fail_mode":["set",[]],"name":"br0","ports":["set",[["uuid","cf0b0e97-2af8-49a9-af52-57f9f1a6873c"],["uuid","ebce585b-3540-4363-82e6-9bc159c1fdd6"]]],"controller":["uuid","05df805b-c5f0-45a0-83bf-3e8d4af9b904"]}}},"Controller":{"da3e5eaa-25d9-4c1b-986a-a7b680790cfa":{"old":{"target":"ssl:172.31.1.2:6633"}},"05df805b-c5f0-45a0-83bf-3e8d4af9b904":{"new":{"target":"ssl:172.31.1.2:6633"}}}}]
2015-08-10T21:32:44Z|00014|jsonrpc|DBG|unix:/var/run/openvswitch/db.sock: received reply, result=[{},{},{},{"count":1},{"uuid":["uuid","05df805b-c5f0-45a0-83bf-3e8d4af9b904"]},{"count":1},{"rows":[{"next_cfg":22}]},{}], id=1
2015-08-10T21:32:44Z|00015|jsonrpc|DBG|unix:/var/run/openvswitch/db.sock: received notification, method="update", params=[null,{"Open_vSwitch":{"863ace31-2111-4898-92b1-774efe9807e9":{"old":{"cur_cfg":21},"new":{"bridges":["uuid","c9819cd8-1fe1-433e-86ac-e5fb778e744e"],"cur_cfg":22}}}}]
2015-08-10T21:32:44Z|00016|poll_loop|DBG|wakeup due to 0-ms timeout at ../lib/ovsdb-idl.c:1344




Sincerely,
Sanket Tandulwadkar
standulwadka at avaya.com<mailto:standulwadka at avaya.com>
+19786713205

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150810/a3c799ad/attachment-0001.html>

From 1214781328 at qq.com  Tue Aug 11 23:16:17 2015
From: 1214781328 at qq.com (1214781328 at qq.com)
Date: Wed, 12 Aug 2015 14:16:17 +0800
Subject: [ovs-discuss] Questions about Openvswitch on FreeBSD 10.1 Release
Message-ID: <201508121416161460122@qq.com>

Hello: 
Sorry for bothering you, but I got a strange bug while trying to build a GRE tunnel using Openvswitch between 2 virtual machines based on KVM. The OS of 2 virtual machines are FreeBSD 10.1 Release, and the host OS is CentOS 6.3, Openvswitch version 2.3.2 on virtual machines. I’ll describe my bug in the following paragraphs.

INSTALLATION: I checked all the optional modules while installing FreeBSD, and installed openvswitch 2.3.2 by typing “pkg install openvswitch” into FreeBSD’s console, then “pkg install python” because the console said some additional modules needs to be installed (2KB).

CONFIGURATION: 
1) “rm -f /var/db/openvswitch/conf.db”
2) “ovsdb-tool create /var/db/openvswitch/conf.db /usr/local/share/openvswitch/vswitch.ovsschema”
3) “ovsdb-server --remote=punix:/var/run/openvswitch/db.sock --remote=db.Open_vSwitch,manager_options --pidfile --detach”
4) “ovs-vsctl --no-wait init”
5) “ova-vswichd --pidfile --detach ―mlockall
NO ERROR during the procedures above.

THEN COMES THE BUG: When I try to add a bridge “ovs-vsctl add-br br0", it said: "ovs-vsctl: Error detected while setting up 'br0'.  See ovs-vswitchd log for details.” Then i tried “ovs-vswitchd log”:

2015-08-11T05:48:55Z|00001|reconnect|INFO|log: connecting...
2015-08-11T05:48:55Z|00002|reconnect|INFO|log: connection attempt failed (Address family not supported by protocol family)
2015-08-11T05:48:55Z|00003|reconnect|INFO|log: waiting 1 seconds before reconnect

Also i can’t find any info about “br0” in the list generated by “ifconfig”...

So i checked on google and someone said do “ovs-vsctl set bridge br0 data path_type=netdev” and the new bridge will appear in “ifconfig”, well i tried and it did work. BUT the same error ("Address family blabla..”) keeps appearing after any command i tried to execute, like add-port. I wonder if I did something wrong or didn’t configure some options during Openvswitch installation and configuration. I hope you can check my email and let me know the solution, or if you are not aware of the specific solution, let me know the details when you install and configure Openvswitch on FreeBSD. Thank you very much.

Yours.
Jialiang.Zhang
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150812/9f812a0b/attachment.html>

From jesse at nicira.com  Wed Aug 12 09:36:53 2015
From: jesse at nicira.com (Jesse Gross)
Date: Wed, 12 Aug 2015 09:36:53 -0700
Subject: [ovs-discuss] Questions about Openvswitch on FreeBSD 10.1
	Release
In-Reply-To: <201508121416161460122@qq.com>
References: <201508121416161460122@qq.com>
Message-ID: <CAEP_g=-pXHxDibNn5F3AHuAZUBjy8DgppenUpwZnkh577Hz2xw@mail.gmail.com>

On Tue, Aug 11, 2015 at 11:16 PM, 1214781328 at qq.com <1214781328 at qq.com> wrote:
> Hello:
> Sorry for bothering you, but I got a strange bug while trying to build a GRE
> tunnel using Openvswitch between 2 virtual machines based on KVM. The OS of
> 2 virtual machines are FreeBSD 10.1 Release, and the host OS is CentOS 6.3,
> Openvswitch version 2.3.2 on virtual machines. I’ll describe my bug in the
> following paragraphs.
>
> INSTALLATION: I checked all the optional modules while installing FreeBSD,
> and installed openvswitch 2.3.2 by typing “pkg install openvswitch” into
> FreeBSD’s console, then “pkg install python” because the console said some
> additional modules needs to be installed (2KB).
>
> CONFIGURATION:
> 1) “rm -f /var/db/openvswitch/conf.db”
> 2) “ovsdb-tool create /var/db/openvswitch/conf.db
> /usr/local/share/openvswitch/vswitch.ovsschema”
> 3) “ovsdb-server --remote=punix:/var/run/openvswitch/db.sock
> --remote=db.Open_vSwitch,manager_options --pidfile --detach”
> 4) “ovs-vsctl --no-wait init”
> 5) “ova-vswichd --pidfile --detach —mlockall
> NO ERROR during the procedures above.
>
> THEN COMES THE BUG: When I try to add a bridge “ovs-vsctl add-br br0", it
> said: "ovs-vsctl: Error detected while setting up 'br0'.  See ovs-vswitchd
> log for details.” Then i tried “ovs-vswitchd log”:
>
> 2015-08-11T05:48:55Z|00001|reconnect|INFO|log: connecting...
> 2015-08-11T05:48:55Z|00002|reconnect|INFO|log: connection attempt failed
> (Address family not supported by protocol family)
> 2015-08-11T05:48:55Z|00003|reconnect|INFO|log: waiting 1 seconds before
> reconnect

Tunnels, including GRE, are currently only supported on Linux.

From joestringer at nicira.com  Wed Aug 12 15:53:07 2015
From: joestringer at nicira.com (Joe Stringer)
Date: Wed, 12 Aug 2015 15:53:07 -0700
Subject: [ovs-discuss] UserSpace <-> KernelSpace
In-Reply-To: <CAARSoVyni_UT9PMisKGJ6_BikFmLNDuJP4RVT5G0N53xA1ijDA@mail.gmail.com>
References: <CADDmorReS8+y46EGFdr1KR6cCxOrdLzvCBMSWXgvD2cDhcogPg@mail.gmail.com>
 <CAARSoVyni_UT9PMisKGJ6_BikFmLNDuJP4RVT5G0N53xA1ijDA@mail.gmail.com>
Message-ID: <CANr6G5xZ+Haf0h58wYEzJWAZF=TWd+Hc5Ed3=zjq4_wo3B6Dcg@mail.gmail.com>

On 10 August 2015 at 11:16, Dave Waters <davewaters1970 at gmail.com> wrote:
>
>
> On Mon, Aug 10, 2015 at 7:50 PM, Abhishek Verma <abhishekv.verma at gmail.com>
> wrote:
>>
>> Hi,
>>
>> Flow entries in the kernel data plane expire every 5 secs. This means that
>> if i get a packet once every 6 secs then that packet will always get routed
>> to the user space, since the flow would get expired the next time it comes
>> again.
>>
>> Is this correct?
>
>
> Yes. The idea is that if youre getting a packet that infrequently then you
> shouldnt mind paying the user-space tax.
>
>>
>>
>> If Yes, then can i set an age with a few selected flow entries so that
>> they dont time out?
>
>
> No, you cannot do that. The kernel automatically installs flow entries and
> you cannot control that.

Minor correction: Userspace is responsible for installing flow
entries. The kernel sends an upcall including a packet to userspace,
which then makes the decisions. However like Dave said, there is no
way to 'pin' flows to the datapath.

From ambigioz at gmail.com  Wed Aug 12 18:43:04 2015
From: ambigioz at gmail.com (Dario Banfi)
Date: Thu, 13 Aug 2015 11:43:04 +1000
Subject: [ovs-discuss] Reordering TCP packets in openvswitch
Message-ID: <1A6A0A36-159F-45F9-B78B-ADF69DFEDFB7@gmail.com>

Hello,

I am trying to create a special TCP reordering group in open vSwitch, in a network with very high packet reordering.
Some TCP flows will be grouped in this OpenFlow group and the switch will buffer the packets and try to send them out in order.
I tried to buffer the xlate_context in ofproto-dpif-xlate until the buffer (of 4 contexts to test) is full, but once I send them out I get some segfaults at netlink.c.
I guess that using context for this is not the best approach. Where else could I implement a similar functionality?

Thanks in advance

From 948676270 at qq.com  Wed Aug 12 23:05:12 2015
From: 948676270 at qq.com (948676270 at qq.com)
Date: Thu, 13 Aug 2015 14:05:12 +0800
Subject: [ovs-discuss] could we mirror the packages of patch port?
Message-ID: <201508131405113942215@qq.com>

Hi Ben,
     What do you mean about "It doesn't look like it",do you mean that the bug he reported exists and this problem isn't fixed yet?
     Thank you~~
Suheng


948676270 at qq.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150813/a684498c/attachment.html>

From kevlo at FreeBSD.org  Thu Aug 13 00:44:09 2015
From: kevlo at FreeBSD.org (Kevin Lo)
Date: Thu, 13 Aug 2015 15:44:09 +0800
Subject: [ovs-discuss] Questions about Openvswitch on FreeBSD 10.1
	Release
In-Reply-To: <CAEP_g=-pXHxDibNn5F3AHuAZUBjy8DgppenUpwZnkh577Hz2xw@mail.gmail.com>
References: <201508121416161460122@qq.com>
 <CAEP_g=-pXHxDibNn5F3AHuAZUBjy8DgppenUpwZnkh577Hz2xw@mail.gmail.com>
Message-ID: <20150813074409.GA97165@ns.kevlo.org>

On Wed, Aug 12, 2015 at 09:36:53AM -0700, Jesse Gross wrote:
> 
> On Tue, Aug 11, 2015 at 11:16 PM, 1214781328 at qq.com <1214781328 at qq.com> wrote:
> > Hello:
> > Sorry for bothering you, but I got a strange bug while trying to build a GRE
> > tunnel using Openvswitch between 2 virtual machines based on KVM. The OS of
> > 2 virtual machines are FreeBSD 10.1 Release, and the host OS is CentOS 6.3,
> > Openvswitch version 2.3.2 on virtual machines. I’ll describe my bug in the
> > following paragraphs.
> >
> > INSTALLATION: I checked all the optional modules while installing FreeBSD,
> > and installed openvswitch 2.3.2 by typing “pkg install openvswitch” into
> > FreeBSD’s console, then “pkg install python” because the console said some
> > additional modules needs to be installed (2KB).
> >
> > CONFIGURATION:
> > 1) “rm -f /var/db/openvswitch/conf.db”
> > 2) “ovsdb-tool create /var/db/openvswitch/conf.db
> > /usr/local/share/openvswitch/vswitch.ovsschema”
> > 3) “ovsdb-server --remote=punix:/var/run/openvswitch/db.sock
> > --remote=db.Open_vSwitch,manager_options --pidfile --detach”
> > 4) “ovs-vsctl --no-wait init”
> > 5) “ova-vswichd --pidfile --detach —mlockall
> > NO ERROR during the procedures above.
> >
> > THEN COMES THE BUG: When I try to add a bridge “ovs-vsctl add-br br0", it
> > said: "ovs-vsctl: Error detected while setting up 'br0'.  See ovs-vswitchd
> > log for details.” Then i tried “ovs-vswitchd log”:
> >
> > 2015-08-11T05:48:55Z|00001|reconnect|INFO|log: connecting...
> > 2015-08-11T05:48:55Z|00002|reconnect|INFO|log: connection attempt failed
> > (Address family not supported by protocol family)
> > 2015-08-11T05:48:55Z|00003|reconnect|INFO|log: waiting 1 seconds before
> > reconnect
> 
> Tunnels, including GRE, are currently only supported on Linux.

Besides, you should use service command for starting ovs on FreeBSD rather 
than starting ovs manually:

service ovsdb_server onestart
service ovs_vswitchd onestart

	Kevin

From fbl at sysclose.org  Thu Aug 13 09:45:53 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Thu, 13 Aug 2015 13:45:53 -0300
Subject: [ovs-discuss] Vhost-User port not work and always show 'down'
In-Reply-To: <32bb8e56.1f125.14ef829c4c4.Coremail.wenx05124561@163.com>
References: <CAF4aoupYuHUdVR1aqDMqxatkMVE2z=7sZAeH9+roMG5jCbTtNQ@mail.gmail.com>
 <738D45BC1F695740A983F43CFE1B7EA9437BB4A5@IRSMSX108.ger.corp.intel.com>
 <32bb8e56.1f125.14ef829c4c4.Coremail.wenx05124561@163.com>
Message-ID: <20150813164553.GA7795@x240.home>

On Tue, Aug 04, 2015 at 06:02:43PM +0800, wenxu wrote:
> I build a ovs-dpdk and vhost-user POC through INSTALL.DPDK.md.
> My host is centos7.0
> There is a br0 with dpdk0 and vhost-user-0
> I build dpdk with 2.0.0 and ovs with branch 2.4
> # ovs-vsctl show
> ovs-vsctl show
> c38093a7-6c7e-4d6a-a7c1-627d95acbdc6
>     Bridge "br0"
>         Port "br0"
>             Interface "br0"
>                 type: internal
>         Port "vhost-user-0"
>             Interface "vhost-user-0"
>                 type: dpdkvhostuser
>         Port "dpdk0"
>             Interface "dpdk0"
>                 type: dpdk
> 
> I setup a virtual machine succesfully. qemu version is 2.3.0 which is ok for vhost-user
> 
> # qemu-system-x86_64 -smp 2 -m 1024 -hda ubuntu.img -vnc :1 -chardev socket,id=char1,path=/usr/local/var/run/openvswitch/vhost-user-0 -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce -device virtio-net-pci,mac=22:33:44:55:66:77,netdev=mynet1 -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on -numa node,memdev=mem -mem-prealloc
> 
> qemu-system-x86_64: -netdev type=vhost-user,id=mynet1,chardev=char1,vhostforce: chardev "char1" went up
> 
> I set the br0 10.0.0.2/24 and virtual machine eth0 10.0.0.1/24
> But they can't ping each other
> 
> # ovs-ofctl dump-flows br0
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=79598.075s, table=0, n_packets=445, n_bytes=27204, idle_age=0, hard_age=65534, priority=0 actions=NORMAL
> 
> # ovs-vsctl list interface vhost-user-0
> _uuid               : ca02a658-3f7f-4133-8b3c-cfc776154d38
> admin_state         : down
> bfd                 : {}
> bfd_status          : {}
> cfm_fault           : []
> cfm_fault_status    : []
> cfm_flap_count      : []
> cfm_health          : []
> cfm_mpid            : []
> cfm_remote_mpids    : []
> cfm_remote_opstate  : []
> duplex              : []
> error               : []
> external_ids        : {}
> ifindex             : 0
> ingress_policing_burst: 0
> ingress_policing_rate: 0
> lacp_current        : []
> link_resets         : 1
> link_speed          : []
> link_state          : down
> lldp                : {}
> mac                 : []
> mac_in_use          : "00:00:00:00:00:00"
> mtu                 : 1500
> name                : "vhost-user-0"
> ofport              : 4
> ofport_request      : []
> options             : {}
> other_config        : {}
> statistics          : {rx_packets=0, tx_dropped=36, tx_packets=0}
> status              : {}
> type                : dpdkvhostuser
> 
> I  can see the vhost-user-0 port always show down and there are some dropped packets which are sent from br0.

It would be nice if you could provide the ovs-vswitch.log to see if
the vhost user succeed and if it is attached properly otherwise there
will be tx_dropped.

Also, the command line used to start ovs-vswitchd.

fbl



From fbl at sysclose.org  Thu Aug 13 09:52:51 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Thu, 13 Aug 2015 13:52:51 -0300
Subject: [ovs-discuss] Deleting internal ports takes too long
In-Reply-To: <CADtzDCnQQh+dNf6yybSaS7NatXbYfnVw=JPMsCDvQStcLNJ+UA@mail.gmail.com>
References: <CADtzDCnQQh+dNf6yybSaS7NatXbYfnVw=JPMsCDvQStcLNJ+UA@mail.gmail.com>
Message-ID: <20150813165251.GB7795@x240.home>

On Thu, Aug 06, 2015 at 03:08:16PM -0700, Han Zhou wrote:
> Hello Folks,
> 
> I am facing a problem of internal port deletion.
> In neutron dhcp node, it use ovs internal ports for dhcp interfaces
> for virtual networks.
> During cleanup, it takes around 500ms to delete a port. It is
> producation environment, so I cannot do much testing.
> But in my testing environment it is 10 times faster.
> Is there a quick answer why deleting an internal port would take so
> long in that production env?
> 
> The command I used was:
> ovs-vsctl del-port br-int <port name>
> 
> Note:
> 
> - the ports are in namespaces.
> - there are hundreds of such ports (but in my testing env I created
> same number of ports and it was still 10 times faster than the
> production env)

You could try deleting a bunch of interfaces at once to avoid the
cost of reading all the configuration on every operation.

ovs-vsctl del-port <bridge> <port1> -- del-port <bridge> <port2> ...

fbl


From fbl at sysclose.org  Thu Aug 13 09:59:45 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Thu, 13 Aug 2015 13:59:45 -0300
Subject: [ovs-discuss] speed of execution.
In-Reply-To: <AM2PR04MB09144EB51C1961FA8E091D2788720@AM2PR04MB0914.eurprd04.prod.outlook.com>
References: <AM2PR04MB09144EB51C1961FA8E091D2788720@AM2PR04MB0914.eurprd04.prod.outlook.com>
Message-ID: <20150813165945.GC7795@x240.home>

On Sat, Aug 08, 2015 at 03:45:55PM +0000, Amal KAMMOUN wrote:
> Dear all,
> 
> My question is about the processing speed of packets in OVS.
> 
> I mean that when a traffic comes to an OVS, in how much speed the OVS will treat the packets?

The answer depends on many factors, but you can assume that it's fast.
fbl



From zhouhan at gmail.com  Thu Aug 13 12:16:53 2015
From: zhouhan at gmail.com (Han Zhou)
Date: Thu, 13 Aug 2015 12:16:53 -0700
Subject: [ovs-discuss] Deleting internal ports takes too long
In-Reply-To: <20150813165251.GB7795@x240.home>
References: <CADtzDCnQQh+dNf6yybSaS7NatXbYfnVw=JPMsCDvQStcLNJ+UA@mail.gmail.com>
 <20150813165251.GB7795@x240.home>
Message-ID: <CADtzDCmVPW8r7_qukVDN30Uo7HduPzMs93RDhgSsJuDLXov2Og@mail.gmail.com>

On Thu, Aug 13, 2015 at 9:52 AM, Flavio Leitner <fbl at sysclose.org> wrote:
>
> You could try deleting a bunch of interfaces at once to avoid the
> cost of reading all the configuration on every operation.
>
> ovs-vsctl del-port <bridge> <port1> -- del-port <bridge> <port2> ...
>
> fbl
>

Hi Flavio,

Good suggestion!
Yes, the time spent are mostly caused by the ovsdb transaction
including the change notification to the controller.
So combining multiple ports deletion in one transaction reduces the
time significantly.

Thanks,
Han

From abhishekv.verma at gmail.com  Fri Aug 14 07:09:50 2015
From: abhishekv.verma at gmail.com (Abhishek Verma)
Date: Fri, 14 Aug 2015 19:39:50 +0530
Subject: [ovs-discuss] GRE ports missing in ovs-dpctl
Message-ID: <CADDmorT7R0KaMOjXj-3zyXSH4KkDdvapEaH0ib5NAe090_mLyg@mail.gmail.com>

Hi,

I downloaded the latest OVS code from the git repository and i notice that
i dont see the GRE ports as separate ports in the data plane. There now
appears only one GRE port gre_sys that represents all the GRE ports in the
system.

root@:/home/akabra# ovs-dpctl show
system at ovs-system:
lookups: hit:331101 missed:1090 lost:0
flows: 1
masks: hit:584458 total:1 hit/pkt:1.76
port 0: ovs-system (internal)
port 1: ion1 (internal)
port 2: gre_sys (gre)

Can somebody tell me why this change was done? Wasnt the earlier
abstraction (at least till 2.3.2) better since each GRE tunnel was an OF
port (or a dataplane port) and it was quite intuitive to write the of-flow
rules since i could identify the GRE tunnel by a port. We seem to have lost
that abstraction. Is there a benefit we get by doing this -- performance
gain, etc?

Thanks, Abhishek
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150814/60f4a8b0/attachment.html>

From abhishekv.verma at gmail.com  Fri Aug 14 10:04:07 2015
From: abhishekv.verma at gmail.com (Abhishek Verma)
Date: Fri, 14 Aug 2015 22:34:07 +0530
Subject: [ovs-discuss] Not picking up latest OVS kernel module
Message-ID: <CADDmorS4n1SXiG_zPcpWbRdjh7hbaYSNPJcD7c43OZtmvSQGPQ@mail.gmail.com>

Hi,

I am building the latest OVS code downloaded from git repository

root at ip-172-31-4-210:/home/ubuntu/ovs# ovs-vswitchd --version
ovs-vswitchd (Open vSwitch) 2.4.90
Compiled Aug 14 2015 09:21:16
root at ip-172-31-4-210:/home/ubuntu/ovs#

However, it seems to be still using the old ovs kernel modules.

root at ip-172-31-4-210:/home/ubuntu/ovs# lsmod | grep open
openvswitch            66908  0
vxlan                  37619  1 openvswitch
gre                    13796  1 openvswitch
libcrc32c              12644  1 openvswitch
root at ip-172-31-4-210:/home/ubuntu/ovs#

Any idea on how i can get it to use the compiled OVS kernel module?

Thanks, Abhishek
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150814/954a8771/attachment.html>

From davidjoshuaevans at gmail.com  Fri Aug 14 11:08:10 2015
From: davidjoshuaevans at gmail.com (David Evans)
Date: Fri, 14 Aug 2015 13:08:10 -0500
Subject: [ovs-discuss] custom packet actions and recirc.
Message-ID: <D1F398BA.3095C%davidjoshuaevans@gmail.com>

Hi OVS wizards!

What is the alchemy behind  the fn below in compose mpls push action.

    ctx->xout->slow |= commit_odp_actions(flow, &ctx->base_flow,

                                              ctx->odp_actions,

                                              ctx->wc, use_masked);


Where it appears in ofproto-dpif-xlate.c  in some compose actions.

Is it a thing I need in my custom compose actions if I want recirculation to
work properly after manipulating packets?

Cheers,
Dave.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150814/be380469/attachment.html>

From davewaters1970 at gmail.com  Fri Aug 14 17:26:08 2015
From: davewaters1970 at gmail.com (Dave Waters)
Date: Sat, 15 Aug 2015 05:56:08 +0530
Subject: [ovs-discuss] GRE ports missing in ovs-dpctl
In-Reply-To: <CADDmorT7R0KaMOjXj-3zyXSH4KkDdvapEaH0ib5NAe090_mLyg@mail.gmail.com>
References: <CADDmorT7R0KaMOjXj-3zyXSH4KkDdvapEaH0ib5NAe090_mLyg@mail.gmail.com>
Message-ID: <CAARSoVxc70K13yr1aL_kyzi5jQOyHiKGYofv_5cPzo887Yyq8g@mail.gmail.com>

>
>
> I downloaded the latest OVS code from the git repository and i notice that
> i dont see the GRE ports as separate ports in the data plane. There now
> appears only one GRE port gre_sys that represents all the GRE ports in the
> system.
>

In the dataplane yes. However, from the OF view, each GRE tunnel is still
assigned a different OF port.


>
> root@:/home/akabra# ovs-dpctl show
> system at ovs-system:
> lookups: hit:331101 missed:1090 lost:0
> flows: 1
> masks: hit:584458 total:1 hit/pkt:1.76
> port 0: ovs-system (internal)
> port 1: ion1 (internal)
> port 2: gre_sys (gre)
>
> Can somebody tell me why this change was done? Wasnt the earlier
> abstraction (at least till 2.3.2) better since each GRE tunnel was an OF
> port (or a dataplane port) and it was quite intuitive to write the of-flow
> rules since i could identify the GRE tunnel by a port. We seem to have lost
> that abstraction. Is there a benefit we get by doing this -- performance
> gain, etc?
>

I dont know why this was done, but you can still add flow rules by
specifying the in_port as a GRE OF port, so the abstraction that you liked
still exists.

Dave

>
> Thanks, Abhishek
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150815/e636fb8b/attachment.html>

From davewaters1970 at gmail.com  Fri Aug 14 17:27:11 2015
From: davewaters1970 at gmail.com (Dave Waters)
Date: Sat, 15 Aug 2015 05:57:11 +0530
Subject: [ovs-discuss] speed of execution.
In-Reply-To: <20150813165945.GC7795@x240.home>
References: <AM2PR04MB09144EB51C1961FA8E091D2788720@AM2PR04MB0914.eurprd04.prod.outlook.com>
 <20150813165945.GC7795@x240.home>
Message-ID: <CAARSoVwo4zDEeb22OZskLGhs+QvhsjZvS4vpXbJ7uFNh0Q3inA@mail.gmail.com>

Its much faster than the linux bridge and also a tad faster than linux
routing. But completely depends upon your configuration and setup.

Dave

On Thu, Aug 13, 2015 at 10:29 PM, Flavio Leitner <fbl at sysclose.org> wrote:

> On Sat, Aug 08, 2015 at 03:45:55PM +0000, Amal KAMMOUN wrote:
> > Dear all,
> >
> > My question is about the processing speed of packets in OVS.
> >
> > I mean that when a traffic comes to an OVS, in how much speed the OVS
> will treat the packets?
>
> The answer depends on many factors, but you can assume that it's fast.
> fbl
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150815/1a117a2b/attachment.html>

From davewaters1970 at gmail.com  Fri Aug 14 17:29:31 2015
From: davewaters1970 at gmail.com (Dave Waters)
Date: Sat, 15 Aug 2015 05:59:31 +0530
Subject: [ovs-discuss] Deep Packet Inspection possible?
In-Reply-To: <CAEP_g=8AmU3LBG4_NbW4G70SGWJOrX9KMDeoowrjpB7h12dhAg@mail.gmail.com>
References: <CAARSoVx-trjuM4WRdrUZYTGPHCSxzCEoyNmy2S_dK3zaV4kEZQ@mail.gmail.com>
 <CAEP_g=8AmU3LBG4_NbW4G70SGWJOrX9KMDeoowrjpB7h12dhAg@mail.gmail.com>
Message-ID: <CAARSoVwK4FCNTJvwoxOwzicOzb9GzD88z-xQ=jJzaHdt2Mdpcg@mail.gmail.com>

I took a look at P4 and i thought it was primarily for HW devices. Let me
see how i can use that with OVS.

Can you give me the function in the code that i could start looking at if i
want to make custom changes to deep inspect the packet in OVS. Some
starting point would help.

Dave

On Wed, Aug 12, 2015 at 5:02 AM, Jesse Gross <jesse at nicira.com> wrote:

> On Mon, Aug 10, 2015 at 11:55 AM, Dave Waters <davewaters1970 at gmail.com>
> wrote:
> > Hi,
> >
> > Can i use OVS to deep inspect beyond the L4 headers inside the packet.
> If i
> > know the exact encapsulations then can i for example look at say, the 1st
> > bit in the 110th byte of the incoming packet?
> >
> > When i say i know the exact encapsulation, i mean that i know that its an
> > untagged plain IPv4 UDP/TCP packet.
>
> No, OVS doesn't have an ability to grab arbitrary byte offsets into the
> packet.
>
> In general, I think there are too many corner cases for this to be the
> right solution for OVS to expose for most people. I would rather see
> an implementation of a flexible parser like P4 as the way to achieve
> this.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150815/ba7dee9c/attachment.html>

From jesse at nicira.com  Fri Aug 14 17:56:41 2015
From: jesse at nicira.com (Jesse Gross)
Date: Fri, 14 Aug 2015 17:56:41 -0700
Subject: [ovs-discuss] Deep Packet Inspection possible?
In-Reply-To: <CAARSoVwK4FCNTJvwoxOwzicOzb9GzD88z-xQ=jJzaHdt2Mdpcg@mail.gmail.com>
References: <CAARSoVx-trjuM4WRdrUZYTGPHCSxzCEoyNmy2S_dK3zaV4kEZQ@mail.gmail.com>
 <CAEP_g=8AmU3LBG4_NbW4G70SGWJOrX9KMDeoowrjpB7h12dhAg@mail.gmail.com>
 <CAARSoVwK4FCNTJvwoxOwzicOzb9GzD88z-xQ=jJzaHdt2Mdpcg@mail.gmail.com>
Message-ID: <CAEP_g=98hqZE24--jL+FCe9pR4E0Zs8LTQiPWFKnq30rcM57ew@mail.gmail.com>

On Fri, Aug 14, 2015 at 5:29 PM, Dave Waters <davewaters1970 at gmail.com> wrote:
> I took a look at P4 and i thought it was primarily for HW devices. Let me
> see how i can use that with OVS.
>
> Can you give me the function in the code that i could start looking at if i
> want to make custom changes to deep inspect the packet in OVS. Some starting
> point would help.

>From the FAQ:

### Q: How do I add support for a new field or header?

A: Add new members for your field to "struct flow" in lib/flow.h, and
   add new enumerations for your new field to "enum mf_field_id" in
   lib/meta-flow.h, following the existing pattern.  Also, add support
   to miniflow_extract() in lib/flow.c for extracting your new field
   from a packet into struct miniflow.  Then recompile and fix all of
   the new warnings, implementing new functionality for the new field
   or header as needed.  (If you configure with --enable-Werror, as
   described in [INSTALL.md], then it is impossible to miss any
   warnings.)

   If you want kernel datapath support for your new field, you also
   need to modify the kernel module for the operating systems you are
   interested in.  This isn't mandatory, since fields understood only
   by userspace work too (with a performance penalty), so it's
   reasonable to start development without it.  If you implement
   kernel module support for Linux, then the Linux kernel "netdev"
   mailing list is the place to submit that support first; please read
   up on the Linux kernel development process separately.  The Windows
   datapath kernel module support, on the other hand, is maintained
   within the OVS tree, so patches for that can go directly to
   ovs-dev.

From jun.xiao at cloudnetengine.com  Sat Aug 15 09:11:59 2015
From: jun.xiao at cloudnetengine.com (Jun Xiao)
Date: Sun, 16 Aug 2015 00:11:59 +0800
Subject: [ovs-discuss] =?utf-8?q?More_performance_comparisons_on_virtual_s?=
	=?utf-8?q?witches?=
Message-ID: <----Tc------lRRzc$c24dd4bf-575a-458c-85ce-f90eead6da5b@cloudnetengine.com>

Hi All,
Since we announced CloudNetEngine virtual switch technical preview, we received quite a few very good suggestions/feedbacks from evaluation customers, thank you all!

Today we release CloudNetEngine vSwitch technical preview update 1, which includes a number of performance improvements over last few weeks. Here we also share more performance comparisons on Native kernel OVS, OVS-DPDK, and CNE vSwitch technical preview update 1. The methodology for the comparison is also commonly used by virtualization vendors, i.e. end to end TCP throughput/CPU usage, and TCP_RR transaction throughput. 

A few key observations:

- OVS-DPDK is not designed to optimize for intra VMs communication, its tcp throughput is even worse than Native kernel OVS.

- OVS-DPDK only wins at TCP_RR, and this is reasonable as it always keep a CPU core 100% busy.

- CNE vSwitch wins on almost all metrics (except OVS_DPDK's TCP_RR), and its TCP throughput/CPU efficiency is around 3X against Native kernel OVS while also provides better TCP_RR throughput than Native kernel OVS.

For more information, please refer to http://cloudnetengine.com/en/blog/2015/08/15/more/

If you want to try CNE vSwitch technical preview update 1, please don't hesitate to send a evaluation request to info at cloudnetengine.com.
Thanks,Jun Xiaowww.cloudnetengine.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150816/a2b9225a/attachment-0001.html>

From tony.vanderpeet at gmail.com  Mon Aug 17 20:00:12 2015
From: tony.vanderpeet at gmail.com (Tony van der Peet)
Date: Tue, 18 Aug 2015 15:00:12 +1200
Subject: [ovs-discuss] Possible new issue with flow modification
Message-ID: <CAKL=qh_h3cUxX29GE8O3MfTiJAhXnWes+ORxETY7wkEQOa_-PA@mail.gmail.com>

Hi

I have just upgraded to the tip of master, and some of my regression
tests are failing, but only when run as a group - individually they
pass.

Not done with my investigations yet, but it looks as though Ethan
Jackson's recent commit might have something to do with it.

https://github.com/openvswitch/ovs/commit/43b2f131a229238619ed9ae9ee64092fcae092ca

In a nutshell, flows created for earlier tests are being kept alive
and having their actions modified, but then the modification as a
result of a later test causes that later test to fail.

Here's the flow in the first test:

recirc_id(0),in_port(1),eth_type(0x0800),ipv4(proto=17,frag=no),
packets:0, bytes:0, used:never, actions:2

It undergoes a few mods over the next few tests:

recirc_id(0),in_port(1),eth_type(0x0800),ipv4(proto=17,frag=no),
packets:1, bytes:104, used:3.754s,
actions:userspace(pid=0,slow_path(controller))

recirc_id(0),in_port(1),eth_type(0x0800),ipv4(proto=17,frag=no),
packets:1, bytes:104, used:8.065s, actions:drop

But ends up as:

recirc_id(0),in_port(1),eth_type(0x0800),ipv4(proto=17,frag=no),
packets:3, bytes:304, used:10.135s, actions:2

when the rule becomes:

duration=2s, n_packets=0, n_bytes=0,
priority=1000,vlan_tci=0x0000/0x1fff,actions=output:2

Disregarding the flow's age, any UDP packet sent, VLAN or not, will
result in output:2, but this is not the correct action for all packets
(those with a VLAN tag).

My guess is that this is fairly deep and beyond my limited experience
with OpenVSwitch. However, I will continue to work this issue, but
thought you might like to know. And any advice much appreciated.

Tony

From fan.du at intel.com  Tue Aug 18 02:56:01 2015
From: fan.du at intel.com (Du, Fan)
Date: Tue, 18 Aug 2015 09:56:01 +0000
Subject: [ovs-discuss] Query about user space vxlan tunneling setup
Message-ID: <5A90DA2E42F8AE43BC4A093BF0678848EC1F1C@SHSMSX104.ccr.corp.intel.com>

Hi folks

While trying to integrate dpdkvhostuser port with user space Vxlan tunneling as described in ovs/README-native-tunneling.md,
My setup topology is as below, all bridges are in user space.

On host 1:
Ping VM2
VM1(10.0.1.2) <------> dpdk-vhostuser <------> br-int <------> Vxlan <------> br-ex(192.168.1.2) <------> dpdk0 <------> NIC
                         ^                                 ^
                         |                                 |
                       dummy0                          dummy1


#Setup br-int, attach dpdkvhostuser and vxlan ports to it
ovs-vsctl add-br br-int -- set bridge br-int datapath_type=netdev
ovs-vsctl add-port br-int vhost-user-1 -- set Interface vhost-user-1 type=dpdkvhostuser
ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=191.168.1.2 options:key=99
ovs-ofctl add-flow br-int arp,action=normal

#Setup br-ex, attach dpdk0 to it, so packets can hit on wire
ovs-vsctl add-br br-ex -- set bridge br-ex datapath_type=netdev
ovs-vsctl add-port br-ex dpdk0 -- set Interface dpdk0 type=dpdk
ifconfig br-ex 192.168.1.4/24
ovs-appctl ovs/route/add 192.168.1.4/24 br-ex
ovs-ofctl add-flow br-ex arp,action=normal

#Setup mirror ports to tcpdump packets
rmmod dummy
modprobe dummy numdummies=2
ifconfig dummy0 up
ifconfig dummy1 up
ovs-vsctl add-port br-ex dummy1   -- --id=@p get port dummy1  -- --id=@m create mirror name=m0 select-all=true output-port=@p -- set bridge br-ex mirrors=@m
ovs-vsctl add-port br-int dummy0   -- --id=@p get port dummy0  -- --id=@m create mirror name=m0 select-all=true output-port=@p -- set bridge br-int mirrors=@m


On host 2:
VM2(10.0.1.4) <------> dpdk-vhostuser <------> br-int <------> Vxlan <------> br-ex(192.168.1.4) <------> dpdk0 <------> NIC
                         ^                                 ^
                         |                                 |
                       dummy0                          dummy1
Host2 use the same configuration as host1 except for the ip address.

On host1 VM1 ping its peer VM2:
1.      When not employing Vxlan interface, just dpdk-hostuser <--> br-int <--> dpdk0 style setup, traffic between VM1 and VM2
   goes well.
2.      When integrated Vxlan interface as above topology, on host1, ping VM1, I can tcpdump arp packet on dummy0 port,
   On dummy1, Vxlan encapsulated arp packet for guest packet did show up as expected. As a result connectivity is broken.

# ovs-ofctl dump-ports br-int
OFPST_PORT reply (xid=0x2): 4 ports
  port LOCAL: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=16, bytes=2544, drop=0, errs=0, coll=0
  port  1: rx pkts=16, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
           tx pkts=0, bytes=?, drop=0, errs=?, coll=?
  port  2: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=16, bytes=2544, drop=0, errs=0, coll=0
  port  3: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=19, bytes=2754, drop=0, errs=0, coll=0
# ovs-vsctl get Interface vxlan1 ofport
2
# ovs-vsctl get Interface vhost-user-1 ofport
1
]# ovs-vsctl show
af3f1e06-82e6-4bc1-9074-b90377ef32fa
    Bridge br-ex
        Port "dummy1"
            Interface "dummy1"
        Port "dpdk0"
            Interface "dpdk0"
                type: dpdk
        Port br-ex
            Interface br-ex
                type: internal
    Bridge br-int
        Port "dummy0"
            Interface "dummy0"
        Port "vhost-user-1"
            Interface "vhost-user-1"
                type: dpdkvhostuser
        Port br-int
            Interface br-int
                type: internal
        Port "vxlan1"
            Interface "vxlan1"
                type: vxlan
                options: {key="99", remote_ip="191.168.1.2"}

It seems vxlan1 ports did do its job, but why does the encapsulated Vxlan packets didn't route into br-ex
as commanded by "ovs-appctl ovs/route/add 192.168.1.4/24 br-ex" from README-native-tunneling.md

Did I missing anything else obviously? Any hint/suggestion would be appreciated.








-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150818/8c49575c/attachment.html>

From standulwadka at avaya.com  Tue Aug 18 07:16:35 2015
From: standulwadka at avaya.com (Tandulwadkar, Sanket Ravindra (Sanket Ravindra))
Date: Tue, 18 Aug 2015 14:16:35 +0000
Subject: [ovs-discuss] OFFrameDecoder.Decode() did not read anything but
	decoded a message
Message-ID: <9CE18184B620BC45BF38C3D5361BCDA8034F5D@AZ-US1EXMB01.global.avaya.com>

Hello,

I am trying to add TLS support to ODL. When I try to check if the connection is established, I get a handshake failure at ODL.

On OvS VM:

openssl s_client -connect 172.31.1.2:6633 -ssl3

On ODL log:

2015-08-18 09:43:14,828 | WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 - org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium | Unexpected exception from downstream. io.netty.handler.codec.DecoderException: OFFrameDecoder.decode() did not read anything but decoded a message. at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:334)[144:io.netty.codec:4.0.26.Final] at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:229)[144:io.netty.codec:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)[118:io.netty.transport:4.0.26.Final] at io.netty.handler.timeout.ReadTimeoutHandler.channelRead(ReadTimeoutHandler.java:150)[145:io.netty.handler:4.0.26.Final] at org.opendaylight.openflowjava.protocol.impl.core.IdleHandler.channelRead(IdleHandler.java:39)[213:org.opendaylight.openflowjava.openflow-protocol-impl:0.6.0.Lithium] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.ChannelInboundHandlerAdapter.channelRead(ChannelInboundHandlerAdapter.java:86)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:847)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:131)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:511)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:468)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:382)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:349)[118:io.netty.transport:4.0.26.Final] at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)[119:io.netty.common:4.0.26.Final] at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)[119:io.netty.common:4.0.26.Final] at java.lang.Thread.run(Thread.java:745)[:1.7.079] 2015-08-18 09:43:14,828 | WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 - org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium | Closing connection. 2015-08-18 09:43:14,833 | WARN | entLoopGroup-6-1 | SessionManagerOFImpl | 216 - org.opendaylight.openflowplugin - 0.1.0.Lithium | context for invalidation not found 2015-08-18 09:43:14,834 | WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 - org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium | Unexpected exception from downstream. io.netty.handler.codec.DecoderException: OFFrameDecoder.decode() did not read anything but decoded a message. at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:334)[144:io.netty.codec:4.0.26.Final] at io.netty.handler.codec.ByteToMessageDecoder.channelInactive(ByteToMessageDecoder.java:271)[144:io.netty.codec:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:237)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:223)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.ChannelInboundHandlerAdapter.channelInactive(ChannelInboundHandlerAdapter.java:75)[118:io.netty.transport:4.0.26.Final] at io.netty.handler.timeout.ReadTimeoutHandler.channelInactive(ReadTimeoutHandler.java:144)[145:io.netty.handler:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:237)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:223)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.ChannelInboundHandlerAdapter.channelInactive(ChannelInboundHandlerAdapter.java:75)[118:io.netty.transport:4.0.26.Final] at org.opendaylight.openflowjava.protocol.impl.core.connection.ChannelOutboundQueue.channelInactive(ChannelOutboundQueue.java:256)[213:org.opendaylight.openflowjava.openflow-protocol-impl:0.6.0.Lithium] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:237)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:223)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.DefaultChannelPipeline.fireChannelInactive(DefaultChannelPipeline.java:829)[118:io.netty.transport:4.0.26.Final] at io.netty.channel.AbstractChannel$AbstractUnsafe$7.run(AbstractChannel.java:610)[118:io.netty.transport:4.0.26.Final] at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:328)[119:io.netty.common:4.0.26.Final] at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)[118:io.netty.transport:4.0.26.Final] at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)[119:io.netty.common:4.0.26.Final] at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)[119:io.netty.common:4.0.26.Final] at java.lang.Thread.run(Thread.java:745)[:1.7.079] 2015-08-18 09:43:14,834 | WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 - org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium | Closing connection. 2015-08-18 09:43:14,836 | INFO | entLoopGroup-6-1 | ConnectionConductorImpl | 216 - org.opendaylight.openflowplugin - 0.1.0.Lithium | OF handshake failed, doing cleanup.

Is this a known issue? Or am I doing something wrong?



--Sanket

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150818/d6ecb3f2/attachment.html>

From Gabe.Black at viavisolutions.com  Tue Aug 18 16:32:56 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Tue, 18 Aug 2015 23:32:56 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>

Hi Sean,

I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.

For now, I am trying to get a single host set up to try and keep it as simple as possible.

I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example

Changes that I have made in order to get things to work on Ubuntu, are the following:

====================================================

networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454

+    qemu_group=`id -ng $qemu_group`

Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."

====================================================

The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.

It seems that with those changes devstack.sh is be able to complete.  

--------------------------------

There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:
...
2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.
...

Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain)
...
VHOST_CONFIG: socket created, fd:52
VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1
2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1
2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node
2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 
...

I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).

=====================================================

Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:

Hugetable-backed memory:

<memoryBacking>
    <hugepages/>
  </memoryBacking>

Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 )
<qemu:commandline>
    <qemu:arg value='-chardev'/>
    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>
    <qemu:arg value='-netdev'/>
    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>
    <qemu:arg value='-device'/>
    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>
  </qemu:commandline>

Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:

1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"
- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..

2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied. 

I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).

I feel I am close, and would appreciate any advice you might have.

Very best,
Gabriel Black




From shettyg at nicira.com  Wed Aug 19 09:51:26 2015
From: shettyg at nicira.com (Gurucharan Shetty)
Date: Wed, 19 Aug 2015 09:51:26 -0700
Subject: [ovs-discuss] OFFrameDecoder.Decode() did not read anything but
 decoded a message
In-Reply-To: <9CE18184B620BC45BF38C3D5361BCDA8034F5D@AZ-US1EXMB01.global.avaya.com>
References: <9CE18184B620BC45BF38C3D5361BCDA8034F5D@AZ-US1EXMB01.global.avaya.com>
Message-ID: <CAHbON5rgMFcm7oXjBA0tPsGweu_8=htSdZ_86dCrSGPAyQpMQg@mail.gmail.com>

I think you should read the following document:
https://github.com/openvswitch/ovs/blob/master/INSTALL.SSL.md

Then have ovs-vsctl speak to ovsdb-server over ssl. Once you can get
that working, you should try integrating with ODL. Hardly anyone
active in this list know much about ODL, so you will likely not get
any answer to ODL specific questions.

(SSL support has been there in OVS for a long time, and there are
multiple unit tests that continuously test them and multiple products
that have been using SSL support with OVS for many years.)

On Tue, Aug 18, 2015 at 7:16 AM, Tandulwadkar, Sanket Ravindra (Sanket
Ravindra) <standulwadka at avaya.com> wrote:
> Hello,
>
> I am trying to add TLS support to ODL. When I try to check if the connection
> is established, I get a handshake failure at ODL.
>
> On OvS VM:
>
> openssl s_client -connect 172.31.1.2:6633 -ssl3
>
> On ODL log:
>
> 2015-08-18 09:43:14,828 | WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 -
> org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium |
> Unexpected exception from downstream.
> io.netty.handler.codec.DecoderException: OFFrameDecoder.decode() did not
> read anything but decoded a message. at
> io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:334)[144:io.netty.codec:4.0.26.Final]
> at
> io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:229)[144:io.netty.codec:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.handler.timeout.ReadTimeoutHandler.channelRead(ReadTimeoutHandler.java:150)[145:io.netty.handler:4.0.26.Final]
> at
> org.opendaylight.openflowjava.protocol.impl.core.IdleHandler.channelRead(IdleHandler.java:39)[213:org.opendaylight.openflowjava.openflow-protocol-impl:0.6.0.Lithium]
> at
> io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.ChannelInboundHandlerAdapter.channelRead(ChannelInboundHandlerAdapter.java:86)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:339)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:324)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:847)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:131)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:511)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:468)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:382)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:349)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)[119:io.netty.common:4.0.26.Final]
> at
> io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)[119:io.netty.common:4.0.26.Final]
> at java.lang.Thread.run(Thread.java:745)[:1.7.079] 2015-08-18 09:43:14,828 |
> WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 -
> org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium |
> Closing connection. 2015-08-18 09:43:14,833 | WARN | entLoopGroup-6-1 |
> SessionManagerOFImpl | 216 - org.opendaylight.openflowplugin - 0.1.0.Lithium
> | context for invalidation not found 2015-08-18 09:43:14,834 | WARN |
> entLoopGroup-6-1 | OFFrameDecoder | 213 -
> org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium |
> Unexpected exception from downstream.
> io.netty.handler.codec.DecoderException: OFFrameDecoder.decode() did not
> read anything but decoded a message. at
> io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:334)[144:io.netty.codec:4.0.26.Final]
> at
> io.netty.handler.codec.ByteToMessageDecoder.channelInactive(ByteToMessageDecoder.java:271)[144:io.netty.codec:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:237)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:223)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.ChannelInboundHandlerAdapter.channelInactive(ChannelInboundHandlerAdapter.java:75)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.handler.timeout.ReadTimeoutHandler.channelInactive(ReadTimeoutHandler.java:144)[145:io.netty.handler:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:237)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:223)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.ChannelInboundHandlerAdapter.channelInactive(ChannelInboundHandlerAdapter.java:75)[118:io.netty.transport:4.0.26.Final]
> at
> org.opendaylight.openflowjava.protocol.impl.core.connection.ChannelOutboundQueue.channelInactive(ChannelOutboundQueue.java:256)[213:org.opendaylight.openflowjava.openflow-protocol-impl:0.6.0.Lithium]
> at
> io.netty.channel.AbstractChannelHandlerContext.invokeChannelInactive(AbstractChannelHandlerContext.java:237)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannelHandlerContext.fireChannelInactive(AbstractChannelHandlerContext.java:223)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.DefaultChannelPipeline.fireChannelInactive(DefaultChannelPipeline.java:829)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.channel.AbstractChannel$AbstractUnsafe$7.run(AbstractChannel.java:610)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:328)[119:io.netty.common:4.0.26.Final]
> at
> io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)[118:io.netty.transport:4.0.26.Final]
> at
> io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)[119:io.netty.common:4.0.26.Final]
> at
> io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)[119:io.netty.common:4.0.26.Final]
> at java.lang.Thread.run(Thread.java:745)[:1.7.079] 2015-08-18 09:43:14,834 |
> WARN | entLoopGroup-6-1 | OFFrameDecoder | 213 -
> org.opendaylight.openflowjava.openflow-protocol-impl - 0.6.0.Lithium |
> Closing connection. 2015-08-18 09:43:14,836 | INFO | entLoopGroup-6-1 |
> ConnectionConductorImpl | 216 - org.opendaylight.openflowplugin -
> 0.1.0.Lithium | OF handshake failed, doing cleanup.
>
> Is this a known issue? Or am I doing something wrong?
>
>
>
> --Sanket
>
>
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>

From sean.k.mooney at intel.com  Wed Aug 19 13:04:34 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Wed, 19 Aug 2015 20:04:34 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>

Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch


I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150819/d8a65de7/attachment-0001.html>

From jpettit at nicira.com  Wed Aug 19 15:12:29 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Wed, 19 Aug 2015 15:12:29 -0700
Subject: [ovs-discuss] OVS Conference Hotel Discount Code
Message-ID: <FFF5AFE9-DD81-40BD-864F-1828D36A9A29@nicira.com>

A few people had asked whether a discount code is available for those who wanted to stay at the conference hotel.  I was just informed that one is available for those who mention "OVS Con" when booking at the Doubletree Hotel San Jose.  We will continue to update the EventBrite page with the latest information:

    https://www.eventbrite.com/e/open-vswitch-fall-2015-conference-tickets-18029784571

If you have any questions, feel free to contact us at ovscon at openvswitch.org.

Thanks,

--Justin



From blp at nicira.com  Wed Aug 19 15:54:10 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 15:54:10 -0700
Subject: [ovs-discuss] tc ingress qdisc of tapB disappeared when
 del-port tapA from bridge
In-Reply-To: <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
References: <1c0e8fce.1792d.14eb3811fcd.Coremail.ychen103103@163.com>
 <20150722153415.GC28552@nicira.com>
 <5ecd6666.62cd.14eb8e5c3ac.Coremail.ychen103103@163.com>
 <20150723155141.GD3888@nicira.com>
 <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
Message-ID: <20150819225410.GF860@nicira.com>

On Mon, Aug 10, 2015 at 09:36:51PM +0800, ychen wrote:
> There are still something puzzled me, can you do some help?
> 1. what's the meaning of the flag VALID_POLICING?
>    I don't see any meaning of the flag VALID_POLICING in function netdev_linux_set_policing().
>    you see, whether the parameter "kbits_rate"equals to 0, the clause netdev->cache_valid |= VALID_POLICING; will be executed only if the conditions matches error !=0 

I don't think that's true.  The full condition checks for error == 0 or
error == ENODEV:
    if (!error || error == ENODEV) {
        netdev->netdev_policing_error = error;
        netdev->cache_valid |= VALID_POLICING;
    }

>    another strange phenomenon is that, when i set breakpoint on function netdev_linux_set_policing, I found that netdev->cache_valid equals to 0x73 which means VALID_POLICING has set before this function
>    but I can't find anywhere to set this flag except in function netdev_linux_set_policing. why?

I also only see netdev_linux_set_policing() setting this flag.

> 2. which event triggered message RTM_NEWLINK?
>    I found that when use command "add-port br0  tap111", first function netdev_linux_set_policing() will be called, then netdev_linux_update() with message RTM_NEWLINK
>    and this message will lead to netdev->cache_valid to clear the flag VALID_POLICING.
>    my question is, the port tap111 is a system port, I have created it in kernel before add it to ovs bridge.
>    and I didn't to anything like up the port or change the port's namespace or change mtu/mac etc, but why RTM_NEWLINK is trigerred?

I'm not an expert on that aspect of Linux.  You can read the kernel
source code as easily as I can, I guess.

From blp at nicira.com  Wed Aug 19 16:01:17 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 16:01:17 -0700
Subject: [ovs-discuss] dpctl and user-defined flows
In-Reply-To: <CAARSoVxcd77-LYhL7tO-boRg0nmiYTQT4be9Mh=x+Lun5HA73g@mail.gmail.com>
References: <CAARSoVxcd77-LYhL7tO-boRg0nmiYTQT4be9Mh=x+Lun5HA73g@mail.gmail.com>
Message-ID: <20150819230117.GG860@nicira.com>

On Mon, Jul 27, 2015 at 04:50:56AM +0530, Dave Waters wrote:
> When i switch traffic in OVS i see that the dataplane automatically creates
> a flow that i can see with the ovs-dpctl dump-flows command. And then there
> are flows that are created by the user using ofctl add-flow command. One
> difference that i see between the two is that the flows added automatically
> by the data plane are restricted to Layer 3 information (source IP, dest IP
> and protocol type) while the user defined can go all the way till Layer 4
> (UDP source port, UDP dest port, etc).
> 
> So are the ones created by the data plane automatically the "mega flows"
> while the ones created by users the "micro flows"?

No.  Megaflows and microflows are both part of the kernel caching layer.

This paper talks about megaflows and microflows:
        http://benpfaff.org/papers/ovs.pdf

From blp at nicira.com  Wed Aug 19 16:01:32 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 16:01:32 -0700
Subject: [ovs-discuss] dpctl and user-defined flows
In-Reply-To: <CADDmorTV9ZV1wJRj0t5FAE8ysp=mkZoqskTXPyCfimJUYx5EBw@mail.gmail.com>
References: <CAARSoVxcd77-LYhL7tO-boRg0nmiYTQT4be9Mh=x+Lun5HA73g@mail.gmail.com>
 <CADDmorTV9ZV1wJRj0t5FAE8ysp=mkZoqskTXPyCfimJUYx5EBw@mail.gmail.com>
Message-ID: <20150819230132.GH860@nicira.com>

Sorry, that's wrong.

On Mon, Jul 27, 2015 at 06:19:35AM +0530, Abhishek Verma wrote:
> Yes, since ones installed by dataplane only affect forwarding and are hence
> mega-flows.
> 
> On Mon, Jul 27, 2015 at 4:50 AM, Dave Waters <davewaters1970 at gmail.com>
> wrote:
> 
> > Hi,
> >
> > When i switch traffic in OVS i see that the dataplane automatically
> > creates a flow that i can see with the ovs-dpctl dump-flows command. And
> > then there are flows that are created by the user using ofctl add-flow
> > command. One difference that i see between the two is that the flows added
> > automatically by the data plane are restricted to Layer 3 information
> > (source IP, dest IP and protocol type) while the user defined can go all
> > the way till Layer 4 (UDP source port, UDP dest port, etc).
> >
> > So are the ones created by the data plane automatically the "mega flows"
> > while the ones created by users the "micro flows"?
> >
> > Dave
> >
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss
> >
> >

> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss


From ychen103103 at 163.com  Wed Aug 19 19:59:36 2015
From: ychen103103 at 163.com (ychen)
Date: Thu, 20 Aug 2015 10:59:36 +0800 (CST)
Subject: [ovs-discuss] tc ingress qdisc of tapB disappeared when
 del-port tapA from bridge
In-Reply-To: <20150819225410.GF860@nicira.com>
References: <1c0e8fce.1792d.14eb3811fcd.Coremail.ychen103103@163.com>
 <20150722153415.GC28552@nicira.com>
 <5ecd6666.62cd.14eb8e5c3ac.Coremail.ychen103103@163.com>
 <20150723155141.GD3888@nicira.com>
 <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
 <20150819225410.GF860@nicira.com>
Message-ID: <7c2a36fe.b57b.14f490c2590.Coremail.ychen103103@163.com>



1. maybe I am not clearly describe this question.
   what I am want to find out is why VALID_POLICING is still set when kbits_rate equals to 0?
  in openvsiwthc document, it says:

 ingress_policing_rate: integer, at least 0
     Maximum rate for data received on this interface, in kbps. Data received faster than this rate is
     dropped. Set to 0 (the default) to disable policing.


2. ok, for this RTM_NEWLILNK, i wil find it by myself. 
    anyway, thanks!







At 2015-08-20 06:54:10, "Ben Pfaff" <blp at nicira.com> wrote:
>On Mon, Aug 10, 2015 at 09:36:51PM +0800, ychen wrote:
>> There are still something puzzled me, can you do some help?
>> 1. what's the meaning of the flag VALID_POLICING?
>>    I don't see any meaning of the flag VALID_POLICING in function netdev_linux_set_policing().
>>    you see, whether the parameter "kbits_rate"equals to 0, the clause netdev->cache_valid |= VALID_POLICING; will be executed only if the conditions matches error !=0 
>
>I don't think that's true.  The full condition checks for error == 0 or
>error == ENODEV:
>    if (!error || error == ENODEV) {
>        netdev->netdev_policing_error = error;
>        netdev->cache_valid |= VALID_POLICING;
>    }
>
>>    another strange phenomenon is that, when i set breakpoint on function netdev_linux_set_policing, I found that netdev->cache_valid equals to 0x73 which means VALID_POLICING has set before this function
>>    but I can't find anywhere to set this flag except in function netdev_linux_set_policing. why?
>
>I also only see netdev_linux_set_policing() setting this flag.
>
>> 2. which event triggered message RTM_NEWLINK?
>>    I found that when use command "add-port br0  tap111", first function netdev_linux_set_policing() will be called, then netdev_linux_update() with message RTM_NEWLINK
>>    and this message will lead to netdev->cache_valid to clear the flag VALID_POLICING.
>>    my question is, the port tap111 is a system port, I have created it in kernel before add it to ovs bridge.
>>    and I didn't to anything like up the port or change the port's namespace or change mtu/mac etc, but why RTM_NEWLINK is trigerred?
>
>I'm not an expert on that aspect of Linux.  You can read the kernel
>source code as easily as I can, I guess.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/b4a03039/attachment-0001.html>

From blp at nicira.com  Wed Aug 19 21:10:34 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:10:34 -0700
Subject: [ovs-discuss] Arguments to memcmp() must be nonnull
In-Reply-To: <CAHN905JvXVYXFxgA4ZkZYwCOgnBXQ6Drcj=fC5qroGaOhLkEOg@mail.gmail.com>
References: <CAHN905JvXVYXFxgA4ZkZYwCOgnBXQ6Drcj=fC5qroGaOhLkEOg@mail.gmail.com>
Message-ID: <20150820041034.GO860@nicira.com>

On Mon, Aug 10, 2015 at 03:46:45PM +0530, neeraj mehta wrote:
> Hi,
> 
> There is a possible defect in "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2.
> 
> In ovs-ofctl.c, NULL(in certain conditions) being passed as argument in
> memcmp().
> ISO C says that the arguments to memcmp() must not be NULL.
> 
> ---
> 
> "lib/ofpbuf.h" 425L, 14598C OVS-2.3.2
> 
> static inline void * ofpbuf_l3(const struct ofpbuf *b)
> {
>     return b->l3_ofs != UINT16_MAX ? (char *)b->frame + b->l3_ofs : NULL;
> }
> ---
> 
> ---
> "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
> if (ofptype_pull(&type, reply)
>             || type != OFPTYPE_ECHO_REPLY
>             || ofpbuf_size(reply) != payload
>             || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
> ---
> 
> One of possible solutions for this can be:
> 
> ---
> "utilities/ovs-ofctl.c" line 2013 OVS-2.3.2
> if (ofptype_pull(&type, reply)
>              || type != OFPTYPE_ECHO_REPLY
>              || ofpbuf_size(reply) != payload
> +           || !ofpbuf_l3(request) || !ofpbuf_l3(reply)
>              || memcmp(ofpbuf_l3(request), ofpbuf_l3(reply), payload)) {
> ---
> 
> Can someone confirm the above understanding?

Thanks for the report.

Neither of the pointer arguments can be NULL in this case.

From blp at nicira.com  Wed Aug 19 21:13:13 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:13:13 -0700
Subject: [ovs-discuss] _APPLY_ vs _WRITE_ actions
In-Reply-To: <CAB8HAh43xyPo+XWKSBX5YDHbfgk6w3g-BxW3-bVBw3UF7UnSPA@mail.gmail.com>
References: <CAB8HAh43xyPo+XWKSBX5YDHbfgk6w3g-BxW3-bVBw3UF7UnSPA@mail.gmail.com>
Message-ID: <20150820041313.GP860@nicira.com>

On Mon, Aug 10, 2015 at 02:42:18PM -0500, David Evans wrote:
> I would like to OFPTFPT13_APPLY_ACTIONS and have have subsequent table
> matches on the modified packet.
> The OpenFlow spec indicates that apply actions are applied immediately, and
> the matches defined in subsequent tables are tests against the modified
> packet. but this doesn't seem to be so for me.

I don't understand the sentence below:

> Packet tests against an inner header are do not discover the inner traffic
> unless there has been a recirculation. (forcing an update of the packet
> metadata/flow data)


From blp at nicira.com  Wed Aug 19 21:21:52 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:21:52 -0700
Subject: [ovs-discuss] Multipart request interleaving with individual
 request
In-Reply-To: <0E0BB0168B0E284CBB6CFE99BF094A8E071930DFF2@MAAX7MCDC102.APAC.DELL.COM>
References: <0E0BB0168B0E284CBB6CFE99BF094A8E071930DFF2@MAAX7MCDC102.APAC.DELL.COM>
Message-ID: <20150820042152.GQ860@nicira.com>

On Tue, Aug 11, 2015 at 10:27:25PM +0530, Hariharan_Sethuraman at Dell.com wrote:
> I am working in opendaylight. Would like to get the following clarified.
> 
> 
> 1.       Can a multipart reply mix up with individual reply causing invoking client out of sync with OVS?
> 
> For example:
> ofp_port_stats_request is a request for individual port
> statistics. Ofpmp_multipart_request can be a request for more port
> statistcs.
> 
> Lets say the SDN controller, requests ofpmp_multipart_request and
> ofp_port_stats_request in any order to OVS. When OVS is constructing
> the replies and a port status flaps (up to down) in between, is there
> a chance of replies is in the order such that the SDN controller
> receives the replies and sees the port status as down in first reply
> (ofp_port_stats) and up in multipart replies? So at the end the
> controller thinks the port status is up but the port status is down in
> ovs. Is this possible? Or the mutlipart reply is always the live
> status and not built on buffered?

I don't think that OpenFlow forbids interleaving of multipart replies
with other replies, but no version of OVS interleaves them.

From blp at nicira.com  Wed Aug 19 21:29:45 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:29:45 -0700
Subject: [ovs-discuss] could we mirror the packages of patch port?
In-Reply-To: <201508131405113942215@qq.com>
References: <201508131405113942215@qq.com>
Message-ID: <20150820042945.GR860@nicira.com>

On Thu, Aug 13, 2015 at 02:05:12PM +0800, 948676270 at qq.com wrote:
>      What do you mean about "It doesn't look like it",do you mean that
>      the bug he reported exists and this problem isn't fixed yet?

I don't think the bug is fixed.  Please consider submitting a fix.

From blp at nicira.com  Wed Aug 19 21:31:46 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:31:46 -0700
Subject: [ovs-discuss] Deleting internal ports takes too long
In-Reply-To: <CADtzDCmVPW8r7_qukVDN30Uo7HduPzMs93RDhgSsJuDLXov2Og@mail.gmail.com>
References: <CADtzDCnQQh+dNf6yybSaS7NatXbYfnVw=JPMsCDvQStcLNJ+UA@mail.gmail.com>
 <20150813165251.GB7795@x240.home>
 <CADtzDCmVPW8r7_qukVDN30Uo7HduPzMs93RDhgSsJuDLXov2Og@mail.gmail.com>
Message-ID: <20150820043146.GS860@nicira.com>

On Thu, Aug 13, 2015 at 12:16:53PM -0700, Han Zhou wrote:
> On Thu, Aug 13, 2015 at 9:52 AM, Flavio Leitner <fbl at sysclose.org> wrote:
> >
> > You could try deleting a bunch of interfaces at once to avoid the
> > cost of reading all the configuration on every operation.
> >
> > ovs-vsctl del-port <bridge> <port1> -- del-port <bridge> <port2> ...
> >
> > fbl
> >
> 
> Hi Flavio,
> 
> Good suggestion!
> Yes, the time spent are mostly caused by the ovsdb transaction
> including the change notification to the controller.
> So combining multiple ports deletion in one transaction reduces the
> time significantly.

This is pretty much like the FAQ:

### Q: I want to add thousands of ports to an Open vSwitch bridge, but
   it takes too long (minutes or hours) to do it with ovs-vsctl.  How
   can I do it faster?

A: If you add them one at a time with ovs-vsctl, it can take a long
   time to add thousands of ports to an Open vSwitch bridge.  This is
   because every invocation of ovs-vsctl first reads the current
   configuration from OVSDB.  As the number of ports grows, this
   starts to take an appreciable amount of time, and when it is
   repeated thousands of times the total time becomes significant.

   The solution is to add the ports in one invocation of ovs-vsctl (or
   a small number of them).  For example, using bash:

       ovs-vsctl add-br br0
       cmds=; for i in {1..5000}; do cmds+=" -- add-port br0 p$i"; done
       ovs-vsctl $cmds

   takes seconds, not minutes or hours, in the OVS sandbox environment.

From blp at nicira.com  Wed Aug 19 21:34:37 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:34:37 -0700
Subject: [ovs-discuss] GRE ports missing in ovs-dpctl
In-Reply-To: <CADDmorT7R0KaMOjXj-3zyXSH4KkDdvapEaH0ib5NAe090_mLyg@mail.gmail.com>
References: <CADDmorT7R0KaMOjXj-3zyXSH4KkDdvapEaH0ib5NAe090_mLyg@mail.gmail.com>
Message-ID: <20150820043437.GT860@nicira.com>

On Fri, Aug 14, 2015 at 07:39:50PM +0530, Abhishek Verma wrote:
> I downloaded the latest OVS code from the git repository and i notice that
> i dont see the GRE ports as separate ports in the data plane. There now
> appears only one GRE port gre_sys that represents all the GRE ports in the
> system.
> 
> root@:/home/akabra# ovs-dpctl show
> system at ovs-system:
> lookups: hit:331101 missed:1090 lost:0
> flows: 1
> masks: hit:584458 total:1 hit/pkt:1.76
> port 0: ovs-system (internal)
> port 1: ion1 (internal)
> port 2: gre_sys (gre)
> 
> Can somebody tell me why this change was done? Wasnt the earlier
> abstraction (at least till 2.3.2) better since each GRE tunnel was an OF
> port (or a dataplane port) and it was quite intuitive to write the of-flow
> rules since i could identify the GRE tunnel by a port. 

The OpenFlow and OVSDB interfaces remain the same, so you can still do
that.

From blp at nicira.com  Wed Aug 19 21:59:57 2015
From: blp at nicira.com (Ben Pfaff)
Date: Wed, 19 Aug 2015 21:59:57 -0700
Subject: [ovs-discuss] tc ingress qdisc of tapB disappeared when
 del-port tapA from bridge
In-Reply-To: <7c2a36fe.b57b.14f490c2590.Coremail.ychen103103@163.com>
References: <1c0e8fce.1792d.14eb3811fcd.Coremail.ychen103103@163.com>
 <20150722153415.GC28552@nicira.com>
 <5ecd6666.62cd.14eb8e5c3ac.Coremail.ychen103103@163.com>
 <20150723155141.GD3888@nicira.com>
 <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
 <20150819225410.GF860@nicira.com>
 <7c2a36fe.b57b.14f490c2590.Coremail.ychen103103@163.com>
Message-ID: <20150820045957.GB860@nicira.com>



On Thu, Aug 20, 2015 at 10:59:36AM +0800, ychen wrote:
> 1. maybe I am not clearly describe this question.
>    what I am want to find out is why VALID_POLICING is still set when kbits_rate equals to 0?
>   in openvsiwthc document, it says:
> 
>  ingress_policing_rate: integer, at least 0
>      Maximum rate for data received on this interface, in kbps. Data received faster than this rate is
>      dropped. Set to 0 (the default) to disable policing.

If VALID_POLICING is set, and netdev->kbits_rate is 0, then OVS has
removed policing from the netdev and any further requests to remove
policing can turn into no-ops.

From ychen103103 at 163.com  Wed Aug 19 23:59:22 2015
From: ychen103103 at 163.com (ychen)
Date: Thu, 20 Aug 2015 14:59:22 +0800 (CST)
Subject: [ovs-discuss] tc ingress qdisc of tapB disappeared when
 del-port tapA from bridge
In-Reply-To: <20150820045957.GB860@nicira.com>
References: <1c0e8fce.1792d.14eb3811fcd.Coremail.ychen103103@163.com>
 <20150722153415.GC28552@nicira.com>
 <5ecd6666.62cd.14eb8e5c3ac.Coremail.ychen103103@163.com>
 <20150723155141.GD3888@nicira.com>
 <7c9c0352.1afc1.14f17d3f88b.Coremail.ychen103103@163.com>
 <20150819225410.GF860@nicira.com>
 <7c2a36fe.b57b.14f490c2590.Coremail.ychen103103@163.com>
 <20150820045957.GB860@nicira.com>
Message-ID: <189f324d.1ad21.14f49e7a721.Coremail.ychen103103@163.com>



ok, I think now I understand what's your meaning about flag VALID_POLICING.
as your explanation, this flag will always set whether or not netdev->kbits_rate is 0,
so there will be no flag to describe whether ingress policing is enabled or not.


hence it lead to the problem, when the first time port add to ovs bridge, 
VALID_POLICING is not set in netdev->cache_valid, so we don't check the netdev->kbits_rate == kbits_rate,
and so tc_add_del_ingress_qdisc(netdev_, false) is called, then lead to tc ingress rule which configured by linux tc removed by ovs function.


my solution is just give VALID_POLICING another meaning,
when ingress policing is enabled(ingress_policing_rate not equal to 0), then VALID_POLICING set
when ingress policing is disabled(ingress_policing_rate  equal to 0), then VALID_POLICING is unset


when ingress policing is disabled, in order to do nothing with tc ingress, so I check the 
parameter kbits_rate with stored value netdev->kbits_rate(maybe check VALID_POLICING with kbits_rate will be better)
if the current status is ingress policing disabling, and the parameter is still to disable ingress policing(kbits_rate=0), so we do nothing.


of course, the solution is not perfect, but is did resolved my problem, and I think it is the lowest cost method.
 I have run ovs unit tests, and the following tests passed:
1. ovs service restart
2. change port tag
3. add or del port from  ovs
4. ovs ingress policing
5. use linux command to up/down interface, change mac, mtu after interface has added to ovs birdge


If this is not a good answer, maybe I can try another more complicated method.









At 2015-08-20 12:59:57, "Ben Pfaff" <blp at nicira.com> wrote:
>
>
>On Thu, Aug 20, 2015 at 10:59:36AM +0800, ychen wrote:
>> 1. maybe I am not clearly describe this question.
>>    what I am want to find out is why VALID_POLICING is still set when kbits_rate equals to 0?
>>   in openvsiwthc document, it says:
>> 
>>  ingress_policing_rate: integer, at least 0
>>      Maximum rate for data received on this interface, in kbps. Data received faster than this rate is
>>      dropped. Set to 0 (the default) to disable policing.
>
>If VALID_POLICING is set, and netdev->kbits_rate is 0, then OVS has
>removed policing from the netdev and any further requests to remove
>policing can turn into no-ops.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/3db980db/attachment.html>

From p.schmitt.82 at gmx.net  Thu Aug 20 05:21:47 2015
From: p.schmitt.82 at gmx.net (Peter Schmitt)
Date: Thu, 20 Aug 2015 14:21:47 +0200
Subject: [ovs-discuss] Leaking packets from one bridge to another or how can
 I isolate networks with OVS?
Message-ID: <55D5C65B.1080106@gmx.net>

Hi,

thanks for adding me to this list. I have a fairly strange problem and I am
not sure if it is a design flaw in my setup or a bug.

I want to use OpenVSwitch and KVMs to create some testnetworks that have
Internet access but are strictly separated otherwise, so that I have VLAN
functionality and packets from different networks do not interfere with each
other.

My setup is as following:

I have one host and I use one instance of ovs 2.3.0 and pox with the
l2_learning module as
controller on every bridge.
I have a bridge br0 that should be used for the access to the outer network.
This bridge has an IP address on the host and also the physical devices
added
as a bond. Also one interface from a KVM (KVM0) is added to this bridge.

Bridge "br0"
    Controller "tcp:127.0.0.1:6633"
        is_connected: true
    Port "tap0"
        Interface "tap0"
    Port "br0"
        Interface "br0"
            type: internal
    Port "bond0"
        Interface "p12p2"
        Interface "p10p1"
        Interface "p12p1"

I have access to the outer network from KVM0. Now I added a second bridge
br1000. This device is not up on the host and only used in ovs. I
start some KVMs and connect the tap devices to this bridge br1000 and
also some
interfaces from KVM0. So basically, KVM0
is connected to br0 and br1000. I use IP forwarding on KVM0 to enable
access for all the other KVMs on br1000. This does also work.

Bridge "br1000"
    Controller "tcp:127.0.0.1:6633"
        is_connected: true
    Port "br1000"
        Interface "br1000"
            type: internal
    Port "tap4"
        Interface "tap4"
    Port "tap1"
        Interface "tap1"
    Port "tap3"
        Interface "tap3"
    Port "tap2"
        Interface "tap2"

What happens now is, that I can see ARP requests and other traffic from
the outer network on
br1000, which should (in my understanding) not be visible on br1000. It
should
only be visible on br0. I can also see this traffic from inside the KVMs
connected to br1000 only.

Some experiments I did:

Removing KVM0's interface tap0 from br0 and adding it to br1000 fixes the
problem that I can see other traffic, but of course, access to the outer
network is not available from all KVMs.
Adding a patch connection between br0 and br1000 of course lets the traffic
appear again on both bridges and I have again internet access.
I cannot see why my KVM0 should forward ARP requests to a different
Layer 3 network?!

Can anyone point me in the right direction on what is going wrong here?
Is the
setup in general ok? How can I achieve that I have isolated networks and
only
IP forwarding between my outer network and the KVM networks?
If any further information is needed, I am happy to give it to you. I
have this setup
ready and can do tests if needed.

Thank you in advance.

Best regards,
Peter


From sean.k.mooney at intel.com  Thu Aug 20 07:25:06 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Thu, 20 Aug 2015 14:25:06 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/6f62e56a/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ubuntu_reference_image.xml
Type: text/xml
Size: 5822 bytes
Desc: ubuntu_reference_image.xml
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/6f62e56a/attachment-0001.xml>

From shague at gmail.com  Thu Aug 20 08:20:53 2015
From: shague at gmail.com (Sam Hague)
Date: Thu, 20 Aug 2015 11:20:53 -0400
Subject: [ovs-discuss] Preserve vxlan headers when sending to a non-vxlan
	port on bridge?
Message-ID: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>

Is it possible to send vxlan encapsulated packets to a bridge port and keep
the vxlan headers?

For example say you had a setup like below where you have two bridges, each
one has a vxlan port (vx1 and vx2) and another port that is really
connected to a vm (vsff1-sf11 and vsff2-vsf21).

Then could I add a flow or some other trick to take vxlan packets coming in
vx1 and send them to the vsff1-sf11 port so that the vm would receive the
packet including the vxlan headers?

My testing so far shows the vxlan headers are stripped and I can't seem to
find a way to keep them.

Thanks, Sam

84d3dda9-d7a4-4b75-a3bc-aaef9bf23e06
    Bridge "sff2"
        Port "vx2"
            Interface "vx2"
                type: vxlan
                options: {key="10", local_ip="10.1.1.2",
remote_ip="10.1.1.1"}
        Port "sff2"
            Interface "sff2"
                type: internal
        Port "vsff2-sf21"
            Interface "vsff2-sf21"
    Bridge "sff1"
        Port "vsff1-sf11"
            Interface "vsff1-sf11"
        Port "vx1"
            Interface "vx1"
                type: vxlan
                options: {key="10", local_ip="10.1.1.1",
remote_ip="10.1.1.2"}
        Port "sff1"
            Interface "sff1"
                type: internal
    ovs_version: "2.3.1"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/c24a9ccb/attachment.html>

From Gabe.Black at viavisolutions.com  Wed Aug 19 14:18:19 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Wed, 19 Aug 2015 21:18:19 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150819/83a963d4/attachment-0001.html>

From shague86 at gmail.com  Thu Aug 20 05:47:25 2015
From: shague86 at gmail.com (Sam Hague)
Date: Thu, 20 Aug 2015 08:47:25 -0400
Subject: [ovs-discuss] Is it possible to forward vxlan packets to a
 bridge port that isn't a vxlan port?
In-Reply-To: <CAKWNE3eZ8P3HTgZO_=vCVO6YquEcMA0tjwdRt0D6+emja7aSCw@mail.gmail.com>
References: <CAKWNE3eZ8P3HTgZO_=vCVO6YquEcMA0tjwdRt0D6+emja7aSCw@mail.gmail.com>
Message-ID: <CAKWNE3fVRamOHs=YjiGzwwbTRhTOZQ+PjjLAhLeBZ+oykZnzjQ@mail.gmail.com>

---------- Forwarded message ----------
From: Sam Hague <shague86 at gmail.com>
Date: Wed, Aug 19, 2015 at 5:20 PM
Subject: Is it possible to forward vxlan packets to a bridge port that
isn't a vxlan port?
To: "discuss at openvswitch.org" <discuss at openvswitch.org>


Is it possible to send vxlan encapsulated packets to a bridge port and keep
the vxlan headers?

For example say you had a setup like below where you have two bridges, each
one has a vxlan port (vx1 and vx2) and another port that is really
connected to a vm (vsff1-sf11 and vsff2-vsf21).

Then could I add a flow or some other trick to take vxlan packets coming in
vx1 and send them to the vsff1-sf11 port so that the vm would receive the
packet including the vxlan headers?

My testing so far shows the vxlan headers are stripped.

Thanks, Sam

84d3dda9-d7a4-4b75-a3bc-aaef9bf23e06
    Bridge "sff2"
        Port "vx2"
            Interface "vx2"
                type: vxlan
                options: {key="10", local_ip="10.1.1.2",
remote_ip="10.1.1.1"}
        Port "sff2"
            Interface "sff2"
                type: internal
        Port "vsff2-sf21"
            Interface "vsff2-sf21"
    Bridge "sff1"
        Port "vsff1-sf11"
            Interface "vsff1-sf11"
        Port "vx1"
            Interface "vx1"
                type: vxlan
                options: {key="10", local_ip="10.1.1.1",
remote_ip="10.1.1.2"}
        Port "sff1"
            Interface "sff1"
                type: internal
    ovs_version: "2.3.1"
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/95699bbb/attachment-0001.html>

From Gabe.Black at viavisolutions.com  Thu Aug 20 08:30:55 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Thu, 20 Aug 2015 15:30:55 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5ABD7@AMEXMB01.ds.jdsu.net>

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/9a40a2dc/attachment-0001.html>

From Gabe.Black at viavisolutions.com  Thu Aug 20 09:19:40 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Thu, 20 Aug 2015 16:19:40 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com> 
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>

Ok, I think I found the config that had it boot.

Your example xml that you attached had:

<memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB' nodeset='0'/>
    </hugepages>
  </memoryBacking>

The page element was the missing piece for me.

Thanks!


From: Gabe Black
Sent: Thursday, August 20, 2015 9:31 AM
To: 'Mooney, Sean K'
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/8b13ee5d/attachment-0001.html>

From blp at nicira.com  Thu Aug 20 10:07:02 2015
From: blp at nicira.com (Ben Pfaff)
Date: Thu, 20 Aug 2015 10:07:02 -0700
Subject: [ovs-discuss] Leaking packets from one bridge to another or how
 can I isolate networks with OVS?
In-Reply-To: <55D5C65B.1080106@gmx.net>
References: <55D5C65B.1080106@gmx.net>
Message-ID: <20150820170702.GB15750@nicira.com>

On Thu, Aug 20, 2015 at 02:21:47PM +0200, Peter Schmitt wrote:
> Hi,
> 
> thanks for adding me to this list. I have a fairly strange problem and I am
> not sure if it is a design flaw in my setup or a bug.
> 
> I want to use OpenVSwitch and KVMs to create some testnetworks that have
> Internet access but are strictly separated otherwise, so that I have VLAN
> functionality and packets from different networks do not interfere with each
> other.
> 
> My setup is as following:
> 
> I have one host and I use one instance of ovs 2.3.0 and pox with the
> l2_learning module as
> controller on every bridge.
> I have a bridge br0 that should be used for the access to the outer network.
> This bridge has an IP address on the host and also the physical devices
> added
> as a bond. Also one interface from a KVM (KVM0) is added to this bridge.
> 
> Bridge "br0"
>     Controller "tcp:127.0.0.1:6633"
>         is_connected: true
>     Port "tap0"
>         Interface "tap0"
>     Port "br0"
>         Interface "br0"
>             type: internal
>     Port "bond0"
>         Interface "p12p2"
>         Interface "p10p1"
>         Interface "p12p1"
> 
> I have access to the outer network from KVM0. Now I added a second bridge
> br1000. This device is not up on the host and only used in ovs. I
> start some KVMs and connect the tap devices to this bridge br1000 and
> also some
> interfaces from KVM0. So basically, KVM0
> is connected to br0 and br1000. I use IP forwarding on KVM0 to enable
> access for all the other KVMs on br1000. This does also work.
> 
> Bridge "br1000"
>     Controller "tcp:127.0.0.1:6633"
>         is_connected: true
>     Port "br1000"
>         Interface "br1000"
>             type: internal
>     Port "tap4"
>         Interface "tap4"
>     Port "tap1"
>         Interface "tap1"
>     Port "tap3"
>         Interface "tap3"
>     Port "tap2"
>         Interface "tap2"
> 
> What happens now is, that I can see ARP requests and other traffic from
> the outer network on
> br1000, which should (in my understanding) not be visible on br1000. It
> should
> only be visible on br0. I can also see this traffic from inside the KVMs
> connected to br1000 only.
> 
> Some experiments I did:
> 
> Removing KVM0's interface tap0 from br0 and adding it to br1000 fixes the
> problem that I can see other traffic, but of course, access to the outer
> network is not available from all KVMs.
> Adding a patch connection between br0 and br1000 of course lets the traffic
> appear again on both bridges and I have again internet access.
> I cannot see why my KVM0 should forward ARP requests to a different
> Layer 3 network?!
> 
> Can anyone point me in the right direction on what is going wrong here?
> Is the
> setup in general ok? How can I achieve that I have isolated networks and
> only
> IP forwarding between my outer network and the KVM networks?
> If any further information is needed, I am happy to give it to you. I
> have this setup
> ready and can do tests if needed.

Did you see this question in the FAQ?

### Q: I configured one IP address on VLAN 0 and another on VLAN 9, like
   this:

       ovs-vsctl add-br br0
       ovs-vsctl add-port br0 eth0
       ifconfig br0 192.168.0.5
       ovs-vsctl add-port br0 vlan9 tag=9 -- set interface vlan9 type=internal
       ifconfig vlan9 192.168.0.9

   but other hosts that are only on VLAN 0 can reach the IP address
   configured on VLAN 9.  What's going on?

A: RFC 1122 section 3.3.4.2 "Multihoming Requirements" describes two
   approaches to IP address handling in Internet hosts:

   - In the "Strong ES Model", where an ES is a host ("End
     System"), an IP address is primarily associated with a
     particular interface.  The host discards packets that arrive
     on interface A if they are destined for an IP address that is
     configured on interface B.  The host never sends packets from
     interface A using a source address configured on interface B.

   - In the "Weak ES Model", an IP address is primarily associated
     with a host.  The host accepts packets that arrive on any
     interface if they are destined for any of the host's IP
     addresses, even if the address is configured on some
     interface other than the one on which it arrived.  The host
     does not restrict itself to sending packets from an IP
     address associated with the originating interface.

   Linux uses the weak ES model.  That means that when packets
   destined to the VLAN 9 IP address arrive on eth0 and are bridged to
   br0, the kernel IP stack accepts them there for the VLAN 9 IP
   address, even though they were not received on vlan9, the network
   device for vlan9.

   To simulate the strong ES model on Linux, one may add iptables rule
   to filter packets based on source and destination address and
   adjust ARP configuration with sysctls.

   BSD uses the strong ES model.

From jesse at nicira.com  Thu Aug 20 10:32:24 2015
From: jesse at nicira.com (Jesse Gross)
Date: Thu, 20 Aug 2015 10:32:24 -0700
Subject: [ovs-discuss] Preserve vxlan headers when sending to a
 non-vxlan port on bridge?
In-Reply-To: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>
References: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>
Message-ID: <CAEP_g=9bMb4xqgDSD2Scfti4jvSyG3QPMkbn_-t=cOsLjAgNgg@mail.gmail.com>

On Thu, Aug 20, 2015 at 8:20 AM, Sam Hague <shague at gmail.com> wrote:
> Is it possible to send vxlan encapsulated packets to a bridge port and keep
> the vxlan headers?

It's not possible unless you don't terminate the tunnels, in which
case you can't match on anything in the header.

From blp at nicira.com  Thu Aug 20 10:51:24 2015
From: blp at nicira.com (Ben Pfaff)
Date: Thu, 20 Aug 2015 10:51:24 -0700
Subject: [ovs-discuss] _APPLY_ vs _WRITE_ actions
In-Reply-To: <D1FB433D.30BC6%davidjoshuaevans@gmail.com>
References: <CAB8HAh43xyPo+XWKSBX5YDHbfgk6w3g-BxW3-bVBw3UF7UnSPA@mail.gmail.com>
 <20150820041313.GP860@nicira.com>
 <D1FB433D.30BC6%davidjoshuaevans@gmail.com>
Message-ID: <20150820175124.GB21479@nicira.com>

[adding the list back]

This may be a bug.  Can you provide a small example that allows me to
reproduce the problem?

On Thu, Aug 20, 2015 at 08:56:01AM -0500, David Evans wrote:
> I have a header modifier (custom action) rule in a table, Apply actions,
> go to next table. - This works and output pcaps show the packet to be
> correctly modified.
> Then in the next table I have a filter rule. (the contents of the packet
> should' be visible to the filter rule now because of the header modifier
> in previous table) 
> But do not get the expected match
> 
> My confusion is  OFPTTFPT13_APPLY_ACTIONS in the spec says it ought to
> apply immediately, 
> should mean that the following table match¹ should be testing against the
> modified packet.
> But the mini flow is unchanged and following table matches don¹t happen.
> 
> Anyhow, I ended up doing exactly the same as MPLS header removal does,
>  to engage recirculation in compose action using was_mpls etc
>  and CHECK_MPLS_RECIRCULATION() in the switch for do_xlate_actions()
>  - which works.
> 
> 
> I know you¹re crazy busy. Thanks for your time helping out.
> Cheers,
> 
> Dave.
> 
> On 8/19/15, 11:13 PM, "Ben Pfaff" <blp at nicira.com> wrote:
> 
> >On Mon, Aug 10, 2015 at 02:42:18PM -0500, David Evans wrote:
> >> I would like to OFPTFPT13_APPLY_ACTIONS and have have subsequent table
> >> matches on the modified packet.
> >> The OpenFlow spec indicates that apply actions are applied immediately,
> >>and
> >> the matches defined in subsequent tables are tests against the modified
> >> packet. but this doesn't seem to be so for me.
> >
> >I don't understand the sentence below:
> >
> >> Packet tests against an inner header are do not discover the inner
> >>traffic
> >> unless there has been a recirculation. (forcing an update of the packet
> >> metadata/flow data)
> >
> 
> 

From sean.k.mooney at intel.com  Thu Aug 20 12:53:31 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Thu, 20 Aug 2015 19:53:31 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA645170A6D@IRSMSX107.ger.corp.intel.com>

Hi I am glad you got it working.
Thanks for reminding me about apparmor also.

We had set all profiles into complain mode but it was still blocking access to the vhost user sockets on our system also.

Apt-get purge apparmor results in vms booting correctly on our system also.

For now we will document this as a workaround and investage updating the apparmor profile to allow access to the
/var/run/openvswitch directory.

Just incase you are not aware to have network connective in the vm when  booting via openstack it is also neesicary to request hugepages
This can be done by modifying the flavor as follows
nova flavor-key <FLAVOR> set hw:mem_page_size=large
without this flavor extra spec option nova will not generate hugepage element or populate the pages element.

on the acceleration question
br-p6p1 and br-int  both use the dpdk enabled netdev datapath.

Because both bridges are connected by a patch port ovs is able to
Collapse the two bridges into a single datapath. This effectively means that while there are
Two logical bridges with the vm vhost-user port connected to br-int and the dpdk physical port connected
To br-p6p1 it is the equivalent of connecting all ports to a single bridge.

Regards
Sean.

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Thursday, August 20, 2015 5:20 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Ok, I think I found the config that had it boot.

Your example xml that you attached had:

<memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB' nodeset='0'/>
    </hugepages>
  </memoryBacking>

The page element was the missing piece for me.

Thanks!


From: Gabe Black
Sent: Thursday, August 20, 2015 9:31 AM
To: 'Mooney, Sean K'
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/7745f0e4/attachment-0001.html>

From shague at gmail.com  Thu Aug 20 13:58:17 2015
From: shague at gmail.com (Sam Hague)
Date: Thu, 20 Aug 2015 16:58:17 -0400
Subject: [ovs-discuss] Preserve vxlan headers when sending to a
 non-vxlan port on bridge?
In-Reply-To: <CAEP_g=9bMb4xqgDSD2Scfti4jvSyG3QPMkbn_-t=cOsLjAgNgg@mail.gmail.com>
References: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>
 <CAEP_g=9bMb4xqgDSD2Scfti4jvSyG3QPMkbn_-t=cOsLjAgNgg@mail.gmail.com>
Message-ID: <CAFXH76cC2G0mnG2r1sh=N1Mjwi5g1pkVWWRtYiuw2gAcRrEYOg@mail.gmail.com>

On Thu, Aug 20, 2015 at 1:32 PM, Jesse Gross <jesse at nicira.com> wrote:

> On Thu, Aug 20, 2015 at 8:20 AM, Sam Hague <shague at gmail.com> wrote:
> > Is it possible to send vxlan encapsulated packets to a bridge port and
> keep
> > the vxlan headers?
>
> It's not possible unless you don't terminate the tunnels, in which
> case you can't match on anything in the header.
>

Is the only way to add vxlan headers by sending a packet out a vxlan port -
whether the key/srcip/dstip are port or flow-based?

Is there any way to "overload" the vm port such that if I sent a vxlan
packet froma normal vxlan port on the bridge it could come back into the
bridge and to that vm port such that the vm would terminate the tunnel?

The use case is for the typical openstack setup where the VMs are ports
hanging off the bridge and flows are added to simply push normal l2-l4
packets to the port. But I would like to terminate vxlan inside the VM
itself but under this constraint that is was OpenStack that instantiated
the VM in the way it typically does.

So I could see adding some flows to send a vxlan packet out a port on the
bridge, and somehow getting it to come back into the bridge and not have
the header stripped. Typically those VM addresses are internal addresses
which the host wouldn't know about so if I sent a vxlan out a bridge port,
the network stack wouldn't send it back.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150820/702ac15e/attachment.html>

From p.schmitt.82 at gmx.net  Thu Aug 20 23:41:29 2015
From: p.schmitt.82 at gmx.net (Peter Schmitt)
Date: Fri, 21 Aug 2015 08:41:29 +0200
Subject: [ovs-discuss] Leaking packets from one bridge to another or how
 can I isolate networks with OVS?
In-Reply-To: <20150820170702.GB15750@nicira.com>
References: <55D5C65B.1080106@gmx.net> <20150820170702.GB15750@nicira.com>
Message-ID: <55D6C819.90303@gmx.net>

Hi,
thank you for the answer. Yes I saw that, but that does not explain why
I see
ARP requests from the host network on br1000. Maybe I did not explain
this quite well.

Assume I have my normal home network here being 192.168.0.0/24. All my hosts
are connected to this network, and also the KVM host machine.
Now I start ovs, pox and some KVMs on the KVM host machine.
The br0 on ovs is also in the network 192.168.0.0/24. The network between
my KVM machines is 10.0.0.0/24 on br1000. With the setup described below,
I can see ARP requests from two different hosts in the 192.168.0.0/24
network (not the IP address of the KVM host) on my KVM appliances in the
10.0.0.0/24 network.
That would (in my understanding) mean, that the KVM forwards ARP requests
for some reason to the second bridge or there is anything fishy with
ovs. I don't
have any bridges or anything configured on the KVM host.
The strange thing is that if I remove the interface of my KVM from the
br0 in ovs,
the ARP requests disappear on br1000.

I hope this got a little bit clearer now. I don't think this might be
related to the ES Model,
or am I wrong here?

Best regards,
Peter


On 20.08.2015 19:07, Ben Pfaff wrote:
> On Thu, Aug 20, 2015 at 02:21:47PM +0200, Peter Schmitt wrote:
>> Hi,
>>
>> thanks for adding me to this list. I have a fairly strange problem and I am
>> not sure if it is a design flaw in my setup or a bug.
>>
>> I want to use OpenVSwitch and KVMs to create some testnetworks that have
>> Internet access but are strictly separated otherwise, so that I have VLAN
>> functionality and packets from different networks do not interfere with each
>> other.
>>
>> My setup is as following:
>>
>> I have one host and I use one instance of ovs 2.3.0 and pox with the
>> l2_learning module as
>> controller on every bridge.
>> I have a bridge br0 that should be used for the access to the outer network.
>> This bridge has an IP address on the host and also the physical devices
>> added
>> as a bond. Also one interface from a KVM (KVM0) is added to this bridge.
>>
>> Bridge "br0"
>>     Controller "tcp:127.0.0.1:6633"
>>         is_connected: true
>>     Port "tap0"
>>         Interface "tap0"
>>     Port "br0"
>>         Interface "br0"
>>             type: internal
>>     Port "bond0"
>>         Interface "p12p2"
>>         Interface "p10p1"
>>         Interface "p12p1"
>>
>> I have access to the outer network from KVM0. Now I added a second bridge
>> br1000. This device is not up on the host and only used in ovs. I
>> start some KVMs and connect the tap devices to this bridge br1000 and
>> also some
>> interfaces from KVM0. So basically, KVM0
>> is connected to br0 and br1000. I use IP forwarding on KVM0 to enable
>> access for all the other KVMs on br1000. This does also work.
>>
>> Bridge "br1000"
>>     Controller "tcp:127.0.0.1:6633"
>>         is_connected: true
>>     Port "br1000"
>>         Interface "br1000"
>>             type: internal
>>     Port "tap4"
>>         Interface "tap4"
>>     Port "tap1"
>>         Interface "tap1"
>>     Port "tap3"
>>         Interface "tap3"
>>     Port "tap2"
>>         Interface "tap2"
>>
>> What happens now is, that I can see ARP requests and other traffic from
>> the outer network on
>> br1000, which should (in my understanding) not be visible on br1000. It
>> should
>> only be visible on br0. I can also see this traffic from inside the KVMs
>> connected to br1000 only.
>>
>> Some experiments I did:
>>
>> Removing KVM0's interface tap0 from br0 and adding it to br1000 fixes the
>> problem that I can see other traffic, but of course, access to the outer
>> network is not available from all KVMs.
>> Adding a patch connection between br0 and br1000 of course lets the traffic
>> appear again on both bridges and I have again internet access.
>> I cannot see why my KVM0 should forward ARP requests to a different
>> Layer 3 network?!
>>
>> Can anyone point me in the right direction on what is going wrong here?
>> Is the
>> setup in general ok? How can I achieve that I have isolated networks and
>> only
>> IP forwarding between my outer network and the KVM networks?
>> If any further information is needed, I am happy to give it to you. I
>> have this setup
>> ready and can do tests if needed.
> Did you see this question in the FAQ?
>
> ### Q: I configured one IP address on VLAN 0 and another on VLAN 9, like
>    this:
>
>        ovs-vsctl add-br br0
>        ovs-vsctl add-port br0 eth0
>        ifconfig br0 192.168.0.5
>        ovs-vsctl add-port br0 vlan9 tag=9 -- set interface vlan9 type=internal
>        ifconfig vlan9 192.168.0.9
>
>    but other hosts that are only on VLAN 0 can reach the IP address
>    configured on VLAN 9.  What's going on?
>
> A: RFC 1122 section 3.3.4.2 "Multihoming Requirements" describes two
>    approaches to IP address handling in Internet hosts:
>
>    - In the "Strong ES Model", where an ES is a host ("End
>      System"), an IP address is primarily associated with a
>      particular interface.  The host discards packets that arrive
>      on interface A if they are destined for an IP address that is
>      configured on interface B.  The host never sends packets from
>      interface A using a source address configured on interface B.
>
>    - In the "Weak ES Model", an IP address is primarily associated
>      with a host.  The host accepts packets that arrive on any
>      interface if they are destined for any of the host's IP
>      addresses, even if the address is configured on some
>      interface other than the one on which it arrived.  The host
>      does not restrict itself to sending packets from an IP
>      address associated with the originating interface.
>
>    Linux uses the weak ES model.  That means that when packets
>    destined to the VLAN 9 IP address arrive on eth0 and are bridged to
>    br0, the kernel IP stack accepts them there for the VLAN 9 IP
>    address, even though they were not received on vlan9, the network
>    device for vlan9.
>
>    To simulate the strong ES model on Linux, one may add iptables rule
>    to filter packets based on source and destination address and
>    adjust ARP configuration with sysctls.
>
>    BSD uses the strong ES model.


From ychen103103 at 163.com  Fri Aug 21 04:33:21 2015
From: ychen103103 at 163.com (ychen)
Date: Fri, 21 Aug 2015 19:33:21 +0800 (CST)
Subject: [ovs-discuss] questions about namespace,
 mtu and ingress policing for ovs internal port
Message-ID: <3bcdff66.f17b.14f5008db6f.Coremail.ychen103103@163.com>

I did some tests for internal ports, and found the following problems:
1. ovs ingress policing has not effect for internal port if this port is not in the default namespace
2. set interface mtu can not really change port's mtu
3. ingress policing statistics cleared after change port's mtu and add another port to ovs bridge


here is the testing steps:
step 1: add namespace ns111
        ip netns add ns111
        
step 2: create internal port tap111 and tap222
        ovs-vsctl add-port br0 tap111 -- set interface tap111 type=internal
        ovs-vsctl add-port br0 tap222 -- set interface tap222 type=internal
        
step 3: add port tap111 to namespace ns111
       ip link set tap111 netns ns111
       ip netns exec ns111 ip link set dev tap111 up 
       ip netns exec ns111 ifconfig tap111 192.168.1.1/24
       
step 4: set ingress policing for tap111
       ovs-vsctl set interface tap111 ingress_policing_rate=1000
       (no error happend, but when use command "tc qdisc show dev tap111 ingress",
       there is no qdisc rule attached on interface tap111)
       
step 5: set ingress policing for port tap222
        ifconfig tap222 up(now the mtu is 1500 for this port)
        ifconfig tap222 192.l68.1.2/24
        ovs-vsctl set interface tap222 ingress_policing_rate=1000
        ping 192.168.1.1 -c 1000
        (use command "tc -s qdisc show dev tap222", now rx packets is greater than 1000)
        
step 6: change mtu for port tap222
        ovs-vsctl set interface tap222=1400
        (use command ifconfig tap222, but the mtu is still 1500)
        
step 7: change mtu with ifconfig
        ifconfig tap222 mtu 1400
        (now mtu changed to 1400)
        
step 8: add port tap333
        ovs-vsctl add-port br0 tap333 -- set interface tap333 type=internal
        (now the statistics of qdisc for tap222 is cleared to 0
        if we set breakpoint in function netdev_linux_set_policing,
        we can see tc_add_del_ingress_qdisc(netdev_, false) is called)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/5b572657/attachment-0001.html>

From ychen103103 at 163.com  Fri Aug 21 05:49:32 2015
From: ychen103103 at 163.com (ychen)
Date: Fri, 21 Aug 2015 20:49:32 +0800 (CST)
Subject: [ovs-discuss] questions about namespace,
 mtu and ingress policing for ovs internal port
In-Reply-To: <3bcdff66.f17b.14f5008db6f.Coremail.ychen103103@163.com>
References: <3bcdff66.f17b.14f5008db6f.Coremail.ychen103103@163.com>
Message-ID: <28ed3566.10724.14f504e97cc.Coremail.ychen103103@163.com>

and another step for reproducing the phenomenon is like that:
1. add port tap333 with ingress policing
   ovs-vsctl add-port br0 tap333 -- set interface tap333 type=internal -- set interface tap333 ingress_policing_rate=100
2. receive some packet from tap333
    ifconfig tap333 up
    ifconfig tap333 192.168.1.3/24
    ping 192.168.1.1
    (now use command "tc -s qdisc show dev tap333 ingress", we have some rx packets)


4. add port tap444
    ovs-vsctl add-port br0 tap444 -- set interface tap444 type=internal
   (after this step, statistics cleared to 0 on tap333
   which means tc qdisc rule have removed then added again
   I think it is not a good idea to affect another port when adding a new port)






At 2015-08-21 19:33:21, "ychen" <ychen103103 at 163.com> wrote:

I did some tests for internal ports, and found the following problems:
1. ovs ingress policing has not effect for internal port if this port is not in the default namespace
2. set interface mtu can not really change port's mtu
3. ingress policing statistics cleared after change port's mtu and add another port to ovs bridge


here is the testing steps:
step 1: add namespace ns111
        ip netns add ns111
        
step 2: create internal port tap111 and tap222
        ovs-vsctl add-port br0 tap111 -- set interface tap111 type=internal
        ovs-vsctl add-port br0 tap222 -- set interface tap222 type=internal
        
step 3: add port tap111 to namespace ns111
       ip link set tap111 netns ns111
       ip netns exec ns111 ip link set dev tap111 up 
       ip netns exec ns111 ifconfig tap111 192.168.1.1/24
       
step 4: set ingress policing for tap111
       ovs-vsctl set interface tap111 ingress_policing_rate=1000
       (no error happend, but when use command "tc qdisc show dev tap111 ingress",
       there is no qdisc rule attached on interface tap111)
       
step 5: set ingress policing for port tap222
        ifconfig tap222 up(now the mtu is 1500 for this port)
        ifconfig tap222 192.l68.1.2/24
        ovs-vsctl set interface tap222 ingress_policing_rate=1000
        ping 192.168.1.1 -c 1000
        (use command "tc -s qdisc show dev tap222", now rx packets is greater than 1000)
        
step 6: change mtu for port tap222
        ovs-vsctl set interface tap222=1400
        (use command ifconfig tap222, but the mtu is still 1500)
        
step 7: change mtu with ifconfig
        ifconfig tap222 mtu 1400
        (now mtu changed to 1400)
        
step 8: add port tap333
        ovs-vsctl add-port br0 tap333 -- set interface tap333 type=internal
        (now the statistics of qdisc for tap222 is cleared to 0
        if we set breakpoint in function netdev_linux_set_policing,
        we can see tc_add_del_ingress_qdisc(netdev_, false) is called)



夏日畅销榜大牌美妆只要1元
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/d48cb970/attachment.html>

From blp at nicira.com  Fri Aug 21 07:17:59 2015
From: blp at nicira.com (Ben Pfaff)
Date: Fri, 21 Aug 2015 07:17:59 -0700
Subject: [ovs-discuss] Leaking packets from one bridge to another or how
 can I isolate networks with OVS?
In-Reply-To: <55D6C819.90303@gmx.net>
References: <55D5C65B.1080106@gmx.net> <20150820170702.GB15750@nicira.com>
 <55D6C819.90303@gmx.net>
Message-ID: <20150821141759.GA31657@nicira.com>

On Fri, Aug 21, 2015 at 08:41:29AM +0200, Peter Schmitt wrote:
> Hi,
> thank you for the answer. Yes I saw that, but that does not explain why
> I see
> ARP requests from the host network on br1000. Maybe I did not explain
> this quite well.
> 
> Assume I have my normal home network here being 192.168.0.0/24. All my hosts
> are connected to this network, and also the KVM host machine.
> Now I start ovs, pox and some KVMs on the KVM host machine.
> The br0 on ovs is also in the network 192.168.0.0/24. The network between
> my KVM machines is 10.0.0.0/24 on br1000. With the setup described below,
> I can see ARP requests from two different hosts in the 192.168.0.0/24
> network (not the IP address of the KVM host) on my KVM appliances in the
> 10.0.0.0/24 network.
> That would (in my understanding) mean, that the KVM forwards ARP requests
> for some reason to the second bridge or there is anything fishy with
> ovs. I don't
> have any bridges or anything configured on the KVM host.
> The strange thing is that if I remove the interface of my KVM from the
> br0 in ovs,
> the ARP requests disappear on br1000.
> 
> I hope this got a little bit clearer now. I don't think this might be
> related to the ES Model,
> or am I wrong here?

OK, if it's not the ES model, then you can trace the path of a packet
through your system hop-by-hop to figure out what's happening.  The FAQ
has some info:

### Q: I have a sophisticated network setup involving Open vSwitch, VMs or
   multiple hosts, and other components.  The behavior isn't what I
   expect.  Help!

A: To debug network behavior problems, trace the path of a packet,
   hop-by-hop, from its origin in one host to a remote host.  If
   that's correct, then trace the path of the response packet back to
   the origin.

   Usually a simple ICMP echo request and reply ("ping") packet is
   good enough.  Start by initiating an ongoing "ping" from the origin
   host to a remote host.  If you are tracking down a connectivity
   problem, the "ping" will not display any successful output, but
   packets are still being sent.  (In this case the packets being sent
   are likely ARP rather than ICMP.)

   Tools available for tracing include the following:

   - "tcpdump" and "wireshark" for observing hops across network
     devices, such as Open vSwitch internal devices and physical
     wires.

   - "ovs-appctl dpif/dump-flows <br>" in Open vSwitch 1.10 and
     later or "ovs-dpctl dump-flows <br>" in earlier versions.
     These tools allow one to observe the actions being taken on
     packets in ongoing flows.

     See ovs-vswitchd(8) for "ovs-appctl dpif/dump-flows"
     documentation, ovs-dpctl(8) for "ovs-dpctl dump-flows"
     documentation, and "Why are there so many different ways to
     dump flows?" above for some background.

   - "ovs-appctl ofproto/trace" to observe the logic behind how
     ovs-vswitchd treats packets.  See ovs-vswitchd(8) for
     documentation.  You can out more details about a given flow
     that "ovs-dpctl dump-flows" displays, by cutting and pasting
     a flow from the output into an "ovs-appctl ofproto/trace"
     command.

   - SPAN, RSPAN, and ERSPAN features of physical switches, to
     observe what goes on at these physical hops.

   Starting at the origin of a given packet, observe the packet at
   each hop in turn.  For example, in one plausible scenario, you
   might:

   1. "tcpdump" the "eth" interface through which an ARP egresses
      a VM, from inside the VM.

   2. "tcpdump" the "vif" or "tap" interface through which the ARP
      ingresses the host machine.

   3. Use "ovs-dpctl dump-flows" to spot the ARP flow and observe
      the host interface through which the ARP egresses the
      physical machine.  You may need to use "ovs-dpctl show" to
      interpret the port numbers.  If the output seems surprising,
      you can use "ovs-appctl ofproto/trace" to observe details of
      how ovs-vswitchd determined the actions in the "ovs-dpctl
      dump-flows" output.

   4. "tcpdump" the "eth" interface through which the ARP egresses
      the physical machine.

   5. "tcpdump" the "eth" interface through which the ARP
      ingresses the physical machine, at the remote host that
      receives the ARP.

   6. Use "ovs-dpctl dump-flows" to spot the ARP flow on the
      remote host that receives the ARP and observe the VM "vif"
      or "tap" interface to which the flow is directed.  Again,
      "ovs-dpctl show" and "ovs-appctl ofproto/trace" might help.

   7. "tcpdump" the "vif" or "tap" interface to which the ARP is
      directed.

   8. "tcpdump" the "eth" interface through which the ARP
      ingresses a VM, from inside the VM.

   It is likely that during one of these steps you will figure out the
   problem.  If not, then follow the ARP reply back to the origin, in
   reverse.

From baclawski.pawel at gmail.com  Fri Aug 21 03:20:44 2015
From: baclawski.pawel at gmail.com (=?UTF-8?B?UGF3ZcWCIEJhY8WCYXdza2k=?=)
Date: Fri, 21 Aug 2015 12:20:44 +0200
Subject: [ovs-discuss] OVS with DPDK 2.1.0
Message-ID: <CAHjVv4saLuDYbhzaNy2yS4PDP6uGFK8Bi1nF=arLPpJwki4VqQ@mail.gmail.com>

Hello,

could you please tell me if OVS is already compatibile with recently
released DPDK 2.1.0? Or what sould I do to make it work, when I am
receiving "cannot link with dpdk" error - DPDK 2.0.0 works for me.

Kind regards,
Pawel Baclawski
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/6d928afb/attachment-0001.html>

From contact at shape.host  Fri Aug 21 05:02:03 2015
From: contact at shape.host (ShapeHost)
Date: Fri, 21 Aug 2015 15:02:03 +0300
Subject: [ovs-discuss] openvswitch install on centos 6.6 issue
Message-ID: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>

Hello,

I have some problem with openvswitch install on centos 6.6 2.6.32-573.3.1.el6.x86_64.

I tried to install many version of OVS like 1.9.0, 1.9.3, 1.10.0, 2.1.1, 2.3.0.

Every time i have problems on this line :
--------------------------------------
Starting Line #
---------------------------------------
#[root at ns509777 openvswitch-2.1.1]# rpmbuild -bb rhel/openvswitch-kmod-rhel6.spec
Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.hWy71a
+ umask 022
+ cd /root/rpmbuild/BUILD
+ LANG=C
+ export LANG
+ unset DISPLAY
+ cd /root/rpmbuild/BUILD
+ rm -rf openvswitch-2.1.1
+ /usr/bin/gzip -dc /root/rpmbuild/SOURCES/openvswitch-2.1.1.tar.gz
+ /bin/tar -xvvf -

---------------------------------------------------
and is ending with this :
--------------------------------------------------
                 from /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../compat.h:26,
                 from /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../datapath.h:29,
                 from /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.c:34:
/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9: error: redefinition of 'ip_is_fragment'
include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was here
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow.o] Error 1
make[2]: *** Waiting for unfinished jobs....
In file included from include/net/xfrm.h:18,
                 from /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.c:39:
/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9: error: redefinition of 'ip_is_fragment'
include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was here
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.o] Error 1
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/dp_notify.o] Error 1
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/datapath.o] Error 1
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_netlink.o] Error 1
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.o] Error 1
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_table.o] Error 1
make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/actions.o] Error 1
make[1]: *** [_module_/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux] Error 2
make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
make: *** [default] Error 2
make: Leaving directory `/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux'
error: Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)


RPM build errors:
    Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)


-----------------------------------------------

I'm going crazy :)) i'm not sure how to fix this, can i get some help ?





Regards,
Cristian

 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/5e817f9c/attachment.html>

From shettyg at nicira.com  Fri Aug 21 10:29:00 2015
From: shettyg at nicira.com (Gurucharan Shetty)
Date: Fri, 21 Aug 2015 10:29:00 -0700
Subject: [ovs-discuss] openvswitch install on centos 6.6 issue
In-Reply-To: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>
References: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>
Message-ID: <CAHbON5pqG=zqZKbFJjWZ4sFxqYuJwNtW4ptmHTYATJywf-+pCA@mail.gmail.com>

On Fri, Aug 21, 2015 at 5:02 AM, ShapeHost <contact at shape.host> wrote:
> Hello,
>
> I have some problem with openvswitch install on centos 6.6
> 2.6.32-573.3.1.el6.x86_64.
>
> I tried to install many version of OVS like 1.9.0, 1.9.3, 1.10.0, 2.1.1,
> 2.3.0.
>From what I understand, Centos6.6 is not supported with 2.3

It is likely that OVS 2.4 will be released today. It is likely that
Centos6.6 is supported in that version. branch2.4 is already created,
so you can try that too.


>
> Every time i have problems on this line :
> --------------------------------------
> Starting Line #
> ---------------------------------------
> #[root at ns509777 openvswitch-2.1.1]# rpmbuild -bb
> rhel/openvswitch-kmod-rhel6.spec
> Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.hWy71a
> + umask 022
> + cd /root/rpmbuild/BUILD
> + LANG=C
> + export LANG
> + unset DISPLAY
> + cd /root/rpmbuild/BUILD
> + rm -rf openvswitch-2.1.1
> + /usr/bin/gzip -dc /root/rpmbuild/SOURCES/openvswitch-2.1.1.tar.gz
> + /bin/tar -xvvf -
>
> ---------------------------------------------------
> and is ending with this :
> --------------------------------------------------
>                  from
> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../compat.h:26,
>                  from
> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../datapath.h:29,
>                  from
> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.c:34:
> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
> error: redefinition of 'ip_is_fragment'
> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was here
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow.o]
> Error 1
> make[2]: *** Waiting for unfinished jobs....
> In file included from include/net/xfrm.h:18,
>                  from
> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.c:39:
> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
> error: redefinition of 'ip_is_fragment'
> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was here
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/dp_notify.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/datapath.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_netlink.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_table.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/actions.o]
> Error 1
> make[1]: ***
> [_module_/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux]
> Error 2
> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
> make: *** [default] Error 2
> make: Leaving directory
> `/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux'
> error: Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
>
>
> RPM build errors:
>     Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
>
>
> -----------------------------------------------
>
> I'm going crazy :)) i'm not sure how to fix this, can i get some help ?
>
>
>
>
>
> Regards,
>
> Cristian
>
>
>
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>

From jpettit at nicira.com  Fri Aug 21 10:51:41 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Fri, 21 Aug 2015 10:51:41 -0700
Subject: [ovs-discuss] Open vSwitch 2.4.0 Available
Message-ID: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>

The Open vSwitch team is pleased to announce the release of Open vSwitch 2.4.0:

   http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz

This release contains the largest number of new features of an Open vSwitch release.  A few feature highlights of 2.4.0 include:

  - Support for the Rapid Spanning Tree Protocol (IEEE 802.1D-2004).

  - Support for multicast snooping (IGMPv1, IGMPv2 and IGMPv3).

  - A new "conjunctive match" OpenFlow extension that allows flows to be
    constructed without introducing a Cartesian Product explosion.

  - Add bash command-line completion for most CLI commands.

  - Support for transactional flow updates through OpenFlow 1.4 Bundles.

  - A number of new features from the latest OpenFlow specifications.

  - A simple wrapper script, 'ovs-docker', to integrate OVS with Docker
    containers.

  - Support for STT and basic Geneve tunneling in Linux kernels.

  - Support for VXLAN Group Policy extension.

  - Support for DPDK Tunneling. VXLAN, GRE, and Geneve are supported
    protocols.

  - Support for DPDK vHost.

  - And many others.  See the full change log here:

        http://openvswitch.org/releases/NEWS-2.4.0

Enjoy!

--The Open vSwitch Team   

--------------------   
Open vSwitch is a production quality, multilayer open source virtual switch. It is designed to enable massive network automation through programmatic extension, while still supporting standard management interfaces. Open vSwitch can operate both as a soft switch running within the hypervisor, and as the control stack for switching silicon. It has been ported to multiple virtualization platforms and switching chipsets.


From shettyg at nicira.com  Fri Aug 21 12:09:20 2015
From: shettyg at nicira.com (Gurucharan Shetty)
Date: Fri, 21 Aug 2015 12:09:20 -0700
Subject: [ovs-discuss] openvswitch install on centos 6.6 issue
In-Reply-To: <570c3c32-7580-4e38-af7a-681196ae4f1f@getmailbird.com>
References: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>
 <CAHbON5pqG=zqZKbFJjWZ4sFxqYuJwNtW4ptmHTYATJywf-+pCA@mail.gmail.com>
 <570c3c32-7580-4e38-af7a-681196ae4f1f@getmailbird.com>
Message-ID: <CAHbON5o=jYcWLQUXiq3Zj9EdCHwb1e97_1i4-Q2HzfGBSp0CAw@mail.gmail.com>

Okay, then I was wrong about branch 2.4 supporting Centos 6.6. I have
CC'd a couple of Kernel developers that will know the correct answer.

On Fri, Aug 21, 2015 at 12:03 PM, ShapeHost <contact at shape.host> wrote:
> Hello,
>
>     Thanks for the information, i tested the new 2.4. and i have the same
> problem. :(
>
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> warning: type defaults to 'int' in declaration of 'ret__'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> warning: type defaults to 'int' in declaration of 'ret__'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> error: invalid type argument of 'unary *' (have 'int')
> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> warning: type defaults to 'int' in declaration of 'type name'
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/datapath.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/vport-internal_dev.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/flow_table.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/flow_netlink.o]
> Error 1
> make[2]: ***
> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/vport.o]
> Error 1
> make[1]: ***
> [_module_/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux]
> Error 2
> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
> make: *** [default] Error 2
> make: Leaving directory
> `/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux'
> error: Bad exit status from /var/tmp/rpm-tmp.1mXVkX (%build)
>
>
> RPM build errors:
>     Bad exit status from /var/tmp/rpm-tmp.1mXVkX (%build)
> [root at ns509777 openvswitch-2.4.0]#
>
>
> Regards,
> Cristian
>
> Regards,
>
> ShapeHost
>
> www.istream.today
>
> www.shape.host
>
> +40.733.955.922
>
>
>
> On 8/21/2015 8:29:02 PM, Gurucharan Shetty <shettyg at nicira.com> wrote:
>
> On Fri, Aug 21, 2015 at 5:02 AM, ShapeHost wrote:
>> Hello,
>>
>> I have some problem with openvswitch install on centos 6.6
>> 2.6.32-573.3.1.el6.x86_64.
>>
>> I tried to install many version of OVS like 1.9.0, 1.9.3, 1.10.0, 2.1.1,
>> 2.3.0.
> From what I understand, Centos6.6 is not supported with 2.3
>
> It is likely that OVS 2.4 will be released today. It is likely that
> Centos6.6 is supported in that version. branch2.4 is already created,
> so you can try that too.
>
>
>>
>> Every time i have problems on this line :
>> --------------------------------------
>> Starting Line #
>> ---------------------------------------
>> #[root at ns509777 openvswitch-2.1.1]# rpmbuild -bb
>> rhel/openvswitch-kmod-rhel6.spec
>> Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.hWy71a
>> + umask 022
>> + cd /root/rpmbuild/BUILD
>> + LANG=C
>> + export LANG
>> + unset DISPLAY
>> + cd /root/rpmbuild/BUILD
>> + rm -rf openvswitch-2.1.1
>> + /usr/bin/gzip -dc /root/rpmbuild/SOURCES/openvswitch-2.1.1.tar.gz
>> + /bin/tar -xvvf -
>>
>> ---------------------------------------------------
>> and is ending with this :
>> --------------------------------------------------
>> from
>>
>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../compat.h:26,
>> from
>>
>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../datapath.h:29,
>> from
>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.c:34:
>>
>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
>> error: redefinition of 'ip_is_fragment'
>> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was
>> here
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow.o]
>> Error 1
>> make[2]: *** Waiting for unfinished jobs....
>> In file included from include/net/xfrm.h:18,
>> from
>>
>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.c:39:
>>
>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
>> error: redefinition of 'ip_is_fragment'
>> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was
>> here
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.o]
>> Error 1
>> make[2]: ***
>>
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/dp_notify.o]
>> Error 1
>> make[2]: ***
>>
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/datapath.o]
>> Error 1
>> make[2]: ***
>>
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_netlink.o]
>> Error 1
>> make[2]: ***
>>
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.o]
>> Error 1
>> make[2]: ***
>>
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_table.o]
>> Error 1
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/actions.o]
>> Error 1
>> make[1]: ***
>> [_module_/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux]
>> Error 2
>> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
>> make: *** [default] Error 2
>> make: Leaving directory
>> `/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux'
>> error: Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
>>
>>
>> RPM build errors:
>> Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
>>
>>
>> -----------------------------------------------
>>
>> I'm going crazy :)) i'm not sure how to fix this, can i get some help ?
>>
>>
>>
>>
>>
>> Regards,
>>
>> Cristian
>>
>>
>>
>>
>>
>> _______________________________________________
>> discuss mailing list
>> discuss at openvswitch.org
>> http://openvswitch.org/mailman/listinfo/discuss
>>

From jason.burns at nutanix.com  Fri Aug 21 12:14:33 2015
From: jason.burns at nutanix.com (Jason Burns)
Date: Fri, 21 Aug 2015 19:14:33 +0000
Subject: [ovs-discuss] Open vSwitch balance-slb bond mode with two upstream
	switches
Message-ID: <59E36CB3-5F6B-46B5-AEB4-B663737F6DB1@nutanix.com>

I hope this is the right forum to ask this question. If not - feel free to direct me elsewhere.

Can the balance-slb bond mode in Open vSwitch be used for a bond connected to two separate upstream switches?

When I read the documentation [1] it states that only active-backup can be used to connect to two separate upstream switches, but no explanation is provided.

active-backup
                    Assigns  all flows to one slave, failing over to a backup
                    slave when the active slave is  disabled.   This  is  the
                    only bonding mode in which interfaces may be plugged into
                    different upstream switches

I read the INTERNALS [2] document to get more details on the complications with balance-slb, but after reading this I still don’t see anything that would prevent balance-slb from working when connected to two separate switches. My lab testing here is positive so far.

Am I missing some piece of information about why this is a bad idea? I’d like to take full advantage of the bond member bandwidth for the multiple virtual machines running on this host, AND get the fault tolerance that two separate switches provide. Ideally I’d be able to do this without any configuration on the switch side such as LACP. Is balance-slb a good way to do this, or is there some other way?

Thanks for your help!

[1] http://openvswitch.org/support/dist-docs/ovs-vswitchd.conf.db.5.html
[2] https://github.com/openvswitch/ovs/blob/master/vswitchd/INTERNALS

Jason Burns

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/d799b5b0/attachment.html>

From shague at gmail.com  Fri Aug 21 16:08:55 2015
From: shague at gmail.com (Sam Hague)
Date: Fri, 21 Aug 2015 19:08:55 -0400
Subject: [ovs-discuss] Is there a way to set vxlan tunnel dst_port via flow?
Message-ID: <CAFXH76cCAswtkcqRWKV-WPY5Xh9-up+1+pmK9Gof8WKF_pB53g@mail.gmail.com>

Is there a way to set the dst_port of the tunnel via flows? I know you can
use "options:dst_port=xxx" to set it on the bridge port. ovs-ofctl will
take options:dst_port=flow but I can't find what it would take to actually
set the port in the flow.

I imagine not since I can only see fields like "tun_id, tun_src, tun_dst,
NXM_NX_TUN_ID, NXM_NX_TUN_IPV4_SRC, NXM_NX_TUN_IPV4_DST" in the code.

If dst_port cannot be set via the flow what is the technical limitation?

The use case I was attempting was to be able to have two bridges on a
single host, where one bridge sends vxlan packets to the other bridge and I
want to keep that vxlan encapsulation without it being stripped by a vxlan
port. If you have a vxlan port on the receiving bridge then the vxlan is
stripped. So I thought maybe if the sending bridge could set a different
dst_port then the vxlan packet would just make it to the receiving bridge
as a typical ip/udp packet.

I see the below errors now when I try do prototype this. I am down in the
kernel or datapath the udp/vxlan header is seen so ovs is looking for a
vxlan port. Is that right? If so is there a way to add a flow that would
somehow mask the tunnel processing or grab the packet before the tunnel
stuff was processed?

2015-08-21T19:31:30.479Z|00026|ofproto_dpif_upcall(handler6)|INFO|received
packet on unassociated datapath port 8
2015-08-21T19:31:31.902Z|00005|tunnel(revalidator7)|WARN|receive tunnel
port not found
(tcp,tun_id=0x14,tun_src=10.1.1.2,tun_dst=10.1.1.1,tun_tos=0,t
un_ttl=64,key,metadata=0,in_port=8,vlan_tci=0x0000,dl_src=f6:00:00:0c:01:03,dl_dst=f6:00:00:0c:01:04,nw_src=10.2.1.3,nw_dst=10.2.1.4,nw_tos=0,nw_ecn=
0,nw_ttl=64,tp_src=58099,tp_dst=80,tcp_flags=0x002)
2015-08-21T19:31:33.483Z|00027|tunnel(handler6)|WARN|receive tunnel port
not found (tcp,tun_id=0x14,tun_src=10.1.1.2,tun_dst=10.1.1.1,tun_tos=0,tun_t
tl=64,key,metadata=0,in_port=8,vlan_tci=0x0000,dl_src=f6:00:00:0c:01:03,dl_dst=f6:00:00:0c:01:04,nw_src=10.2.1.3,nw_dst=10.2.1.4,nw_tos=0,nw_ecn=0,nw
_ttl=64,tp_src=58099,tp_dst=80,tcp_flags=0x002)
2015-08-21T19:31:33.483Z|00028|ofproto_dpif_upcall(handler6)|INFO|received
packet on unassociated datapath port 8
2015-08-21T19:31:35.483Z|00029|tunnel(handler6)|WARN|receive tunnel port
not found (arp,tun_id=0x14,tun_src=10.1.1.2,tun_dst=10.1.1.1,tun_tos=0,tun_t
tl=64,key,metadata=0,in_port=8,vlan_tci=0x0000,dl_src=f6:00:00:0c:01:03,dl_dst=f6:00:00:0c:01:04,arp_spa=10.2.1.3,arp_tpa=10.2.1.4,arp_op=1,arp_sha=f
6:00:00:0c:01:03,arp_tha=00:00:00:00:00:00)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/21a8914f/attachment-0001.html>

From jesse at nicira.com  Fri Aug 21 17:57:58 2015
From: jesse at nicira.com (Jesse Gross)
Date: Fri, 21 Aug 2015 17:57:58 -0700
Subject: [ovs-discuss] Preserve vxlan headers when sending to a
 non-vxlan port on bridge?
In-Reply-To: <CAFXH76cC2G0mnG2r1sh=N1Mjwi5g1pkVWWRtYiuw2gAcRrEYOg@mail.gmail.com>
References: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>
 <CAEP_g=9bMb4xqgDSD2Scfti4jvSyG3QPMkbn_-t=cOsLjAgNgg@mail.gmail.com>
 <CAFXH76cC2G0mnG2r1sh=N1Mjwi5g1pkVWWRtYiuw2gAcRrEYOg@mail.gmail.com>
Message-ID: <CAEP_g=-OU+W=eSBqU6PmqdB5fnv3fYgL4sX44K0j-5PviLdwEQ@mail.gmail.com>

On Thu, Aug 20, 2015 at 1:58 PM, Sam Hague <shague at gmail.com> wrote:
>
>
> On Thu, Aug 20, 2015 at 1:32 PM, Jesse Gross <jesse at nicira.com> wrote:
>>
>> On Thu, Aug 20, 2015 at 8:20 AM, Sam Hague <shague at gmail.com> wrote:
>> > Is it possible to send vxlan encapsulated packets to a bridge port and
>> > keep
>> > the vxlan headers?
>>
>> It's not possible unless you don't terminate the tunnels, in which
>> case you can't match on anything in the header.
>
>
> Is the only way to add vxlan headers by sending a packet out a vxlan port -
> whether the key/srcip/dstip are port or flow-based?

Yes.

> Is there any way to "overload" the vm port such that if I sent a vxlan
> packet froma normal vxlan port on the bridge it could come back into the
> bridge and to that vm port such that the vm would terminate the tunnel?
>
> The use case is for the typical openstack setup where the VMs are ports
> hanging off the bridge and flows are added to simply push normal l2-l4
> packets to the port. But I would like to terminate vxlan inside the VM
> itself but under this constraint that is was OpenStack that instantiated the
> VM in the way it typically does.
>
> So I could see adding some flows to send a vxlan packet out a port on the
> bridge, and somehow getting it to come back into the bridge and not have the
> header stripped. Typically those VM addresses are internal addresses which
> the host wouldn't know about so if I sent a vxlan out a bridge port, the
> network stack wouldn't send it back.

Presumably, in this case the destination IP address is owned by the
hypervisor. In that case, the hypervisor IP stack is going to consume
the packet regardless of what the OVS or VXLAN configuration is. The
only way around that is either to actually address packets to the VM
(either on the remote side or by re-encapsulating the packet locally)
or hack together some rules to prevent the hypervisor IP stack from
seeing the packet altogether, likely using NAT.

To answer your question from the other thread, the UDP dest port can't
be set by the flow. The reason for this is specifically to prevent the
situation you are trying to create - to receive packets, you need to
bind to the port ahead of time.

From shague at gmail.com  Fri Aug 21 19:24:27 2015
From: shague at gmail.com (Sam Hague)
Date: Fri, 21 Aug 2015 22:24:27 -0400
Subject: [ovs-discuss] Preserve vxlan headers when sending to a
 non-vxlan port on bridge?
In-Reply-To: <CAEP_g=-OU+W=eSBqU6PmqdB5fnv3fYgL4sX44K0j-5PviLdwEQ@mail.gmail.com>
References: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>
 <CAEP_g=9bMb4xqgDSD2Scfti4jvSyG3QPMkbn_-t=cOsLjAgNgg@mail.gmail.com>
 <CAFXH76cC2G0mnG2r1sh=N1Mjwi5g1pkVWWRtYiuw2gAcRrEYOg@mail.gmail.com>
 <CAEP_g=-OU+W=eSBqU6PmqdB5fnv3fYgL4sX44K0j-5PviLdwEQ@mail.gmail.com>
Message-ID: <CAFXH76eTnKK4DtJogs-i6bhoPv6Ki936sZfVCLjJ42g5Du4avw@mail.gmail.com>

On Fri, Aug 21, 2015 at 8:57 PM, Jesse Gross <jesse at nicira.com> wrote:

> On Thu, Aug 20, 2015 at 1:58 PM, Sam Hague <shague at gmail.com> wrote:
> >
> >
> > On Thu, Aug 20, 2015 at 1:32 PM, Jesse Gross <jesse at nicira.com> wrote:
> >>
> >> On Thu, Aug 20, 2015 at 8:20 AM, Sam Hague <shague at gmail.com> wrote:
> >> > Is it possible to send vxlan encapsulated packets to a bridge port and
> >> > keep
> >> > the vxlan headers?
> >>
> >> It's not possible unless you don't terminate the tunnels, in which
> >> case you can't match on anything in the header.
> >
> >
> > Is the only way to add vxlan headers by sending a packet out a vxlan
> port -
> > whether the key/srcip/dstip are port or flow-based?
>
> Yes.
>
> > Is there any way to "overload" the vm port such that if I sent a vxlan
> > packet froma normal vxlan port on the bridge it could come back into the
> > bridge and to that vm port such that the vm would terminate the tunnel?
> >
> > The use case is for the typical openstack setup where the VMs are ports
> > hanging off the bridge and flows are added to simply push normal l2-l4
> > packets to the port. But I would like to terminate vxlan inside the VM
> > itself but under this constraint that is was OpenStack that instantiated
> the
> > VM in the way it typically does.
> >
> > So I could see adding some flows to send a vxlan packet out a port on the
> > bridge, and somehow getting it to come back into the bridge and not have
> the
> > header stripped. Typically those VM addresses are internal addresses
> which
> > the host wouldn't know about so if I sent a vxlan out a bridge port, the
> > network stack wouldn't send it back.
>
> Presumably, in this case the destination IP address is owned by the
> hypervisor. In that case, the hypervisor IP stack is going to consume
> the packet regardless of what the OVS or VXLAN configuration is. The
> only way around that is either to actually address packets to the VM
> (either on the remote side or by re-encapsulating the packet locally)
> or hack together some rules to prevent the hypervisor IP stack from
> seeing the packet altogether, likely using NAT.
>

Yeah, was hoping I could find the trickery to get around this. I assigned
IP addresses to the two bridges and used those address as the src/dst for
the vxlan tunnel - without adding a vxlan port on the destination bridge,
thinking maybe it would sneak into the bridge as a l3 packet. But looks
like somewhere in the stack the packet was identified as vxlan and got into
OVS and OVS dropped it.

I can't think of a way to address packets to the VM directly since the VM's
address is an internal address that isn't visible outside the typical
Openstack neutron vxlan overlay. That overlay is from bridge to bridge so
not sure how to also get an overlay into the VM.

When you mention NAT, I think I would still have the same issue right?
Meaning I have to send the packet using vxlan so that I can get the payload
encapsulated with vxlan. Once that happens I am stuck with the problem that
somewhere that vxlan packet is getting consumed. Is there any other type of
flows I can add to get these packets?


> To answer your question from the other thread, the UDP dest port can't
> be set by the flow. The reason for this is specifically to prevent the
> situation you are trying to create - to receive packets, you need to
> bind to the port ahead of time.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/adbc118b/attachment.html>

From v.tolstov at selfip.ru  Sat Aug 22 01:48:04 2015
From: v.tolstov at selfip.ru (Vasiliy Tolstov)
Date: Sat, 22 Aug 2015 11:48:04 +0300
Subject: [ovs-discuss] Open vSwitch 2.4.0 Available
In-Reply-To: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
Message-ID: <CACaajQuMC28JFgFjSs_ePXW=BFpNbCaqe7T89zeNh7E1wauvQw@mail.gmail.com>

2015-08-21 20:51 GMT+03:00 Justin Pettit <jpettit at nicira.com>:
> The Open vSwitch team is pleased to announce the release of Open vSwitch 2.4.0:
>
>    http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz
>
> This release contains the largest number of new features of an Open vSwitch release.  A few feature highlights of 2.4.0 include:


Very good job! Thanks! What is the status of ipv6 tunneling support
for current ovs master ?

-- 
Vasiliy Tolstov,
e-mail: v.tolstov at selfip.ru

From mark.d.gray at intel.com  Sat Aug 22 09:47:05 2015
From: mark.d.gray at intel.com (Gray, Mark D)
Date: Sat, 22 Aug 2015 16:47:05 +0000
Subject: [ovs-discuss] OVS with DPDK 2.1.0
In-Reply-To: <CAHjVv4saLuDYbhzaNy2yS4PDP6uGFK8Bi1nF=arLPpJwki4VqQ@mail.gmail.com>
References: <CAHjVv4saLuDYbhzaNy2yS4PDP6uGFK8Bi1nF=arLPpJwki4VqQ@mail.gmail.com>
Message-ID: <738D45BC1F695740A983F43CFE1B7EA9437D9053@IRSMSX108.ger.corp.intel.com>

> Hello,
> 
> could you please tell me if OVS is already compatibile with recently released
> DPDK 2.1.0? Or what sould I do to make it work, when I am receiving "cannot
> link with dpdk" error - DPDK 2.0.0 works for me.

There are few small changes required which fix a performance regression.
We are going to post a patch in a couple of days. The issue you are seeing is that
the DPDK library name has changed. You could hold off until we post the full patch
or you could try changing DPDK_LIB="-ldpdk" in acinclude.m4.


From jesse at nicira.com  Sat Aug 22 13:21:24 2015
From: jesse at nicira.com (Jesse Gross)
Date: Sat, 22 Aug 2015 13:21:24 -0700
Subject: [ovs-discuss] [ovs-announce] Open vSwitch 2.4.0 Available
In-Reply-To: <CACaajQuMC28JFgFjSs_ePXW=BFpNbCaqe7T89zeNh7E1wauvQw@mail.gmail.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
 <CACaajQuMC28JFgFjSs_ePXW=BFpNbCaqe7T89zeNh7E1wauvQw@mail.gmail.com>
Message-ID: <CAEP_g=-j3FwDPtyvHS9DgNu3w-cgxFzxCt-v=+9DMdWEGgCh9A@mail.gmail.com>

On Saturday, August 22, 2015, Vasiliy Tolstov <v.tolstov at selfip.ru> wrote:

> 2015-08-21 20:51 GMT+03:00 Justin Pettit <jpettit at nicira.com
> <javascript:;>>:
> > The Open vSwitch team is pleased to announce the release of Open vSwitch
> 2.4.0:
> >
> >    http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz
> >
> > This release contains the largest number of new features of an Open
> vSwitch release.  A few feature highlights of 2.4.0 include:
>
>
> Very good job! Thanks! What is the status of ipv6 tunneling support
> for current ovs master ?
>

There is work going on but no code is checked in yet.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150822/4b4ca3d6/attachment.html>

From seamus.na at gmail.com  Sat Aug 22 20:09:42 2015
From: seamus.na at gmail.com (=?utf-8?B?c2VhbXVzLm5h?=)
Date: Sun, 23 Aug 2015 11:09:42 +0800
Subject: [ovs-discuss] =?utf-8?b?5Zue5aSN77yaIElzIHRoZXJlIGEgd2F5IHRvIHNl?=
 =?utf-8?q?t_vxlan_tunnel_dst=5Fport_via_flow=3F?=
References: <CAFXH76cCAswtkcqRWKV-WPY5Xh9-up+1+pmK9Gof8WKF_pB53g@mail.gmail.com>
Message-ID: <tencent_95FD7730511E0D9D3A4DBD63@qq.com>

An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150823/65386f29/attachment.html>

From chao.hu at ericsson.com  Fri Aug 21 12:51:15 2015
From: chao.hu at ericsson.com (Chao Hu)
Date: Fri, 21 Aug 2015 19:51:15 +0000
Subject: [ovs-discuss] a problem about passing metadata in packet-in
Message-ID: <20B66EA7EF50DC49A18DB7C78070FB344145B4E1@ESGSCMB109.ericsson.se>

Hi,

I'm trying to pass metadata from OVS switch to controller but always get 0. Anything wrong with my steps?
My test environment is:
OVS: 2.0.2
OVS-controller: 2.3.1
OF: OpenFlow1.3

My test steps are:

1.       Make OVS-controller to send a OFPRAW_NXT_SET_PACKET_IN_FORMAT message to OVS switch, to set the packet-in-format to NXM (Nicira Extended). As I captured, it's a OFPT_EXPERIMENTER packet and the content is exactly the same with the packet of running "ovs-ofctl monitor -P nxm tcp:myip:6653 -O OpenFlow13". Seems Switch do nothing after received this packet.

2.        Add a flow to OVS switch:
cookie=0x0, duration=28.019s, table=0, n_packets=0, n_bytes=0, in_port=2 actions=CONTROLLER:65535,write_metadata:0x11/0xffff

3.       OVS switch send the packet-in traffic to controller when it matches above flow, but metadata is 0.

Thanks!
Chao
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/a51613a7/attachment-0001.html>

From Gabe.Black at viavisolutions.com  Fri Aug 21 15:58:26 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Fri, 21 Aug 2015 22:58:26 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <4B1BB321037C0849AAE171801564DFA645170A6D@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645170A6D@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5BD58@AMEXMB01.ds.jdsu.net>

Hi Sean,

I thought I had it "working".  I spent all day trying to get my vms to access the external network.  I was unsuccessful.  I used your flavor setting as well, but that didn't help.

Furthermore, when I create a new network, and attach the VMs to that network, I can't get the VMs to ping eachother either (and thus I can't test the dpdk datapath)

I'm at a loss of what to do next to try and figure it out.  The xml is vm's qemu is autocreated with everything that I think is necessary when I apply the nova flavor-key thing you mentioned below (both the memoryBacking and the <cpu>... memAccess="shared">... elements are there); that is, no manual editing of the xml seems to be required.

I saw that a new release came out and I copied the local.conf.single_node and used that (of course replacing my host_ip with corresponding values for my em1 interface and then using p6p1 for the data interface.

That created that stack environment it seemed without a hitch, except the demo tenant did not get a private network and router to the public network automatically created as before.  So I manually created those, as well as a dummy network and hung two vms off each of those networks, (the private one with a router to the public network, and the dummy network).

Neither VM got any dhcp address from the private network - ok, I may not have created the router, etc correctly, but at least I should be able to ping between the two vms on the dummy network.  After statically assigning the IPs that nova assigned to the ports on the dummy network for those vms, neither could ping eachother.

I'm at a loss of what I might be missing.  I think maybe I just need to reimage the box and start from a completely clean Ubuntu 15.04 install just to make sure artifacts from previous attempts aren't hanging around.

Anyway, thanks for all the help you have provided, and have a good weekend!
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 1:54 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi I am glad you got it working.
Thanks for reminding me about apparmor also.

We had set all profiles into complain mode but it was still blocking access to the vhost user sockets on our system also.

Apt-get purge apparmor results in vms booting correctly on our system also.
For now we will document this as a workaround and investage updating the apparmor profile to allow access to the
/var/run/openvswitch directory.

Just incase you are not aware to have network connective in the vm when  booting via openstack it is also neesicary to request hugepages
This can be done by modifying the flavor as follows
nova flavor-key <FLAVOR> set hw:mem_page_size=large
without this flavor extra spec option nova will not generate hugepage element or populate the pages element.

on the acceleration question
br-p6p1 and br-int  both use the dpdk enabled netdev datapath.

Because both bridges are connected by a patch port ovs is able to
Collapse the two bridges into a single datapath. This effectively means that while there are
Two logical bridges with the vm vhost-user port connected to br-int and the dpdk physical port connected
To br-p6p1 it is the equivalent of connecting all ports to a single bridge.

Regards
Sean.

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Thursday, August 20, 2015 5:20 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Ok, I think I found the config that had it boot.

Your example xml that you attached had:

<memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB' nodeset='0'/>
    </hugepages>
  </memoryBacking>

The page element was the missing piece for me.

Thanks!


From: Gabe Black
Sent: Thursday, August 20, 2015 9:31 AM
To: 'Mooney, Sean K'
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150821/af24db77/attachment-0001.html>

From qcorba at gmail.com  Sun Aug 23 03:18:20 2015
From: qcorba at gmail.com (qcorba)
Date: Sun, 23 Aug 2015 18:18:20 +0800
Subject: [ovs-discuss] [openvswitch 2.4.0] testsuite: 10 11 12 13 14 15 20
 21 22 23 24 25 26 27 28 29 94 95 96 97 98 367 375 392 393 394 395 396 397
 398 399 417 418 419 420 421 422 423 424 625 626 627 628 629 630 631 636 637
 673 749 750 751 752 756 757 758 759 760 761 762 779 780 781 785 786 787 788
 789 790 791 792 793 795 796 797 798 799 800 801 802 803 804 805 806 807 808
 809 810 811 812 813 814 815 819 820 821 822 823 824 825 826 827 828 829 830
 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849
 850 851 852 853 854 855 856 857 859 860 861 862 863 864 865 866 867 868 869
 870 871 872 873 874 877 878 879 880 881 882 884 885 886 887 888 889 890 891
 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 911
 912 913 915 916 917 918 919 920 921 922 924 1392 1395 1396 1397 1398 1399
 1400 1401 1402 1403 1404 1405 1406 1407 1408 1409 1410 1411 1412 1413 1414
 1415 1416 1417 1418 1419 1420 1599 1606 failed
Message-ID: <CANjJQeYj=QgaAQ1m76WNHKHpr5qQChiO7HWuq5fpN-f4cZH_Zg@mail.gmail.com>


-------------- next part --------------
A non-text attachment was scrubbed...
Name: testsuite.log.bz2
Type: application/x-bzip2
Size: 247320 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150823/d1330673/attachment-0001.bin>

From pradeeps at linux.vnet.ibm.com  Sun Aug 23 10:06:20 2015
From: pradeeps at linux.vnet.ibm.com (Pradeep Satyanarayana)
Date: Sun, 23 Aug 2015 10:06:20 -0700
Subject: [ovs-discuss] Open vSwitch 2.4.0 Available
In-Reply-To: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
Message-ID: <55D9FD8C.2000900@linux.vnet.ibm.com>

On 08/21/2015 10:51 AM, Justin Pettit wrote:
> The Open vSwitch team is pleased to announce the release of Open vSwitch 2.4.0:
>
>     http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz
>
> This release contains the largest number of new features of an Open vSwitch release.  A few feature highlights of 2.4.0 include:
>
>    - Support for the Rapid Spanning Tree Protocol (IEEE 802.1D-2004).
>
>    - Support for multicast snooping (IGMPv1, IGMPv2 and IGMPv3).
>
>    - A new "conjunctive match" OpenFlow extension that allows flows to be
>      constructed without introducing a Cartesian Product explosion.
>
>    - Add bash command-line completion for most CLI commands.
>
>    - Support for transactional flow updates through OpenFlow 1.4 Bundles.
>
>    - A number of new features from the latest OpenFlow specifications.
>
>    - A simple wrapper script, 'ovs-docker', to integrate OVS with Docker
>      containers.
>
>    - Support for STT and basic Geneve tunneling in Linux kernels.
>
>    - Support for VXLAN Group Policy extension.
>
>    - Support for DPDK Tunneling. VXLAN, GRE, and Geneve are supported
>      protocols.
>
>    - Support for DPDK vHost.

Thanks for all of the work that went into this release!

Can you tell me which version of DPDK has been integrated and tested in 
OVS 2.4? Was that DPDK 2.0.0 or 2.1.0?

-Pradeep


From gowrishankar.m at linux.vnet.ibm.com  Mon Aug 24 00:35:33 2015
From: gowrishankar.m at linux.vnet.ibm.com (gowrishankar)
Date: Mon, 24 Aug 2015 13:05:33 +0530
Subject: [ovs-discuss] OVS with DPDK 2.1.0
In-Reply-To: <738D45BC1F695740A983F43CFE1B7EA9437D9053@IRSMSX108.ger.corp.intel.com>
References: <CAHjVv4saLuDYbhzaNy2yS4PDP6uGFK8Bi1nF=arLPpJwki4VqQ@mail.gmail.com>
 <738D45BC1F695740A983F43CFE1B7EA9437D9053@IRSMSX108.ger.corp.intel.com>
Message-ID: <55DAC945.2060603@linux.vnet.ibm.com>

Hi,

I could get build done and dpdk 2.1.0 running along with ovs 2.4.0.
In case you wish to refer the changes I applied (including -ldpdk):

           1. configure script to check libdpdk.a (not libintel_dpdk.a).
           2. include libnuma-dev package if you enable 
CONFIG_RTE_LIBRTE_VHOST_NUMA.
           3. virtio-net.c:(.text+0x904): undefined reference to 
`get_mempolicy'
              configure script to also include libnuma along with libdpdk.

TCP over vxlan overlay works unless the segment size is equal to MSS. 
While at MSS,
I see receiving guest dropping packets due to tcp checksum invalid. As I 
see same
cksum value thrown at sender side (though wrong!), I suspect sender side 
has put
wrong cksum. I used MSS not more than 1450 to accommodate vxlan 
encapsulation.
I had also tried disabling all possible offload features (tso,tx csum, 
gso) in both guest's
vnic (using ethtool). In fact, just switching dpdk sdk to 2.0.0 for same 
OVS code did not
cause any such problem (just to verify).

I then tried same code base (just built for above dpdk ports) for a 
plain vxlan (phy nic
as tunnel end points). Everything works in TCP. I just thought of 
sharing this checksum
issue here so that, if anyone have already fixed, could you please share 
your finding.

Regards,
Gowrishankar

On Saturday 22 August 2015 10:17 PM, Gray, Mark D wrote:
>> Hello,
>>
>> could you please tell me if OVS is already compatibile with recently released
>> DPDK 2.1.0? Or what sould I do to make it work, when I am receiving "cannot
>> link with dpdk" error - DPDK 2.0.0 works for me.
> There are few small changes required which fix a performance regression.
> We are going to post a patch in a couple of days. The issue you are seeing is that
> the DPDK library name has changed. You could hold off until we post the full patch
> or you could try changing DPDK_LIB="-ldpdk" in acinclude.m4.
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss


From kevin.traynor at intel.com  Mon Aug 24 01:57:54 2015
From: kevin.traynor at intel.com (Traynor, Kevin)
Date: Mon, 24 Aug 2015 08:57:54 +0000
Subject: [ovs-discuss] Open vSwitch 2.4.0 Available
In-Reply-To: <55D9FD8C.2000900@linux.vnet.ibm.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
 <55D9FD8C.2000900@linux.vnet.ibm.com>
Message-ID: <BC0FEEC7D7650749874CEC11314A88F7451F99CE@IRSMSX104.ger.corp.intel.com>


> -----Original Message-----
> From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of Pradeep
> Satyanarayana
> Sent: Sunday, August 23, 2015 6:06 PM
> To: discuss at openvswitch.org
> Subject: Re: [ovs-discuss] Open vSwitch 2.4.0 Available
> 
> On 08/21/2015 10:51 AM, Justin Pettit wrote:
> > The Open vSwitch team is pleased to announce the release of Open vSwitch
> 2.4.0:
> >
> >     http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz
> >
> > This release contains the largest number of new features of an Open vSwitch
> release.  A few feature highlights of 2.4.0 include:
> >
> >    - Support for the Rapid Spanning Tree Protocol (IEEE 802.1D-2004).
> >
> >    - Support for multicast snooping (IGMPv1, IGMPv2 and IGMPv3).
> >
> >    - A new "conjunctive match" OpenFlow extension that allows flows to be
> >      constructed without introducing a Cartesian Product explosion.
> >
> >    - Add bash command-line completion for most CLI commands.
> >
> >    - Support for transactional flow updates through OpenFlow 1.4 Bundles.
> >
> >    - A number of new features from the latest OpenFlow specifications.
> >
> >    - A simple wrapper script, 'ovs-docker', to integrate OVS with Docker
> >      containers.
> >
> >    - Support for STT and basic Geneve tunneling in Linux kernels.
> >
> >    - Support for VXLAN Group Policy extension.
> >
> >    - Support for DPDK Tunneling. VXLAN, GRE, and Geneve are supported
> >      protocols.
> >
> >    - Support for DPDK vHost.
> 
> Thanks for all of the work that went into this release!
> 
> Can you tell me which version of DPDK has been integrated and tested in
> OVS 2.4? Was that DPDK 2.0.0 or 2.1.0?

DPDK 2.0.0. The DPDK version is listed at the top of the INSTALL.DPDK.md file.

> 
> -Pradeep
> 
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

From gal.sagie at gmail.com  Mon Aug 24 02:19:29 2015
From: gal.sagie at gmail.com (Gal Sagie)
Date: Mon, 24 Aug 2015 12:19:29 +0300
Subject: [ovs-discuss] Open vSwitch 2.4.0 Available
In-Reply-To: <BC0FEEC7D7650749874CEC11314A88F7451F99CE@IRSMSX104.ger.corp.intel.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
 <55D9FD8C.2000900@linux.vnet.ibm.com>
 <BC0FEEC7D7650749874CEC11314A88F7451F99CE@IRSMSX104.ger.corp.intel.com>
Message-ID: <CAG9LJa5RAUnJXEoxjtLognAMA0LJe7dB53M5oq5Jpkmu_LRuiw@mail.gmail.com>

Wasn't the connection tracking integration was suppose to be out in this
version as well?
Is it delayed?

On Mon, Aug 24, 2015 at 11:57 AM, Traynor, Kevin <kevin.traynor at intel.com>
wrote:

>
> > -----Original Message-----
> > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of
> Pradeep
> > Satyanarayana
> > Sent: Sunday, August 23, 2015 6:06 PM
> > To: discuss at openvswitch.org
> > Subject: Re: [ovs-discuss] Open vSwitch 2.4.0 Available
> >
> > On 08/21/2015 10:51 AM, Justin Pettit wrote:
> > > The Open vSwitch team is pleased to announce the release of Open
> vSwitch
> > 2.4.0:
> > >
> > >     http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz
> > >
> > > This release contains the largest number of new features of an Open
> vSwitch
> > release.  A few feature highlights of 2.4.0 include:
> > >
> > >    - Support for the Rapid Spanning Tree Protocol (IEEE 802.1D-2004).
> > >
> > >    - Support for multicast snooping (IGMPv1, IGMPv2 and IGMPv3).
> > >
> > >    - A new "conjunctive match" OpenFlow extension that allows flows to
> be
> > >      constructed without introducing a Cartesian Product explosion.
> > >
> > >    - Add bash command-line completion for most CLI commands.
> > >
> > >    - Support for transactional flow updates through OpenFlow 1.4
> Bundles.
> > >
> > >    - A number of new features from the latest OpenFlow specifications.
> > >
> > >    - A simple wrapper script, 'ovs-docker', to integrate OVS with
> Docker
> > >      containers.
> > >
> > >    - Support for STT and basic Geneve tunneling in Linux kernels.
> > >
> > >    - Support for VXLAN Group Policy extension.
> > >
> > >    - Support for DPDK Tunneling. VXLAN, GRE, and Geneve are supported
> > >      protocols.
> > >
> > >    - Support for DPDK vHost.
> >
> > Thanks for all of the work that went into this release!
> >
> > Can you tell me which version of DPDK has been integrated and tested in
> > OVS 2.4? Was that DPDK 2.0.0 or 2.1.0?
>
> DPDK 2.0.0. The DPDK version is listed at the top of the INSTALL.DPDK.md
> file.
>
> >
> > -Pradeep
> >
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>



-- 
Best Regards ,

The G.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150824/37fa1623/attachment.html>

From sean.k.mooney at intel.com  Mon Aug 24 04:07:20 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Mon, 24 Aug 2015 11:07:20 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5BD58@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645170A6D@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5BD58@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA6451743D7@IRSMSX107.ger.corp.intel.com>

Hi Gabe.
I don't know if you have reimaged your board yet.

If you have not can you check 5 things for me.

First  when you have one of the vms booted can you provide the output of

ps aux| grep qemu

second can you run ifconfig in the guest and see if packet sent from the guest are reported
as transmitted via eth0

third if they are transmitted for the guest can you check if they are received by the vswitch

this can be done by using
sudo ovs-ofctl dump-ports br-int
or
sudo ovs-ofctl dump-flows br-int

when you run the above command you should either see the port statics increase or a packet hit one of the flows.

If the packet is still making it this far can you check in the remote vm with tcpdump or ifconfig if the guest recives it?

Finally can you check the ovs-vswitchd  log.
It will be in /opt/stack/logs or where ever you have set for you log directory in your local.conf
If no log directory is set it will be in  /tmp
In the vswitchd log you should see a message saying the usvhost port was added. Are there any relevant error messages in the log?

We were able to get one node working on Ubuntu 14.04 with ovs-dpdk and connectivity between vms on Friday and are
Currently repeating the process to make sure we have captured all the steps.
We hope  to submit a patch to our networking-ovs-dpdk repo with documentation and support for Ubuntu in the next week to 2 weeks.

Regards
sean

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Friday, August 21, 2015 11:58 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

I thought I had it "working".  I spent all day trying to get my vms to access the external network.  I was unsuccessful.  I used your flavor setting as well, but that didn't help.

Furthermore, when I create a new network, and attach the VMs to that network, I can't get the VMs to ping eachother either (and thus I can't test the dpdk datapath)

I'm at a loss of what to do next to try and figure it out.  The xml is vm's qemu is autocreated with everything that I think is necessary when I apply the nova flavor-key thing you mentioned below (both the memoryBacking and the <cpu>... memAccess="shared">... elements are there); that is, no manual editing of the xml seems to be required.

I saw that a new release came out and I copied the local.conf.single_node and used that (of course replacing my host_ip with corresponding values for my em1 interface and then using p6p1 for the data interface.

That created that stack environment it seemed without a hitch, except the demo tenant did not get a private network and router to the public network automatically created as before.  So I manually created those, as well as a dummy network and hung two vms off each of those networks, (the private one with a router to the public network, and the dummy network).

Neither VM got any dhcp address from the private network - ok, I may not have created the router, etc correctly, but at least I should be able to ping between the two vms on the dummy network.  After statically assigning the IPs that nova assigned to the ports on the dummy network for those vms, neither could ping eachother.

I'm at a loss of what I might be missing.  I think maybe I just need to reimage the box and start from a completely clean Ubuntu 15.04 install just to make sure artifacts from previous attempts aren't hanging around.

Anyway, thanks for all the help you have provided, and have a good weekend!
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 1:54 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi I am glad you got it working.
Thanks for reminding me about apparmor also.

We had set all profiles into complain mode but it was still blocking access to the vhost user sockets on our system also.

Apt-get purge apparmor results in vms booting correctly on our system also.
For now we will document this as a workaround and investage updating the apparmor profile to allow access to the
/var/run/openvswitch directory.

Just incase you are not aware to have network connective in the vm when  booting via openstack it is also neesicary to request hugepages
This can be done by modifying the flavor as follows
nova flavor-key <FLAVOR> set hw:mem_page_size=large
without this flavor extra spec option nova will not generate hugepage element or populate the pages element.

on the acceleration question
br-p6p1 and br-int  both use the dpdk enabled netdev datapath.

Because both bridges are connected by a patch port ovs is able to
Collapse the two bridges into a single datapath. This effectively means that while there are
Two logical bridges with the vm vhost-user port connected to br-int and the dpdk physical port connected
To br-p6p1 it is the equivalent of connecting all ports to a single bridge.

Regards
Sean.

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Thursday, August 20, 2015 5:20 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Ok, I think I found the config that had it boot.

Your example xml that you attached had:

<memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB' nodeset='0'/>
    </hugepages>
  </memoryBacking>

The page element was the missing piece for me.

Thanks!


From: Gabe Black
Sent: Thursday, August 20, 2015 9:31 AM
To: 'Mooney, Sean K'
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150824/2b50115d/attachment-0001.html>

From ychen103103 at 163.com  Mon Aug 24 05:43:26 2015
From: ychen103103 at 163.com (ychen)
Date: Mon, 24 Aug 2015 20:43:26 +0800 (CST)
Subject: [ovs-discuss] QoS question: ovs- QoS configuration and linux-QoS
Message-ID: <25cab8b0.18d9b.14f5fbc15d3.Coremail.ychen103103@163.com>

>scenario like this:
>
>        1. In the OVS database, the manager (which could be a human admin
>           or a program) sets an interface to use some particular QoS
>           settings.  OVS configures them on the interface.
>
>        2. Someone stops OVS.
>
>        3. The manager deletes the QoS settings from the OVS database.
>
>       4. Someone starts OVS again.
>
>Currently, following step 4, OVS clears the QoS settings, because it
>always believes that it owns them, but with this change it would
>preserve them.I have one question, while internal port is created by ovs-vsctl command,then when OVS stopped,  why this internal port still exists? In this condition, I think it is rational to clear OVS QoS settings when DB settings changed,because we set the QoS by OVS command.



>Other possible changes in this area, with different tradeoffs:
>
>        * Add a QoS type that says that OVS should leave the QoS
>          settings alone for an interface.  This would solve the problem
>          but it seems user-unfriendly, since it is surprising that OVS

>          changes the QoS settings at all if it isn't asked to do so.
I think it is a good idea. OVS configure egress QoS with this method.
when egress QoS is disabled, we set the QoS type to null, or just clear port qos.
maybe we can coding just like egress QoS do:
in function iface_configure_qos():
if (!qos || qos->type[0] == '\0' || qos->n_queues < 1) {
        netdev_set_qos(iface->netdev, NULL, NULL);
}
in function netdev_linux_set_qos():

if (new_ops == netdev->tc->ops) {
        error = new_ops->qdisc_set ? new_ops->qdisc_set(netdev_, details) : 0;
    } else {
...
}
so if egress QoS is already disabled, it will do nothing(if branch)
and if egress QoS is cleared, it will enter the else branch.


>        * Make OVS record in the database when it changes the QoS
>          settings (upon request only), so that it can change them back
>          only if it set them up to begin with.  This might be hard to
>          do reliably across system reboots and deletions and creations

>          of distinct network devices that have the same name.
If ingress QoS is set by linux tc, then the qdisc rule may more complicated than OVS ingress policing,
and so there maybe not one-to-one mapping from linux QoS to OVS QoS.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150824/3f5a3abb/attachment.html>

From gowrishankar.m at linux.vnet.ibm.com  Mon Aug 24 06:13:48 2015
From: gowrishankar.m at linux.vnet.ibm.com (gowrishankar)
Date: Mon, 24 Aug 2015 18:43:48 +0530
Subject: [ovs-discuss] OVS with DPDK 2.1.0
In-Reply-To: <55DAC945.2060603@linux.vnet.ibm.com>
References: <CAHjVv4saLuDYbhzaNy2yS4PDP6uGFK8Bi1nF=arLPpJwki4VqQ@mail.gmail.com>
 <738D45BC1F695740A983F43CFE1B7EA9437D9053@IRSMSX108.ger.corp.intel.com>
 <55DAC945.2060603@linux.vnet.ibm.com>
Message-ID: <55DB188C.4060603@linux.vnet.ibm.com>

On Monday 24 August 2015 01:05 PM, gowrishankar wrote:
> Hi,
>
> I could get build done and dpdk 2.1.0 running along with ovs 2.4.0.
> In case you wish to refer the changes I applied (including -ldpdk):
>
>           1. configure script to check libdpdk.a (not libintel_dpdk.a).
>           2. include libnuma-dev package if you enable 
> CONFIG_RTE_LIBRTE_VHOST_NUMA.
>           3. virtio-net.c:(.text+0x904): undefined reference to 
> `get_mempolicy'
>              configure script to also include libnuma along with libdpdk.
>
> TCP over vxlan overlay works unless the segment size is equal to MSS. 
> While at MSS,
> I see receiving guest dropping packets due to tcp checksum invalid. As 
> I see same

On some deeper inspection with snooping on dpdk ports between the 
systems (MTU 1450),
I observed that, when a payload size not more than 920, tcp checksum 
seems to be correctly
set by sender (as receiver validated and accepted). I tried sending tcp 
payload more than
this 920 and upto mss, but all these times, invalid checksum is reported 
in packet captures.

I could not get any clue on why this 920 is magical fig here.. I tried 
building dpdk with
possible CONFIG_RTE_LIBRTE_xx debug variables and loading dpdk again, 
but no debug
traces being reported in both syslog and ovs vswitchd log. Any pointer 
to inspect further ?


> cksum value thrown at sender side (though wrong!), I suspect sender 
> side has put
> wrong cksum. I used MSS not more than 1450 to accommodate vxlan 
> encapsulation.

Typo. MTU I meant.

> I had also tried disabling all possible offload features (tso,tx csum, 
> gso) in both guest's
> vnic (using ethtool). In fact, just switching dpdk sdk to 2.0.0 for 
> same OVS code did not
> cause any such problem (just to verify).
>
> I then tried same code base (just built for above dpdk ports) for a 
> plain vxlan (phy nic
> as tunnel end points). Everything works in TCP. I just thought of 
> sharing this checksum
> issue here so that, if anyone have already fixed, could you please 
> share your finding.
>
> Regards,
> Gowrishankar
>
> On Saturday 22 August 2015 10:17 PM, Gray, Mark D wrote:
>>> Hello,
>>>
>>> could you please tell me if OVS is already compatibile with recently 
>>> released
>>> DPDK 2.1.0? Or what sould I do to make it work, when I am receiving 
>>> "cannot
>>> link with dpdk" error - DPDK 2.0.0 works for me.
>> There are few small changes required which fix a performance regression.
>> We are going to post a patch in a couple of days. The issue you are 
>> seeing is that
>> the DPDK library name has changed. You could hold off until we post 
>> the full patch
>> or you could try changing DPDK_LIB="-ldpdk" in acinclude.m4.
>>
>> _______________________________________________
>> discuss mailing list
>> discuss at openvswitch.org
>> http://openvswitch.org/mailman/listinfo/discuss


-- 
Regards,
Gowrishankar M


From ben.jannet.khaled at gmail.com  Sun Aug 23 16:03:35 2015
From: ben.jannet.khaled at gmail.com (khaled ben jannet)
Date: Mon, 24 Aug 2015 00:03:35 +0100
Subject: [ovs-discuss] OVS fail after rebooting Xenserver 6.2
Message-ID: <CAM9JGNMgL9wQpJeWJaBGvzet0iSJ+EXyyPjf=iujHoyDWHEeug@mail.gmail.com>

Hello,

I'm working with Xenserver 6.2 and Cloudstack 4.4

Xenserver is configured with openvswitch, every new network create a new
tunnel. The issue is that when we reboot an Xenserver host all tunnel are
droped.

Then when I migrate an existing vm to the host it lose connectivity with
the other VM in the same network, but when we create a ew tunnel and new VM
it works correctly.

Can you help me on this issue ?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150824/077bcd7e/attachment.html>

From Gabe.Black at viavisolutions.com  Mon Aug 24 09:07:51 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Mon, 24 Aug 2015 16:07:51 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <4B1BB321037C0849AAE171801564DFA6451743D7@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645170A6D@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5BD58@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA6451743D7@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5DE47@AMEXMB01.ds.jdsu.net>

I have already reimaged, however I will take those steps and let you know if/when I run in to it again.

Thanks,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Monday, August 24, 2015 5:07 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Gabe.
I don't know if you have reimaged your board yet.
If you have not can you check 5 things for me.

First  when you have one of the vms booted can you provide the output of

ps aux| grep qemu

second can you run ifconfig in the guest and see if packet sent from the guest are reported
as transmitted via eth0

third if they are transmitted for the guest can you check if they are received by the vswitch

this can be done by using
sudo ovs-ofctl dump-ports br-int
or
sudo ovs-ofctl dump-flows br-int

when you run the above command you should either see the port statics increase or a packet hit one of the flows.

If the packet is still making it this far can you check in the remote vm with tcpdump or ifconfig if the guest recives it?

Finally can you check the ovs-vswitchd  log.
It will be in /opt/stack/logs or where ever you have set for you log directory in your local.conf
If no log directory is set it will be in  /tmp
In the vswitchd log you should see a message saying the usvhost port was added. Are there any relevant error messages in the log?

We were able to get one node working on Ubuntu 14.04 with ovs-dpdk and connectivity between vms on Friday and are
Currently repeating the process to make sure we have captured all the steps.
We hope  to submit a patch to our networking-ovs-dpdk repo with documentation and support for Ubuntu in the next week to 2 weeks.
Regards
sean

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Friday, August 21, 2015 11:58 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

I thought I had it "working".  I spent all day trying to get my vms to access the external network.  I was unsuccessful.  I used your flavor setting as well, but that didn't help.

Furthermore, when I create a new network, and attach the VMs to that network, I can't get the VMs to ping eachother either (and thus I can't test the dpdk datapath)

I'm at a loss of what to do next to try and figure it out.  The xml is vm's qemu is autocreated with everything that I think is necessary when I apply the nova flavor-key thing you mentioned below (both the memoryBacking and the <cpu>... memAccess="shared">... elements are there); that is, no manual editing of the xml seems to be required.

I saw that a new release came out and I copied the local.conf.single_node and used that (of course replacing my host_ip with corresponding values for my em1 interface and then using p6p1 for the data interface.

That created that stack environment it seemed without a hitch, except the demo tenant did not get a private network and router to the public network automatically created as before.  So I manually created those, as well as a dummy network and hung two vms off each of those networks, (the private one with a router to the public network, and the dummy network).

Neither VM got any dhcp address from the private network - ok, I may not have created the router, etc correctly, but at least I should be able to ping between the two vms on the dummy network.  After statically assigning the IPs that nova assigned to the ports on the dummy network for those vms, neither could ping eachother.

I'm at a loss of what I might be missing.  I think maybe I just need to reimage the box and start from a completely clean Ubuntu 15.04 install just to make sure artifacts from previous attempts aren't hanging around.

Anyway, thanks for all the help you have provided, and have a good weekend!
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 1:54 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi I am glad you got it working.
Thanks for reminding me about apparmor also.

We had set all profiles into complain mode but it was still blocking access to the vhost user sockets on our system also.

Apt-get purge apparmor results in vms booting correctly on our system also.
For now we will document this as a workaround and investage updating the apparmor profile to allow access to the
/var/run/openvswitch directory.

Just incase you are not aware to have network connective in the vm when  booting via openstack it is also neesicary to request hugepages
This can be done by modifying the flavor as follows
nova flavor-key <FLAVOR> set hw:mem_page_size=large
without this flavor extra spec option nova will not generate hugepage element or populate the pages element.

on the acceleration question
br-p6p1 and br-int  both use the dpdk enabled netdev datapath.

Because both bridges are connected by a patch port ovs is able to
Collapse the two bridges into a single datapath. This effectively means that while there are
Two logical bridges with the vm vhost-user port connected to br-int and the dpdk physical port connected
To br-p6p1 it is the equivalent of connecting all ports to a single bridge.

Regards
Sean.

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Thursday, August 20, 2015 5:20 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Ok, I think I found the config that had it boot.

Your example xml that you attached had:

<memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB' nodeset='0'/>
    </hugepages>
  </memoryBacking>

The page element was the missing piece for me.

Thanks!


From: Gabe Black
Sent: Thursday, August 20, 2015 9:31 AM
To: 'Mooney, Sean K'
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150824/1af2e11a/attachment-0001.html>

From shettyg at nicira.com  Mon Aug 24 09:35:04 2015
From: shettyg at nicira.com (Gurucharan Shetty)
Date: Mon, 24 Aug 2015 09:35:04 -0700
Subject: [ovs-discuss] OVS fail after rebooting Xenserver 6.2
In-Reply-To: <CAM9JGNMgL9wQpJeWJaBGvzet0iSJ+EXyyPjf=iujHoyDWHEeug@mail.gmail.com>
References: <CAM9JGNMgL9wQpJeWJaBGvzet0iSJ+EXyyPjf=iujHoyDWHEeug@mail.gmail.com>
Message-ID: <CAHbON5qQz+Gh3i_YnaHZ5Q+PggPEM1KMtdDOYR5kNb09U2QQrA@mail.gmail.com>

When XenServer is rebooted, it destroys OVS database and reconstructs
it based on its internal xapi database. So it is natural to loose any
configuration not done via xapi API. I do not know anything about
cloudstack, so I cannot help you there. You will likely get better
help in a cloudstack mailing list.

On Sun, Aug 23, 2015 at 4:03 PM, khaled ben jannet
<ben.jannet.khaled at gmail.com> wrote:
> Hello,
>
> I'm working with Xenserver 6.2 and Cloudstack 4.4
>
> Xenserver is configured with openvswitch, every new network create a new
> tunnel. The issue is that when we reboot an Xenserver host all tunnel are
> droped.
>
> Then when I migrate an existing vm to the host it lose connectivity with the
> other VM in the same network, but when we create a ew tunnel and new VM it
> works correctly.
>
> Can you help me on this issue ?
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>

From fbl at sysclose.org  Mon Aug 24 09:56:32 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Mon, 24 Aug 2015 13:56:32 -0300
Subject: [ovs-discuss] Open vSwitch 2.4.0 Available
In-Reply-To: <CAG9LJa5RAUnJXEoxjtLognAMA0LJe7dB53M5oq5Jpkmu_LRuiw@mail.gmail.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
 <55D9FD8C.2000900@linux.vnet.ibm.com>
 <BC0FEEC7D7650749874CEC11314A88F7451F99CE@IRSMSX104.ger.corp.intel.com>
 <CAG9LJa5RAUnJXEoxjtLognAMA0LJe7dB53M5oq5Jpkmu_LRuiw@mail.gmail.com>
Message-ID: <20150824165632.GA2241@x240.home>

On Mon, Aug 24, 2015 at 12:19:29PM +0300, Gal Sagie wrote:
> Wasn't the connection tracking integration was suppose to be out in this
> version as well?
> Is it delayed?

It's delayed, see this thread:
http://openvswitch.org/pipermail/discuss/2015-June/017886.html

fbl


> 
> On Mon, Aug 24, 2015 at 11:57 AM, Traynor, Kevin <kevin.traynor at intel.com>
> wrote:
> 
> >
> > > -----Original Message-----
> > > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of
> > Pradeep
> > > Satyanarayana
> > > Sent: Sunday, August 23, 2015 6:06 PM
> > > To: discuss at openvswitch.org
> > > Subject: Re: [ovs-discuss] Open vSwitch 2.4.0 Available
> > >
> > > On 08/21/2015 10:51 AM, Justin Pettit wrote:
> > > > The Open vSwitch team is pleased to announce the release of Open
> > vSwitch
> > > 2.4.0:
> > > >
> > > >     http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz
> > > >
> > > > This release contains the largest number of new features of an Open
> > vSwitch
> > > release.  A few feature highlights of 2.4.0 include:
> > > >
> > > >    - Support for the Rapid Spanning Tree Protocol (IEEE 802.1D-2004).
> > > >
> > > >    - Support for multicast snooping (IGMPv1, IGMPv2 and IGMPv3).
> > > >
> > > >    - A new "conjunctive match" OpenFlow extension that allows flows to
> > be
> > > >      constructed without introducing a Cartesian Product explosion.
> > > >
> > > >    - Add bash command-line completion for most CLI commands.
> > > >
> > > >    - Support for transactional flow updates through OpenFlow 1.4
> > Bundles.
> > > >
> > > >    - A number of new features from the latest OpenFlow specifications.
> > > >
> > > >    - A simple wrapper script, 'ovs-docker', to integrate OVS with
> > Docker
> > > >      containers.
> > > >
> > > >    - Support for STT and basic Geneve tunneling in Linux kernels.
> > > >
> > > >    - Support for VXLAN Group Policy extension.
> > > >
> > > >    - Support for DPDK Tunneling. VXLAN, GRE, and Geneve are supported
> > > >      protocols.
> > > >
> > > >    - Support for DPDK vHost.
> > >
> > > Thanks for all of the work that went into this release!
> > >
> > > Can you tell me which version of DPDK has been integrated and tested in
> > > OVS 2.4? Was that DPDK 2.0.0 or 2.1.0?
> >
> > DPDK 2.0.0. The DPDK version is listed at the top of the INSTALL.DPDK.md
> > file.
> >
> > >
> > > -Pradeep
> > >
> > > _______________________________________________
> > > discuss mailing list
> > > discuss at openvswitch.org
> > > http://openvswitch.org/mailman/listinfo/discuss
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss
> >
> 
> 
> 
> -- 
> Best Regards ,
> 
> The G.

> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss



From blp at nicira.com  Mon Aug 24 10:19:56 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 24 Aug 2015 10:19:56 -0700
Subject: [ovs-discuss] [openvswitch 2.4.0] testsuite: 10 11 12 13 14 15
 20 21 22 23 24 25 26 27 28 29 94 95 96 97 98 367 375 392 393 394 395 396
 397 398 399 417 418 419 420 421 422 423 424 625 626 627 628 629 630 631 636
 637 673 749 750 751 752 756 757 758 759 760 761 762 779 780 781 785 786 787
 788 789 790 791 792 793 795 796 797 798 799 800 801 802 803 804 805 806 807
 808 809 810 811 812 813 814 815 819 820 821 822 823 824 825 826 827 828 829
 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848
 849 850 851 852 853 854 855 856 857 859 860 861 862 863 864 865 866 867 868
 869 870 871 872 873 874 877 878 879 880 881 882 884 885 886 887 888 889 890
 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909
 911 912 913 915 916 917 918 919 920 921 922 924 1392 1395 1396 1397 1398
 1399 1400 1401 1402 1403 1404 1405 1406 1407 1408 1409 1410 1411 1412 1413
 1414 1415 1416 1417 1418 1419 1420 1599 1606 failed
In-Reply-To: <CANjJQeYj=QgaAQ1m76WNHKHpr5qQChiO7HWuq5fpN-f4cZH_Zg@mail.gmail.com>
References: <CANjJQeYj=QgaAQ1m76WNHKHpr5qQChiO7HWuq5fpN-f4cZH_Zg@mail.gmail.com>
Message-ID: <20150824171956.GB3360@nicira.com>

Do you have /proc mounted on your system?

From blp at nicira.com  Mon Aug 24 10:37:03 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 24 Aug 2015 10:37:03 -0700
Subject: [ovs-discuss] a problem about passing metadata in packet-in
In-Reply-To: <20B66EA7EF50DC49A18DB7C78070FB344145B4E1@ESGSCMB109.ericsson.se>
References: <20B66EA7EF50DC49A18DB7C78070FB344145B4E1@ESGSCMB109.ericsson.se>
Message-ID: <20150824173703.GE3360@nicira.com>

On Fri, Aug 21, 2015 at 07:51:15PM +0000, Chao Hu wrote:
> I'm trying to pass metadata from OVS switch to controller but always get 0. Anything wrong with my steps?
> My test environment is:
> OVS: 2.0.2
> OVS-controller: 2.3.1
> OF: OpenFlow1.3
> 
> My test steps are:
> 
> 1.  Make OVS-controller to send a OFPRAW_NXT_SET_PACKET_IN_FORMAT
> message to OVS switch, to set the packet-in-format to NXM (Nicira
> Extended). As I captured, it's a OFPT_EXPERIMENTER packet and the
> content is exactly the same with the packet of running "ovs-ofctl
> monitor -P nxm tcp:myip:6653 -O OpenFlow13". Seems Switch do nothing
> after received this packet.

This is a bad idea.  The OpenFlow 1.3 packet-in format is already
extensible so there should be no need to change it.

> 2.        Add a flow to OVS switch:
> cookie=0x0, duration=28.019s, table=0, n_packets=0, n_bytes=0, in_port=2 actions=CONTROLLER:65535,write_metadata:0x11/0xffff
> 
> 3.       OVS switch send the packet-in traffic to controller when it matches above flow, but metadata is 0.

The actions above set the metadata after sending the packet to the
controller.

From c1_dx at yahoo.com  Mon Aug 24 23:47:48 2015
From: c1_dx at yahoo.com (c1)
Date: Tue, 25 Aug 2015 14:47:48 +0800
Subject: [ovs-discuss] SR-IOV with OVS
Message-ID: <15422219-89C4-45A2-A2FD-B72D46B26E00@yahoo.com>

Hi,all:
There is a physical interface eth0 on my server, I opened the SR-IOV functionality of this physical port on.Now I can see eth0 ~ 7.
	
	eth0 belong ovs network, there are some in ovs switch virtual interface for virtual machines. 
	
	One virtual interface I configured vlan 174, and through him to create a virtual machine vm0, go after the virtual machine can ping vlan gateways and vlans' IP. 
	
	When I use the SR-IOV interface to create virtual machines created vm1, and configure vlan 174, the virtual machine can also  ping the gateway and vlans' IP.    
	
	But vm1 and vm0 not be able to ping each other.    
	
	When vm1 ping vm2 : vm1 can learn vm0 the arp, arp I can see requests and responses through the tcpdump packet capture on eth0. 

	But I do not see the icmp request packets.    

	Phenomenon is the use of SR-IOV port did not forward the packet to eth0, what I need to do configuration changes?  

	We look forward to your answer!


																				Thank you!

From federico.iezzi at hp.com  Tue Aug 25 00:27:16 2015
From: federico.iezzi at hp.com (Iezzi, Federico)
Date: Tue, 25 Aug 2015 07:27:16 +0000
Subject: [ovs-discuss] [ovs-announce] Open vSwitch 2.4.0 Available
In-Reply-To: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
References: <FF1E8947-1116-4E48-A1F0-C6383364FE7E@nicira.com>
Message-ID: <6B8573EBEA47DA438B0DA2226C90B43213DC1086@G2W2433.americas.hpqcorp.net>

Great works guys!

-----Original Message-----
From: announce [mailto:announce-bounces at openvswitch.org] On Behalf Of Justin Pettit
Sent: Friday, August 21, 2015 7:52 PM
To: discuss <discuss at openvswitch.org>; announce at openvswitch.org
Subject: [ovs-announce] Open vSwitch 2.4.0 Available

The Open vSwitch team is pleased to announce the release of Open vSwitch 2.4.0:

   http://openvswitch.org/releases/openvswitch-2.4.0.tar.gz

This release contains the largest number of new features of an Open vSwitch release.  A few feature highlights of 2.4.0 include:

  - Support for the Rapid Spanning Tree Protocol (IEEE 802.1D-2004).

  - Support for multicast snooping (IGMPv1, IGMPv2 and IGMPv3).

  - A new "conjunctive match" OpenFlow extension that allows flows to be
    constructed without introducing a Cartesian Product explosion.

  - Add bash command-line completion for most CLI commands.

  - Support for transactional flow updates through OpenFlow 1.4 Bundles.

  - A number of new features from the latest OpenFlow specifications.

  - A simple wrapper script, 'ovs-docker', to integrate OVS with Docker
    containers.

  - Support for STT and basic Geneve tunneling in Linux kernels.

  - Support for VXLAN Group Policy extension.

  - Support for DPDK Tunneling. VXLAN, GRE, and Geneve are supported
    protocols.

  - Support for DPDK vHost.

  - And many others.  See the full change log here:

        http://openvswitch.org/releases/NEWS-2.4.0

Enjoy!

--The Open vSwitch Team   

--------------------   
Open vSwitch is a production quality, multilayer open source virtual switch. It is designed to enable massive network automation through programmatic extension, while still supporting standard management interfaces. Open vSwitch can operate both as a soft switch running within the hypervisor, and as the control stack for switching silicon. It has been ported to multiple virtualization platforms and switching chipsets.

_______________________________________________
announce mailing list
announce at openvswitch.org
http://openvswitch.org/mailman/listinfo/announce

From blp at nicira.com  Tue Aug 25 08:15:04 2015
From: blp at nicira.com (Ben Pfaff)
Date: Tue, 25 Aug 2015 08:15:04 -0700
Subject: [ovs-discuss] SR-IOV with OVS
In-Reply-To: <15422219-89C4-45A2-A2FD-B72D46B26E00@yahoo.com>
References: <15422219-89C4-45A2-A2FD-B72D46B26E00@yahoo.com>
Message-ID: <20150825151504.GB30091@nicira.com>

On Tue, Aug 25, 2015 at 02:47:48PM +0800, c1 wrote:
> There is a physical interface eth0 on my server, I opened the SR-IOV functionality of this physical port on.Now I can see eth0 ~ 7.
> 	
> 	eth0 belong ovs network, there are some in ovs switch virtual interface for virtual machines. 
> 	
> 	One virtual interface I configured vlan 174, and through him to create a virtual machine vm0, go after the virtual machine can ping vlan gateways and vlans' IP. 
> 	
> 	When I use the SR-IOV interface to create virtual machines created vm1, and configure vlan 174, the virtual machine can also  ping the gateway and vlans' IP.    
> 	
> 	But vm1 and vm0 not be able to ping each other.    
> 	
> 	When vm1 ping vm2 : vm1 can learn vm0 the arp, arp I can see requests and responses through the tcpdump packet capture on eth0. 
> 
> 	But I do not see the icmp request packets.    
> 
> 	Phenomenon is the use of SR-IOV port did not forward the packet to eth0, what I need to do configuration changes?  

It doesn't make sense to combine SR-IOV and OVS.

From Gabe.Black at viavisolutions.com  Mon Aug 24 13:47:07 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Mon, 24 Aug 2015 20:47:07 +0000
Subject: [ovs-discuss] DPDK OVS on Ubuntu 15.04
In-Reply-To: <4B1BB321037C0849AAE171801564DFA6451743D7@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC58B7F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645169E92@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5956B@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64516F80A@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5AC9F@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645170A6D@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5BD58@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA6451743D7@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5E14B@AMEXMB01.ds.jdsu.net>

It looks like by reimaging I am picking up the latest stuff...  Unfortunately, there were a couple other steps I had to take besides modifying the ovs-dpdk-init script (as mentioned in prior discussion) to get things to make progress.

The master branch seems to create a /var/run/openvswitch, but it is not where the socket files get put.  They are still in /usr/var/run/openvswitch.  So I removed that folder and created a symlink so that /usr/var/run/openvswitch and /var/run/openvswitch are the same location.  I hope that is still the right thing to do.

I also got additional failures because /opt/stack/networking-ovs-dpdk/networking_ovs_dpdk/common/config.py defines some of the same config options that are in the neutron plugin (/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/common/config.py) and so q-agt failed to start, first complaining about duplicate "of_interface", then the others.  I commented out the duplicates, but am now getting failures because ovs-ofctl doesn't show a br-int (q-agt complained about it).  I'm pretty certain it is because of this plugin problem.

The original q-agt problem I was trying to fix was this:
python /usr/local/bin/networking-ovs-dpdk-agent --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini
No handlers could be found for logger "oslo_config.cfg"
Traceback (most recent call last):
  File "/usr/local/bin/networking-ovs-dpdk-agent", line 10, in <module>
    sys.exit(main())
  File "/usr/local/lib/python2.7/dist-packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py", line 20, in main
    agent_main.main()
  File "/usr/local/lib/python2.7/dist-packages/networking_ovs_dpdk/agent/main.py", line 43, in main
    mod = importutils.import_module(mod_name)
  File "/usr/local/lib/python2.7/dist-packages/oslo_utils/importutils.py", line 57, in import_module
    __import__(import_str)
  File "/usr/local/lib/python2.7/dist-packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py", line 17, in <module>
    from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
  File "/usr/local/lib/python2.7/dist-packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py", line 47, in <module>
    from neutron.plugins.ml2.drivers.openvswitch.agent import ovs_dvr_neutron_agent
  File "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_dvr_neutron_agent.py", line 29, in <module>
    cfg.CONF.import_group('AGENT', 'neutron.plugins.ml2.drivers.openvswitch.'
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 2088, in import_group
    __import__(module_str)
  File "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/common/config.py", line 111, in <module>
    cfg.CONF.register_opts(ovs_opts, "OVS")
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 1824, in __inner
    result = f(self, *args, **kwargs)
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 1983, in register_opts
    self.register_opt(opt, group, clear_cache=False)
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 1828, in __inner
    return f(self, *args, **kwargs)
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 1967, in register_opt
    return group._register_opt(opt, cli)
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 1345, in _register_opt
    if _is_opt_registered(self._opts, opt):
  File "/usr/local/lib/python2.7/dist-packages/oslo_config/cfg.py", line 574, in _is_opt_registered
    raise DuplicateOptError(opt.name)
oslo_config.cfg.DuplicateOptError: duplicate option: of_interface
q-agt failed to start

So I don't think commenting out the duplicates was the right approach, but I don't know what the right fix would be.

Any suggestions would be appreciated!

Thanks again!
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Monday, August 24, 2015 5:07 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Gabe.
I don't know if you have reimaged your board yet.
If you have not can you check 5 things for me.

First  when you have one of the vms booted can you provide the output of

ps aux| grep qemu

second can you run ifconfig in the guest and see if packet sent from the guest are reported
as transmitted via eth0

third if they are transmitted for the guest can you check if they are received by the vswitch

this can be done by using
sudo ovs-ofctl dump-ports br-int
or
sudo ovs-ofctl dump-flows br-int

when you run the above command you should either see the port statics increase or a packet hit one of the flows.

If the packet is still making it this far can you check in the remote vm with tcpdump or ifconfig if the guest recives it?

Finally can you check the ovs-vswitchd  log.
It will be in /opt/stack/logs or where ever you have set for you log directory in your local.conf
If no log directory is set it will be in  /tmp
In the vswitchd log you should see a message saying the usvhost port was added. Are there any relevant error messages in the log?

We were able to get one node working on Ubuntu 14.04 with ovs-dpdk and connectivity between vms on Friday and are
Currently repeating the process to make sure we have captured all the steps.
We hope  to submit a patch to our networking-ovs-dpdk repo with documentation and support for Ubuntu in the next week to 2 weeks.
Regards
sean

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Friday, August 21, 2015 11:58 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

I thought I had it "working".  I spent all day trying to get my vms to access the external network.  I was unsuccessful.  I used your flavor setting as well, but that didn't help.

Furthermore, when I create a new network, and attach the VMs to that network, I can't get the VMs to ping eachother either (and thus I can't test the dpdk datapath)

I'm at a loss of what to do next to try and figure it out.  The xml is vm's qemu is autocreated with everything that I think is necessary when I apply the nova flavor-key thing you mentioned below (both the memoryBacking and the <cpu>... memAccess="shared">... elements are there); that is, no manual editing of the xml seems to be required.

I saw that a new release came out and I copied the local.conf.single_node and used that (of course replacing my host_ip with corresponding values for my em1 interface and then using p6p1 for the data interface.

That created that stack environment it seemed without a hitch, except the demo tenant did not get a private network and router to the public network automatically created as before.  So I manually created those, as well as a dummy network and hung two vms off each of those networks, (the private one with a router to the public network, and the dummy network).

Neither VM got any dhcp address from the private network - ok, I may not have created the router, etc correctly, but at least I should be able to ping between the two vms on the dummy network.  After statically assigning the IPs that nova assigned to the ports on the dummy network for those vms, neither could ping eachother.

I'm at a loss of what I might be missing.  I think maybe I just need to reimage the box and start from a completely clean Ubuntu 15.04 install just to make sure artifacts from previous attempts aren't hanging around.

Anyway, thanks for all the help you have provided, and have a good weekend!
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 1:54 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi I am glad you got it working.
Thanks for reminding me about apparmor also.

We had set all profiles into complain mode but it was still blocking access to the vhost user sockets on our system also.

Apt-get purge apparmor results in vms booting correctly on our system also.
For now we will document this as a workaround and investage updating the apparmor profile to allow access to the
/var/run/openvswitch directory.

Just incase you are not aware to have network connective in the vm when  booting via openstack it is also neesicary to request hugepages
This can be done by modifying the flavor as follows
nova flavor-key <FLAVOR> set hw:mem_page_size=large
without this flavor extra spec option nova will not generate hugepage element or populate the pages element.

on the acceleration question
br-p6p1 and br-int  both use the dpdk enabled netdev datapath.

Because both bridges are connected by a patch port ovs is able to
Collapse the two bridges into a single datapath. This effectively means that while there are
Two logical bridges with the vm vhost-user port connected to br-int and the dpdk physical port connected
To br-p6p1 it is the equivalent of connecting all ports to a single bridge.

Regards
Sean.

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Thursday, August 20, 2015 5:20 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Ok, I think I found the config that had it boot.

Your example xml that you attached had:

<memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB' nodeset='0'/>
    </hugepages>
  </memoryBacking>

The page element was the missing piece for me.

Thanks!


From: Gabe Black
Sent: Thursday, August 20, 2015 9:31 AM
To: 'Mooney, Sean K'
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

The symlink let me create the vms in openstack... I'm positive that would have taken me forever to figure out.

I did notice that when I do create the vms with openstack it does generate the vhostuser section, but the vhost-user port isn't created under the br-p6p1 interface (I believe that is the bridge to the physical port (p6p1 which is the intel 82599 nic) that I hope dpdk will accelerate) but rather the vhost-user is created under br-int.

I'm just now getting my hands dirty with openstack, so forgive my ignorance if that is just fine for it to be created under that bridge, as it will still use the dpdk acceleration.

Anyway, after I did make the numa modifications, now when I try and start the VM, I get the error "Unable to find any usable hugetlbfs mount for 0 KiB"

I thought maybe I needed to increase the hugetable allocations for ovs-dpdk so I changed /etc/defaults/ovs-dpdk items to these (they were 2048):

OVS_SOCKET_MEM=16384,16384
OVS_NUM_HUGEPAGES=16384

I then restarted ovs-dpdk service (service ovs-dpdk restart) as well as the libvirtd service in case it had to notice the changes as well (saw a note in the qemu.conf that indicated it might determine hugetable size at daemon start).

However, I still get the same error.  I thought maybe it is a vm config error since it seems weird that it is trying to find a mount for "0" KiB.  These I believe are the relevant VM xml section:


<memory unit='KiB'>1048576</memory>
  <currentMemory unit='KiB'>1048576</currentMemory>
  <memoryBacking>
    <hugepages/>
  </memoryBacking>
....
<cpu mode='host-model'>
    <model fallback='allow'>SandyBridge</model>
    <topology sockets='1' cores='4' threads='1'/>
    <numa>
      <cell id='0' cpus='0-3' memory='1048576' unit='KiB' memAccess='shared'/>
    </numa>
  </cpu>

Now that I can launch VMs with openstack, I may just try and modify that xml to add the hugetable backing (and maybe the vhost-user that is connected to br-p6p1) and see if that works.

Anyway, I really appreciate all the help.
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 20, 2015 8:25 AM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04

The nosharepages  element unfortunately has a different meaning.
http://www.redhat.com/archives/libvir-list/2013-April/msg01263.html

The <nosharepages> element sets the -mem-merge=on|off parameter on the qemu commandline


Where as setting the memAccess attribute on the numa cell resulting in the hugepage file being mmap'd as shared instead of private.

<cpu mode="host-model"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<model fallback="allow"/>
<topology threads="1" cores="1" sockets="8"/>
<numa><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<cell id="0" unit="KiB" memAccess="shared" memory="4190208" cpus="0-7"/>
</numa>
</cpu>


The following Libvirt xml fragment will create a vhost-user port

<interface type="vhostuser"><file:///C:\Users\skmooney\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\WELXANEW\ubuntu_reference_image%20(3).xml>
<mac address="fa:16:3e:cd:81:4a"/>
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>
<model type="virtio"/>
<alias name="net0"/>
<address type="pci" bus="0x00" function="0x0" slot="0x03" domain="0x0000"/>
</interface>


The important line is
<source type="unix" mode="client" path="/var/run/openvswitch/vhuc37437e9-0d"/>

Type select the connection type  eg a unix socket
Mode sets who will create the socket. Clinet mode meads the socket will be created by ovs as part of the add-port.
In server mode the socket is created by the qemu process however this is not compatible with dpdk/ovs at this time.

And finally the path to the socket.

The name of the port created with add-port will be used as the name of the socket.

If you are booting with openstack, nova will generate the correct Libvirt xml.

Regards
Sean.






From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 19, 2015 10:18 PM
To: Mooney, Sean K
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: DPDK OVS on Ubuntu 15.04

Hi Sean,

Thank you for the detailed reply.  I think I finally just discovered the permission denied issue, and I think it is actually related to apparmor.  I'm not sure if the configuration in /etc/apparmor.d/usr.sbin.ibvirtd is complete for Ubuntu installations.

I didn't know what might be missing in that config, so for the sake of progress, I simply disabled apparmor altogether (simply stopping the service wasn't enough, had to disable the service and reboot).  I hope that information is useful as you guys transition to testing on Ubuntu.

I saw in the documentation that the memory backing needed to be shared, and the libvirt documentation seemed to indicate that that hugetable backing is shared by default http://libvirt.org/formatdomain.html#elementsMemoryBacking
...  so all I specified was (i.e. I omitted the <nosharepages> element):

<memoryBacking>

    <hugepages/>

</memoryBacking>

Wouldn't omitting the <nosharepages> be sufficient?

I noticed that you didn't include any sort of xml for connecting to the vhost-user-1 socket.  Isn't that required?

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Wednesday, August 19, 2015 2:05 PM
To: Gabe Black
Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>; Mooney, Sean K
Subject: RE: DPDK OVS on Ubuntu 15.04


Hello Gabriel,



Thanks for trying our code :)

Sorry for the long email but I will try to answer all your questions.



We used to support deploying on ubuntu 12.04 however for the last 9 months we have not had capacity to

Test our deployment code on Ubuntu. It is good timing however as we are currently working on updating our deployment

code to work on Ubuntu.



I have just opened  a bug to track this here https://bugs.launchpad.net/networking-ovs-dpdk/+bug/1486697

Just as a side note we are currently updateing our documentation to include a short getting started guide for

Fedora 21. When we close the above bug we will update the getting started guide we information regarding deployment

On ubunutu also. The current fedora guide can be found here https://review.openstack.org/#/c/214156/2 however it

will not solve your current issues.



Currently we are investigating a number of issues relating to Ubuntu deployment.

We are aware of the su command limitation on Ubuntu and will be updating our code to make it compatible.

On Ubuntu 12.04 there previously was both a "libvirt-qemu" user and group

On 14.04 I belive the "libvirt-qemu" group has changed to "kvm"

On Ubuntu 15.04 you should have a new enough Libvirt and qemu installed by default.

On 14.04 the kilo branch of the Ubuntu cloud archive will provide the correct qemu and Libvirt versions.



In general I recommend Libvirt 1.2.13+ and qemu 2.2+



If you are manually booting with vhost-user  via Libvirt  in addition to specify  the memory backing element

<memoryBacking>

    <hugepages/>

  </memoryBacking>

You also need set the hugepages to be mapped as shared.

This can be done via the numa element in the Libvirt xml

e.g.

  <numa>

      <cell id='0' cpus='0-3' memory='512000' unit='KiB' memAccess='shared'/>

  </numa>



When booting vms with OpenStack this limitation was worked around in our qemu wrapper script for kilo and has be fixed upstream in the liberty nova tree.



The following message can be safely ignored.

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

As part of the plugin we also unload the  kernel module but as it is not required when using dpdk.



This error message is issues because our devstack plugin does not currently create the bridges and set their datapath to netdev as a single atomic command.

As a result the bridge is initially created with the kernel datapath then updated to the netdev datapath resulting in the above warning.



On to your actual question it think the permission denied issue is related to the su issues mentioned previously.



Instead of changing

"sudo su -g $qemu_group ..." to "sg $qemu_group ..."

When starting ovs-vswitchd can you change it as follow



"sudo su -g $qemu_group -c..." to "sudo -g $qemu_group  ..."



The command our service file uses to start ovs is as follows



screen -dms ovs-vswitchd sudo su -g $qemu_group -c "umask 002; ${OVS_INSTALL_DIR}/sbin/ovs-vswitchd --dpdk -c $OVS_CORE_MASK -n $OVS_MEM_CHANNELS  --proc-type primary  --huge-dir $OVS_HUGEPAGE_MOUNT --socket-mem $OVS_SOCKET_MEM $pciAddressWhitelist -- unix:$OVS_DB_SOCKET 2>&1 | tee ${OVS_LOG_DIR}/ovs-vswitchd.log"



that is rather log but the important parts are as follows.



umask 002 changes the default file creation mode for the ovs-vswitchd process to itself and its group.



su -g $qemu_group changes the default group the ovs-vswitchd process runs as part of to the same group as the qemu process.



And obviously the  sudo causes the ovs-vswitchd process to run as the root user.



sudo support setting the group with the -g flag directly so su is not needed.



The result of combining  these command is that all vhost-user socket created by ovs will be owned by the root user and the Libvirt-qemu users group(previously "libvirt-qemu" now  "kvm")



Finally to boot a vm successfully via openstack you will need to create a symlink between /usr/var/run/openvswitch and /var/run/openvswitch.

The base path for the vhost-user socket is a constant in our mechanism driver as it must be the same on all compute nodes regardless of the operating system.



On a side note If anyone knows the correct configure options to specify that binaries should be installed in /usr/bin and all unix socket (ovsdb,ovs-vswictd and vhost-user) should be created in /var/run/openvswitch please let me know.



Currently we use ./configure --with-dpdk=${OVS_DPDK_DIR}/${RTE_TARGET} --prefix=/usr

However on fedora unix sockets are created in /var/run/openvswitch and on Ubuntu they are created in /usr/var/run/openvswitch

I am not sure if the information above will resolve your issues but as I said at the start of the email we are currently working to update our scripts to enable ubuntu support.



Regards

Sean.







-----Original Message-----

From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

Sent: Wednesday, August 19, 2015 12:33 AM

To: Mooney, Sean K

Cc: John Lange; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

Subject: DPDK OVS on Ubuntu 15.04



Hi Sean,



I have carried on where my colleague John Lange left off.  I have installed Ubuntu 15.04 which has kilo support but instead have used the devstack from https://github.com/openstack-dev/devstack to install everything.



For now, I am trying to get a single host set up to try and keep it as simple as possible.



I have used the sample configuration file you suggested for an all in one node provided here https://github.com/stackforge/networking-ovs-dpdk/blob/master/doc/source/_downloads/local.conf_example



Changes that I have made in order to get things to work on Ubuntu, are the following:



====================================================



networking-ovs-dpdk/devstack/ovs-dpdk/ovs-dpdk-init:454



+    qemu_group=`id -ng $qemu_group`



Also lines 463, and 471 I changed the command running in the screen from running "sudo su -g $qemu_group ..." to "sg $qemu_group ..."



====================================================



The reason for these changes is that on Ubuntu the "-g" option does not exist on the su command, so /etc/init.d/ovs-dpdk fails to start.  Also the name "libvirt-qemu" is not the group name, but rather the user.



It seems that with those changes devstack.sh is be able to complete.



--------------------------------



There were a few messages that made me wonder if all was well; for example the ovs-vswitchd.log file had the following:

...

2015-08-18T22:20:28Z|00011|dpif_netlink|ERR|Generic Netlink family 'ovs_datapath' does not exist. The Open vSwitch kernel module is probably not loaded.

...



Also, creating the vhost user port resulted in the following: (note, the ovs-vsctl add-port... command to create the vhost-user did not complain) ...

VHOST_CONFIG: socket created, fd:52

VHOST_CONFIG: bind to /usr/var/run/openvswitch/vhost-user-1

2015-08-18T22:33:01Z|00077|dpdk|INFO|Socket /usr/var/run/openvswitch/vhost-user-1 created for vhost-user port vhost-user-1 2015-08-18T22:33:01Z|00078|dpif_netdev|ERR|Cannot create pmd threads due to out of unpinned cores on numa node 2015-08-18T22:33:01Z|00079|bridge|INFO|bridge br-p6p1: added interface vhost-user-1 on port 3 ...



I never attempted to pin any cores, but it made me wonder if something might be incomplete... (I'm running on a dual quad core (with hyperthreading)).



=====================================================



Anyway, I added the following sections to my VM's libvirt qemu xml (/etc/libvirt/qemu/ubuntutrusty.xml) file to try and have it take the vhost-user interface, as well as ensure the VM is backed by hugetable memory.  These are the sections I added:



Hugetable-backed memory:



<memoryBacking>

    <hugepages/>

  </memoryBacking>



Vhost-user interface (I tried using the <interface type="vhostuser">... but virsh edit would complain about it not validating against domain.rng... I thought it would be supported... running 1.2.12 ) <qemu:commandline>

    <qemu:arg value='-chardev'/>

    <qemu:arg value='socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1'/>

    <qemu:arg value='-netdev'/>

    <qemu:arg value='type=vhost-user,id=mynet1,chardev=char1,vhostforce'/>

    <qemu:arg value='-device'/>

    <qemu:arg value='virtio-net-pci,mac=54:53:00:6a:b3:00,netdev=mynet1'/>

  </qemu:commandline>



Ok, so this finally brings me to my query for assistance:  When I try and launch the VM (via virt-manager), it complains about two things:



1) "process exited while connecting to monitor: /usr/bin/kvm-spice: line 36: /tmp/qemu.orig: Permission denied"

- I tried chmod 777 that file just to allow anyone to write/access that file, and it is getting the command written to it, but that error message still shows... Don't know if that is important..



2) qemu-system-x86_64: -chardev socket,id=char1,path=/usr/var/run/openvswitch/vhost-user-1: Failed to connect to socket: Permission Denied.



I've tried messing with group/user config variables in /etc/libvirt/qemu.conf and /etc/libvirt/libvirtd.conf but most of the time I then get devstack's n-cpu unable to connect to libvirtd (similar permission error).



I feel I am close, and would appreciate any advice you might have.



Very best,

Gabriel Black






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150824/e695fafc/attachment-0001.html>

From daya_k at yahoo.com  Tue Aug 25 04:57:06 2015
From: daya_k at yahoo.com (daya kamath)
Date: Tue, 25 Aug 2015 11:57:06 +0000 (UTC)
Subject: [ovs-discuss] bfd implementation in OVS
Message-ID: <1914153400.120288.1440503826449.JavaMail.yahoo@mail.yahoo.com>

hi ,i would like some clarification on the BFD implementation in OVS.
http://openvswitch.org/pipermail/discuss/2015-February/016515.html indicates the BFD is not multi-hop but sent through the tunnel.


can someone please clarify, if i create a VXLAN tunnel between 2 OVS switches over a WAN,1. will the BFD work, i.e will BFD packets be VXLAN encapsulated, and delivered as if it were a single hop? 2. if yes, how does the OVS detect BFD payload after stripping off the VXLAN header on an incoming packet?3. what does the VTEP put in the inner source and dest IP fields for BFD pkts? does it put the same values as the outer header?
thanks!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150825/b258f8d5/attachment.html>

From tbnelson at gmail.com  Tue Aug 25 08:37:21 2015
From: tbnelson at gmail.com (Tim Nelson)
Date: Tue, 25 Aug 2015 11:37:21 -0400
Subject: [ovs-discuss] Questions about OVS learn action
Message-ID: <CAA2QhFeYawUFhVZLpLWoBbOQs3gtFKTSdqXhc-c6WEvd0JE7Tw@mail.gmail.com>

Hi all,

I have two questions about using the learn action to create and manipulate
new rules:

* Can I use the learn action to delete or modify a rule? The delete_learned
flag for learn-action rules isn't what I need, since it only deletes
learned rules
after the learn-action rule is itself deleted. I need to delete rules
without
controller involement.

* Can a learn-action rule produce rules that themselves have the learn
action?
I'd like to create a cascade of rules that create other rules, but it looks
as
if the learn action is limited to output and field modification.

For reference, I'm looking at this man page:
  http://openvswitch.org/support/dist-docs/ovs-ofctl.8.txt

Cheers,
- Tim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150825/8269bf48/attachment.html>

From blp at nicira.com  Tue Aug 25 09:14:08 2015
From: blp at nicira.com (Ben Pfaff)
Date: Tue, 25 Aug 2015 09:14:08 -0700
Subject: [ovs-discuss] Questions about OVS learn action
In-Reply-To: <CAA2QhFeYawUFhVZLpLWoBbOQs3gtFKTSdqXhc-c6WEvd0JE7Tw@mail.gmail.com>
References: <CAA2QhFeYawUFhVZLpLWoBbOQs3gtFKTSdqXhc-c6WEvd0JE7Tw@mail.gmail.com>
Message-ID: <20150825161408.GD30091@nicira.com>

On Tue, Aug 25, 2015 at 11:37:21AM -0400, Tim Nelson wrote:
> * Can I use the learn action to delete or modify a rule? The delete_learned
> flag for learn-action rules isn't what I need, since it only deletes
> learned rules
> after the learn-action rule is itself deleted. I need to delete rules
> without
> controller involement.

The learn action will modify an existing rule, but not delete one.

> * Can a learn-action rule produce rules that themselves have the learn
> action?
> I'd like to create a cascade of rules that create other rules, but it looks
> as
> if the learn action is limited to output and field modification.

You might be able to work something up with clever use of resubmit, but
there's no direct way to do that.

From alexw at nicira.com  Tue Aug 25 09:50:46 2015
From: alexw at nicira.com (Alex Wang)
Date: Tue, 25 Aug 2015 09:50:46 -0700
Subject: [ovs-discuss] bfd implementation in OVS
In-Reply-To: <1914153400.120288.1440503826449.JavaMail.yahoo@mail.yahoo.com>
References: <1914153400.120288.1440503826449.JavaMail.yahoo@mail.yahoo.com>
Message-ID: <CAArS4XXGKXT73LM_qbcYQy=ZN2RCvGXE4q=CNzYW=WDyvZfKkQ@mail.gmail.com>

On Tue, Aug 25, 2015 at 4:57 AM, daya kamath <daya_k at yahoo.com> wrote:

> hi ,
> i would like some clarification on the BFD implementation in OVS.
>
> http://openvswitch.org/pipermail/discuss/2015-February/016515.html indicates
> the BFD is not multi-hop but sent through the tunnel.
>
> can someone please clarify, if i create a VXLAN tunnel between 2 OVS
> switches over a WAN,
> 1. will the BFD work, i.e will BFD packets be VXLAN encapsulated, and
> delivered as if it were a single hop?
>


You need to create a vlxan tunnel between the two host first,

and then enable bfd on the tunnel ports on both end,

yes, bfd pkt will be delivered as single hop,



> 2. if yes, how does the OVS detect BFD payload after stripping off the
> VXLAN header on an incoming packet?
>


UDP port,

please check the function bfd_should_process_flow() in bfd.c module for
details,



> 3. what does the VTEP put in the inner source and dest IP fields for BFD
> pkts? does it put the same values as the outer header?
>
>

Some hardware switch also requires specific inner bfd header fields, so
these fields are for
compatibility

Since ovs only checks the udp port, you do not need to care about it,
please refer to
function bfd_put_packet() in bfd.c module for how bfd packet is composed,

Thanks,
Alex Wang,



> thanks!
>
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150825/3b0f3bd0/attachment.html>

From sean.k.mooney at intel.com  Tue Aug 25 12:30:19 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Tue, 25 Aug 2015 19:30:19 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>

Hi Gabe
We have started to see that message in our ci since this weekend. 
We are currently investigating it but I belive a change has merged to neuton that we need to back port to
Our agent.

A lot of code has merged in the last 2 weeks as the code freeze for the liberty release is moday.
The stable kilo branch should be unaffected but we are actively looking into this at present.

Regards
Sean.


-----Original Message-----
From: Gabe Black [mailto:Gabe.Black at viavisolutions.com] 
Sent: Tuesday, August 25, 2015 7:50 PM
To: bugs at openvswitch.org
Cc: Mooney, Sean K
Subject: duplicate option: of_interface

I have followed the getting started guide (http://git.openstack.org/cgit/stackforge/networking-ovs-dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu 15.04 to get a single-node set up with dpdk ovs.

My local.conf file is identical to the one provided as the single node template: http://git.openstack.org/cgit/stackforge/networking-ovs-dpdk/tree/doc/source/_downloads/local.conf.single_node

I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124, OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and  ML2_VLAN_RANGES=default:1000:1010

eno1 and associated IP is the interface/ip address of the server (i.e. what we use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will eventually be used for the data interface in a multi-node setup.  Finally the vlan range was just arbitrarily chosen.

Other than that, there isn't anything else modified other than following instructions of the getting started guide.  However for both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some mods that needed to take place like disabling apparmor, symlinking /var/run/openstack, and fixing ovs-dpdk-init script) result in the following error message in q-agt:

Traceback (most recent call last):
  File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
    sys.exit(main())
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py", line 20, in main
    agent_main.main()
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/agent/main.py", line 43, in main
    mod = importutils.import_module(mod_name)
  File "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py", line 57, in import_module
    __import__(import_str)
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py", line 17, in <module>
    from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py", line 47, in <module>
    from neutron.plugins.ml2.drivers.openvswitch.agent import ovs_dvr_neutron_agent
  File "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_dvr_neutron_agent.py", line 29, in <module>
    cfg.CONF.import_group('AGENT', 'neutron.plugins.ml2.drivers.openvswitch.'
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 2088, in import_group
    __import__(module_str)
  File "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/common/config.py", line 111, in <module>
    cfg.CONF.register_opts(ovs_opts, "OVS")
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1824, in __inner
    result = f(self, *args, **kwargs)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1983, in register_opts
    self.register_opt(opt, group, clear_cache=False)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1828, in __inner
    return f(self, *args, **kwargs)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1967, in register_opt
    return group._register_opt(opt, cli)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1345, in _register_opt
    if _is_opt_registered(self._opts, opt):
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 574, in _is_opt_registered
    raise DuplicateOptError(opt.name)
oslo_config.cfg.DuplicateOptError: duplicate option: of_interface q-agt failed to start

I thought this error message was just because Ubuntu testing/support hasn't been fleshed out yet with ovs-dpdk, but then I got the exact same error on Fedora 21.  I tried editing both /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/common/config.py and /opt/stack/networking-ovs-dpdk/networking_ovs_dpdk/common/config.py to get past the error, but then there are complaints about not finding br-int... So I'm guessing that isn't the correct workaround.  Anyone have any suggestions of what I might have misconfigured?

Thank you for your help!
Gabriel Black



From Gabe.Black at viavisolutions.com  Tue Aug 25 13:06:03 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Tue, 25 Aug 2015 20:06:03 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>

Thanks for the reply and hints on changes...  Armed with that I undid the changes from git commit 053bfc5a (neutron) and that allowed the q-agt process to at least not die there with that callstack.  The commit message seemed to indicate it was for better restarting/cleanup; so I hope it is relatively low impact to back out.

However, it now dies because it is still unable to create the br-int bridge:

Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--', 'set', 'Bridge', 'br-int', 'datapath_type=system'].
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Traceback (most recent call last):
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63, in run_vsctl
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     log_fail_as_error=False).rstrip()
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in execute
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise RuntimeError(m)
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl RuntimeError:
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Command: ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--', 'set', 'Bridge', 'br-int', 'datapath_type=system']
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit code: -14
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr: 2015-08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with signal 14 (Alarm clock)
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

I noticed a difference between a multi-node setup and a single node, where multi-node's controller has openvswitch and ovsdpdk for the Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related to that?  Or should it be trying to create br-int as datapath_type netdev instead?  Just throwing things out there because I'm ignorant :-)  I'll try variations of that in hopes I get lucky.


Gabe



> -----Original Message-----
> From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> Sent: Tuesday, August 25, 2015 1:30 PM
> To: Gabe Black; bugs at openvswitch.org
> Subject: RE: duplicate option: of_interface
> 
> Hi Gabe
> We have started to see that message in our ci since this weekend.
> We are currently investigating it but I belive a change has merged to neuton
> that we need to back port to Our agent.
> 
> A lot of code has merged in the last 2 weeks as the code freeze for the liberty
> release is moday.
> The stable kilo branch should be unaffected but we are actively looking into
> this at present.
> 
> Regards
> Sean.
> 
> 
> -----Original Message-----
> From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> Sent: Tuesday, August 25, 2015 7:50 PM
> To: bugs at openvswitch.org
> Cc: Mooney, Sean K
> Subject: duplicate option: of_interface
> 
> I have followed the getting started guide
> (http://git.openstack.org/cgit/stackforge/networking-ovs-
> dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu 15.04
> to get a single-node set up with dpdk ovs.
> 
> My local.conf file is identical to the one provided as the single node template:
> http://git.openstack.org/cgit/stackforge/networking-ovs-
> dpdk/tree/doc/source/_downloads/local.conf.single_node
> 
> I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,
> OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> ML2_VLAN_RANGES=default:1000:1010
> 
> eno1 and associated IP is the interface/ip address of the server (i.e. what we
> use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> eventually be used for the data interface in a multi-node setup.  Finally the
> vlan range was just arbitrarily chosen.
> 
> Other than that, there isn't anything else modified other than following
> instructions of the getting started guide.  However for both Fedora 21, and
> Ubuntu 15.04 (Ubuntu there were some mods that needed to take place like
> disabling apparmor, symlinking /var/run/openstack, and fixing ovs-dpdk-init
> script) result in the following error message in q-agt:
> 
> Traceback (most recent call last):
>   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
>     sys.exit(main())
>   File "/usr/lib/python2.7/site-
> packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> line 20, in main
>     agent_main.main()
>   File "/usr/lib/python2.7/site-
> packages/networking_ovs_dpdk/agent/main.py", line 43, in main
>     mod = importutils.import_module(mod_name)
>   File "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py", line 57, in
> import_module
>     __import__(import_str)
>   File "/usr/lib/python2.7/site-
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> line 17, in <module>
>     from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
>   File "/usr/lib/python2.7/site-
> packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py", line
> 47, in <module>
>     from neutron.plugins.ml2.drivers.openvswitch.agent import
> ovs_dvr_neutron_agent
>   File
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> dvr_neutron_agent.py", line 29, in <module>
>     cfg.CONF.import_group('AGENT',
> 'neutron.plugins.ml2.drivers.openvswitch.'
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 2088, in
> import_group
>     __import__(module_str)
>   File
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> mon/config.py", line 111, in <module>
>     cfg.CONF.register_opts(ovs_opts, "OVS")
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1824, in
> __inner
>     result = f(self, *args, **kwargs)
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1983, in
> register_opts
>     self.register_opt(opt, group, clear_cache=False)
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1828, in
> __inner
>     return f(self, *args, **kwargs)
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1967, in
> register_opt
>     return group._register_opt(opt, cli)
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1345, in
> _register_opt
>     if _is_opt_registered(self._opts, opt):
>   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 574, in
> _is_opt_registered
>     raise DuplicateOptError(opt.name)
> oslo_config.cfg.DuplicateOptError: duplicate option: of_interface q-agt failed
> to start
> 
> I thought this error message was just because Ubuntu testing/support hasn't
> been fleshed out yet with ovs-dpdk, but then I got the exact same error on
> Fedora 21.  I tried editing both
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> on/config.py and /opt/stack/networking-ovs-
> dpdk/networking_ovs_dpdk/common/config.py to get past the error, but
> then there are complaints about not finding br-int... So I'm guessing that isn't
> the correct workaround.  Anyone have any suggestions of what I might have
> misconfigured?
> 
> Thank you for your help!
> Gabriel Black
> 


From Gabe.Black at viavisolutions.com  Tue Aug 25 13:45:16 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Tue, 25 Aug 2015 20:45:16 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>

Sorry, that was premature.  Apparently hugetable memory gets fragmented or leaks or something as the ovs-dpdk failed to start.  Rebooting fixed that.

I still get many errors in the q-agt log file similar to this:
ERROR neutron.agent.linux.utils [-]
Command: ['ovs-ofctl', 'add-flows', 'br-int', '-']
Exit code: 1
Stdin: hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,actions=normal
Stdout:
Stderr: ovs-ofctl: br-int is not a bridge or a socket

and 

ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-d29e450eda38 None None] Unable to execute ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23']. Exception:
Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23']
Exit code: 1
Stdin:
Stdout:
Stderr: ovs-ofctl: br-int is not a bridge or a socket

But at least q-agt isn't dying.  I remember why I hate fedora though.. Even though horizon says it is running and we turned the firewall to permissive, I can never access the website.  Seems like something else is protecting or acting as a firewall.



> -----Original Message-----
> From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of Gabe
> Black
> Sent: Tuesday, August 25, 2015 2:06 PM
> To: Mooney, Sean K; bugs at openvswitch.org
> Subject: Re: [ovs-discuss] duplicate option: of_interface
> 
> Thanks for the reply and hints on changes...  Armed with that I undid the
> changes from git commit 053bfc5a (neutron) and that allowed the q-agt
> process to at least not die there with that callstack.  The commit message
> seemed to indicate it was for better restarting/cleanup; so I hope it is
> relatively low impact to back out.
> 
> However, it now dies because it is still unable to create the br-int bridge:
> 
> Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> '--may-exist', 'add-br', 'br-int', '--', 'set', 'Bridge', 'br-int',
> 'datapath_type=system'].
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Traceback
> (most recent call last):
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63, in
> run_vsctl
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> log_fail_as_error=False).rstrip()
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in execute
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise
> RuntimeError(m)
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> RuntimeError:
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Command:
> ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--', '--may-exist', 'add-
> br', 'br-int', '--', 'set', 'Bridge', 'br-int', 'datapath_type=system']
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit code: -14
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr: 2015-
> 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with signal 14 (Alarm
> clock)
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> 
> I noticed a difference between a multi-node setup and a single node, where
> multi-node's controller has openvswitch and ovsdpdk for the
> Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related to that?  Or
> should it be trying to create br-int as datapath_type netdev instead?  Just
> throwing things out there because I'm ignorant :-)  I'll try variations of that in
> hopes I get lucky.
> 
> 
> Gabe
> 
> 
> 
> > -----Original Message-----
> > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > Sent: Tuesday, August 25, 2015 1:30 PM
> > To: Gabe Black; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > Hi Gabe
> > We have started to see that message in our ci since this weekend.
> > We are currently investigating it but I belive a change has merged to
> > neuton that we need to back port to Our agent.
> >
> > A lot of code has merged in the last 2 weeks as the code freeze for
> > the liberty release is moday.
> > The stable kilo branch should be unaffected but we are actively
> > looking into this at present.
> >
> > Regards
> > Sean.
> >
> >
> > -----Original Message-----
> > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > Sent: Tuesday, August 25, 2015 7:50 PM
> > To: bugs at openvswitch.org
> > Cc: Mooney, Sean K
> > Subject: duplicate option: of_interface
> >
> > I have followed the getting started guide
> > (http://git.openstack.org/cgit/stackforge/networking-ovs-
> > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu
> > 15.04 to get a single-node set up with dpdk ovs.
> >
> > My local.conf file is identical to the one provided as the single node
> template:
> > http://git.openstack.org/cgit/stackforge/networking-ovs-
> > dpdk/tree/doc/source/_downloads/local.conf.single_node
> >
> > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,
> > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> > ML2_VLAN_RANGES=default:1000:1010
> >
> > eno1 and associated IP is the interface/ip address of the server (i.e. what
> we
> > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> > eventually be used for the data interface in a multi-node setup.
> > Finally the vlan range was just arbitrarily chosen.
> >
> > Other than that, there isn't anything else modified other than
> > following instructions of the getting started guide.  However for both
> > Fedora 21, and Ubuntu 15.04 (Ubuntu there were some mods that needed
> > to take place like disabling apparmor, symlinking /var/run/openstack,
> > and fixing ovs-dpdk-init
> > script) result in the following error message in q-agt:
> >
> > Traceback (most recent call last):
> >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
> >     sys.exit(main())
> >   File "/usr/lib/python2.7/site-
> > packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> > line 20, in main
> >     agent_main.main()
> >   File "/usr/lib/python2.7/site-
> > packages/networking_ovs_dpdk/agent/main.py", line 43, in main
> >     mod = importutils.import_module(mod_name)
> >   File "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",
> > line 57, in import_module
> >     __import__(import_str)
> >   File "/usr/lib/python2.7/site-
> >
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> > line 17, in <module>
> >     from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
> >   File "/usr/lib/python2.7/site-
> > packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",
> line
> > 47, in <module>
> >     from neutron.plugins.ml2.drivers.openvswitch.agent import
> > ovs_dvr_neutron_agent
> >   File
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> > dvr_neutron_agent.py", line 29, in <module>
> >     cfg.CONF.import_group('AGENT',
> > 'neutron.plugins.ml2.drivers.openvswitch.'
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 2088, in import_group
> >     __import__(module_str)
> >   File
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> > mon/config.py", line 111, in <module>
> >     cfg.CONF.register_opts(ovs_opts, "OVS")
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 1824, in __inner
> >     result = f(self, *args, **kwargs)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 1983, in register_opts
> >     self.register_opt(opt, group, clear_cache=False)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 1828, in __inner
> >     return f(self, *args, **kwargs)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 1967, in register_opt
> >     return group._register_opt(opt, cli)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 1345, in _register_opt
> >     if _is_opt_registered(self._opts, opt):
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > 574, in _is_opt_registered
> >     raise DuplicateOptError(opt.name)
> > oslo_config.cfg.DuplicateOptError: duplicate option: of_interface
> > q-agt failed to start
> >
> > I thought this error message was just because Ubuntu testing/support
> > hasn't been fleshed out yet with ovs-dpdk, but then I got the exact
> > same error on Fedora 21.  I tried editing both
> >
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> > on/config.py and /opt/stack/networking-ovs-
> > dpdk/networking_ovs_dpdk/common/config.py to get past the error, but
> > then there are complaints about not finding br-int... So I'm guessing
> > that isn't the correct workaround.  Anyone have any suggestions of
> > what I might have misconfigured?
> >
> > Thank you for your help!
> > Gabriel Black
> >
> 
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

From jesse at nicira.com  Tue Aug 25 16:40:29 2015
From: jesse at nicira.com (Jesse Gross)
Date: Tue, 25 Aug 2015 16:40:29 -0700
Subject: [ovs-discuss] openvswitch install on centos 6.6 issue
In-Reply-To: <CAHbON5o=jYcWLQUXiq3Zj9EdCHwb1e97_1i4-Q2HzfGBSp0CAw@mail.gmail.com>
References: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>
 <CAHbON5pqG=zqZKbFJjWZ4sFxqYuJwNtW4ptmHTYATJywf-+pCA@mail.gmail.com>
 <570c3c32-7580-4e38-af7a-681196ae4f1f@getmailbird.com>
 <CAHbON5o=jYcWLQUXiq3Zj9EdCHwb1e97_1i4-Q2HzfGBSp0CAw@mail.gmail.com>
Message-ID: <CAEP_g=8RGnRy82VpsMy-zjVjZBxmfp-QkogDxCLN5p3AwTk2Uw@mail.gmail.com>

Flavio, there's been a few reports of compilation problems on
RHEL/Centos 6. Would it be possible for you to take a look?

On Fri, Aug 21, 2015 at 12:09 PM, Gurucharan Shetty <shettyg at nicira.com> wrote:
> Okay, then I was wrong about branch 2.4 supporting Centos 6.6. I have
> CC'd a couple of Kernel developers that will know the correct answer.
>
> On Fri, Aug 21, 2015 at 12:03 PM, ShapeHost <contact at shape.host> wrote:
>> Hello,
>>
>>     Thanks for the information, i tested the new 2.4. and i have the same
>> problem. :(
>>
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> warning: type defaults to 'int' in declaration of 'ret__'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> warning: type defaults to 'int' in declaration of 'ret__'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> error: invalid type argument of 'unary *' (have 'int')
>> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
>> warning: type defaults to 'int' in declaration of 'type name'
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/datapath.o]
>> Error 1
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.o]
>> Error 1
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/vport-internal_dev.o]
>> Error 1
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/flow_table.o]
>> Error 1
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/flow_netlink.o]
>> Error 1
>> make[2]: ***
>> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/vport.o]
>> Error 1
>> make[1]: ***
>> [_module_/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux]
>> Error 2
>> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
>> make: *** [default] Error 2
>> make: Leaving directory
>> `/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux'
>> error: Bad exit status from /var/tmp/rpm-tmp.1mXVkX (%build)
>>
>>
>> RPM build errors:
>>     Bad exit status from /var/tmp/rpm-tmp.1mXVkX (%build)
>> [root at ns509777 openvswitch-2.4.0]#
>>
>>
>> Regards,
>> Cristian
>>
>> Regards,
>>
>> ShapeHost
>>
>> www.istream.today
>>
>> www.shape.host
>>
>> +40.733.955.922
>>
>>
>>
>> On 8/21/2015 8:29:02 PM, Gurucharan Shetty <shettyg at nicira.com> wrote:
>>
>> On Fri, Aug 21, 2015 at 5:02 AM, ShapeHost wrote:
>>> Hello,
>>>
>>> I have some problem with openvswitch install on centos 6.6
>>> 2.6.32-573.3.1.el6.x86_64.
>>>
>>> I tried to install many version of OVS like 1.9.0, 1.9.3, 1.10.0, 2.1.1,
>>> 2.3.0.
>> From what I understand, Centos6.6 is not supported with 2.3
>>
>> It is likely that OVS 2.4 will be released today. It is likely that
>> Centos6.6 is supported in that version. branch2.4 is already created,
>> so you can try that too.
>>
>>
>>>
>>> Every time i have problems on this line :
>>> --------------------------------------
>>> Starting Line #
>>> ---------------------------------------
>>> #[root at ns509777 openvswitch-2.1.1]# rpmbuild -bb
>>> rhel/openvswitch-kmod-rhel6.spec
>>> Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.hWy71a
>>> + umask 022
>>> + cd /root/rpmbuild/BUILD
>>> + LANG=C
>>> + export LANG
>>> + unset DISPLAY
>>> + cd /root/rpmbuild/BUILD
>>> + rm -rf openvswitch-2.1.1
>>> + /usr/bin/gzip -dc /root/rpmbuild/SOURCES/openvswitch-2.1.1.tar.gz
>>> + /bin/tar -xvvf -
>>>
>>> ---------------------------------------------------
>>> and is ending with this :
>>> --------------------------------------------------
>>> from
>>>
>>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../compat.h:26,
>>> from
>>>
>>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../datapath.h:29,
>>> from
>>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.c:34:
>>>
>>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
>>> error: redefinition of 'ip_is_fragment'
>>> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was
>>> here
>>> make[2]: ***
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow.o]
>>> Error 1
>>> make[2]: *** Waiting for unfinished jobs....
>>> In file included from include/net/xfrm.h:18,
>>> from
>>>
>>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.c:39:
>>>
>>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
>>> error: redefinition of 'ip_is_fragment'
>>> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was
>>> here
>>> make[2]: ***
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.o]
>>> Error 1
>>> make[2]: ***
>>>
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/dp_notify.o]
>>> Error 1
>>> make[2]: ***
>>>
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/datapath.o]
>>> Error 1
>>> make[2]: ***
>>>
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_netlink.o]
>>> Error 1
>>> make[2]: ***
>>>
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.o]
>>> Error 1
>>> make[2]: ***
>>>
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_table.o]
>>> Error 1
>>> make[2]: ***
>>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/actions.o]
>>> Error 1
>>> make[1]: ***
>>> [_module_/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux]
>>> Error 2
>>> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
>>> make: *** [default] Error 2
>>> make: Leaving directory
>>> `/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux'
>>> error: Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
>>>
>>>
>>> RPM build errors:
>>> Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
>>>
>>>
>>> -----------------------------------------------
>>>
>>> I'm going crazy :)) i'm not sure how to fix this, can i get some help ?
>>>
>>>
>>>
>>>
>>>
>>> Regards,
>>>
>>> Cristian
>>>
>>>
>>>
>>>
>>>
>>> _______________________________________________
>>> discuss mailing list
>>> discuss at openvswitch.org
>>> http://openvswitch.org/mailman/listinfo/discuss
>>>

From jesse at nicira.com  Tue Aug 25 17:08:56 2015
From: jesse at nicira.com (Jesse Gross)
Date: Tue, 25 Aug 2015 17:08:56 -0700
Subject: [ovs-discuss] Preserve vxlan headers when sending to a
 non-vxlan port on bridge?
In-Reply-To: <CAFXH76eTnKK4DtJogs-i6bhoPv6Ki936sZfVCLjJ42g5Du4avw@mail.gmail.com>
References: <CAFXH76f6cz-RBEVg=mZMG7rSENrFSt+eoWAH01Y91k769qG6HQ@mail.gmail.com>
 <CAEP_g=9bMb4xqgDSD2Scfti4jvSyG3QPMkbn_-t=cOsLjAgNgg@mail.gmail.com>
 <CAFXH76cC2G0mnG2r1sh=N1Mjwi5g1pkVWWRtYiuw2gAcRrEYOg@mail.gmail.com>
 <CAEP_g=-OU+W=eSBqU6PmqdB5fnv3fYgL4sX44K0j-5PviLdwEQ@mail.gmail.com>
 <CAFXH76eTnKK4DtJogs-i6bhoPv6Ki936sZfVCLjJ42g5Du4avw@mail.gmail.com>
Message-ID: <CAEP_g=8NsFEH1-BwbHu-fRbrtpSxAe4KVo1XPy6cmvLK=M6NUw@mail.gmail.com>

On Fri, Aug 21, 2015 at 7:24 PM, Sam Hague <shague at gmail.com> wrote:
> On Fri, Aug 21, 2015 at 8:57 PM, Jesse Gross <jesse at nicira.com> wrote:
>> On Thu, Aug 20, 2015 at 1:58 PM, Sam Hague <shague at gmail.com> wrote:
>> > On Thu, Aug 20, 2015 at 1:32 PM, Jesse Gross <jesse at nicira.com> wrote:
>> >> On Thu, Aug 20, 2015 at 8:20 AM, Sam Hague <shague at gmail.com> wrote:
>> >> > Is it possible to send vxlan encapsulated packets to a bridge port
>> >> > and
>> >> > keep
>> >> > the vxlan headers?
>> >>
>> >> It's not possible unless you don't terminate the tunnels, in which
>> >> case you can't match on anything in the header.
>> >
>> >
>> > Is the only way to add vxlan headers by sending a packet out a vxlan
>> > port -
>> > whether the key/srcip/dstip are port or flow-based?
>>
>> Yes.
>>
>> > Is there any way to "overload" the vm port such that if I sent a vxlan
>> > packet froma normal vxlan port on the bridge it could come back into the
>> > bridge and to that vm port such that the vm would terminate the tunnel?
>> >
>> > The use case is for the typical openstack setup where the VMs are ports
>> > hanging off the bridge and flows are added to simply push normal l2-l4
>> > packets to the port. But I would like to terminate vxlan inside the VM
>> > itself but under this constraint that is was OpenStack that instantiated
>> > the
>> > VM in the way it typically does.
>> >
>> > So I could see adding some flows to send a vxlan packet out a port on
>> > the
>> > bridge, and somehow getting it to come back into the bridge and not have
>> > the
>> > header stripped. Typically those VM addresses are internal addresses
>> > which
>> > the host wouldn't know about so if I sent a vxlan out a bridge port, the
>> > network stack wouldn't send it back.
>>
>> Presumably, in this case the destination IP address is owned by the
>> hypervisor. In that case, the hypervisor IP stack is going to consume
>> the packet regardless of what the OVS or VXLAN configuration is. The
>> only way around that is either to actually address packets to the VM
>> (either on the remote side or by re-encapsulating the packet locally)
>> or hack together some rules to prevent the hypervisor IP stack from
>> seeing the packet altogether, likely using NAT.
>
>
> Yeah, was hoping I could find the trickery to get around this. I assigned IP
> addresses to the two bridges and used those address as the src/dst for the
> vxlan tunnel - without adding a vxlan port on the destination bridge,
> thinking maybe it would sneak into the bridge as a l3 packet. But looks like
> somewhere in the stack the packet was identified as vxlan and got into OVS
> and OVS dropped it.

Yes, as I said before, this is not specific to OVS or VXLAN. You can't
expect to send a packet destined to the local host's IP address and
expect the stack not to consume it. If there is no VXLAN listener, it
still won't get forwarded - you'll get an ICMP unreachable message.

Fundamentally, there are two communication paths here: remote vSwitch
to local vSwitch and local vSwitch to VM. I think you need to actually
model it this way rather than as forwarding, otherwise you will be
forever running into addressing problems.

From seamus.na at gmail.com  Tue Aug 25 17:34:18 2015
From: seamus.na at gmail.com (=?utf-8?B?c2VhbXVzLm5h?=)
Date: Wed, 26 Aug 2015 08:34:18 +0800
Subject: [ovs-discuss] =?utf-8?b?5Zue5aSN77yaIG9wZW52c3dpdGNoIGluc3RhbGwg?=
 =?utf-8?q?on_centos_6=2E6_issue?=
References: <CAEP_g=8RGnRy82VpsMy-zjVjZBxmfp-QkogDxCLN5p3AwTk2Uw@mail.gmail.com><0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com><CAHbON5pqG=zqZKbFJjWZ4sFxqYuJwNtW4ptmHTYATJywf-+pCA@mail.gmail.com><570c
Message-ID: <tencent_FC71F1BC727A7DAAFAD57EEB@qq.com>

An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150826/8d9278ef/attachment-0001.html>

From c1_dx at yahoo.com  Tue Aug 25 18:15:27 2015
From: c1_dx at yahoo.com (c1)
Date: Wed, 26 Aug 2015 09:15:27 +0800
Subject: [ovs-discuss] SR-IOV with OVS
In-Reply-To: <20150825151504.GB30091@nicira.com>
References: <15422219-89C4-45A2-A2FD-B72D46B26E00@yahoo.com>
 <20150825151504.GB30091@nicira.com>
Message-ID: <B0B4B5A9-9EC7-4CBF-8E88-CCF42897DC48@yahoo.com>

Thank you for your answer, but very disappointed to hear the news. I did try a variety of methods, to no avail, it seems I can only change the program. Still grateful reply.
> 
> On Tue, Aug 25, 2015 at 02:47:48PM +0800, c1 wrote:
>> There is a physical interface eth0 on my server, I opened the SR-IOV functionality of this physical port on.Now I can see eth0 ~ 7.
>> 	
>> 	eth0 belong ovs network, there are some in ovs switch virtual interface for virtual machines. 
>> 	
>> 	One virtual interface I configured vlan 174, and through him to create a virtual machine vm0, go after the virtual machine can ping vlan gateways and vlans' IP. 
>> 	
>> 	When I use the SR-IOV interface to create virtual machines created vm1, and configure vlan 174, the virtual machine can also  ping the gateway and vlans' IP.    
>> 	
>> 	But vm1 and vm0 not be able to ping each other.    
>> 	
>> 	When vm1 ping vm2 : vm1 can learn vm0 the arp, arp I can see requests and responses through the tcpdump packet capture on eth0. 
>> 
>> 	But I do not see the icmp request packets.    
>> 
>> 	Phenomenon is the use of SR-IOV port did not forward the packet to eth0, what I need to do configuration changes?  
> 
> It doesn't make sense to combine SR-IOV and OVS.


From sean.k.mooney at intel.com  Wed Aug 26 04:12:20 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Wed, 26 Aug 2015 11:12:20 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>

I know the feeling. I think your horizon issue can be fixed by
Running 
sudo iptables -F 
sudo iptables -X
iptables based security groups do not work with vhost-user so this will have no effect on vm security

I think the ovs-ofctl: br-int is not a bridge or a socket error is because the 
datapath_type on the bridge is not currently set to netdev.

Looking at your previous error I noticed the follow command the datapath_type is being set to system.
['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--', 
> '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 'br-int', 
> 'datapath_type=system']


I think the reason the bridge does not exists is because it has the wrong datapath type.
You can validate this by running 
sudo ovs-vsctl list-br

when using kernel ovs the output will be similar to this

_uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa
controller          : []
datapath_id         : "0000b24fc650f940"
datapath_type       : system
external_ids        : {bridge-id=br-int}
fail_mode           : secure
flood_vlans         : []
flow_tables         : {}
ipfix               : []
mirrors             : []
name                : br-int
netflow             : []
other_config        : {}
ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-47c1-874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5, e1a7ef91-53a4-4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-bb68a6c132c4]
protocols           : ["OpenFlow10"]
sflow               : []
status              : {}
stp_enable          : false

when using ovs with dpdk the datapath_type  should be netdev.

If it is currently system and assuming you have OVS_DATAPATH_TYPE=netdev set in your local.conf this could be caused,
as one of my patches to neutron merged Saturday and we have not updated our deployment code
To add the appropriate configuration.
https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb46751489a52665e673a5cb0b


If you add 
[ovs]
datapath_type = netdev 
to the ml2_conf.ini the q-agt will configure the dpdk netdev datapath 
instead of the system kernel datapath.

For your running system you can run the following commands to set the datapath

sudo ovs-vsctl set bridge <bridge name> datapath=netdev.

This should be run for all ovs bridges.

On huge table memory as the system is left running main memory gets fragment.
when you start ovs with our service file it allocates hugempage memory in the kernel from the current free memory.

When you compile dpdk there is a hugepage segment limit of 256 segment.
If the dpdk application cannot allocated its hugepage memory in less segment then this limit the application will exit.
You can adjust this limit by setting OVS_DPDK_MEM_SEGMENTS=<value> in your local.conf
The more often you stack and unstack between reboots the more fragmented your memory will be so for development
I tend to set the OVS_DPDK_MEM_SEGMENTS quite high. 

Regards
Sean. 
-----Original Message-----
From: Gabe Black [mailto:Gabe.Black at viavisolutions.com] 
Sent: Tuesday, August 25, 2015 9:45 PM
To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org
Subject: RE: duplicate option: of_interface

Sorry, that was premature.  Apparently hugetable memory gets fragmented or leaks or something as the ovs-dpdk failed to start.  Rebooting fixed that.

I still get many errors in the q-agt log file similar to this:
ERROR neutron.agent.linux.utils [-]
Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1
Stdin: hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,actions=normal
Stdout:
Stderr: ovs-ofctl: br-int is not a bridge or a socket

and 

ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-d29e450eda38 None None] Unable to execute ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23']. Exception:
Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code: 1
Stdin:
Stdout:
Stderr: ovs-ofctl: br-int is not a bridge or a socket

But at least q-agt isn't dying.  I remember why I hate fedora though.. Even though horizon says it is running and we turned the firewall to permissive, I can never access the website.  Seems like something else is protecting or acting as a firewall.



> -----Original Message-----
> From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of 
> Gabe Black
> Sent: Tuesday, August 25, 2015 2:06 PM
> To: Mooney, Sean K; bugs at openvswitch.org
> Subject: Re: [ovs-discuss] duplicate option: of_interface
> 
> Thanks for the reply and hints on changes...  Armed with that I undid 
> the changes from git commit 053bfc5a (neutron) and that allowed the 
> q-agt process to at least not die there with that callstack.  The 
> commit message seemed to indicate it was for better 
> restarting/cleanup; so I hope it is relatively low impact to back out.
> 
> However, it now dies because it is still unable to create the br-int bridge:
> 
> Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline', 
> '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--', 'set', 
> 'Bridge', 'br-int', 'datapath_type=system'].
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Traceback 
> (most recent call last):
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63, in 
> run_vsctl
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> log_fail_as_error=False).rstrip()
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in execute
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise
> RuntimeError(m)
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> RuntimeError:
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Command:
> ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--', 
> '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 'br-int', 
> 'datapath_type=system']
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit 
> code: -14
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr: 
> 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with signal 
> 14 (Alarm
> clock)
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> 
> I noticed a difference between a multi-node setup and a single node, 
> where multi-node's controller has openvswitch and ovsdpdk for the 
> Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related to that?  Or 
> should it be trying to create br-int as datapath_type netdev instead?  
> Just throwing things out there because I'm ignorant :-)  I'll try 
> variations of that in hopes I get lucky.
> 
> 
> Gabe
> 
> 
> 
> > -----Original Message-----
> > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > Sent: Tuesday, August 25, 2015 1:30 PM
> > To: Gabe Black; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > Hi Gabe
> > We have started to see that message in our ci since this weekend.
> > We are currently investigating it but I belive a change has merged 
> > to neuton that we need to back port to Our agent.
> >
> > A lot of code has merged in the last 2 weeks as the code freeze for 
> > the liberty release is moday.
> > The stable kilo branch should be unaffected but we are actively 
> > looking into this at present.
> >
> > Regards
> > Sean.
> >
> >
> > -----Original Message-----
> > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > Sent: Tuesday, August 25, 2015 7:50 PM
> > To: bugs at openvswitch.org
> > Cc: Mooney, Sean K
> > Subject: duplicate option: of_interface
> >
> > I have followed the getting started guide
> > (http://git.openstack.org/cgit/stackforge/networking-ovs-
> > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu
> > 15.04 to get a single-node set up with dpdk ovs.
> >
> > My local.conf file is identical to the one provided as the single 
> > node
> template:
> > http://git.openstack.org/cgit/stackforge/networking-ovs-
> > dpdk/tree/doc/source/_downloads/local.conf.single_node
> >
> > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124, 
> > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> > ML2_VLAN_RANGES=default:1000:1010
> >
> > eno1 and associated IP is the interface/ip address of the server 
> > (i.e. what
> we
> > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> > eventually be used for the data interface in a multi-node setup.
> > Finally the vlan range was just arbitrarily chosen.
> >
> > Other than that, there isn't anything else modified other than 
> > following instructions of the getting started guide.  However for 
> > both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some mods that 
> > needed to take place like disabling apparmor, symlinking 
> > /var/run/openstack, and fixing ovs-dpdk-init
> > script) result in the following error message in q-agt:
> >
> > Traceback (most recent call last):
> >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
> >     sys.exit(main())
> >   File "/usr/lib/python2.7/site-
> > packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> > line 20, in main
> >     agent_main.main()
> >   File "/usr/lib/python2.7/site-
> > packages/networking_ovs_dpdk/agent/main.py", line 43, in main
> >     mod = importutils.import_module(mod_name)
> >   File "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",
> > line 57, in import_module
> >     __import__(import_str)
> >   File "/usr/lib/python2.7/site-
> >
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> > line 17, in <module>
> >     from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
> >   File "/usr/lib/python2.7/site-
> > packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",
> line
> > 47, in <module>
> >     from neutron.plugins.ml2.drivers.openvswitch.agent import 
> > ovs_dvr_neutron_agent
> >   File
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> > dvr_neutron_agent.py", line 29, in <module>
> >     cfg.CONF.import_group('AGENT',
> > 'neutron.plugins.ml2.drivers.openvswitch.'
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 2088, in import_group
> >     __import__(module_str)
> >   File
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> > mon/config.py", line 111, in <module>
> >     cfg.CONF.register_opts(ovs_opts, "OVS")
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 1824, in __inner
> >     result = f(self, *args, **kwargs)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 1983, in register_opts
> >     self.register_opt(opt, group, clear_cache=False)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 1828, in __inner
> >     return f(self, *args, **kwargs)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 1967, in register_opt
> >     return group._register_opt(opt, cli)
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 1345, in _register_opt
> >     if _is_opt_registered(self._opts, opt):
> >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 
> > 574, in _is_opt_registered
> >     raise DuplicateOptError(opt.name)
> > oslo_config.cfg.DuplicateOptError: duplicate option: of_interface 
> > q-agt failed to start
> >
> > I thought this error message was just because Ubuntu testing/support 
> > hasn't been fleshed out yet with ovs-dpdk, but then I got the exact 
> > same error on Fedora 21.  I tried editing both
> >
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> > on/config.py and /opt/stack/networking-ovs- 
> > dpdk/networking_ovs_dpdk/common/config.py to get past the error, but 
> > then there are complaints about not finding br-int... So I'm 
> > guessing that isn't the correct workaround.  Anyone have any 
> > suggestions of what I might have misconfigured?
> >
> > Thank you for your help!
> > Gabriel Black
> >
> 
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

From fan.du at intel.com  Wed Aug 26 07:27:52 2015
From: fan.du at intel.com (Du, Fan)
Date: Wed, 26 Aug 2015 22:27:52 +0800
Subject: [ovs-discuss] Behavior when ping "internal" bridge interface ip
 with dpdk port attached
Message-ID: <55DDCCE8.30502@intel.com>

After creating a user space ovs bridge, and assign an valid ip address
after the "internal" bridge name, then add a physical interface, e.g. 
ens806f1 to the bridge. Ping the internal bridge ip address from the 
other host will work ok.

But once I prevent all the packets reaching ens806f1 by iptable rules,
Ping from the other host will not work. So my understanding is kernel
network stack responds to the ARP request, in which case bypass ovs user
space bridge.
iptables -A INPUT -i ens806f1 -j DROP
iptables -A FORWARD -i ens806f1 -j DROP

But when attaching a dpdk type port(instead of the physical interface
like ens806f1) to the bridge,I can tcpdump ARP_REPLY from the dummy
mirroring port, but the ARP_REPLY packet didn't reach from the other host.

So I'm puzzled, in scenario of dpdk port attached:
a. which part of code build the ARP_REPLY packet?
b. why the arp reply packet didn't hit on wire after setting arp with
    normal action flow?





From Gabe.Black at viavisolutions.com  Tue Aug 25 11:49:55 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Tue, 25 Aug 2015 18:49:55 +0000
Subject: [ovs-discuss] duplicate option: of_interface
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>

I have followed the getting started guide (http://git.openstack.org/cgit/stackforge/networking-ovs-dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu 15.04 to get a single-node set up with dpdk ovs.

My local.conf file is identical to the one provided as the single node template: http://git.openstack.org/cgit/stackforge/networking-ovs-dpdk/tree/doc/source/_downloads/local.conf.single_node

I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124, OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and  ML2_VLAN_RANGES=default:1000:1010

eno1 and associated IP is the interface/ip address of the server (i.e. what we use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will eventually be used for the data interface in a multi-node setup.  Finally the vlan range was just arbitrarily chosen.

Other than that, there isn't anything else modified other than following instructions of the getting started guide.  However for both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some mods that needed to take place like disabling apparmor, symlinking /var/run/openstack, and fixing ovs-dpdk-init script) result in the following error message in q-agt:

Traceback (most recent call last):
  File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
    sys.exit(main())
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py", line 20, in main
    agent_main.main()
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/agent/main.py", line 43, in main
    mod = importutils.import_module(mod_name)
  File "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py", line 57, in import_module
    __import__(import_str)
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py", line 17, in <module>
    from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
  File "/usr/lib/python2.7/site-packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py", line 47, in <module>
    from neutron.plugins.ml2.drivers.openvswitch.agent import ovs_dvr_neutron_agent
  File "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_dvr_neutron_agent.py", line 29, in <module>
    cfg.CONF.import_group('AGENT', 'neutron.plugins.ml2.drivers.openvswitch.'
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 2088, in import_group
    __import__(module_str)
  File "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/common/config.py", line 111, in <module>
    cfg.CONF.register_opts(ovs_opts, "OVS")
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1824, in __inner
    result = f(self, *args, **kwargs)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1983, in register_opts
    self.register_opt(opt, group, clear_cache=False)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1828, in __inner
    return f(self, *args, **kwargs)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1967, in register_opt
    return group._register_opt(opt, cli)
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 1345, in _register_opt
    if _is_opt_registered(self._opts, opt):
  File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line 574, in _is_opt_registered
    raise DuplicateOptError(opt.name)
oslo_config.cfg.DuplicateOptError: duplicate option: of_interface
q-agt failed to start

I thought this error message was just because Ubuntu testing/support hasn't been fleshed out yet with ovs-dpdk, but then I got the exact same error on Fedora 21.  I tried editing both /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/common/config.py and /opt/stack/networking-ovs-dpdk/networking_ovs_dpdk/common/config.py to get past the error, but then there are complaints about not finding br-int... So I'm guessing that isn't the correct workaround.  Anyone have any suggestions of what I might have misconfigured?

Thank you for your help!
Gabriel Black



From dev_raj82 at yahoo.com  Tue Aug 25 12:58:02 2015
From: dev_raj82 at yahoo.com (Nishanth Devarajan)
Date: Wed, 26 Aug 2015 01:28:02 +0530
Subject: [ovs-discuss] Conference 2015
Message-ID: <E2266714-B8F2-4697-AB32-09DD1671D533@yahoo.com>

Hello all, 
          I was watching last year conference videos on YouTube and I noticed that the speakers last year presented specific topics but the topics stated this year are not that meticulous. Were the topics stated last year specific to  a high extent?  or, should the speaker’s presentation delve deep into the stated topics .

Thank you,
Nishanth D 

From chenww at hotmail.com  Tue Aug 25 15:09:03 2015
From: chenww at hotmail.com (Chen Weiwen)
Date: Tue, 25 Aug 2015 16:09:03 -0600
Subject: [ovs-discuss] packet leaking across vswitches
In-Reply-To: <20150804173748.GC2148@x240.home>
References: <SNT405-EAS21551082713620DF9C85A3BCF770@phx.gbl>,
 <20150804173748.GC2148@x240.home>
Message-ID: <SNT149-W83DAD2C2E626B12E8935D6CF610@phx.gbl>

Hi All,
Thanks all for suggestion. What turns out the issue is openvswitch upstart process kicked too early before networking service is fully started. Once I changed the condition of openvswitch upstart process to "stopped networking" no looping is seen anymore.
Not openvswitch issue but some where ...Hope this at least help others
-weiwen

> Date: Tue, 4 Aug 2015 14:37:48 -0300
> From: fbl at sysclose.org
> To: chenww at hotmail.com
> CC: discuss at openvswitch.org
> Subject: Re: [ovs-discuss] packet leaking across vswitches
> 
> On Mon, Aug 03, 2015 at 08:45:35PM +0000, Chen Weiwen wrote:
> > see weird things only with openvswitch, even the latest version,
> > that potentially packet will leak from one vswitch to another, even
> > those two vswitches are configured  separately with different
> > physical NICs on different VLAN trunks. No patch/tunnel ports
> > involved. We see looping detection happens to these two uplink
> > ports.
> > 
> > 
> > vswitch1: 
> >       - eth0
> >       - port with vlan 100
> > 
> > vswitch2:
> >       - eth1
> >       - port with vlan 200
> > 
> > Can someone explain if this is possible the packet from vlan 200 on
> > vswitch1 can reach vswitch2?
> 
> That's really odd.  Can you provide more info about your setup?
> Is it Linux? Do you have configured IP addresses? It is forwarding
> between those configured devices?
> 
> fbl
> 
 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150825/15cf4b80/attachment-0001.html>

From Ravi_Sabapathy at Dell.com  Wed Aug 26 01:58:45 2015
From: Ravi_Sabapathy at Dell.com (Ravi_Sabapathy at Dell.com)
Date: Wed, 26 Aug 2015 14:28:45 +0530
Subject: [ovs-discuss] [ovsdb-dev] bfd implementation in OVS
In-Reply-To: <1914153400.120288.1440503826449.JavaMail.yahoo@mail.yahoo.com>
References: <1914153400.120288.1440503826449.JavaMail.yahoo@mail.yahoo.com>
Message-ID: <D5A6F3355F664C40AFB65BB1277D8D45040EE9D24C@MAAX7MCDC101.APAC.DELL.COM>

Hi Daya,

             BFD operates on top of any data protocol (network layer, link layer, tunnels(vxlan tunnel), etc.)  being forwarded between two systems.  BFD provides failure detection on direct physical links, virtual circuits, tunnels(vxlan tunnel) etc.  If BFD is run over a VXLAN tunnel, the BFD packets will be encapsulated inside the VXLAN header.

Inner IPv4 Header:

                     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                    |Version|  IHL  |Type of Service|          Total Length                                  |
                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                    |         Identification        |Flags|      Fragment Offset                   |
                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                    |  TTL = 1      |Protocol=17(UDP)|   Header Checksum                      |
                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                    |                       Inner Source IPv4 Address                                        |
                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                    |       Inner Destination Ipv4 Address  = 127/8 address              |
                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

The above picture shows a sample Inner IPv4 Header for BFD. The TTL =1 that was mentioned in the link (http://openvswitch.org/pipermail/discuss/2015-February/016515.html) should corresponds to the inner IPv4 TTL.

                             As per BFD specification, the protocol should be run between 2 systems.

1.       On a physical network it will be between 2 links.

2.       On a tunnel/overlay network, it will be between 2 end points.

So, ideally the TTL value should be 1 or single hop.

              Consider your scenario where VXLAN is formed between 2 OVS switches over a WAN network. How will the VM's connected to these switches communicate?

The OVS should not bother about the underlay network and worry only about the VXLAN tunnel. In the same way, BFD will be transmitted to the tunnel end point (TEP) over the VXLAN tunnel and consider it as a single hop.

              For example consider the tunnel end points
                             5.5.5.1 and 5.5.5.2

                             From the TEP 5.5.5.1, VXLAN encapsulated BFD packet is sent. The intermediate routers or switches should not consume the BFD packet. Only TEP (5.5.5.2) switch should de-encapsulate the BFD packet and send it to the BFD protocol. The BFD protocol control messages will be exchanged in this manner. If the BFD control message are not properly exchanged between TEP’s as per agreement, then the BFD protocol should intimate the link down to the OVS. OVS can update it in the Physical locator table.
The above said statements may not be true for OVS implementation of BFD. I have said in the context of a hardware switch using proprietary BFD protocol.

                             I think the BFD IP should be the tunnel IP, since we run BFD protocol between the VXLAN TEP.

Regards,
Ravi

From: ovsdb-dev-bounces at lists.opendaylight.org [mailto:ovsdb-dev-bounces at lists.opendaylight.org] On Behalf Of daya kamath
Sent: Tuesday, August 25, 2015 5:27 PM
To: discuss at openvswitch.org
Cc: Ovsdb-dev <ovsdb-dev at lists.opendaylight.org>
Subject: [ovsdb-dev] bfd implementation in OVS

hi ,
i would like some clarification on the BFD implementation in OVS.

http://openvswitch.org/pipermail/discuss/2015-February/016515.html indicates the BFD is not multi-hop but sent through the tunnel.

can someone please clarify, if i create a VXLAN tunnel between 2 OVS switches over a WAN,
1. will the BFD work, i.e will BFD packets be VXLAN encapsulated, and delivered as if it were a single hop?
2. if yes, how does the OVS detect BFD payload after stripping off the VXLAN header on an incoming packet?
3. what does the VTEP put in the inner source and dest IP fields for BFD pkts? does it put the same values as the outer header?

thanks!


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150826/4533fed6/attachment-0001.html>

From daya_k at yahoo.com  Wed Aug 26 03:03:41 2015
From: daya_k at yahoo.com (daya kamath)
Date: Wed, 26 Aug 2015 10:03:41 +0000 (UTC)
Subject: [ovs-discuss] [ovsdb-dev] bfd implementation in OVS
In-Reply-To: <D5A6F3355F664C40AFB65BB1277D8D45040EE9D24C@MAAX7MCDC101.APAC.DELL.COM>
References: <D5A6F3355F664C40AFB65BB1277D8D45040EE9D24C@MAAX7MCDC101.APAC.DELL.COM>
Message-ID: <1475461721.555254.1440583421930.JavaMail.yahoo@mail.yahoo.com>

thanks ravi and alex! ravi, alex has also confirmed that the pkts are vxlan encapsulated, outer IP would have to be the TEP IP, and inner IP is immaterial since the slow path at the receiver would essentially ignore it.
thanks!daya
      From: "Ravi_Sabapathy at Dell.com" <Ravi_Sabapathy at Dell.com>
 To: daya_k at yahoo.com; discuss at openvswitch.org 
Cc: ovsdb-dev at lists.opendaylight.org; C_Venkataraghavan at DELL.com 
 Sent: Wednesday, August 26, 2015 2:28 PM
 Subject: RE: [ovsdb-dev] bfd implementation in OVS
   
#yiv5620352777 #yiv5620352777 -- _filtered #yiv5620352777 {font-family:SimSun;panose-1:2 1 6 0 3 1 1 1 1 1;} _filtered #yiv5620352777 {panose-1:2 4 5 3 5 4 6 3 2 4;} _filtered #yiv5620352777 {font-family:Calibri;panose-1:2 15 5 2 2 2 4 3 2 4;} _filtered #yiv5620352777 {panose-1:2 1 6 0 3 1 1 1 1 1;} _filtered #yiv5620352777 {font-family:Verdana;panose-1:2 11 6 4 3 5 4 4 2 4;}#yiv5620352777 #yiv5620352777 p.yiv5620352777MsoNormal, #yiv5620352777 li.yiv5620352777MsoNormal, #yiv5620352777 div.yiv5620352777MsoNormal {margin:0in;margin-bottom:.0001pt;font-size:12.0pt;}#yiv5620352777 a:link, #yiv5620352777 span.yiv5620352777MsoHyperlink {color:blue;text-decoration:underline;}#yiv5620352777 a:visited, #yiv5620352777 span.yiv5620352777MsoHyperlinkFollowed {color:purple;text-decoration:underline;}#yiv5620352777 p {margin-right:0in;margin-left:0in;font-size:12.0pt;}#yiv5620352777 p.yiv5620352777MsoListParagraph, #yiv5620352777 li.yiv5620352777MsoListParagraph, #yiv5620352777 div.yiv5620352777MsoListParagraph {margin-top:0in;margin-right:0in;margin-bottom:0in;margin-left:.5in;margin-bottom:.0001pt;font-size:12.0pt;}#yiv5620352777 span.yiv5620352777EmailStyle17 {color:#1F497D;}#yiv5620352777 .yiv5620352777MsoChpDefault {font-size:10.0pt;} _filtered #yiv5620352777 {margin:1.0in 1.0in 1.0in 1.0in;}#yiv5620352777 div.yiv5620352777WordSection1 {}#yiv5620352777 _filtered #yiv5620352777 {} _filtered #yiv5620352777 {margin-left:1.75in;} _filtered #yiv5620352777 {margin-left:2.25in;} _filtered #yiv5620352777 {margin-left:2.75in;} _filtered #yiv5620352777 {margin-left:3.25in;} _filtered #yiv5620352777 {margin-left:3.75in;} _filtered #yiv5620352777 {margin-left:4.25in;} _filtered #yiv5620352777 {margin-left:4.75in;} _filtered #yiv5620352777 {margin-left:5.25in;} _filtered #yiv5620352777 {margin-left:5.75in;}#yiv5620352777 ol {margin-bottom:0in;}#yiv5620352777 ul {margin-bottom:0in;}#yiv5620352777 Hi Daya,                BFD operates on top of any data protocol (network layer, link layer, tunnels(vxlan tunnel), etc.)  being forwarded between two systems.  BFD provides failure detection on direct physical links, virtual circuits, tunnels(vxlan tunnel) etc.  If BFD is run over a VXLAN tunnel, the BFD packets will be encapsulated inside the VXLAN header.   Inner IPv4 Header:                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                    |Version|  IHL  |Type of Service|          Total Length                                  |                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                    |         Identification        |Flags|      Fragment Offset                   |                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                    |  TTL = 1      |Protocol=17(UDP)|   Header Checksum                      |                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                    |                       Inner Source IPv4 Address                                        |                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                    |       Inner Destination Ipv4 Address  = 127/8 address              |                    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  The above picture shows a sample Inner IPv4 Header for BFD. The TTL =1 that was mentioned in the link (http://openvswitch.org/pipermail/discuss/2015-February/016515.html) should corresponds to the inner IPv4 TTL.                                 As per BFD specification, the protocol should be run between 2 systems. 1.       On a physical network it will be between 2 links.2.       On a tunnel/overlay network, it will be between 2 end points.  So, ideally the TTL value should be 1 or single hop.                Consider your scenario where VXLAN is formed between 2 OVS switches over a WAN network. How will the VM's connected to these switches communicate?   The OVS should not bother about the underlay network and worry only about the VXLAN tunnel. In the same way, BFD will be transmitted to the tunnel end point (TEP) over the VXLAN tunnel and consider it as a single hop.                             For example consider the tunnel end points                             5.5.5.1 and 5.5.5.2                                                          From the TEP 5.5.5.1, VXLAN encapsulated BFD packet is sent. The intermediate routers or switches should not consume the BFD packet. Only TEP (5.5.5.2) switch should de-encapsulate the BFD packet and send it to the BFD protocol. The BFD protocol control messages will be exchanged in this manner. If the BFD control message are not properly exchanged between TEP’s as per agreement, then the BFD protocol should intimate the link down to the OVS. OVS can update it in the Physical locator table. The above said statements may not be true for OVS implementation of BFD. I have said in the context of a hardware switch using proprietary BFD protocol.                               I think the BFD IP should be the tunnel IP, since we run BFD protocol between the VXLAN TEP.  Regards,Ravi  

From: ovsdb-dev-bounces at lists.opendaylight.org [mailto:ovsdb-dev-bounces at lists.opendaylight.org] On Behalf Of daya kamath
Sent: Tuesday, August 25, 2015 5:27 PM
To: discuss at openvswitch.org
Cc: Ovsdb-dev <ovsdb-dev at lists.opendaylight.org>
Subject: [ovsdb-dev] bfd implementation in OVS  hi ,i would like some clarification on the BFD implementation in OVS.  http://openvswitch.org/pipermail/discuss/2015-February/016515.html indicates the BFD is not multi-hop but sent through the tunnel.  can someone please clarify, if i create a VXLAN tunnel between 2 OVS switches over a WAN,1. will the BFD work, i.e will BFD packets be VXLAN encapsulated, and delivered as if it were a single hop? 2. if yes, how does the OVS detect BFD payload after stripping off the VXLAN header on an incoming packet?3. what does the VTEP put in the inner source and dest IP fields for BFD pkts? does it put the same values as the outer header?  thanks!    

  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150826/b403d394/attachment-0001.html>

From jpettit at nicira.com  Wed Aug 26 09:02:43 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Wed, 26 Aug 2015 09:02:43 -0700
Subject: [ovs-discuss] Conference 2015
In-Reply-To: <E2266714-B8F2-4697-AB32-09DD1671D533@yahoo.com>
References: <E2266714-B8F2-4697-AB32-09DD1671D533@yahoo.com>
Message-ID: <5F483A86-C195-433E-8ED7-D360815B72F2@nicira.com>

We don't have the schedule yet, since we're still accepting talk proposals:

	http://openvswitch.org/pipermail/announce/2015-August/000076.html

Those are just possible subject areas for proposals.  I imagine that we'll have the final schedule uploaded by the end of September.

--Justin


> On Aug 25, 2015, at 12:58 PM, Nishanth Devarajan <dev_raj82 at yahoo.com> wrote:
> 
> Hello all, 
>          I was watching last year conference videos on YouTube and I noticed that the speakers last year presented specific topics but the topics stated this year are not that meticulous. Were the topics stated last year specific to  a high extent?  or, should the speaker’s presentation delve deep into the stated topics .
> 
> Thank you,
> Nishanth D 
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss


From Gabe.Black at viavisolutions.com  Wed Aug 26 11:41:32 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Wed, 26 Aug 2015 18:41:32 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5F8BB@AMEXMB01.ds.jdsu.net>

Hi Sean,

Yes, I did have the OVS_DATAPATH_TYPE set to netdev.  Even after setting the [ovs] datapath_type=netdev and trying to manually set the datapath_type to netdev (ovs-vsctl set Bridge br-int datapath_type=netdev), the br-int still shows system.

The interesting thing is that the other bridges (br-ex and br-p6p1 are set to netdev (automatically during stacking), but just br-int is system and immutable it seems via manual ovs-vsctl commands).

I'll keep playing around and see if there is some way to reconcile.

Thanks,
Gabe

> -----Original Message-----
> From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> Sent: Wednesday, August 26, 2015 5:12 AM
> To: Gabe Black; bugs at openvswitch.org
> Subject: RE: duplicate option: of_interface
> 
> I know the feeling. I think your horizon issue can be fixed by Running sudo
> iptables -F sudo iptables -X iptables based security groups do not work with
> vhost-user so this will have no effect on vm security
> 
> I think the ovs-ofctl: br-int is not a bridge or a socket error is because the
> datapath_type on the bridge is not currently set to netdev.
> 
> Looking at your previous error I noticed the follow command the
> datapath_type is being set to system.
> ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 'br-int',
> > 'datapath_type=system']
> 
> 
> I think the reason the bridge does not exists is because it has the wrong
> datapath type.
> You can validate this by running
> sudo ovs-vsctl list-br
> 
> when using kernel ovs the output will be similar to this
> 
> _uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa
> controller          : []
> datapath_id         : "0000b24fc650f940"
> datapath_type       : system
> external_ids        : {bridge-id=br-int}
> fail_mode           : secure
> flood_vlans         : []
> flow_tables         : {}
> ipfix               : []
> mirrors             : []
> name                : br-int
> netflow             : []
> other_config        : {}
> ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-47c1-
> 874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5, e1a7ef91-53a4-
> 4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-bb68a6c132c4]
> protocols           : ["OpenFlow10"]
> sflow               : []
> status              : {}
> stp_enable          : false
> 
> when using ovs with dpdk the datapath_type  should be netdev.
> 
> If it is currently system and assuming you have
> OVS_DATAPATH_TYPE=netdev set in your local.conf this could be caused, as
> one of my patches to neutron merged Saturday and we have not updated
> our deployment code To add the appropriate configuration.
> https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb4675148
> 9a52665e673a5cb0b
> 
> 
> If you add
> [ovs]
> datapath_type = netdev
> to the ml2_conf.ini the q-agt will configure the dpdk netdev datapath instead
> of the system kernel datapath.
> 
> For your running system you can run the following commands to set the
> datapath
> 
> sudo ovs-vsctl set bridge <bridge name> datapath=netdev.
> 
> This should be run for all ovs bridges.
> 
> On huge table memory as the system is left running main memory gets
> fragment.
> when you start ovs with our service file it allocates hugempage memory in
> the kernel from the current free memory.
> 
> When you compile dpdk there is a hugepage segment limit of 256 segment.
> If the dpdk application cannot allocated its hugepage memory in less
> segment then this limit the application will exit.
> You can adjust this limit by setting OVS_DPDK_MEM_SEGMENTS=<value> in
> your local.conf The more often you stack and unstack between reboots the
> more fragmented your memory will be so for development I tend to set the
> OVS_DPDK_MEM_SEGMENTS quite high.
> 
> Regards
> Sean.
> -----Original Message-----
> From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> Sent: Tuesday, August 25, 2015 9:45 PM
> To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org
> Subject: RE: duplicate option: of_interface
> 
> Sorry, that was premature.  Apparently hugetable memory gets fragmented
> or leaks or something as the ovs-dpdk failed to start.  Rebooting fixed that.
> 
> I still get many errors in the q-agt log file similar to this:
> ERROR neutron.agent.linux.utils [-]
> Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1
> Stdin:
> hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,actions=nor
> mal
> Stdout:
> Stderr: ovs-ofctl: br-int is not a bridge or a socket
> 
> and
> 
> ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-
> d29e450eda38 None None] Unable to execute ['ovs-ofctl', 'dump-flows', 'br-
> int', 'table=23']. Exception:
> Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code: 1
> Stdin:
> Stdout:
> Stderr: ovs-ofctl: br-int is not a bridge or a socket
> 
> But at least q-agt isn't dying.  I remember why I hate fedora though.. Even
> though horizon says it is running and we turned the firewall to permissive, I
> can never access the website.  Seems like something else is protecting or
> acting as a firewall.
> 
> 
> 
> > -----Original Message-----
> > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of
> > Gabe Black
> > Sent: Tuesday, August 25, 2015 2:06 PM
> > To: Mooney, Sean K; bugs at openvswitch.org
> > Subject: Re: [ovs-discuss] duplicate option: of_interface
> >
> > Thanks for the reply and hints on changes...  Armed with that I undid
> > the changes from git commit 053bfc5a (neutron) and that allowed the
> > q-agt process to at least not die there with that callstack.  The
> > commit message seemed to indicate it was for better
> > restarting/cleanup; so I hope it is relatively low impact to back out.
> >
> > However, it now dies because it is still unable to create the br-int bridge:
> >
> > Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline',
> > '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--', 'set',
> > 'Bridge', 'br-int', 'datapath_type=system'].
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Traceback
> > (most recent call last):
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63, in
> > run_vsctl
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > log_fail_as_error=False).rstrip()
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in execute
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise
> > RuntimeError(m)
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > RuntimeError:
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Command:
> > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 'br-int',
> > 'datapath_type=system']
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit
> > code: -14
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr:
> > 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with signal
> > 14 (Alarm
> > clock)
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> >
> > I noticed a difference between a multi-node setup and a single node,
> > where multi-node's controller has openvswitch and ovsdpdk for the
> > Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related to that?  Or
> > should it be trying to create br-int as datapath_type netdev instead?
> > Just throwing things out there because I'm ignorant :-)  I'll try
> > variations of that in hopes I get lucky.
> >
> >
> > Gabe
> >
> >
> >
> > > -----Original Message-----
> > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > > Sent: Tuesday, August 25, 2015 1:30 PM
> > > To: Gabe Black; bugs at openvswitch.org
> > > Subject: RE: duplicate option: of_interface
> > >
> > > Hi Gabe
> > > We have started to see that message in our ci since this weekend.
> > > We are currently investigating it but I belive a change has merged
> > > to neuton that we need to back port to Our agent.
> > >
> > > A lot of code has merged in the last 2 weeks as the code freeze for
> > > the liberty release is moday.
> > > The stable kilo branch should be unaffected but we are actively
> > > looking into this at present.
> > >
> > > Regards
> > > Sean.
> > >
> > >
> > > -----Original Message-----
> > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > > Sent: Tuesday, August 25, 2015 7:50 PM
> > > To: bugs at openvswitch.org
> > > Cc: Mooney, Sean K
> > > Subject: duplicate option: of_interface
> > >
> > > I have followed the getting started guide
> > > (http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu
> > > 15.04 to get a single-node set up with dpdk ovs.
> > >
> > > My local.conf file is identical to the one provided as the single
> > > node
> > template:
> > > http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > dpdk/tree/doc/source/_downloads/local.conf.single_node
> > >
> > > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,
> > > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> > > ML2_VLAN_RANGES=default:1000:1010
> > >
> > > eno1 and associated IP is the interface/ip address of the server
> > > (i.e. what
> > we
> > > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> > > eventually be used for the data interface in a multi-node setup.
> > > Finally the vlan range was just arbitrarily chosen.
> > >
> > > Other than that, there isn't anything else modified other than
> > > following instructions of the getting started guide.  However for
> > > both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some mods that
> > > needed to take place like disabling apparmor, symlinking
> > > /var/run/openstack, and fixing ovs-dpdk-init
> > > script) result in the following error message in q-agt:
> > >
> > > Traceback (most recent call last):
> > >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
> > >     sys.exit(main())
> > >   File "/usr/lib/python2.7/site-
> > >
> packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> > > line 20, in main
> > >     agent_main.main()
> > >   File "/usr/lib/python2.7/site-
> > > packages/networking_ovs_dpdk/agent/main.py", line 43, in main
> > >     mod = importutils.import_module(mod_name)
> > >   File "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",
> > > line 57, in import_module
> > >     __import__(import_str)
> > >   File "/usr/lib/python2.7/site-
> > >
> >
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> > > line 17, in <module>
> > >     from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
> > >   File "/usr/lib/python2.7/site-
> > > packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",
> > line
> > > 47, in <module>
> > >     from neutron.plugins.ml2.drivers.openvswitch.agent import
> > > ovs_dvr_neutron_agent
> > >   File
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> > > dvr_neutron_agent.py", line 29, in <module>
> > >     cfg.CONF.import_group('AGENT',
> > > 'neutron.plugins.ml2.drivers.openvswitch.'
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 2088, in import_group
> > >     __import__(module_str)
> > >   File
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> > > mon/config.py", line 111, in <module>
> > >     cfg.CONF.register_opts(ovs_opts, "OVS")
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 1824, in __inner
> > >     result = f(self, *args, **kwargs)
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 1983, in register_opts
> > >     self.register_opt(opt, group, clear_cache=False)
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 1828, in __inner
> > >     return f(self, *args, **kwargs)
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 1967, in register_opt
> > >     return group._register_opt(opt, cli)
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 1345, in _register_opt
> > >     if _is_opt_registered(self._opts, opt):
> > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > 574, in _is_opt_registered
> > >     raise DuplicateOptError(opt.name)
> > > oslo_config.cfg.DuplicateOptError: duplicate option: of_interface
> > > q-agt failed to start
> > >
> > > I thought this error message was just because Ubuntu testing/support
> > > hasn't been fleshed out yet with ovs-dpdk, but then I got the exact
> > > same error on Fedora 21.  I tried editing both
> > >
> >
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> > > on/config.py and /opt/stack/networking-ovs-
> > > dpdk/networking_ovs_dpdk/common/config.py to get past the error,
> but
> > > then there are complaints about not finding br-int... So I'm
> > > guessing that isn't the correct workaround.  Anyone have any
> > > suggestions of what I might have misconfigured?
> > >
> > > Thank you for your help!
> > > Gabriel Black
> > >
> >
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss

From Gabe.Black at viavisolutions.com  Wed Aug 26 11:43:30 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Wed, 26 Aug 2015 18:43:30 +0000
Subject: [ovs-discuss] duplicate option: of_interface
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com> 
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5F8F4@AMEXMB01.ds.jdsu.net>

Interesting... it seems that the ovs-vsctl set bridge br-int datapath_type=netdev does take, but very soon after it is changed back to system.  I'll try and figure out how that is happening.

Gabe

> -----Original Message-----
> From: Gabe Black
> Sent: Wednesday, August 26, 2015 12:42 PM
> To: 'Mooney, Sean K'; bugs at openvswitch.org
> Subject: RE: duplicate option: of_interface
> 
> Hi Sean,
> 
> Yes, I did have the OVS_DATAPATH_TYPE set to netdev.  Even after setting
> the [ovs] datapath_type=netdev and trying to manually set the
> datapath_type to netdev (ovs-vsctl set Bridge br-int
> datapath_type=netdev), the br-int still shows system.
> 
> The interesting thing is that the other bridges (br-ex and br-p6p1 are set to
> netdev (automatically during stacking), but just br-int is system and
> immutable it seems via manual ovs-vsctl commands).
> 
> I'll keep playing around and see if there is some way to reconcile.
> 
> Thanks,
> Gabe
> 
> > -----Original Message-----
> > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > Sent: Wednesday, August 26, 2015 5:12 AM
> > To: Gabe Black; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > I know the feeling. I think your horizon issue can be fixed by Running
> > sudo iptables -F sudo iptables -X iptables based security groups do
> > not work with vhost-user so this will have no effect on vm security
> >
> > I think the ovs-ofctl: br-int is not a bridge or a socket error is
> > because the datapath_type on the bridge is not currently set to netdev.
> >
> > Looking at your previous error I noticed the follow command the
> > datapath_type is being set to system.
> > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 'br-int',
> > > 'datapath_type=system']
> >
> >
> > I think the reason the bridge does not exists is because it has the
> > wrong datapath type.
> > You can validate this by running
> > sudo ovs-vsctl list-br
> >
> > when using kernel ovs the output will be similar to this
> >
> > _uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa
> > controller          : []
> > datapath_id         : "0000b24fc650f940"
> > datapath_type       : system
> > external_ids        : {bridge-id=br-int}
> > fail_mode           : secure
> > flood_vlans         : []
> > flow_tables         : {}
> > ipfix               : []
> > mirrors             : []
> > name                : br-int
> > netflow             : []
> > other_config        : {}
> > ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-
> 47c1-
> > 874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5,
> > e1a7ef91-53a4- 4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-
> bb68a6c132c4]
> > protocols           : ["OpenFlow10"]
> > sflow               : []
> > status              : {}
> > stp_enable          : false
> >
> > when using ovs with dpdk the datapath_type  should be netdev.
> >
> > If it is currently system and assuming you have
> > OVS_DATAPATH_TYPE=netdev set in your local.conf this could be caused,
> > as one of my patches to neutron merged Saturday and we have not
> > updated our deployment code To add the appropriate configuration.
> >
> https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb4675148
> > 9a52665e673a5cb0b
> >
> >
> > If you add
> > [ovs]
> > datapath_type = netdev
> > to the ml2_conf.ini the q-agt will configure the dpdk netdev datapath
> > instead of the system kernel datapath.
> >
> > For your running system you can run the following commands to set the
> > datapath
> >
> > sudo ovs-vsctl set bridge <bridge name> datapath=netdev.
> >
> > This should be run for all ovs bridges.
> >
> > On huge table memory as the system is left running main memory gets
> > fragment.
> > when you start ovs with our service file it allocates hugempage memory
> > in the kernel from the current free memory.
> >
> > When you compile dpdk there is a hugepage segment limit of 256 segment.
> > If the dpdk application cannot allocated its hugepage memory in less
> > segment then this limit the application will exit.
> > You can adjust this limit by setting OVS_DPDK_MEM_SEGMENTS=<value>
> in
> > your local.conf The more often you stack and unstack between reboots
> > the more fragmented your memory will be so for development I tend to
> > set the OVS_DPDK_MEM_SEGMENTS quite high.
> >
> > Regards
> > Sean.
> > -----Original Message-----
> > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > Sent: Tuesday, August 25, 2015 9:45 PM
> > To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > Sorry, that was premature.  Apparently hugetable memory gets
> > fragmented or leaks or something as the ovs-dpdk failed to start.
> Rebooting fixed that.
> >
> > I still get many errors in the q-agt log file similar to this:
> > ERROR neutron.agent.linux.utils [-]
> > Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1
> > Stdin:
> > hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,actions=no
> > r
> > mal
> > Stdout:
> > Stderr: ovs-ofctl: br-int is not a bridge or a socket
> >
> > and
> >
> > ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-
> > d29e450eda38 None None] Unable to execute ['ovs-ofctl', 'dump-flows',
> > 'br- int', 'table=23']. Exception:
> > Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code:
> > 1
> > Stdin:
> > Stdout:
> > Stderr: ovs-ofctl: br-int is not a bridge or a socket
> >
> > But at least q-agt isn't dying.  I remember why I hate fedora though..
> > Even though horizon says it is running and we turned the firewall to
> > permissive, I can never access the website.  Seems like something else
> > is protecting or acting as a firewall.
> >
> >
> >
> > > -----Original Message-----
> > > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf Of
> > > Gabe Black
> > > Sent: Tuesday, August 25, 2015 2:06 PM
> > > To: Mooney, Sean K; bugs at openvswitch.org
> > > Subject: Re: [ovs-discuss] duplicate option: of_interface
> > >
> > > Thanks for the reply and hints on changes...  Armed with that I
> > > undid the changes from git commit 053bfc5a (neutron) and that
> > > allowed the q-agt process to at least not die there with that
> > > callstack.  The commit message seemed to indicate it was for better
> > > restarting/cleanup; so I hope it is relatively low impact to back out.
> > >
> > > However, it now dies because it is still unable to create the br-int bridge:
> > >
> > > Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline',
> > > '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--',
> > > 'set', 'Bridge', 'br-int', 'datapath_type=system'].
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > Traceback (most recent call last):
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > > "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63, in
> > > run_vsctl
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > log_fail_as_error=False).rstrip()
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > > "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in execute
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise
> > > RuntimeError(m)
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > RuntimeError:
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> Command:
> > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 'br-int',
> > > 'datapath_type=system']
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit
> > > code: -14
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr:
> > > 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with
> > > signal
> > > 14 (Alarm
> > > clock)
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > >
> > > I noticed a difference between a multi-node setup and a single node,
> > > where multi-node's controller has openvswitch and ovsdpdk for the
> > > Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related to that?
> Or
> > > should it be trying to create br-int as datapath_type netdev instead?
> > > Just throwing things out there because I'm ignorant :-)  I'll try
> > > variations of that in hopes I get lucky.
> > >
> > >
> > > Gabe
> > >
> > >
> > >
> > > > -----Original Message-----
> > > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > > > Sent: Tuesday, August 25, 2015 1:30 PM
> > > > To: Gabe Black; bugs at openvswitch.org
> > > > Subject: RE: duplicate option: of_interface
> > > >
> > > > Hi Gabe
> > > > We have started to see that message in our ci since this weekend.
> > > > We are currently investigating it but I belive a change has merged
> > > > to neuton that we need to back port to Our agent.
> > > >
> > > > A lot of code has merged in the last 2 weeks as the code freeze
> > > > for the liberty release is moday.
> > > > The stable kilo branch should be unaffected but we are actively
> > > > looking into this at present.
> > > >
> > > > Regards
> > > > Sean.
> > > >
> > > >
> > > > -----Original Message-----
> > > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > > > Sent: Tuesday, August 25, 2015 7:50 PM
> > > > To: bugs at openvswitch.org
> > > > Cc: Mooney, Sean K
> > > > Subject: duplicate option: of_interface
> > > >
> > > > I have followed the getting started guide
> > > > (http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and Ubuntu
> > > > 15.04 to get a single-node set up with dpdk ovs.
> > > >
> > > > My local.conf file is identical to the one provided as the single
> > > > node
> > > template:
> > > > http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > > dpdk/tree/doc/source/_downloads/local.conf.single_node
> > > >
> > > > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,
> > > > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> > > > ML2_VLAN_RANGES=default:1000:1010
> > > >
> > > > eno1 and associated IP is the interface/ip address of the server
> > > > (i.e. what
> > > we
> > > > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> > > > eventually be used for the data interface in a multi-node setup.
> > > > Finally the vlan range was just arbitrarily chosen.
> > > >
> > > > Other than that, there isn't anything else modified other than
> > > > following instructions of the getting started guide.  However for
> > > > both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some mods that
> > > > needed to take place like disabling apparmor, symlinking
> > > > /var/run/openstack, and fixing ovs-dpdk-init
> > > > script) result in the following error message in q-agt:
> > > >
> > > > Traceback (most recent call last):
> > > >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
> > > >     sys.exit(main())
> > > >   File "/usr/lib/python2.7/site-
> > > >
> > packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> > > > line 20, in main
> > > >     agent_main.main()
> > > >   File "/usr/lib/python2.7/site-
> > > > packages/networking_ovs_dpdk/agent/main.py", line 43, in main
> > > >     mod = importutils.import_module(mod_name)
> > > >   File
> > > > "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",
> > > > line 57, in import_module
> > > >     __import__(import_str)
> > > >   File "/usr/lib/python2.7/site-
> > > >
> > >
> >
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> > > > line 17, in <module>
> > > >     from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
> > > >   File "/usr/lib/python2.7/site-
> > > > packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",
> > > line
> > > > 47, in <module>
> > > >     from neutron.plugins.ml2.drivers.openvswitch.agent import
> > > > ovs_dvr_neutron_agent
> > > >   File
> > > >
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> > > > dvr_neutron_agent.py", line 29, in <module>
> > > >     cfg.CONF.import_group('AGENT',
> > > > 'neutron.plugins.ml2.drivers.openvswitch.'
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 2088, in import_group
> > > >     __import__(module_str)
> > > >   File
> > > >
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> > > > mon/config.py", line 111, in <module>
> > > >     cfg.CONF.register_opts(ovs_opts, "OVS")
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 1824, in __inner
> > > >     result = f(self, *args, **kwargs)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 1983, in register_opts
> > > >     self.register_opt(opt, group, clear_cache=False)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 1828, in __inner
> > > >     return f(self, *args, **kwargs)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 1967, in register_opt
> > > >     return group._register_opt(opt, cli)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 1345, in _register_opt
> > > >     if _is_opt_registered(self._opts, opt):
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", line
> > > > 574, in _is_opt_registered
> > > >     raise DuplicateOptError(opt.name)
> > > > oslo_config.cfg.DuplicateOptError: duplicate option: of_interface
> > > > q-agt failed to start
> > > >
> > > > I thought this error message was just because Ubuntu
> > > > testing/support hasn't been fleshed out yet with ovs-dpdk, but
> > > > then I got the exact same error on Fedora 21.  I tried editing
> > > > both
> > > >
> > >
> >
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> > > > on/config.py and /opt/stack/networking-ovs-
> > > > dpdk/networking_ovs_dpdk/common/config.py to get past the error,
> > but
> > > > then there are complaints about not finding br-int... So I'm
> > > > guessing that isn't the correct workaround.  Anyone have any
> > > > suggestions of what I might have misconfigured?
> > > >
> > > > Thank you for your help!
> > > > Gabriel Black
> > > >
> > >
> > > _______________________________________________
> > > discuss mailing list
> > > discuss at openvswitch.org
> > > http://openvswitch.org/mailman/listinfo/discuss

From sean.k.mooney at intel.com  Wed Aug 26 11:51:03 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Wed, 26 Aug 2015 18:51:03 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5F8F4@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5F8F4@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA645176F4F@IRSMSX107.ger.corp.intel.com>

My guess would be the neutron ovs agent is changing it back but im not sure why.

My dev environment has been tied up with trying to reproduce a live migrating bug to the last two days.
I will try  to restack my compute node tomorrow and dig into this more then.


-----Original Message-----
From: Gabe Black [mailto:Gabe.Black at viavisolutions.com] 
Sent: Wednesday, August 26, 2015 7:44 PM
To: Mooney, Sean K; bugs at openvswitch.org
Subject: RE: duplicate option: of_interface

Interesting... it seems that the ovs-vsctl set bridge br-int datapath_type=netdev does take, but very soon after it is changed back to system.  I'll try and figure out how that is happening.

Gabe

> -----Original Message-----
> From: Gabe Black
> Sent: Wednesday, August 26, 2015 12:42 PM
> To: 'Mooney, Sean K'; bugs at openvswitch.org
> Subject: RE: duplicate option: of_interface
> 
> Hi Sean,
> 
> Yes, I did have the OVS_DATAPATH_TYPE set to netdev.  Even after 
> setting the [ovs] datapath_type=netdev and trying to manually set the 
> datapath_type to netdev (ovs-vsctl set Bridge br-int 
> datapath_type=netdev), the br-int still shows system.
> 
> The interesting thing is that the other bridges (br-ex and br-p6p1 are 
> set to netdev (automatically during stacking), but just br-int is 
> system and immutable it seems via manual ovs-vsctl commands).
> 
> I'll keep playing around and see if there is some way to reconcile.
> 
> Thanks,
> Gabe
> 
> > -----Original Message-----
> > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > Sent: Wednesday, August 26, 2015 5:12 AM
> > To: Gabe Black; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > I know the feeling. I think your horizon issue can be fixed by 
> > Running sudo iptables -F sudo iptables -X iptables based security 
> > groups do not work with vhost-user so this will have no effect on vm 
> > security
> >
> > I think the ovs-ofctl: br-int is not a bridge or a socket error is 
> > because the datapath_type on the bridge is not currently set to netdev.
> >
> > Looking at your previous error I noticed the follow command the 
> > datapath_type is being set to system.
> > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 
> > > 'br-int', 'datapath_type=system']
> >
> >
> > I think the reason the bridge does not exists is because it has the 
> > wrong datapath type.
> > You can validate this by running
> > sudo ovs-vsctl list-br
> >
> > when using kernel ovs the output will be similar to this
> >
> > _uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa
> > controller          : []
> > datapath_id         : "0000b24fc650f940"
> > datapath_type       : system
> > external_ids        : {bridge-id=br-int}
> > fail_mode           : secure
> > flood_vlans         : []
> > flow_tables         : {}
> > ipfix               : []
> > mirrors             : []
> > name                : br-int
> > netflow             : []
> > other_config        : {}
> > ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-
> 47c1-
> > 874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5,
> > e1a7ef91-53a4- 4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-
> bb68a6c132c4]
> > protocols           : ["OpenFlow10"]
> > sflow               : []
> > status              : {}
> > stp_enable          : false
> >
> > when using ovs with dpdk the datapath_type  should be netdev.
> >
> > If it is currently system and assuming you have 
> > OVS_DATAPATH_TYPE=netdev set in your local.conf this could be 
> > caused, as one of my patches to neutron merged Saturday and we have 
> > not updated our deployment code To add the appropriate configuration.
> >
> https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb4675148
> > 9a52665e673a5cb0b
> >
> >
> > If you add
> > [ovs]
> > datapath_type = netdev
> > to the ml2_conf.ini the q-agt will configure the dpdk netdev 
> > datapath instead of the system kernel datapath.
> >
> > For your running system you can run the following commands to set 
> > the datapath
> >
> > sudo ovs-vsctl set bridge <bridge name> datapath=netdev.
> >
> > This should be run for all ovs bridges.
> >
> > On huge table memory as the system is left running main memory gets 
> > fragment.
> > when you start ovs with our service file it allocates hugempage 
> > memory in the kernel from the current free memory.
> >
> > When you compile dpdk there is a hugepage segment limit of 256 segment.
> > If the dpdk application cannot allocated its hugepage memory in less 
> > segment then this limit the application will exit.
> > You can adjust this limit by setting OVS_DPDK_MEM_SEGMENTS=<value>
> in
> > your local.conf The more often you stack and unstack between reboots 
> > the more fragmented your memory will be so for development I tend to 
> > set the OVS_DPDK_MEM_SEGMENTS quite high.
> >
> > Regards
> > Sean.
> > -----Original Message-----
> > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > Sent: Tuesday, August 25, 2015 9:45 PM
> > To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > Sorry, that was premature.  Apparently hugetable memory gets 
> > fragmented or leaks or something as the ovs-dpdk failed to start.
> Rebooting fixed that.
> >
> > I still get many errors in the q-agt log file similar to this:
> > ERROR neutron.agent.linux.utils [-]
> > Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1
> > Stdin:
> > hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,actions=
> > no
> > r
> > mal
> > Stdout:
> > Stderr: ovs-ofctl: br-int is not a bridge or a socket
> >
> > and
> >
> > ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-
> > d29e450eda38 None None] Unable to execute ['ovs-ofctl', 
> > 'dump-flows',
> > 'br- int', 'table=23']. Exception:
> > Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code:
> > 1
> > Stdin:
> > Stdout:
> > Stderr: ovs-ofctl: br-int is not a bridge or a socket
> >
> > But at least q-agt isn't dying.  I remember why I hate fedora though..
> > Even though horizon says it is running and we turned the firewall to 
> > permissive, I can never access the website.  Seems like something 
> > else is protecting or acting as a firewall.
> >
> >
> >
> > > -----Original Message-----
> > > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf 
> > > Of Gabe Black
> > > Sent: Tuesday, August 25, 2015 2:06 PM
> > > To: Mooney, Sean K; bugs at openvswitch.org
> > > Subject: Re: [ovs-discuss] duplicate option: of_interface
> > >
> > > Thanks for the reply and hints on changes...  Armed with that I 
> > > undid the changes from git commit 053bfc5a (neutron) and that 
> > > allowed the q-agt process to at least not die there with that 
> > > callstack.  The commit message seemed to indicate it was for 
> > > better restarting/cleanup; so I hope it is relatively low impact to back out.
> > >
> > > However, it now dies because it is still unable to create the br-int bridge:
> > >
> > > Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline', 
> > > '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--', 
> > > 'set', 'Bridge', 'br-int', 'datapath_type=system'].
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl 
> > > Traceback (most recent call last):
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > > "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63, 
> > > in run_vsctl
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > log_fail_as_error=False).rstrip()
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > > "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in execute
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise
> > > RuntimeError(m)
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > RuntimeError:
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> Command:
> > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--', 
> > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge', 
> > > 'br-int', 'datapath_type=system']
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit
> > > code: -14
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr:
> > > 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with 
> > > signal
> > > 14 (Alarm
> > > clock)
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > >
> > > I noticed a difference between a multi-node setup and a single 
> > > node, where multi-node's controller has openvswitch and ovsdpdk 
> > > for the Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related to that?
> Or
> > > should it be trying to create br-int as datapath_type netdev instead?
> > > Just throwing things out there because I'm ignorant :-)  I'll try 
> > > variations of that in hopes I get lucky.
> > >
> > >
> > > Gabe
> > >
> > >
> > >
> > > > -----Original Message-----
> > > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > > > Sent: Tuesday, August 25, 2015 1:30 PM
> > > > To: Gabe Black; bugs at openvswitch.org
> > > > Subject: RE: duplicate option: of_interface
> > > >
> > > > Hi Gabe
> > > > We have started to see that message in our ci since this weekend.
> > > > We are currently investigating it but I belive a change has 
> > > > merged to neuton that we need to back port to Our agent.
> > > >
> > > > A lot of code has merged in the last 2 weeks as the code freeze 
> > > > for the liberty release is moday.
> > > > The stable kilo branch should be unaffected but we are actively 
> > > > looking into this at present.
> > > >
> > > > Regards
> > > > Sean.
> > > >
> > > >
> > > > -----Original Message-----
> > > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > > > Sent: Tuesday, August 25, 2015 7:50 PM
> > > > To: bugs at openvswitch.org
> > > > Cc: Mooney, Sean K
> > > > Subject: duplicate option: of_interface
> > > >
> > > > I have followed the getting started guide
> > > > (http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and 
> > > > Ubuntu
> > > > 15.04 to get a single-node set up with dpdk ovs.
> > > >
> > > > My local.conf file is identical to the one provided as the 
> > > > single node
> > > template:
> > > > http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > > dpdk/tree/doc/source/_downloads/local.conf.single_node
> > > >
> > > > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124, 
> > > > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> > > > ML2_VLAN_RANGES=default:1000:1010
> > > >
> > > > eno1 and associated IP is the interface/ip address of the server 
> > > > (i.e. what
> > > we
> > > > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> > > > eventually be used for the data interface in a multi-node setup.
> > > > Finally the vlan range was just arbitrarily chosen.
> > > >
> > > > Other than that, there isn't anything else modified other than 
> > > > following instructions of the getting started guide.  However 
> > > > for both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some 
> > > > mods that needed to take place like disabling apparmor, 
> > > > symlinking /var/run/openstack, and fixing ovs-dpdk-init
> > > > script) result in the following error message in q-agt:
> > > >
> > > > Traceback (most recent call last):
> > > >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
> > > >     sys.exit(main())
> > > >   File "/usr/lib/python2.7/site-
> > > >
> > packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> > > > line 20, in main
> > > >     agent_main.main()
> > > >   File "/usr/lib/python2.7/site- 
> > > > packages/networking_ovs_dpdk/agent/main.py", line 43, in main
> > > >     mod = importutils.import_module(mod_name)
> > > >   File
> > > > "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",
> > > > line 57, in import_module
> > > >     __import__(import_str)
> > > >   File "/usr/lib/python2.7/site-
> > > >
> > >
> >
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> > > > line 17, in <module>
> > > >     from networking_ovs_dpdk.agent import ovs_dpdk_neutron_agent
> > > >   File "/usr/lib/python2.7/site- 
> > > > packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",
> > > line
> > > > 47, in <module>
> > > >     from neutron.plugins.ml2.drivers.openvswitch.agent import 
> > > > ovs_dvr_neutron_agent
> > > >   File
> > > >
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> > > > dvr_neutron_agent.py", line 29, in <module>
> > > >     cfg.CONF.import_group('AGENT', 
> > > > 'neutron.plugins.ml2.drivers.openvswitch.'
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 2088, in import_group
> > > >     __import__(module_str)
> > > >   File
> > > >
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> > > > mon/config.py", line 111, in <module>
> > > >     cfg.CONF.register_opts(ovs_opts, "OVS")
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 1824, in __inner
> > > >     result = f(self, *args, **kwargs)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 1983, in register_opts
> > > >     self.register_opt(opt, group, clear_cache=False)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 1828, in __inner
> > > >     return f(self, *args, **kwargs)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 1967, in register_opt
> > > >     return group._register_opt(opt, cli)
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 1345, in _register_opt
> > > >     if _is_opt_registered(self._opts, opt):
> > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py", 
> > > > line 574, in _is_opt_registered
> > > >     raise DuplicateOptError(opt.name)
> > > > oslo_config.cfg.DuplicateOptError: duplicate option: 
> > > > of_interface q-agt failed to start
> > > >
> > > > I thought this error message was just because Ubuntu 
> > > > testing/support hasn't been fleshed out yet with ovs-dpdk, but 
> > > > then I got the exact same error on Fedora 21.  I tried editing 
> > > > both
> > > >
> > >
> >
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> > > > on/config.py and /opt/stack/networking-ovs- 
> > > > dpdk/networking_ovs_dpdk/common/config.py to get past the error,
> > but
> > > > then there are complaints about not finding br-int... So I'm 
> > > > guessing that isn't the correct workaround.  Anyone have any 
> > > > suggestions of what I might have misconfigured?
> > > >
> > > > Thank you for your help!
> > > > Gabriel Black
> > > >
> > >
> > > _______________________________________________
> > > discuss mailing list
> > > discuss at openvswitch.org
> > > http://openvswitch.org/mailman/listinfo/discuss

From Gabe.Black at viavisolutions.com  Wed Aug 26 12:51:52 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Wed, 26 Aug 2015 19:51:52 +0000
Subject: [ovs-discuss] duplicate option: of_interface
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>  
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC5F9AF@AMEXMB01.ds.jdsu.net>

K, tracked it down to neutron/agent/common/ovs_lib.py:151

Datapath_type has a default value of OVS_DATAPATH_SYSTEM.  I'm guessing somewhere someone created an instance of the object without passing in the datapath_type variable from config.

Anyway, changing that to OVS_DATAPATH_NETDEV got rid of the br-int errors...

It didn't, however get dhcp, ping, or anything else networking related to work on the vm;  Even when I statically assign the IP addresses (matching what the connected ports say they should be), I don't even see the ifconfig stats change.

ps aux | grep  qemu shows this line for one of the qemu's:
/usr/bin/qemu-system-x86_64 -name instance-00000003 -S -machine pc-i440fx-utopic,accel=kvm,usb=off -m 2048 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -object memory-backend-file,prealloc=yes,mem-path=/dev/hugepages/libvirt/qemu,share=on,size=2048M,id=ram-node0,host-nodes=0,policy=bind,share=on -numa node,nodeid=0,cpus=0,memdev=ram-node0 -uuid c1e511c9-216a-4248-a2cf-7f08d61dbcc8 -smbios type=1,manufacturer=OpenStack Foundation,product=OpenStack Nova,version=12.0.0,serial=be47d935-9390-b631-e0a7-e6ad55dde37f,uuid=c1e511c9-216a-4248-a2cf-7f08d61dbcc8,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/instance-00000003.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=discard -no-hpet -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/disk,if=none,id=drive-virtio-disk0,format=qcow2,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/disk.config,if=none,id=drive-ide0-1-1,readonly=on,format=raw,cache=none -device ide-cd,bus=ide.1,unit=1,drive=drive-ide0-1-1,id=ide0-1-1 -chardev socket,id=charnet0,path=/var/run/openvswitch/vhu3272d0ab-f3 -netdev type=vhost-user,id=hostnet0,chardev=charnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:82:61:6c,bus=pci.0,addr=0x3 -chardev socket,id=charnet1,path=/var/run/openvswitch/vhuea352081-64 -netdev type=vhost-user,id=hostnet1,chardev=charnet1 -device virtio-net-pci,netdev=hostnet1,id=net1,mac=fa:16:3e:d7:6c:17,bus=pci.0,addr=0x4 -chardev file,id=charserial0,path=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -vnc 127.0.0.1:1 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on

Osv-ofctl dump-ports br-int doesn't have any stats that change...
  port 16: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
           tx pkts=0, bytes=?, drop=0, errs=?, coll=?
  port LOCAL: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=18, bytes=1538, drop=0, errs=0, coll=0
  port  5: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=18, bytes=1486, drop=0, errs=0, coll=0
  port 15: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
...



> -----Original Message-----
> From: Gabe Black
> Sent: Wednesday, August 26, 2015 12:43 PM
> To: 'Mooney, Sean K'; 'bugs at openvswitch.org'
> Subject: RE: duplicate option: of_interface
> 
> Interesting... it seems that the ovs-vsctl set bridge br-int
> datapath_type=netdev does take, but very soon after it is changed back to
> system.  I'll try and figure out how that is happening.
> 
> Gabe
> 
> > -----Original Message-----
> > From: Gabe Black
> > Sent: Wednesday, August 26, 2015 12:42 PM
> > To: 'Mooney, Sean K'; bugs at openvswitch.org
> > Subject: RE: duplicate option: of_interface
> >
> > Hi Sean,
> >
> > Yes, I did have the OVS_DATAPATH_TYPE set to netdev.  Even after
> > setting the [ovs] datapath_type=netdev and trying to manually set the
> > datapath_type to netdev (ovs-vsctl set Bridge br-int
> > datapath_type=netdev), the br-int still shows system.
> >
> > The interesting thing is that the other bridges (br-ex and br-p6p1 are
> > set to netdev (automatically during stacking), but just br-int is
> > system and immutable it seems via manual ovs-vsctl commands).
> >
> > I'll keep playing around and see if there is some way to reconcile.
> >
> > Thanks,
> > Gabe
> >
> > > -----Original Message-----
> > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > > Sent: Wednesday, August 26, 2015 5:12 AM
> > > To: Gabe Black; bugs at openvswitch.org
> > > Subject: RE: duplicate option: of_interface
> > >
> > > I know the feeling. I think your horizon issue can be fixed by
> > > Running sudo iptables -F sudo iptables -X iptables based security
> > > groups do not work with vhost-user so this will have no effect on vm
> > > security
> > >
> > > I think the ovs-ofctl: br-int is not a bridge or a socket error is
> > > because the datapath_type on the bridge is not currently set to netdev.
> > >
> > > Looking at your previous error I noticed the follow command the
> > > datapath_type is being set to system.
> > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge',
> > > > 'br-int', 'datapath_type=system']
> > >
> > >
> > > I think the reason the bridge does not exists is because it has the
> > > wrong datapath type.
> > > You can validate this by running
> > > sudo ovs-vsctl list-br
> > >
> > > when using kernel ovs the output will be similar to this
> > >
> > > _uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa
> > > controller          : []
> > > datapath_id         : "0000b24fc650f940"
> > > datapath_type       : system
> > > external_ids        : {bridge-id=br-int}
> > > fail_mode           : secure
> > > flood_vlans         : []
> > > flow_tables         : {}
> > > ipfix               : []
> > > mirrors             : []
> > > name                : br-int
> > > netflow             : []
> > > other_config        : {}
> > > ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-
> > 47c1-
> > > 874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5,
> > > e1a7ef91-53a4- 4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-
> > bb68a6c132c4]
> > > protocols           : ["OpenFlow10"]
> > > sflow               : []
> > > status              : {}
> > > stp_enable          : false
> > >
> > > when using ovs with dpdk the datapath_type  should be netdev.
> > >
> > > If it is currently system and assuming you have
> > > OVS_DATAPATH_TYPE=netdev set in your local.conf this could be
> > > caused, as one of my patches to neutron merged Saturday and we have
> > > not updated our deployment code To add the appropriate configuration.
> > >
> >
> https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb4675148
> > > 9a52665e673a5cb0b
> > >
> > >
> > > If you add
> > > [ovs]
> > > datapath_type = netdev
> > > to the ml2_conf.ini the q-agt will configure the dpdk netdev
> > > datapath instead of the system kernel datapath.
> > >
> > > For your running system you can run the following commands to set
> > > the datapath
> > >
> > > sudo ovs-vsctl set bridge <bridge name> datapath=netdev.
> > >
> > > This should be run for all ovs bridges.
> > >
> > > On huge table memory as the system is left running main memory gets
> > > fragment.
> > > when you start ovs with our service file it allocates hugempage
> > > memory in the kernel from the current free memory.
> > >
> > > When you compile dpdk there is a hugepage segment limit of 256
> segment.
> > > If the dpdk application cannot allocated its hugepage memory in less
> > > segment then this limit the application will exit.
> > > You can adjust this limit by setting
> OVS_DPDK_MEM_SEGMENTS=<value>
> > in
> > > your local.conf The more often you stack and unstack between reboots
> > > the more fragmented your memory will be so for development I tend to
> > > set the OVS_DPDK_MEM_SEGMENTS quite high.
> > >
> > > Regards
> > > Sean.
> > > -----Original Message-----
> > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > > Sent: Tuesday, August 25, 2015 9:45 PM
> > > To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org
> > > Subject: RE: duplicate option: of_interface
> > >
> > > Sorry, that was premature.  Apparently hugetable memory gets
> > > fragmented or leaks or something as the ovs-dpdk failed to start.
> > Rebooting fixed that.
> > >
> > > I still get many errors in the q-agt log file similar to this:
> > > ERROR neutron.agent.linux.utils [-]
> > > Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1
> > > Stdin:
> > > hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,actions=
> > > no
> > > r
> > > mal
> > > Stdout:
> > > Stderr: ovs-ofctl: br-int is not a bridge or a socket
> > >
> > > and
> > >
> > > ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-
> > > d29e450eda38 None None] Unable to execute ['ovs-ofctl',
> > > 'dump-flows',
> > > 'br- int', 'table=23']. Exception:
> > > Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code:
> > > 1
> > > Stdin:
> > > Stdout:
> > > Stderr: ovs-ofctl: br-int is not a bridge or a socket
> > >
> > > But at least q-agt isn't dying.  I remember why I hate fedora though..
> > > Even though horizon says it is running and we turned the firewall to
> > > permissive, I can never access the website.  Seems like something
> > > else is protecting or acting as a firewall.
> > >
> > >
> > >
> > > > -----Original Message-----
> > > > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf
> > > > Of Gabe Black
> > > > Sent: Tuesday, August 25, 2015 2:06 PM
> > > > To: Mooney, Sean K; bugs at openvswitch.org
> > > > Subject: Re: [ovs-discuss] duplicate option: of_interface
> > > >
> > > > Thanks for the reply and hints on changes...  Armed with that I
> > > > undid the changes from git commit 053bfc5a (neutron) and that
> > > > allowed the q-agt process to at least not die there with that
> > > > callstack.  The commit message seemed to indicate it was for
> > > > better restarting/cleanup; so I hope it is relatively low impact to back
> out.
> > > >
> > > > However, it now dies because it is still unable to create the br-int
> bridge:
> > > >
> > > > Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline',
> > > > '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--',
> > > > 'set', 'Bridge', 'br-int', 'datapath_type=system'].
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > > Traceback (most recent call last):
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > > > "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63,
> > > > in run_vsctl
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > > log_fail_as_error=False).rstrip()
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File
> > > > "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in
> execute
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise
> > > > RuntimeError(m)
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > > RuntimeError:
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > Command:
> > > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',
> > > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge',
> > > > 'br-int', 'datapath_type=system']
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Exit
> > > > code: -14
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr:
> > > > 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with
> > > > signal
> > > > 14 (Alarm
> > > > clock)
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl
> > > >
> > > > I noticed a difference between a multi-node setup and a single
> > > > node, where multi-node's controller has openvswitch and ovsdpdk
> > > > for the Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related
> to that?
> > Or
> > > > should it be trying to create br-int as datapath_type netdev instead?
> > > > Just throwing things out there because I'm ignorant :-)  I'll try
> > > > variations of that in hopes I get lucky.
> > > >
> > > >
> > > > Gabe
> > > >
> > > >
> > > >
> > > > > -----Original Message-----
> > > > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
> > > > > Sent: Tuesday, August 25, 2015 1:30 PM
> > > > > To: Gabe Black; bugs at openvswitch.org
> > > > > Subject: RE: duplicate option: of_interface
> > > > >
> > > > > Hi Gabe
> > > > > We have started to see that message in our ci since this weekend.
> > > > > We are currently investigating it but I belive a change has
> > > > > merged to neuton that we need to back port to Our agent.
> > > > >
> > > > > A lot of code has merged in the last 2 weeks as the code freeze
> > > > > for the liberty release is moday.
> > > > > The stable kilo branch should be unaffected but we are actively
> > > > > looking into this at present.
> > > > >
> > > > > Regards
> > > > > Sean.
> > > > >
> > > > >
> > > > > -----Original Message-----
> > > > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
> > > > > Sent: Tuesday, August 25, 2015 7:50 PM
> > > > > To: bugs at openvswitch.org
> > > > > Cc: Mooney, Sean K
> > > > > Subject: duplicate option: of_interface
> > > > >
> > > > > I have followed the getting started guide
> > > > > (http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > > > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and
> > > > > Ubuntu
> > > > > 15.04 to get a single-node set up with dpdk ovs.
> > > > >
> > > > > My local.conf file is identical to the one provided as the
> > > > > single node
> > > > template:
> > > > > http://git.openstack.org/cgit/stackforge/networking-ovs-
> > > > > dpdk/tree/doc/source/_downloads/local.conf.single_node
> > > > >
> > > > > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,
> > > > > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and
> > > > > ML2_VLAN_RANGES=default:1000:1010
> > > > >
> > > > > eno1 and associated IP is the interface/ip address of the server
> > > > > (i.e. what
> > > > we
> > > > > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will
> > > > > eventually be used for the data interface in a multi-node setup.
> > > > > Finally the vlan range was just arbitrarily chosen.
> > > > >
> > > > > Other than that, there isn't anything else modified other than
> > > > > following instructions of the getting started guide.  However
> > > > > for both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some
> > > > > mods that needed to take place like disabling apparmor,
> > > > > symlinking /var/run/openstack, and fixing ovs-dpdk-init
> > > > > script) result in the following error message in q-agt:
> > > > >
> > > > > Traceback (most recent call last):
> > > > >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>
> > > > >     sys.exit(main())
> > > > >   File "/usr/lib/python2.7/site-
> > > > >
> > >
> packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",
> > > > > line 20, in main
> > > > >     agent_main.main()
> > > > >   File "/usr/lib/python2.7/site-
> > > > > packages/networking_ovs_dpdk/agent/main.py", line 43, in main
> > > > >     mod = importutils.import_module(mod_name)
> > > > >   File
> > > > > "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",
> > > > > line 57, in import_module
> > > > >     __import__(import_str)
> > > > >   File "/usr/lib/python2.7/site-
> > > > >
> > > >
> > >
> >
> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",
> > > > > line 17, in <module>
> > > > >     from networking_ovs_dpdk.agent import
> ovs_dpdk_neutron_agent
> > > > >   File "/usr/lib/python2.7/site-
> > > > >
> packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",
> > > > line
> > > > > 47, in <module>
> > > > >     from neutron.plugins.ml2.drivers.openvswitch.agent import
> > > > > ovs_dvr_neutron_agent
> > > > >   File
> > > > >
> > > >
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_
> > > > > dvr_neutron_agent.py", line 29, in <module>
> > > > >     cfg.CONF.import_group('AGENT',
> > > > > 'neutron.plugins.ml2.drivers.openvswitch.'
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 2088, in import_group
> > > > >     __import__(module_str)
> > > > >   File
> > > > >
> > > >
> > >
> >
> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com
> > > > > mon/config.py", line 111, in <module>
> > > > >     cfg.CONF.register_opts(ovs_opts, "OVS")
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 1824, in __inner
> > > > >     result = f(self, *args, **kwargs)
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 1983, in register_opts
> > > > >     self.register_opt(opt, group, clear_cache=False)
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 1828, in __inner
> > > > >     return f(self, *args, **kwargs)
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 1967, in register_opt
> > > > >     return group._register_opt(opt, cli)
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 1345, in _register_opt
> > > > >     if _is_opt_registered(self._opts, opt):
> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",
> > > > > line 574, in _is_opt_registered
> > > > >     raise DuplicateOptError(opt.name)
> > > > > oslo_config.cfg.DuplicateOptError: duplicate option:
> > > > > of_interface q-agt failed to start
> > > > >
> > > > > I thought this error message was just because Ubuntu
> > > > > testing/support hasn't been fleshed out yet with ovs-dpdk, but
> > > > > then I got the exact same error on Fedora 21.  I tried editing
> > > > > both
> > > > >
> > > >
> > >
> >
> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm
> > > > > on/config.py and /opt/stack/networking-ovs-
> > > > > dpdk/networking_ovs_dpdk/common/config.py to get past the
> error,
> > > but
> > > > > then there are complaints about not finding br-int... So I'm
> > > > > guessing that isn't the correct workaround.  Anyone have any
> > > > > suggestions of what I might have misconfigured?
> > > > >
> > > > > Thank you for your help!
> > > > > Gabriel Black
> > > > >
> > > >
> > > > _______________________________________________
> > > > discuss mailing list
> > > > discuss at openvswitch.org
> > > > http://openvswitch.org/mailman/listinfo/discuss

From fbl at redhat.com  Wed Aug 26 16:19:59 2015
From: fbl at redhat.com (Flavio Leitner)
Date: Wed, 26 Aug 2015 20:19:59 -0300
Subject: [ovs-discuss] openvswitch install on centos 6.6 issue
In-Reply-To: <CAEP_g=8RGnRy82VpsMy-zjVjZBxmfp-QkogDxCLN5p3AwTk2Uw@mail.gmail.com>
References: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>
 <CAHbON5pqG=zqZKbFJjWZ4sFxqYuJwNtW4ptmHTYATJywf-+pCA@mail.gmail.com>
 <570c3c32-7580-4e38-af7a-681196ae4f1f@getmailbird.com>
 <CAHbON5o=jYcWLQUXiq3Zj9EdCHwb1e97_1i4-Q2HzfGBSp0CAw@mail.gmail.com>
 <CAEP_g=8RGnRy82VpsMy-zjVjZBxmfp-QkogDxCLN5p3AwTk2Uw@mail.gmail.com>
Message-ID: <20150826231959.GI2353@x240.home>

On Tue, Aug 25, 2015 at 04:40:29PM -0700, Jesse Gross wrote:
> Flavio, there's been a few reports of compilation problems on
> RHEL/Centos 6. Would it be possible for you to take a look?

Yup, I will look into this.
fbl


> 
> On Fri, Aug 21, 2015 at 12:09 PM, Gurucharan Shetty <shettyg at nicira.com> wrote:
> > Okay, then I was wrong about branch 2.4 supporting Centos 6.6. I have
> > CC'd a couple of Kernel developers that will know the correct answer.
> >
> > On Fri, Aug 21, 2015 at 12:03 PM, ShapeHost <contact at shape.host> wrote:
> >> Hello,
> >>
> >>     Thanks for the information, i tested the new 2.4. and i have the same
> >> problem. :(
> >>
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> warning: type defaults to 'int' in declaration of 'ret__'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> warning: type defaults to 'int' in declaration of 'ret__'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:987:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:999:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> error: invalid type argument of 'unary *' (have 'int')
> >> /root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.c:1006:
> >> warning: type defaults to 'int' in declaration of 'type name'
> >> make[2]: ***
> >> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/datapath.o]
> >> Error 1
> >> make[2]: ***
> >> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/actions.o]
> >> Error 1
> >> make[2]: ***
> >> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/vport-internal_dev.o]
> >> Error 1
> >> make[2]: ***
> >> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/flow_table.o]
> >> Error 1
> >> make[2]: ***
> >> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/flow_netlink.o]
> >> Error 1
> >> make[2]: ***
> >> [/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux/vport.o]
> >> Error 1
> >> make[1]: ***
> >> [_module_/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux]
> >> Error 2
> >> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
> >> make: *** [default] Error 2
> >> make: Leaving directory
> >> `/root/rpmbuild/BUILD/openvswitch-2.4.0/_default/datapath/linux'
> >> error: Bad exit status from /var/tmp/rpm-tmp.1mXVkX (%build)
> >>
> >>
> >> RPM build errors:
> >>     Bad exit status from /var/tmp/rpm-tmp.1mXVkX (%build)
> >> [root at ns509777 openvswitch-2.4.0]#
> >>
> >>
> >> Regards,
> >> Cristian
> >>
> >> Regards,
> >>
> >> ShapeHost
> >>
> >> www.istream.today
> >>
> >> www.shape.host
> >>
> >> +40.733.955.922
> >>
> >>
> >>
> >> On 8/21/2015 8:29:02 PM, Gurucharan Shetty <shettyg at nicira.com> wrote:
> >>
> >> On Fri, Aug 21, 2015 at 5:02 AM, ShapeHost wrote:
> >>> Hello,
> >>>
> >>> I have some problem with openvswitch install on centos 6.6
> >>> 2.6.32-573.3.1.el6.x86_64.
> >>>
> >>> I tried to install many version of OVS like 1.9.0, 1.9.3, 1.10.0, 2.1.1,
> >>> 2.3.0.
> >> From what I understand, Centos6.6 is not supported with 2.3
> >>
> >> It is likely that OVS 2.4 will be released today. It is likely that
> >> Centos6.6 is supported in that version. branch2.4 is already created,
> >> so you can try that too.
> >>
> >>
> >>>
> >>> Every time i have problems on this line :
> >>> --------------------------------------
> >>> Starting Line #
> >>> ---------------------------------------
> >>> #[root at ns509777 openvswitch-2.1.1]# rpmbuild -bb
> >>> rhel/openvswitch-kmod-rhel6.spec
> >>> Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.hWy71a
> >>> + umask 022
> >>> + cd /root/rpmbuild/BUILD
> >>> + LANG=C
> >>> + export LANG
> >>> + unset DISPLAY
> >>> + cd /root/rpmbuild/BUILD
> >>> + rm -rf openvswitch-2.1.1
> >>> + /usr/bin/gzip -dc /root/rpmbuild/SOURCES/openvswitch-2.1.1.tar.gz
> >>> + /bin/tar -xvvf -
> >>>
> >>> ---------------------------------------------------
> >>> and is ending with this :
> >>> --------------------------------------------------
> >>> from
> >>>
> >>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../compat.h:26,
> >>> from
> >>>
> >>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/../datapath.h:29,
> >>> from
> >>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.c:34:
> >>>
> >>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
> >>> error: redefinition of 'ip_is_fragment'
> >>> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was
> >>> here
> >>> make[2]: ***
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow.o]
> >>> Error 1
> >>> make[2]: *** Waiting for unfinished jobs....
> >>> In file included from include/net/xfrm.h:18,
> >>> from
> >>>
> >>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.c:39:
> >>>
> >>> /root/rpmbuild/BUILD/openvswitch-2.1.1/_default/../datapath/linux/compat/include/net/ip.h:9:
> >>> error: redefinition of 'ip_is_fragment'
> >>> include/net/ip.h:249: note: previous definition of 'ip_is_fragment' was
> >>> here
> >>> make[2]: ***
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport.o]
> >>> Error 1
> >>> make[2]: ***
> >>>
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/dp_notify.o]
> >>> Error 1
> >>> make[2]: ***
> >>>
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/datapath.o]
> >>> Error 1
> >>> make[2]: ***
> >>>
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_netlink.o]
> >>> Error 1
> >>> make[2]: ***
> >>>
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/vport-gre.o]
> >>> Error 1
> >>> make[2]: ***
> >>>
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/flow_table.o]
> >>> Error 1
> >>> make[2]: ***
> >>> [/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux/actions.o]
> >>> Error 1
> >>> make[1]: ***
> >>> [_module_/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux]
> >>> Error 2
> >>> make[1]: Leaving directory `/usr/src/kernels/2.6.32-573.3.1.el6.x86_64'
> >>> make: *** [default] Error 2
> >>> make: Leaving directory
> >>> `/root/rpmbuild/BUILD/openvswitch-2.1.1/_default/datapath/linux'
> >>> error: Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
> >>>
> >>>
> >>> RPM build errors:
> >>> Bad exit status from /var/tmp/rpm-tmp.nnTlyL (%build)
> >>>
> >>>
> >>> -----------------------------------------------
> >>>
> >>> I'm going crazy :)) i'm not sure how to fix this, can i get some help ?
> >>>
> >>>
> >>>
> >>>
> >>>
> >>> Regards,
> >>>
> >>> Cristian
> >>>
> >>>
> >>>
> >>>
> >>>
> >>> _______________________________________________
> >>> discuss mailing list
> >>> discuss at openvswitch.org
> >>> http://openvswitch.org/mailman/listinfo/discuss
> >>>
> 

From sean.k.mooney at intel.com  Thu Aug 27 02:52:47 2015
From: sean.k.mooney at intel.com (Mooney, Sean K)
Date: Thu, 27 Aug 2015 09:52:47 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC5F9AF@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5F9AF@AMEXMB01.ds.jdsu.net>
Message-ID: <4B1BB321037C0849AAE171801564DFA645178741@IRSMSX107.ger.corp.intel.com>

Hi gabe

Thank I know what the error is.



As part of the change I upstreamed to neutron I made the following change to the

Standard ovs neuton agent that I have not backported to our ovs-dpdk agent



import time

import uuid

+import functools

import netaddr

from oslo_config import cfg

from oslo_log import log as logging

@@ -173,9 +174,14 @@ def __init__(self, bridge_classes, integ_br, tun_br, local_ip,

         :param conf: an instance of ConfigOpts

         '''

         super(OVSNeutronAgent, self).__init__()

-        self.br_int_cls = bridge_classes['br_int']

-        self.br_phys_cls = bridge_classes['br_phys']

-        self.br_tun_cls = bridge_classes['br_tun']

+        self.conf = conf or cfg.CONF

+

+        # init bridge classes with configured datapath type.

+        self.br_int_cls, self.br_phys_cls, self.br_tun_cls = (

+            functools.partial(bridge_classes[b],

+                              datapath_type=self.conf.OVS.datapath_type)

+            for b in ('br_int', 'br_phys', 'br_tun'))

+

         self.use_veth_interconnection = use_veth_interconnection

         self.veth_mtu = veth_mtu

         self.available_local_vlans = set(moves.range(p_const.MIN_VLAN_TAG,

@@ -188,7 +194,6 @@ def __init__(self, bridge_classes, integ_br, tun_br, local_ip,

         self.enable_distributed_routing = enable_distributed_routing

         self.arp_responder_enabled = arp_responder and self.l2_pop

         self.prevent_arp_spoofing = prevent_arp_spoofing

-        self.conf = conf or cfg.CONF

         self.agent_state = {

             'binary': 'neutron-openvswitch-agent',



As a result our current agent does not read the config value and reverts to the default system datapath.



I will open a bug for this change and release a patch to fix it later today to our networking-ovs-dpdk repo.



Regards

Sean.



-----Original Message-----
From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 26, 2015 8:52 PM
To: Mooney, Sean K; bugs at openvswitch.org
Subject: RE: duplicate option: of_interface



K, tracked it down to neutron/agent/common/ovs_lib.py:151



Datapath_type has a default value of OVS_DATAPATH_SYSTEM.  I'm guessing somewhere someone created an instance of the object without passing in the datapath_type variable from config.



Anyway, changing that to OVS_DATAPATH_NETDEV got rid of the br-int errors...



It didn't, however get dhcp, ping, or anything else networking related to work on the vm;  Even when I statically assign the IP addresses (matching what the connected ports say they should be), I don't even see the ifconfig stats change.



ps aux | grep  qemu shows this line for one of the qemu's:

/usr/bin/qemu-system-x86_64 -name instance-00000003 -S -machine pc-i440fx-utopic,accel=kvm,usb=off -m 2048 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -object memory-backend-file,prealloc=yes,mem-path=/dev/hugepages/libvirt/qemu,share=on,size=2048M,id=ram-node0,host-nodes=0,policy=bind,share=on -numa node,nodeid=0,cpus=0,memdev=ram-node0 -uuid c1e511c9-216a-4248-a2cf-7f08d61dbcc8 -smbios type=1,manufacturer=OpenStack Foundation,product=OpenStack Nova,version=12.0.0,serial=be47d935-9390-b631-e0a7-e6ad55dde37f,uuid=c1e511c9-216a-4248-a2cf-7f08d61dbcc8,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/instance-00000003.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=discard -no-hpet -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/disk,if=none,id=drive-virtio-disk0,format=qcow2,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/disk.config,if=none,id=drive-ide0-1-1,readonly=on,format=raw,cache=none -device ide-cd,bus=ide.1,unit=1,drive=drive-ide0-1-1,id=ide0-1-1 -chardev socket,id=charnet0,path=/var/run/openvswitch/vhu3272d0ab-f3 -netdev type=vhost-user,id=hostnet0,chardev=charnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:82:61:6c,bus=pci.0,addr=0x3 -chardev socket,id=charnet1,path=/var/run/openvswitch/vhuea352081-64 -netdev type=vhost-user,id=hostnet1,chardev=charnet1 -device virtio-net-pci,netdev=hostnet1,id=net1,mac=fa:16:3e:d7:6c:17,bus=pci.0,addr=0x4 -chardev file,id=charserial0,path=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -vnc 127.0.0.1:1 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on



Osv-ofctl dump-ports br-int doesn't have any stats that change...

  port 16: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?

           tx pkts=0, bytes=?, drop=0, errs=?, coll=?

  port LOCAL: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0

           tx pkts=18, bytes=1538, drop=0, errs=0, coll=0

  port  5: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0

           tx pkts=18, bytes=1486, drop=0, errs=0, coll=0

  port 15: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?

...







> -----Original Message-----

> From: Gabe Black

> Sent: Wednesday, August 26, 2015 12:43 PM

> To: 'Mooney, Sean K'; 'bugs at openvswitch.org'

> Subject: RE: duplicate option: of_interface

>

> Interesting... it seems that the ovs-vsctl set bridge br-int

> datapath_type=netdev does take, but very soon after it is changed back

> to system.  I'll try and figure out how that is happening.

>

> Gabe

>

> > -----Original Message-----

> > From: Gabe Black

> > Sent: Wednesday, August 26, 2015 12:42 PM

> > To: 'Mooney, Sean K'; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > Subject: RE: duplicate option: of_interface

> >

> > Hi Sean,

> >

> > Yes, I did have the OVS_DATAPATH_TYPE set to netdev.  Even after

> > setting the [ovs] datapath_type=netdev and trying to manually set

> > the datapath_type to netdev (ovs-vsctl set Bridge br-int

> > datapath_type=netdev), the br-int still shows system.

> >

> > The interesting thing is that the other bridges (br-ex and br-p6p1

> > are set to netdev (automatically during stacking), but just br-int

> > is system and immutable it seems via manual ovs-vsctl commands).

> >

> > I'll keep playing around and see if there is some way to reconcile.

> >

> > Thanks,

> > Gabe

> >

> > > -----Original Message-----

> > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]

> > > Sent: Wednesday, August 26, 2015 5:12 AM

> > > To: Gabe Black; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > Subject: RE: duplicate option: of_interface

> > >

> > > I know the feeling. I think your horizon issue can be fixed by

> > > Running sudo iptables -F sudo iptables -X iptables based security

> > > groups do not work with vhost-user so this will have no effect on

> > > vm security

> > >

> > > I think the ovs-ofctl: br-int is not a bridge or a socket error is

> > > because the datapath_type on the bridge is not currently set to netdev.

> > >

> > > Looking at your previous error I noticed the follow command the

> > > datapath_type is being set to system.

> > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',

> > > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge',

> > > > 'br-int', 'datapath_type=system']

> > >

> > >

> > > I think the reason the bridge does not exists is because it has

> > > the wrong datapath type.

> > > You can validate this by running

> > > sudo ovs-vsctl list-br

> > >

> > > when using kernel ovs the output will be similar to this

> > >

> > > _uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa

> > > controller          : []

> > > datapath_id         : "0000b24fc650f940"

> > > datapath_type       : system

> > > external_ids        : {bridge-id=br-int}

> > > fail_mode           : secure

> > > flood_vlans         : []

> > > flow_tables         : {}

> > > ipfix               : []

> > > mirrors             : []

> > > name                : br-int

> > > netflow             : []

> > > other_config        : {}

> > > ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-

> > 47c1-

> > > 874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5,

> > > e1a7ef91-53a4- 4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-

> > bb68a6c132c4]

> > > protocols           : ["OpenFlow10"]

> > > sflow               : []

> > > status              : {}

> > > stp_enable          : false

> > >

> > > when using ovs with dpdk the datapath_type  should be netdev.

> > >

> > > If it is currently system and assuming you have

> > > OVS_DATAPATH_TYPE=netdev set in your local.conf this could be

> > > caused, as one of my patches to neutron merged Saturday and we

> > > have not updated our deployment code To add the appropriate configuration.

> > >

> >

> https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb4675148

> > > 9a52665e673a5cb0b

> > >

> > >

> > > If you add

> > > [ovs]

> > > datapath_type = netdev

> > > to the ml2_conf.ini the q-agt will configure the dpdk netdev

> > > datapath instead of the system kernel datapath.

> > >

> > > For your running system you can run the following commands to set

> > > the datapath

> > >

> > > sudo ovs-vsctl set bridge <bridge name> datapath=netdev.

> > >

> > > This should be run for all ovs bridges.

> > >

> > > On huge table memory as the system is left running main memory

> > > gets fragment.

> > > when you start ovs with our service file it allocates hugempage

> > > memory in the kernel from the current free memory.

> > >

> > > When you compile dpdk there is a hugepage segment limit of 256

> segment.

> > > If the dpdk application cannot allocated its hugepage memory in

> > > less segment then this limit the application will exit.

> > > You can adjust this limit by setting

> OVS_DPDK_MEM_SEGMENTS=<value>

> > in

> > > your local.conf The more often you stack and unstack between

> > > reboots the more fragmented your memory will be so for development

> > > I tend to set the OVS_DPDK_MEM_SEGMENTS quite high.

> > >

> > > Regards

> > > Sean.

> > > -----Original Message-----

> > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

> > > Sent: Tuesday, August 25, 2015 9:45 PM

> > > To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > Subject: RE: duplicate option: of_interface

> > >

> > > Sorry, that was premature.  Apparently hugetable memory gets

> > > fragmented or leaks or something as the ovs-dpdk failed to start.

> > Rebooting fixed that.

> > >

> > > I still get many errors in the q-agt log file similar to this:

> > > ERROR neutron.agent.linux.utils [-]

> > > Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1

> > > Stdin:

> > > hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,action

> > > s=

> > > no

> > > r

> > > mal

> > > Stdout:

> > > Stderr: ovs-ofctl: br-int is not a bridge or a socket

> > >

> > > and

> > >

> > > ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-

> > > d29e450eda38 None None] Unable to execute ['ovs-ofctl',

> > > 'dump-flows',

> > > 'br- int', 'table=23']. Exception:

> > > Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code:

> > > 1

> > > Stdin:

> > > Stdout:

> > > Stderr: ovs-ofctl: br-int is not a bridge or a socket

> > >

> > > But at least q-agt isn't dying.  I remember why I hate fedora though..

> > > Even though horizon says it is running and we turned the firewall

> > > to permissive, I can never access the website.  Seems like

> > > something else is protecting or acting as a firewall.

> > >

> > >

> > >

> > > > -----Original Message-----

> > > > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf

> > > > Of Gabe Black

> > > > Sent: Tuesday, August 25, 2015 2:06 PM

> > > > To: Mooney, Sean K; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > > Subject: Re: [ovs-discuss] duplicate option: of_interface

> > > >

> > > > Thanks for the reply and hints on changes...  Armed with that I

> > > > undid the changes from git commit 053bfc5a (neutron) and that

> > > > allowed the q-agt process to at least not die there with that

> > > > callstack.  The commit message seemed to indicate it was for

> > > > better restarting/cleanup; so I hope it is relatively low impact

> > > > to back

> out.

> > > >

> > > > However, it now dies because it is still unable to create the

> > > > br-int

> bridge:

> > > >

> > > > Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline',

> > > > '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--',

> > > > 'set', 'Bridge', 'br-int', 'datapath_type=system'].

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > Traceback (most recent call last):

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File

> > > > "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63,

> > > > in run_vsctl

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > log_fail_as_error=False).rstrip()

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File

> > > > "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in

> execute

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise

> > > > RuntimeError(m)

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > RuntimeError:

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > Command:

> > > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json',

> > > > '--', '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge',

> > > > 'br-int', 'datapath_type=system']

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > Exit

> > > > code: -14

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr:

> > > > 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with

> > > > signal

> > > > 14 (Alarm

> > > > clock)

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > >

> > > > I noticed a difference between a multi-node setup and a single

> > > > node, where multi-node's controller has openvswitch and ovsdpdk

> > > > for the Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related

> to that?

> > Or

> > > > should it be trying to create br-int as datapath_type netdev instead?

> > > > Just throwing things out there because I'm ignorant :-)  I'll

> > > > try variations of that in hopes I get lucky.

> > > >

> > > >

> > > > Gabe

> > > >

> > > >

> > > >

> > > > > -----Original Message-----

> > > > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]

> > > > > Sent: Tuesday, August 25, 2015 1:30 PM

> > > > > To: Gabe Black; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > > > Subject: RE: duplicate option: of_interface

> > > > >

> > > > > Hi Gabe

> > > > > We have started to see that message in our ci since this weekend.

> > > > > We are currently investigating it but I belive a change has

> > > > > merged to neuton that we need to back port to Our agent.

> > > > >

> > > > > A lot of code has merged in the last 2 weeks as the code

> > > > > freeze for the liberty release is moday.

> > > > > The stable kilo branch should be unaffected but we are

> > > > > actively looking into this at present.

> > > > >

> > > > > Regards

> > > > > Sean.

> > > > >

> > > > >

> > > > > -----Original Message-----

> > > > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

> > > > > Sent: Tuesday, August 25, 2015 7:50 PM

> > > > > To: bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > > > Cc: Mooney, Sean K

> > > > > Subject: duplicate option: of_interface

> > > > >

> > > > > I have followed the getting started guide

> > > > > (http://git.openstack.org/cgit/stackforge/networking-ovs-

> > > > > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and

> > > > > Ubuntu

> > > > > 15.04 to get a single-node set up with dpdk ovs.

> > > > >

> > > > > My local.conf file is identical to the one provided as the

> > > > > single node

> > > > template:

> > > > > http://git.openstack.org/cgit/stackforge/networking-ovs-

> > > > > dpdk/tree/doc/source/_downloads/local.conf.single_node

> > > > >

> > > > > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,

> > > > > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and

> > > > > ML2_VLAN_RANGES=default:1000:1010

> > > > >

> > > > > eno1 and associated IP is the interface/ip address of the

> > > > > server (i.e. what

> > > > we

> > > > > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will

> > > > > eventually be used for the data interface in a multi-node setup.

> > > > > Finally the vlan range was just arbitrarily chosen.

> > > > >

> > > > > Other than that, there isn't anything else modified other than

> > > > > following instructions of the getting started guide.  However

> > > > > for both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some

> > > > > mods that needed to take place like disabling apparmor,

> > > > > symlinking /var/run/openstack, and fixing ovs-dpdk-init

> > > > > script) result in the following error message in q-agt:

> > > > >

> > > > > Traceback (most recent call last):

> > > > >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>

> > > > >     sys.exit(main())

> > > > >   File "/usr/lib/python2.7/site-

> > > > >

> > >

> packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",

> > > > > line 20, in main

> > > > >     agent_main.main()

> > > > >   File "/usr/lib/python2.7/site-

> > > > > packages/networking_ovs_dpdk/agent/main.py", line 43, in main

> > > > >     mod = importutils.import_module(mod_name)

> > > > >   File

> > > > > "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",

> > > > > line 57, in import_module

> > > > >     __import__(import_str)

> > > > >   File "/usr/lib/python2.7/site-

> > > > >

> > > >

> > >

> >

> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",

> > > > > line 17, in <module>

> > > > >     from networking_ovs_dpdk.agent import

> ovs_dpdk_neutron_agent

> > > > >   File "/usr/lib/python2.7/site-

> > > > >

> packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",

> > > > line

> > > > > 47, in <module>

> > > > >     from neutron.plugins.ml2.drivers.openvswitch.agent import

> > > > > ovs_dvr_neutron_agent

> > > > >   File

> > > > >

> > > >

> > >

> >

> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_

> > > > > dvr_neutron_agent.py", line 29, in <module>

> > > > >     cfg.CONF.import_group('AGENT',

> > > > > 'neutron.plugins.ml2.drivers.openvswitch.'

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 2088, in import_group

> > > > >     __import__(module_str)

> > > > >   File

> > > > >

> > > >

> > >

> >

> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com

> > > > > mon/config.py", line 111, in <module>

> > > > >     cfg.CONF.register_opts(ovs_opts, "OVS")

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1824, in __inner

> > > > >     result = f(self, *args, **kwargs)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1983, in register_opts

> > > > >     self.register_opt(opt, group, clear_cache=False)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1828, in __inner

> > > > >     return f(self, *args, **kwargs)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1967, in register_opt

> > > > >     return group._register_opt(opt, cli)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1345, in _register_opt

> > > > >     if _is_opt_registered(self._opts, opt):

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 574, in _is_opt_registered

> > > > >     raise DuplicateOptError(opt.name)

> > > > > oslo_config.cfg.DuplicateOptError: duplicate option:

> > > > > of_interface q-agt failed to start

> > > > >

> > > > > I thought this error message was just because Ubuntu

> > > > > testing/support hasn't been fleshed out yet with ovs-dpdk, but

> > > > > then I got the exact same error on Fedora 21.  I tried editing

> > > > > both

> > > > >

> > > >

> > >

> >

> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm

> > > > > on/config.py and /opt/stack/networking-ovs-

> > > > > dpdk/networking_ovs_dpdk/common/config.py to get past the

> error,

> > > but

> > > > > then there are complaints about not finding br-int... So I'm

> > > > > guessing that isn't the correct workaround.  Anyone have any

> > > > > suggestions of what I might have misconfigured?

> > > > >

> > > > > Thank you for your help!

> > > > > Gabriel Black

> > > > >

> > > >

> > > > _______________________________________________

> > > > discuss mailing list

> > > > discuss at openvswitch.org<mailto:discuss at openvswitch.org>

> > > > http://openvswitch.org/mailman/listinfo/discuss
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150827/df2addcb/attachment-0001.html>

From sugesh.chandran at intel.com  Thu Aug 27 03:12:34 2015
From: sugesh.chandran at intel.com (Chandran, Sugesh)
Date: Thu, 27 Aug 2015 10:12:34 +0000
Subject: [ovs-discuss] ovn: Handling of broadcast packets in OVN-Container
	underlay mode.
Message-ID: <2EF2F5C0CC56984AA024D0B180335FCB13C8C9D2@IRSMSX102.ger.corp.intel.com>

Hello OVN team,

I am trying out OVN-Container underlay setup manually.  I found an issue with forwarding ARP/broadcast packets between containers on different VMs in same logical network.
The integration bridge on the host puts VLAN ID of the container before forwarding the packet to the VM . The OVS inside the VM then forwards this packet to the right container interface using the VLANID.
However when a packet received with broadcast mac address, integration bridge forwards it as untagged to the VM. The OVS inside the VM drops this packet, because the container interface is designated to receive only tagged packets. ARP is failing because of ARP-request never reaches the destined Container.
Is there anything I missed out to configure for handling the container broadcast/ARP traffic??? 


Please find the logs below for the flow rule details programmed on the integration bridge(Unicast and Broadcast traffic). 

$  sudo /home/sugeshch/repo/ovs_dpdk/ovs_dpdk/utilities/ovs-appctl ofproto/trace br-int in_port=3,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_vlan=100 -generate
Bridge: br-int
Flow: in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000

Rule: table=0 cookie=0 priority=150,in_port=3,dl_vlan=100
OpenFlow actions=set_field:0x1->metadata,set_field:0x6->reg6,pop_vlan,resubmit(,16)

        Resubmitted flow: reg6=0x6,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
        Resubmitted  odp: drop
        Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
        Rule: table=16 cookie=0 priority=50,reg6=0x6,metadata=0x1
        OpenFlow actions=resubmit(,17)

                Resubmitted flow: unchanged
                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
                Resubmitted  odp: drop
                Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                Rule: table=17 cookie=0 priority=50,metadata=0x1,dl_dst=00:00:00:01:00:01
                OpenFlow actions=set_field:0x4->reg7,resubmit(,32)

                        Resubmitted flow: reg6=0x6,reg7=0x4,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
                        Resubmitted  odp: drop
                        Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                        Rule: table=32 cookie=0 priority=0
                        OpenFlow actions=resubmit(,33)

                                Resubmitted flow: unchanged
                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
                                Resubmitted  odp: drop
                                Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                                Rule: table=33 cookie=0 priority=100,reg7=0x4,metadata=0x1
                                OpenFlow actions=resubmit(,34)

                                        Resubmitted flow: unchanged
                                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
                                        Resubmitted  odp: drop
                                        Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                                        Rule: table=34 cookie=0 priority=0
                                        OpenFlow actions=set_field:0->reg0,set_field:0->reg1,set_field:0->reg2,set_field:0->reg3,set_field:0->reg4,set_field:0->reg5,resubmit(,48)

                                                Resubmitted flow: unchanged
                                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
                                                Resubmitted  odp: drop
                                                Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                                                Rule: table=48 cookie=0 priority=0,metadata=0x1
                                                OpenFlow actions=resubmit(,49)

                                                        Resubmitted flow: unchanged
                                                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
                                                        Resubmitted  odp: drop
                                                        Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                                                        Rule: table=49 cookie=0 priority=50,reg7=0x4,metadata=0x1
                                                        OpenFlow actions=resubmit(,64)

                                                                Resubmitted flow: unchanged
                                                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
                                                                Resubmitted  odp: drop
                                                                Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
                                                                Rule: table=64 cookie=0 priority=100,reg7=0x4,metadata=0x1
                                                                OpenFlow actions=push_vlan:0x8100,set_field:4196->vlan_vid,push:NXM_OF_IN_PORT[],set_field:0->in_port,output:2,pop_vlan,pop:NXM_OF_IN_PORT[]

Final flow: reg6=0x6,reg7=0x4,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
Megaflow: recirc_id=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
Datapath actions: 5   → VLAN tags present when forwarding to the VM. 





$  sudo /home/sugeshch/repo/ovs_dpdk/ovs_dpdk/utilities/ovs-appctl ofproto/trace br-int in_port=3,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_vlan=100 -generate
Bridge: br-int
Flow: in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000

Rule: table=0 cookie=0 priority=150,in_port=3,dl_vlan=100
OpenFlow actions=set_field:0x1->metadata,set_field:0x6->reg6,pop_vlan,resubmit(,16)

        Resubmitted flow: reg6=0x6,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
        Resubmitted  odp: drop
        Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
        Rule: table=16 cookie=0 priority=50,reg6=0x6,metadata=0x1
        OpenFlow actions=resubmit(,17)

                Resubmitted flow: unchanged
                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
                Resubmitted  odp: drop
                Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                Rule: table=17 cookie=0 priority=100,metadata=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00
                OpenFlow actions=set_field:0xffff->reg7,resubmit(,32)

                        Resubmitted flow: reg6=0x6,reg7=0xffff,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0xffff
                        Resubmitted  odp: drop
                        Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                        Rule: table=32 cookie=0 priority=100,reg7=0xffff,metadata=0x1
                        OpenFlow actions=load:0x1->NXM_NX_TUN_ID[0..23],load:0xffff->NXM_NX_TUN_METADATA0[0..31],move:NXM_NX_REG6[0..14]->NXM_NX_TUN_METADATA0[16..30],output:1,resubmit(,33)                        output to native tunnel
                        tunneling to 192.168.200.2 via br-ext
                        tunneling from 00:1e:67:d1:a5:f5 192.168.200.1 to 00:1e:67:51:2a:00 192.168.200.2

                                Resubmitted flow: reg6=0x6,reg7=0xffff,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0xffff
                                Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
                                Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                Rule: table=33 cookie=0 priority=100,reg7=0xffff,metadata=0x1
                                OpenFlow actions=set_field:0x1->reg7,resubmit(,34),set_field:0x2->reg7,resubmit(,34)

                                        Resubmitted flow: reg6=0x6,reg7=0x1,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
                                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
                                        Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
                                        Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                        Rule: table=34 cookie=0 priority=0
                                        OpenFlow actions=set_field:0->reg0,set_field:0->reg1,set_field:0->reg2,set_field:0->reg3,set_field:0->reg4,set_field:0->reg5,resubmit(,48)

                                                Resubmitted flow: unchanged
                                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
                                                Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
                                                Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                                Rule: table=48 cookie=0 priority=0,metadata=0x1
                                                OpenFlow actions=resubmit(,49)

                                                        Resubmitted flow: unchanged
                                                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
                                                        Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
                                                        Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                                        Rule: table=49 cookie=0 priority=100,metadata=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00
                                                        OpenFlow actions=resubmit(,64)

                                                                Resubmitted flow: unchanged
                                                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
                                                                Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
                                                                Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                                                Rule: table=64 cookie=0 priority=100,reg7=0x1,metadata=0x1
                                                                OpenFlow actions=output:2

                                        Resubmitted flow: reg6=0x6,reg7=0x2,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
                                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
                                        Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
                                        Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                        Rule: table=34 cookie=0 priority=0
                                        OpenFlow actions=set_field:0->reg0,set_field:0->reg1,set_field:0->reg2,set_field:0->reg3,set_field:0->reg4,set_field:0->reg5,resubmit(,48)

                                                Resubmitted flow: unchanged
                                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
                                                Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
                                                Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                                Rule: table=48 cookie=0 priority=0,metadata=0x1
                                                OpenFlow actions=resubmit(,49)

                                                        Resubmitted flow: unchanged
                                                        Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
                                                        Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
                                                        Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                                        Rule: table=49 cookie=0 priority=100,metadata=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00
                                                        OpenFlow actions=resubmit(,64)

                                                                Resubmitted flow: unchanged
                                                                Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
                                                                Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
                                                                Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
                                                                Rule: table=64 cookie=0 priority=100,reg7=0x2,metadata=0x1
                                                                OpenFlow actions=output:3
                                                                skipping output to input port

Final flow: reg6=0x6,reg7=0x2,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
Megaflow: recirc_id=0,tun_id=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
Datapath actions: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5 → VLAN tag stripped off before sending out.




From pchui2012 at gmail.com  Thu Aug 27 05:36:01 2015
From: pchui2012 at gmail.com (hui pang)
Date: Thu, 27 Aug 2015 20:36:01 +0800
Subject: [ovs-discuss] Wrong flow statistics
Message-ID: <CAN7rjFkYfXLzQAx+nG1xwNtpcWgbXQrvZjD-QZ0kSkeEWzNHqQ@mail.gmail.com>

Hi,

I'm attempting to collect packet statistics from flow remove messages. But
I found some flow statistics are of no consistence.

The topology of my experiment is a linear one, which is generated from "mn
--topo=linear,5,1".
i.e., h1 -- s1-eth1 -- s1-eth2 -- s2-eth2 -- s2-eth3 -- s3-eth2 -- s3-eth3
-- s4-eth2 -- s4-eth3 -- s5-eth2 -- s5-eth1 -- h5. (some host are ignored).
And in my experiment, packets are forwarded according to its IPv4
destination address.
Firstly, I inject the following rules to assure every IP packets can be
forwarded from h1 to h5 without any PacketIn message being triggered.
----------------------------------------------------------------------------------------
  switch |                          rule
----------------------------------------------------------------------------------------
    s1     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:2
    s2     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
    s3     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
    s4     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
    s5     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:1
-----------------------------------------------------------------------------------------
Secondly, I use traffic generation tool (nping) to inject traffic from h1
to h5 (h1 nping -N -udp -g 2000 -p 3000-3600 -delay 0.2 -c 1 10.0.0.5). And
destination port is also used as an identity.
Thirdly, I insert new rules on s5 and s3 to count packets directed to h5
and with the tos field set to 24, and the hard timeout of those rule is set
to 30 seconds. Besides, those rules have a priority of 2.
Finally, I install a new rule on s1 to set the tos field to 24 for all
traffic toward to 10.0.0.5. Also, this rule have a priority of 2 and its
hard timeout is set to 10 seconds.
Those three rules are listed as follows:
----------------------------------------------------------------------------------------------------------------------------------------
  switch |                          rule
----------------------------------------------------------------------------------------------------------------------------------------
    s1     |
ip,nw_dst=10.0.0.5,priority=2,hardtimeout=10,actions=mod_nw_tos=24,output:2
    s3     |
ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:3
    s5     |
ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:1
-----------------------------------------------------------------------------------------------------------------------------------------
In general, those three rules should report the same flow statistics after
their expire, but actually, the first rule (on s1) report a different (at a
distance of about 1 or 2 packets) packet count and byte count some times.
For example, the statistics may be: 52 55 55.

My test script is as attached as the attachement. An example output is as
follows:
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=185.030s, table=0, n_packets=549, n_bytes=23058,
hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
actions=output:2
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=185.028s, table=0, n_packets=601, n_bytes=25242,
hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
actions=output:3
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=185.026s, table=0, n_packets=546, n_bytes=22932,
hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
actions=output:3
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=185.023s, table=0, n_packets=601, n_bytes=25242,
hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
actions=output:3
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=185.021s, table=0, n_packets=546, n_bytes=22932,
hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
actions=output:1
They are statistics from the flow rules injected firstly(the rules in the
first table).
The packet statistics of the second batch of flow rules is calculated from
those statistics, say 52 = 601-549, 55 = 601-546, 55=601-546

So, my doubt is why those statistics are not of the same quantity? Is there
anything wrong with my method?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150827/1f3a0139/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rule-test.sh
Type: application/x-sh
Size: 1841 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150827/1f3a0139/attachment-0001.sh>

From p.schmitt.82 at gmx.net  Thu Aug 27 07:06:44 2015
From: p.schmitt.82 at gmx.net (Peter Schmitt)
Date: Thu, 27 Aug 2015 16:06:44 +0200
Subject: [ovs-discuss] Leaking packets from one bridge to another or how
 can I isolate networks with OVS?
In-Reply-To: <20150821141759.GA31657@nicira.com>
References: <55D5C65B.1080106@gmx.net> <20150820170702.GB15750@nicira.com>
 <55D6C819.90303@gmx.net> <20150821141759.GA31657@nicira.com>
Message-ID: <55DF1974.5020002@gmx.net>

Hi,

thank you very much for your help. I finally found the solution to this.
It was a qemu related problem. I use multiple NICs per KVM and tap
devices for the network connectivity:

-net nic,model=e1000,macaddr=XX:XX:XX:XX:XX:XX -net
tap,script=/path/to/ovs-ifup.sh,downscript=/path/to/ovs-ifdown.sh
-net nic,model=e1000,macaddr=YY:YY:YY:YY:YY:YY -net
tap,script=/path/to/ovs-ifup.sh,downscript=/path/to/ovs-ifdown.sh

What happens now is that qemu implicitly creates a network hub and
connects all tap devices and virtual nics to this hub which leads to the
effect I've seen.
The solution is to "connect" these entries by using the vlan parameter
(which has nothing to do with 802.1q). It simply tells qemu which nic in
the guest belongs to which
tap device in the host-system:

-net nic,model=e1000,macaddr=XX:XX:XX:XX:XX:XX,vlan=0 -net
tap,script=/path/to/ovs-ifup.sh,downscript=/path/to/ovs-ifdown.sh,vlan=0
-net nic,model=e1000,macaddr=YY:YY:YY:YY:YY:YY,vlan=1 -net
tap,script=/path/to/ovs-ifup.sh,downscript=/path/to/ovs-ifdown.sh,vlan=1

A detailed description can be found here:
http://lists.gnu.org/archive/html/qemu-discuss/2014-06/msg00067.html

So this is entirely not an OVS related problem I had, but it seemed like
that in the first place. I just want to post my solution here, so that
it may be of help for someone else with similar problems :)

Best regards,
Peter


On 21.08.2015 16:17, Ben Pfaff wrote:
> On Fri, Aug 21, 2015 at 08:41:29AM +0200, Peter Schmitt wrote:
>> Hi,
>> thank you for the answer. Yes I saw that, but that does not explain why
>> I see
>> ARP requests from the host network on br1000. Maybe I did not explain
>> this quite well.
>>
>> Assume I have my normal home network here being 192.168.0.0/24. All my hosts
>> are connected to this network, and also the KVM host machine.
>> Now I start ovs, pox and some KVMs on the KVM host machine.
>> The br0 on ovs is also in the network 192.168.0.0/24. The network between
>> my KVM machines is 10.0.0.0/24 on br1000. With the setup described below,
>> I can see ARP requests from two different hosts in the 192.168.0.0/24
>> network (not the IP address of the KVM host) on my KVM appliances in the
>> 10.0.0.0/24 network.
>> That would (in my understanding) mean, that the KVM forwards ARP requests
>> for some reason to the second bridge or there is anything fishy with
>> ovs. I don't
>> have any bridges or anything configured on the KVM host.
>> The strange thing is that if I remove the interface of my KVM from the
>> br0 in ovs,
>> the ARP requests disappear on br1000.
>>
>> I hope this got a little bit clearer now. I don't think this might be
>> related to the ES Model,
>> or am I wrong here?
> OK, if it's not the ES model, then you can trace the path of a packet
> through your system hop-by-hop to figure out what's happening.  The FAQ
> has some info:
>
> ### Q: I have a sophisticated network setup involving Open vSwitch, VMs or
>    multiple hosts, and other components.  The behavior isn't what I
>    expect.  Help!
>
> A: To debug network behavior problems, trace the path of a packet,
>    hop-by-hop, from its origin in one host to a remote host.  If
>    that's correct, then trace the path of the response packet back to
>    the origin.
>
>    Usually a simple ICMP echo request and reply ("ping") packet is
>    good enough.  Start by initiating an ongoing "ping" from the origin
>    host to a remote host.  If you are tracking down a connectivity
>    problem, the "ping" will not display any successful output, but
>    packets are still being sent.  (In this case the packets being sent
>    are likely ARP rather than ICMP.)
>
>    Tools available for tracing include the following:
>
>    - "tcpdump" and "wireshark" for observing hops across network
>      devices, such as Open vSwitch internal devices and physical
>      wires.
>
>    - "ovs-appctl dpif/dump-flows <br>" in Open vSwitch 1.10 and
>      later or "ovs-dpctl dump-flows <br>" in earlier versions.
>      These tools allow one to observe the actions being taken on
>      packets in ongoing flows.
>
>      See ovs-vswitchd(8) for "ovs-appctl dpif/dump-flows"
>      documentation, ovs-dpctl(8) for "ovs-dpctl dump-flows"
>      documentation, and "Why are there so many different ways to
>      dump flows?" above for some background.
>
>    - "ovs-appctl ofproto/trace" to observe the logic behind how
>      ovs-vswitchd treats packets.  See ovs-vswitchd(8) for
>      documentation.  You can out more details about a given flow
>      that "ovs-dpctl dump-flows" displays, by cutting and pasting
>      a flow from the output into an "ovs-appctl ofproto/trace"
>      command.
>
>    - SPAN, RSPAN, and ERSPAN features of physical switches, to
>      observe what goes on at these physical hops.
>
>    Starting at the origin of a given packet, observe the packet at
>    each hop in turn.  For example, in one plausible scenario, you
>    might:
>
>    1. "tcpdump" the "eth" interface through which an ARP egresses
>       a VM, from inside the VM.
>
>    2. "tcpdump" the "vif" or "tap" interface through which the ARP
>       ingresses the host machine.
>
>    3. Use "ovs-dpctl dump-flows" to spot the ARP flow and observe
>       the host interface through which the ARP egresses the
>       physical machine.  You may need to use "ovs-dpctl show" to
>       interpret the port numbers.  If the output seems surprising,
>       you can use "ovs-appctl ofproto/trace" to observe details of
>       how ovs-vswitchd determined the actions in the "ovs-dpctl
>       dump-flows" output.
>
>    4. "tcpdump" the "eth" interface through which the ARP egresses
>       the physical machine.
>
>    5. "tcpdump" the "eth" interface through which the ARP
>       ingresses the physical machine, at the remote host that
>       receives the ARP.
>
>    6. Use "ovs-dpctl dump-flows" to spot the ARP flow on the
>       remote host that receives the ARP and observe the VM "vif"
>       or "tap" interface to which the flow is directed.  Again,
>       "ovs-dpctl show" and "ovs-appctl ofproto/trace" might help.
>
>    7. "tcpdump" the "vif" or "tap" interface to which the ARP is
>       directed.
>
>    8. "tcpdump" the "eth" interface through which the ARP
>       ingresses a VM, from inside the VM.
>
>    It is likely that during one of these steps you will figure out the
>    problem.  If not, then follow the ARP reply back to the origin, in
>    reverse.


From shettyg at nicira.com  Thu Aug 27 07:50:50 2015
From: shettyg at nicira.com (Gurucharan Shetty)
Date: Thu, 27 Aug 2015 07:50:50 -0700
Subject: [ovs-discuss] ovn: Handling of broadcast packets in
 OVN-Container underlay mode.
In-Reply-To: <2EF2F5C0CC56984AA024D0B180335FCB13C8C9D2@IRSMSX102.ger.corp.intel.com>
References: <2EF2F5C0CC56984AA024D0B180335FCB13C8C9D2@IRSMSX102.ger.corp.intel.com>
Message-ID: <CAHbON5r7E4SB89rnGbkNog0sOXeN2DiC7d4xV8j0T3oFfEuCbA@mail.gmail.com>

On Thu, Aug 27, 2015 at 3:12 AM, Chandran, Sugesh
<sugesh.chandran at intel.com> wrote:
> Hello OVN team,
>
> I am trying out OVN-Container underlay setup manually.  I found an issue with forwarding ARP/broadcast packets between containers on different VMs in same logical network.
> The integration bridge on the host puts VLAN ID of the container before forwarding the packet to the VM . The OVS inside the VM then forwards this packet to the right container interface using the VLANID.
> However when a packet received with broadcast mac address, integration bridge forwards it as untagged to the VM. The OVS inside the VM drops this packet, because the container interface is designated to receive only tagged packets. ARP is failing because of ARP-request never reaches the destined Container.
> Is there anything I missed out to configure for handling the container broadcast/ARP traffic???

Things were working fine the last time I checked. But recently Ben
added changes to the way braodcasting is done. It is possible that it
broke something. I will look into it.

>
>
> Please find the logs below for the flow rule details programmed on the integration bridge(Unicast and Broadcast traffic).
>
> $  sudo /home/sugeshch/repo/ovs_dpdk/ovs_dpdk/utilities/ovs-appctl ofproto/trace br-int in_port=3,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_vlan=100 -generate
> Bridge: br-int
> Flow: in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>
> Rule: table=0 cookie=0 priority=150,in_port=3,dl_vlan=100
> OpenFlow actions=set_field:0x1->metadata,set_field:0x6->reg6,pop_vlan,resubmit(,16)
>
>         Resubmitted flow: reg6=0x6,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
>         Resubmitted  odp: drop
>         Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>         Rule: table=16 cookie=0 priority=50,reg6=0x6,metadata=0x1
>         OpenFlow actions=resubmit(,17)
>
>                 Resubmitted flow: unchanged
>                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
>                 Resubmitted  odp: drop
>                 Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                 Rule: table=17 cookie=0 priority=50,metadata=0x1,dl_dst=00:00:00:01:00:01
>                 OpenFlow actions=set_field:0x4->reg7,resubmit(,32)
>
>                         Resubmitted flow: reg6=0x6,reg7=0x4,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
>                         Resubmitted  odp: drop
>                         Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                         Rule: table=32 cookie=0 priority=0
>                         OpenFlow actions=resubmit(,33)
>
>                                 Resubmitted flow: unchanged
>                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
>                                 Resubmitted  odp: drop
>                                 Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                                 Rule: table=33 cookie=0 priority=100,reg7=0x4,metadata=0x1
>                                 OpenFlow actions=resubmit(,34)
>
>                                         Resubmitted flow: unchanged
>                                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
>                                         Resubmitted  odp: drop
>                                         Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                                         Rule: table=34 cookie=0 priority=0
>                                         OpenFlow actions=set_field:0->reg0,set_field:0->reg1,set_field:0->reg2,set_field:0->reg3,set_field:0->reg4,set_field:0->reg5,resubmit(,48)
>
>                                                 Resubmitted flow: unchanged
>                                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
>                                                 Resubmitted  odp: drop
>                                                 Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                                                 Rule: table=48 cookie=0 priority=0,metadata=0x1
>                                                 OpenFlow actions=resubmit(,49)
>
>                                                         Resubmitted flow: unchanged
>                                                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
>                                                         Resubmitted  odp: drop
>                                                         Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                                                         Rule: table=49 cookie=0 priority=50,reg7=0x4,metadata=0x1
>                                                         OpenFlow actions=resubmit(,64)
>
>                                                                 Resubmitted flow: unchanged
>                                                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x4
>                                                                 Resubmitted  odp: drop
>                                                                 Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
>                                                                 Rule: table=64 cookie=0 priority=100,reg7=0x4,metadata=0x1
>                                                                 OpenFlow actions=push_vlan:0x8100,set_field:4196->vlan_vid,push:NXM_OF_IN_PORT[],set_field:0->in_port,output:2,pop_vlan,pop:NXM_OF_IN_PORT[]
>
> Final flow: reg6=0x6,reg7=0x4,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=00:00:00:01:00:01,dl_type=0x0000
> Megaflow: recirc_id=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:01:00:01,dl_type=0x0000
> Datapath actions: 5   → VLAN tags present when forwarding to the VM.
>
>
>
>
>
> $  sudo /home/sugeshch/repo/ovs_dpdk/ovs_dpdk/utilities/ovs-appctl ofproto/trace br-int in_port=3,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_vlan=100 -generate
> Bridge: br-int
> Flow: in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
>
> Rule: table=0 cookie=0 priority=150,in_port=3,dl_vlan=100
> OpenFlow actions=set_field:0x1->metadata,set_field:0x6->reg6,pop_vlan,resubmit(,16)
>
>         Resubmitted flow: reg6=0x6,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
>         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
>         Resubmitted  odp: drop
>         Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>         Rule: table=16 cookie=0 priority=50,reg6=0x6,metadata=0x1
>         OpenFlow actions=resubmit(,17)
>
>                 Resubmitted flow: unchanged
>                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x0
>                 Resubmitted  odp: drop
>                 Resubmitted megaflow: recirc_id=0,reg6=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                 Rule: table=17 cookie=0 priority=100,metadata=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00
>                 OpenFlow actions=set_field:0xffff->reg7,resubmit(,32)
>
>                         Resubmitted flow: reg6=0x6,reg7=0xffff,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
>                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0xffff
>                         Resubmitted  odp: drop
>                         Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                         Rule: table=32 cookie=0 priority=100,reg7=0xffff,metadata=0x1
>                         OpenFlow actions=load:0x1->NXM_NX_TUN_ID[0..23],load:0xffff->NXM_NX_TUN_METADATA0[0..31],move:NXM_NX_REG6[0..14]->NXM_NX_TUN_METADATA0[16..30],output:1,resubmit(,33)                        output to native tunnel
>                         tunneling to 192.168.200.2 via br-ext
>                         tunneling from 00:1e:67:d1:a5:f5 192.168.200.1 to 00:1e:67:51:2a:00 192.168.200.2
>
>                                 Resubmitted flow: reg6=0x6,reg7=0xffff,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
>                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0xffff
>                                 Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
>                                 Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                 Rule: table=33 cookie=0 priority=100,reg7=0xffff,metadata=0x1
>                                 OpenFlow actions=set_field:0x1->reg7,resubmit(,34),set_field:0x2->reg7,resubmit(,34)
>
>                                         Resubmitted flow: reg6=0x6,reg7=0x1,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
>                                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
>                                         Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
>                                         Resubmitted megaflow: recirc_id=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                         Rule: table=34 cookie=0 priority=0
>                                         OpenFlow actions=set_field:0->reg0,set_field:0->reg1,set_field:0->reg2,set_field:0->reg3,set_field:0->reg4,set_field:0->reg5,resubmit(,48)
>
>                                                 Resubmitted flow: unchanged
>                                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
>                                                 Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
>                                                 Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                                 Rule: table=48 cookie=0 priority=0,metadata=0x1
>                                                 OpenFlow actions=resubmit(,49)
>
>                                                         Resubmitted flow: unchanged
>                                                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
>                                                         Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
>                                                         Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                                         Rule: table=49 cookie=0 priority=100,metadata=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00
>                                                         OpenFlow actions=resubmit(,64)
>
>                                                                 Resubmitted flow: unchanged
>                                                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x1
>                                                                 Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2))
>                                                                 Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                                                 Rule: table=64 cookie=0 priority=100,reg7=0x1,metadata=0x1
>                                                                 OpenFlow actions=output:2
>
>                                         Resubmitted flow: reg6=0x6,reg7=0x2,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
>                                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
>                                         Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
>                                         Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                         Rule: table=34 cookie=0 priority=0
>                                         OpenFlow actions=set_field:0->reg0,set_field:0->reg1,set_field:0->reg2,set_field:0->reg3,set_field:0->reg4,set_field:0->reg5,resubmit(,48)
>
>                                                 Resubmitted flow: unchanged
>                                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
>                                                 Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
>                                                 Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                                 Rule: table=48 cookie=0 priority=0,metadata=0x1
>                                                 OpenFlow actions=resubmit(,49)
>
>                                                         Resubmitted flow: unchanged
>                                                         Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
>                                                         Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
>                                                         Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                                         Rule: table=49 cookie=0 priority=100,metadata=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00
>                                                         OpenFlow actions=resubmit(,64)
>
>                                                                 Resubmitted flow: unchanged
>                                                                 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x6 reg7=0x2
>                                                                 Resubmitted  odp: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5
>                                                                 Resubmitted megaflow: recirc_id=0,reg0=0,reg1=0,reg2=0,reg3=0,reg4=0,reg5=0,reg6=0,reg7=0,tun_id=0,metadata=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
>                                                                 Rule: table=64 cookie=0 priority=100,reg7=0x2,metadata=0x1
>                                                                 OpenFlow actions=output:3
>                                                                 skipping output to input port
>
> Final flow: reg6=0x6,reg7=0x2,tun_id=0x1,metadata=0x1,in_port=3,vlan_tci=0x0000,dl_src=00:00:00:01:00:02,dl_dst=ff:ff:ff:ff:ff:ff,dl_type=0x0000
> Megaflow: recirc_id=0,tun_id=0,in_port=3,dl_vlan=100,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00,dl_type=0x0000
> Datapath actions: pop_vlan,tnl_push(tnl_port(4),header(size=58,type=5,eth(dst=00:1e:67:51:2a:00,src=00:1e:67:d1:a5:f5,dl_type=0x0800),ipv4(src=192.168.200.1,dst=192.168.200.2,proto=17,tos=0,ttl=64,frag=0x40),udp(src=0,dst=6081,csum=0x0),geneve(vni=0x1,options({class=0xffff,type=0,len=4,0x6ffff}))),out_port(2)),5 → VLAN tag stripped off before sending out.
>
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

From Gabe.Black at viavisolutions.com  Thu Aug 27 08:10:44 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Thu, 27 Aug 2015 15:10:44 +0000
Subject: [ovs-discuss] duplicate option: of_interface
In-Reply-To: <4B1BB321037C0849AAE171801564DFA645178741@IRSMSX107.ger.corp.intel.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC5EC09@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA64517642B@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5ED42@AMEXMB01.ds.jdsu.net>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5EE22@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645176BB3@IRSMSX107.ger.corp.intel.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC5F9AF@AMEXMB01.ds.jdsu.net>
 <4B1BB321037C0849AAE171801564DFA645178741@IRSMSX107.ger.corp.intel.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC61E4D@AMEXMB01.ds.jdsu.net>

Hi Sean,

Glad you found the root cause.  You could probably tell, but I’m pretty new to openstack, and the learning curve is steep (at least for me).  Any tips on how I might go about debugging packet flow (I don’t really see any packets going to or from my interfaces)?  The interface does pick up an ipv6 address (from the auto-created ipv6 router between the public and private networks), and they match what horizon says they should be, but they don’t pick up ipv4 addresses.  The VMs on the private network are not able to ping eachother (not even via the ipv6 addresses).

Anyway, you gave me a couple commands, and I’ll use their documentation, but I’ll probably search the mailing lists and other areas to try and see how I might debug why packets aren’t making it through ovs.

Thanks again,
Gabe

From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]
Sent: Thursday, August 27, 2015 3:53 AM
To: Gabe Black; bugs at openvswitch.org
Subject: RE: duplicate option: of_interface


Hi gabe

Thank I know what the error is.



As part of the change I upstreamed to neutron I made the following change to the

Standard ovs neuton agent that I have not backported to our ovs-dpdk agent



import time

import uuid



+import functools

import netaddr

from oslo_config import cfg

from oslo_log import log as logging

@@ -173,9 +174,14 @@ def __init__(self, bridge_classes, integ_br, tun_br, local_ip,

         :param conf: an instance of ConfigOpts

         '''

         super(OVSNeutronAgent, self).__init__()

-        self.br_int_cls = bridge_classes['br_int']

-        self.br_phys_cls = bridge_classes['br_phys']

-        self.br_tun_cls = bridge_classes['br_tun']

+        self.conf = conf or cfg.CONF

+

+        # init bridge classes with configured datapath type.

+        self.br_int_cls, self.br_phys_cls, self.br_tun_cls = (

+            functools.partial(bridge_classes[b],

+                              datapath_type=self.conf.OVS.datapath_type)

+            for b in ('br_int', 'br_phys', 'br_tun'))

+

         self.use_veth_interconnection = use_veth_interconnection

         self.veth_mtu = veth_mtu

         self.available_local_vlans = set(moves.range(p_const.MIN_VLAN_TAG,

@@ -188,7 +194,6 @@ def __init__(self, bridge_classes, integ_br, tun_br, local_ip,

         self.enable_distributed_routing = enable_distributed_routing

         self.arp_responder_enabled = arp_responder and self.l2_pop

         self.prevent_arp_spoofing = prevent_arp_spoofing

-        self.conf = conf or cfg.CONF



         self.agent_state = {

             'binary': 'neutron-openvswitch-agent',



As a result our current agent does not read the config value and reverts to the default system datapath.



I will open a bug for this change and release a patch to fix it later today to our networking-ovs-dpdk repo.



Regards

Sean.



-----Original Message-----
From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]
Sent: Wednesday, August 26, 2015 8:52 PM
To: Mooney, Sean K; bugs at openvswitch.org<mailto:bugs at openvswitch.org>
Subject: RE: duplicate option: of_interface



K, tracked it down to neutron/agent/common/ovs_lib.py:151



Datapath_type has a default value of OVS_DATAPATH_SYSTEM.  I'm guessing somewhere someone created an instance of the object without passing in the datapath_type variable from config.



Anyway, changing that to OVS_DATAPATH_NETDEV got rid of the br-int errors...



It didn't, however get dhcp, ping, or anything else networking related to work on the vm;  Even when I statically assign the IP addresses (matching what the connected ports say they should be), I don't even see the ifconfig stats change.



ps aux | grep  qemu shows this line for one of the qemu's:

/usr/bin/qemu-system-x86_64 -name instance-00000003 -S -machine pc-i440fx-utopic,accel=kvm,usb=off -m 2048 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -object memory-backend-file,prealloc=yes,mem-path=/dev/hugepages/libvirt/qemu,share=on,size=2048M,id=ram-node0,host-nodes=0,policy=bind,share=on -numa node,nodeid=0,cpus=0,memdev=ram-node0 -uuid c1e511c9-216a-4248-a2cf-7f08d61dbcc8 -smbios type=1,manufacturer=OpenStack Foundation,product=OpenStack Nova,version=12.0.0,serial=be47d935-9390-b631-e0a7-e6ad55dde37f,uuid=c1e511c9-216a-4248-a2cf-7f08d61dbcc8,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/instance-00000003.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=discard -no-hpet -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/disk,if=none,id=drive-virtio-disk0,format=qcow2,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/disk.config,if=none,id=drive-ide0-1-1,readonly=on,format=raw,cache=none -device ide-cd,bus=ide.1,unit=1,drive=drive-ide0-1-1,id=ide0-1-1 -chardev socket,id=charnet0,path=/var/run/openvswitch/vhu3272d0ab-f3 -netdev type=vhost-user,id=hostnet0,chardev=charnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:82:61:6c,bus=pci.0,addr=0x3 -chardev socket,id=charnet1,path=/var/run/openvswitch/vhuea352081-64 -netdev type=vhost-user,id=hostnet1,chardev=charnet1 -device virtio-net-pci,netdev=hostnet1,id=net1,mac=fa:16:3e:d7:6c:17,bus=pci.0,addr=0x4 -chardev file,id=charserial0,path=/opt/stack/data/nova/instances/c1e511c9-216a-4248-a2cf-7f08d61dbcc8/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -vnc 127.0.0.1:1 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on



Osv-ofctl dump-ports br-int doesn't have any stats that change...

  port 16: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?

           tx pkts=0, bytes=?, drop=0, errs=?, coll=?

  port LOCAL: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0

           tx pkts=18, bytes=1538, drop=0, errs=0, coll=0

  port  5: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0

           tx pkts=18, bytes=1486, drop=0, errs=0, coll=0

  port 15: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?

...







> -----Original Message-----

> From: Gabe Black

> Sent: Wednesday, August 26, 2015 12:43 PM

> To: 'Mooney, Sean K'; 'bugs at openvswitch.org'

> Subject: RE: duplicate option: of_interface

>

> Interesting... it seems that the ovs-vsctl set bridge br-int

> datapath_type=netdev does take, but very soon after it is changed back

> to system.  I'll try and figure out how that is happening.

>

> Gabe

>

> > -----Original Message-----

> > From: Gabe Black

> > Sent: Wednesday, August 26, 2015 12:42 PM

> > To: 'Mooney, Sean K'; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > Subject: RE: duplicate option: of_interface

> >

> > Hi Sean,

> >

> > Yes, I did have the OVS_DATAPATH_TYPE set to netdev.  Even after

> > setting the [ovs] datapath_type=netdev and trying to manually set

> > the datapath_type to netdev (ovs-vsctl set Bridge br-int

> > datapath_type=netdev), the br-int still shows system.

> >

> > The interesting thing is that the other bridges (br-ex and br-p6p1

> > are set to netdev (automatically during stacking), but just br-int

> > is system and immutable it seems via manual ovs-vsctl commands).

> >

> > I'll keep playing around and see if there is some way to reconcile.

> >

> > Thanks,

> > Gabe

> >

> > > -----Original Message-----

> > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]

> > > Sent: Wednesday, August 26, 2015 5:12 AM

> > > To: Gabe Black; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > Subject: RE: duplicate option: of_interface

> > >

> > > I know the feeling. I think your horizon issue can be fixed by

> > > Running sudo iptables -F sudo iptables -X iptables based security

> > > groups do not work with vhost-user so this will have no effect on

> > > vm security

> > >

> > > I think the ovs-ofctl: br-int is not a bridge or a socket error is

> > > because the datapath_type on the bridge is not currently set to netdev.

> > >

> > > Looking at your previous error I noticed the follow command the

> > > datapath_type is being set to system.

> > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json', '--',

> > > > '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge',

> > > > 'br-int', 'datapath_type=system']

> > >

> > >

> > > I think the reason the bridge does not exists is because it has

> > > the wrong datapath type.

> > > You can validate this by running

> > > sudo ovs-vsctl list-br

> > >

> > > when using kernel ovs the output will be similar to this

> > >

> > > _uuid               : 50c64fb3-3c0c-40f9-8e45-6384a99687aa

> > > controller          : []

> > > datapath_id         : "0000b24fc650f940"

> > > datapath_type       : system

> > > external_ids        : {bridge-id=br-int}

> > > fail_mode           : secure

> > > flood_vlans         : []

> > > flow_tables         : {}

> > > ipfix               : []

> > > mirrors             : []

> > > name                : br-int

> > > netflow             : []

> > > other_config        : {}

> > > ports               : [1e2aeb85-01a2-4f1d-a0ef-f4954acab3f2, b8c7a19e-c510-

> > 47c1-

> > > 874c-9d99ec6085f5, c370d053-6aea-4f16-a6bc-f54f1aabfcb5,

> > > e1a7ef91-53a4- 4222-9bf7-249888ad48ef, e917d939-44db-4661-9311-

> > bb68a6c132c4]

> > > protocols           : ["OpenFlow10"]

> > > sflow               : []

> > > status              : {}

> > > stp_enable          : false

> > >

> > > when using ovs with dpdk the datapath_type  should be netdev.

> > >

> > > If it is currently system and assuming you have

> > > OVS_DATAPATH_TYPE=netdev set in your local.conf this could be

> > > caused, as one of my patches to neutron merged Saturday and we

> > > have not updated our deployment code To add the appropriate configuration.

> > >

> >

> https://github.com/openstack/neutron/commit/5b708d5f0e9a5ddb4675148

> > > 9a52665e673a5cb0b

> > >

> > >

> > > If you add

> > > [ovs]

> > > datapath_type = netdev

> > > to the ml2_conf.ini the q-agt will configure the dpdk netdev

> > > datapath instead of the system kernel datapath.

> > >

> > > For your running system you can run the following commands to set

> > > the datapath

> > >

> > > sudo ovs-vsctl set bridge <bridge name> datapath=netdev.

> > >

> > > This should be run for all ovs bridges.

> > >

> > > On huge table memory as the system is left running main memory

> > > gets fragment.

> > > when you start ovs with our service file it allocates hugempage

> > > memory in the kernel from the current free memory.

> > >

> > > When you compile dpdk there is a hugepage segment limit of 256

> segment.

> > > If the dpdk application cannot allocated its hugepage memory in

> > > less segment then this limit the application will exit.

> > > You can adjust this limit by setting

> OVS_DPDK_MEM_SEGMENTS=<value>

> > in

> > > your local.conf The more often you stack and unstack between

> > > reboots the more fragmented your memory will be so for development

> > > I tend to set the OVS_DPDK_MEM_SEGMENTS quite high.

> > >

> > > Regards

> > > Sean.

> > > -----Original Message-----

> > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

> > > Sent: Tuesday, August 25, 2015 9:45 PM

> > > To: Gabe Black; Mooney, Sean K; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > Subject: RE: duplicate option: of_interface

> > >

> > > Sorry, that was premature.  Apparently hugetable memory gets

> > > fragmented or leaks or something as the ovs-dpdk failed to start.

> > Rebooting fixed that.

> > >

> > > I still get many errors in the q-agt log file similar to this:

> > > ERROR neutron.agent.linux.utils [-]

> > > Command: ['ovs-ofctl', 'add-flows', 'br-int', '-'] Exit code: 1

> > > Stdin:

> > > hard_timeout=0,idle_timeout=0,priority=0,table=0,cookie=0x0,action

> > > s=

> > > no

> > > r

> > > mal

> > > Stdout:

> > > Stderr: ovs-ofctl: br-int is not a bridge or a socket

> > >

> > > and

> > >

> > > ERROR neutron.agent.common.ovs_lib [req-ab1e1f65-d14c-4209-ac20-

> > > d29e450eda38 None None] Unable to execute ['ovs-ofctl',

> > > 'dump-flows',

> > > 'br- int', 'table=23']. Exception:

> > > Command: ['ovs-ofctl', 'dump-flows', 'br-int', 'table=23'] Exit code:

> > > 1

> > > Stdin:

> > > Stdout:

> > > Stderr: ovs-ofctl: br-int is not a bridge or a socket

> > >

> > > But at least q-agt isn't dying.  I remember why I hate fedora though..

> > > Even though horizon says it is running and we turned the firewall

> > > to permissive, I can never access the website.  Seems like

> > > something else is protecting or acting as a firewall.

> > >

> > >

> > >

> > > > -----Original Message-----

> > > > From: discuss [mailto:discuss-bounces at openvswitch.org] On Behalf

> > > > Of Gabe Black

> > > > Sent: Tuesday, August 25, 2015 2:06 PM

> > > > To: Mooney, Sean K; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > > Subject: Re: [ovs-discuss] duplicate option: of_interface

> > > >

> > > > Thanks for the reply and hints on changes...  Armed with that I

> > > > undid the changes from git commit 053bfc5a (neutron) and that

> > > > allowed the q-agt process to at least not die there with that

> > > > callstack.  The commit message seemed to indicate it was for

> > > > better restarting/cleanup; so I hope it is relatively low impact

> > > > to back

> out.

> > > >

> > > > However, it now dies because it is still unable to create the

> > > > br-int

> bridge:

> > > >

> > > > Unable to execute ['ovs-vsctl', '--timeout=10', '--oneline',

> > > > '--format=json', '--', '--may-exist', 'add-br', 'br-int', '--',

> > > > 'set', 'Bridge', 'br-int', 'datapath_type=system'].

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > Traceback (most recent call last):

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File

> > > > "/opt/stack/neutron/neutron/agent/ovsdb/impl_vsctl.py", line 63,

> > > > in run_vsctl

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > log_fail_as_error=False).rstrip()

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl   File

> > > > "/opt/stack/neutron/neutron/agent/linux/utils.py", line 153, in

> execute

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl     raise

> > > > RuntimeError(m)

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > RuntimeError:

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > Command:

> > > > ['ovs-vsctl', '--timeout=10', '--oneline', '--format=json',

> > > > '--', '--may-exist', 'add- br', 'br-int', '--', 'set', 'Bridge',

> > > > 'br-int', 'datapath_type=system']

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > Exit

> > > > code: -14

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdin:

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stdout:

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl Stderr:

> > > > 2015- 08-25T19:59:44Z|00002|fatal_signal|WARN|terminating with

> > > > signal

> > > > 14 (Alarm

> > > > clock)

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > > 2015-08-25 12:59:44.777 TRACE neutron.agent.ovsdb.impl_vsctl

> > > >

> > > > I noticed a difference between a multi-node setup and a single

> > > > node, where multi-node's controller has openvswitch and ovsdpdk

> > > > for the Q_ML2_PLUGIN_MECHANISM_DRIVERS.  Is it perhaps related

> to that?

> > Or

> > > > should it be trying to create br-int as datapath_type netdev instead?

> > > > Just throwing things out there because I'm ignorant :-)  I'll

> > > > try variations of that in hopes I get lucky.

> > > >

> > > >

> > > > Gabe

> > > >

> > > >

> > > >

> > > > > -----Original Message-----

> > > > > From: Mooney, Sean K [mailto:sean.k.mooney at intel.com]

> > > > > Sent: Tuesday, August 25, 2015 1:30 PM

> > > > > To: Gabe Black; bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > > > Subject: RE: duplicate option: of_interface

> > > > >

> > > > > Hi Gabe

> > > > > We have started to see that message in our ci since this weekend.

> > > > > We are currently investigating it but I belive a change has

> > > > > merged to neuton that we need to back port to Our agent.

> > > > >

> > > > > A lot of code has merged in the last 2 weeks as the code

> > > > > freeze for the liberty release is moday.

> > > > > The stable kilo branch should be unaffected but we are

> > > > > actively looking into this at present.

> > > > >

> > > > > Regards

> > > > > Sean.

> > > > >

> > > > >

> > > > > -----Original Message-----

> > > > > From: Gabe Black [mailto:Gabe.Black at viavisolutions.com]

> > > > > Sent: Tuesday, August 25, 2015 7:50 PM

> > > > > To: bugs at openvswitch.org<mailto:bugs at openvswitch.org>

> > > > > Cc: Mooney, Sean K

> > > > > Subject: duplicate option: of_interface

> > > > >

> > > > > I have followed the getting started guide

> > > > > (http://git.openstack.org/cgit/stackforge/networking-ovs-

> > > > > dpdk/tree/doc/source/getstarted.rst) on both fedora 21 and

> > > > > Ubuntu

> > > > > 15.04 to get a single-node set up with dpdk ovs.

> > > > >

> > > > > My local.conf file is identical to the one provided as the

> > > > > single node

> > > > template:

> > > > > http://git.openstack.org/cgit/stackforge/networking-ovs-

> > > > > dpdk/tree/doc/source/_downloads/local.conf.single_node

> > > > >

> > > > > I set HOST_IP_IFACE=eno1, HOST_IP=10.3.73.124,

> > > > > OVS_BRIDGE_MAPPINGS="default:br-enp4s0f0", and

> > > > > ML2_VLAN_RANGES=default:1000:1010

> > > > >

> > > > > eno1 and associated IP is the interface/ip address of the

> > > > > server (i.e. what

> > > > we

> > > > > use to ssh to the box).   enp4s0f0 is the 10G intel nic interface that will

> > > > > eventually be used for the data interface in a multi-node setup.

> > > > > Finally the vlan range was just arbitrarily chosen.

> > > > >

> > > > > Other than that, there isn't anything else modified other than

> > > > > following instructions of the getting started guide.  However

> > > > > for both Fedora 21, and Ubuntu 15.04 (Ubuntu there were some

> > > > > mods that needed to take place like disabling apparmor,

> > > > > symlinking /var/run/openstack, and fixing ovs-dpdk-init

> > > > > script) result in the following error message in q-agt:

> > > > >

> > > > > Traceback (most recent call last):

> > > > >   File "/usr/bin/networking-ovs-dpdk-agent", line 10, in <module>

> > > > >     sys.exit(main())

> > > > >   File "/usr/lib/python2.7/site-

> > > > >

> > >

> packages/networking_ovs_dpdk/eventlet/ovs_dpdk_neutron_agent.py",

> > > > > line 20, in main

> > > > >     agent_main.main()

> > > > >   File "/usr/lib/python2.7/site-

> > > > > packages/networking_ovs_dpdk/agent/main.py", line 43, in main

> > > > >     mod = importutils.import_module(mod_name)

> > > > >   File

> > > > > "/usr/lib/python2.7/site-packages/oslo_utils/importutils.py",

> > > > > line 57, in import_module

> > > > >     __import__(import_str)

> > > > >   File "/usr/lib/python2.7/site-

> > > > >

> > > >

> > >

> >

> packages/networking_ovs_dpdk/agent/openflow/ovsdpdk_ofctl/main.py",

> > > > > line 17, in <module>

> > > > >     from networking_ovs_dpdk.agent import

> ovs_dpdk_neutron_agent

> > > > >   File "/usr/lib/python2.7/site-

> > > > >

> packages/networking_ovs_dpdk/agent/ovs_dpdk_neutron_agent.py",

> > > > line

> > > > > 47, in <module>

> > > > >     from neutron.plugins.ml2.drivers.openvswitch.agent import

> > > > > ovs_dvr_neutron_agent

> > > > >   File

> > > > >

> > > >

> > >

> >

> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_

> > > > > dvr_neutron_agent.py", line 29, in <module>

> > > > >     cfg.CONF.import_group('AGENT',

> > > > > 'neutron.plugins.ml2.drivers.openvswitch.'

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 2088, in import_group

> > > > >     __import__(module_str)

> > > > >   File

> > > > >

> > > >

> > >

> >

> "/opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/com

> > > > > mon/config.py", line 111, in <module>

> > > > >     cfg.CONF.register_opts(ovs_opts, "OVS")

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1824, in __inner

> > > > >     result = f(self, *args, **kwargs)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1983, in register_opts

> > > > >     self.register_opt(opt, group, clear_cache=False)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1828, in __inner

> > > > >     return f(self, *args, **kwargs)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1967, in register_opt

> > > > >     return group._register_opt(opt, cli)

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 1345, in _register_opt

> > > > >     if _is_opt_registered(self._opts, opt):

> > > > >   File "/usr/lib/python2.7/site-packages/oslo_config/cfg.py",

> > > > > line 574, in _is_opt_registered

> > > > >     raise DuplicateOptError(opt.name)

> > > > > oslo_config.cfg.DuplicateOptError: duplicate option:

> > > > > of_interface q-agt failed to start

> > > > >

> > > > > I thought this error message was just because Ubuntu

> > > > > testing/support hasn't been fleshed out yet with ovs-dpdk, but

> > > > > then I got the exact same error on Fedora 21.  I tried editing

> > > > > both

> > > > >

> > > >

> > >

> >

> /opt/stack/neutron/neutron/plugins/ml2/drivers/openvswitch/agent/comm

> > > > > on/config.py and /opt/stack/networking-ovs-

> > > > > dpdk/networking_ovs_dpdk/common/config.py to get past the

> error,

> > > but

> > > > > then there are complaints about not finding br-int... So I'm

> > > > > guessing that isn't the correct workaround.  Anyone have any

> > > > > suggestions of what I might have misconfigured?

> > > > >

> > > > > Thank you for your help!

> > > > > Gabriel Black

> > > > >

> > > >

> > > > _______________________________________________

> > > > discuss mailing list

> > > > discuss at openvswitch.org<mailto:discuss at openvswitch.org>

> > > > http://openvswitch.org/mailman/listinfo/discuss
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150827/b11ef920/attachment-0001.html>

From snadathu at altera.com  Wed Aug 26 18:32:58 2015
From: snadathu at altera.com (Sundar Nadathur)
Date: Thu, 27 Aug 2015 01:32:58 +0000
Subject: [ovs-discuss] OVS with VLANs
Message-ID: <6F84DE007D2BD24A9221FF68E8A09FE0D23151@SJ-ITEXCH02.altera.priv.altera.com>

Hi,
   On two hosts running Centos 7.1, I have an eth interface each with VLAN 3 configured on top. These enp1s0.3 interfaces can ping each other.

On a third host, also running Centos 7.1, I have configured an OVS br-int, with enp1s0 as a port. To this, I added an internal port with tag 10:
# ovs-vsctl add-port br-int vlan3 tag=3 -- set interface vlan3 type=internal
# ifconfig vlan3 192.168.3.11 netmask ... up
Now, ifconfig and route commands show valid output, but we cannot ping the other hosts.

If I add enp1s0.3 as the physical interface instead of enp1s0, it makes no difference. If I configure the IP directly on br-int, without a VLAN tag and use enp1s0.3 as physical interface, that doesn't work either. However, if I configure the IP on enp1s0.3, I can then ping the other hosts, as expected.

IOW, no configuration involving OVS is working with VLANs. But the direct physical interface is able to reach out on VLAN 3. The external switch is unmanaged.

In all these cases, the relevant bridge and physical interfaces are "UP, RUNNING" in ifconfig. The 'systemctl status openvswitch' shows it is running.  Both ovsdb-server and ovs-vswitchd are running as root.

What do I need to do to fix this?

Cheers,
Sundar


________________________________

Confidentiality Notice.
This message may contain information that is confidential or otherwise protected from disclosure. If you are not the intended recipient, you are hereby notified that any use, disclosure, dissemination, distribution, or copying of this message, or any attachments, is strictly prohibited. If you have received this message in error, please advise the sender by reply e-mail, and delete the message and any attachments. Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150827/c99a1f79/attachment.html>

From alexw at nicira.com  Thu Aug 27 09:48:25 2015
From: alexw at nicira.com (Alex Wang)
Date: Thu, 27 Aug 2015 09:48:25 -0700
Subject: [ovs-discuss] Wrong flow statistics
In-Reply-To: <CAN7rjFkYfXLzQAx+nG1xwNtpcWgbXQrvZjD-QZ0kSkeEWzNHqQ@mail.gmail.com>
References: <CAN7rjFkYfXLzQAx+nG1xwNtpcWgbXQrvZjD-QZ0kSkeEWzNHqQ@mail.gmail.com>
Message-ID: <CAArS4XV+8+dx58h7VD6fjvCrHifOAw7Smsq4BJLqB2NF9r=ALQ@mail.gmail.com>

On Thu, Aug 27, 2015 at 5:36 AM, hui pang <pchui2012 at gmail.com> wrote:

> Hi,
>
> I'm attempting to collect packet statistics from flow remove messages. But
> I found some flow statistics are of no consistence.
>
> The topology of my experiment is a linear one, which is generated from "mn
> --topo=linear,5,1".
> i.e., h1 -- s1-eth1 -- s1-eth2 -- s2-eth2 -- s2-eth3 -- s3-eth2 -- s3-eth3
> -- s4-eth2 -- s4-eth3 -- s5-eth2 -- s5-eth1 -- h5. (some host are ignored).
> And in my experiment, packets are forwarded according to its IPv4
> destination address.
> Firstly, I inject the following rules to assure every IP packets can be
> forwarded from h1 to h5 without any PacketIn message being triggered.
>
> ----------------------------------------------------------------------------------------
>   switch |                          rule
>
> ----------------------------------------------------------------------------------------
>     s1     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:2
>     s2     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
>     s3     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
>     s4     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
>     s5     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:1
>
> -----------------------------------------------------------------------------------------
> Secondly, I use traffic generation tool (nping) to inject traffic from h1
> to h5 (h1 nping -N -udp -g 2000 -p 3000-3600 -delay 0.2 -c 1 10.0.0.5). And
> destination port is also used as an identity.
> Thirdly, I insert new rules on s5 and s3 to count packets directed to h5
> and with the tos field set to 24, and the hard timeout of those rule is set
> to 30 seconds. Besides, those rules have a priority of 2.
> Finally, I install a new rule on s1 to set the tos field to 24 for all
> traffic toward to 10.0.0.5. Also, this rule have a priority of 2 and its
> hard timeout is set to 10 seconds.
> Those three rules are listed as follows:
>
> ----------------------------------------------------------------------------------------------------------------------------------------
>   switch |                          rule
>
> ----------------------------------------------------------------------------------------------------------------------------------------
>     s1     |
> ip,nw_dst=10.0.0.5,priority=2,hardtimeout=10,actions=mod_nw_tos=24,output:2
>     s3     |
> ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:3
>     s5     |
> ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:1
>
> -----------------------------------------------------------------------------------------------------------------------------------------
> In general, those three rules should report the same flow statistics after
> their expire, but actually, the first rule (on s1) report a different (at a
> distance of about 1 or 2 packets) packet count and byte count some times.
> For example, the statistics may be: 52 55 55.
>

Hey,

Here is my understanding,

Not sure the version of ovs you used, but say for branch-2.3, the flow
expiration is handled by
ofproto_rule_expire(), which will call delete_flow__()...

The delete_flow__() will first call ofproto_rule_send_removed() which sends
the flow deletion
notification to any controller, and then actually deletes the flow...

In other words, when ovs reports the flow deletion, the flow is valid still
there...  and we may fail
to include the final stats (between notifying flow deletion and actually
deleting the flow in
datapath)...

Ben, do you think we should address this?

Thanks,
Alex Wang,



> My test script is as attached as the attachement. An example output is as
> follows:
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=185.030s, table=0, n_packets=549, n_bytes=23058,
> hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
> actions=output:2
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=185.028s, table=0, n_packets=601, n_bytes=25242,
> hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
> actions=output:3
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=185.026s, table=0, n_packets=546, n_bytes=22932,
> hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
> actions=output:3
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=185.023s, table=0, n_packets=601, n_bytes=25242,
> hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
> actions=output:3
> NXST_FLOW reply (xid=0x4):
>  cookie=0x0, duration=185.021s, table=0, n_packets=546, n_bytes=22932,
> hard_timeout=3000, idle_age=64, priority=1,ip,nw_dst=10.0.0.5
> actions=output:1
> They are statistics from the flow rules injected firstly(the rules in the
> first table).
> The packet statistics of the second batch of flow rules is calculated from
> those statistics, say 52 = 601-549, 55 = 601-546, 55=601-546
>
> So, my doubt is why those statistics are not of the same quantity? Is
> there anything wrong with my method?
>
>
>
>
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150827/2b4a05ee/attachment-0001.html>

From blp at nicira.com  Thu Aug 27 09:53:12 2015
From: blp at nicira.com (Ben Pfaff)
Date: Thu, 27 Aug 2015 09:53:12 -0700
Subject: [ovs-discuss] Wrong flow statistics
In-Reply-To: <CAArS4XV+8+dx58h7VD6fjvCrHifOAw7Smsq4BJLqB2NF9r=ALQ@mail.gmail.com>
References: <CAN7rjFkYfXLzQAx+nG1xwNtpcWgbXQrvZjD-QZ0kSkeEWzNHqQ@mail.gmail.com>
 <CAArS4XV+8+dx58h7VD6fjvCrHifOAw7Smsq4BJLqB2NF9r=ALQ@mail.gmail.com>
Message-ID: <20150827165312.GF18875@nicira.com>

On Thu, Aug 27, 2015 at 09:48:25AM -0700, Alex Wang wrote:
> On Thu, Aug 27, 2015 at 5:36 AM, hui pang <pchui2012 at gmail.com> wrote:
> 
> > Hi,
> >
> > I'm attempting to collect packet statistics from flow remove messages. But
> > I found some flow statistics are of no consistence.
> >
> > The topology of my experiment is a linear one, which is generated from "mn
> > --topo=linear,5,1".
> > i.e., h1 -- s1-eth1 -- s1-eth2 -- s2-eth2 -- s2-eth3 -- s3-eth2 -- s3-eth3
> > -- s4-eth2 -- s4-eth3 -- s5-eth2 -- s5-eth1 -- h5. (some host are ignored).
> > And in my experiment, packets are forwarded according to its IPv4
> > destination address.
> > Firstly, I inject the following rules to assure every IP packets can be
> > forwarded from h1 to h5 without any PacketIn message being triggered.
> >
> > ----------------------------------------------------------------------------------------
> >   switch |                          rule
> >
> > ----------------------------------------------------------------------------------------
> >     s1     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:2
> >     s2     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
> >     s3     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
> >     s4     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
> >     s5     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:1
> >
> > -----------------------------------------------------------------------------------------
> > Secondly, I use traffic generation tool (nping) to inject traffic from h1
> > to h5 (h1 nping -N -udp -g 2000 -p 3000-3600 -delay 0.2 -c 1 10.0.0.5). And
> > destination port is also used as an identity.
> > Thirdly, I insert new rules on s5 and s3 to count packets directed to h5
> > and with the tos field set to 24, and the hard timeout of those rule is set
> > to 30 seconds. Besides, those rules have a priority of 2.
> > Finally, I install a new rule on s1 to set the tos field to 24 for all
> > traffic toward to 10.0.0.5. Also, this rule have a priority of 2 and its
> > hard timeout is set to 10 seconds.
> > Those three rules are listed as follows:
> >
> > ----------------------------------------------------------------------------------------------------------------------------------------
> >   switch |                          rule
> >
> > ----------------------------------------------------------------------------------------------------------------------------------------
> >     s1     |
> > ip,nw_dst=10.0.0.5,priority=2,hardtimeout=10,actions=mod_nw_tos=24,output:2
> >     s3     |
> > ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:3
> >     s5     |
> > ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:1
> >
> > -----------------------------------------------------------------------------------------------------------------------------------------
> > In general, those three rules should report the same flow statistics after
> > their expire, but actually, the first rule (on s1) report a different (at a
> > distance of about 1 or 2 packets) packet count and byte count some times.
> > For example, the statistics may be: 52 55 55.
> >
> 
> Hey,
> 
> Here is my understanding,
> 
> Not sure the version of ovs you used, but say for branch-2.3, the flow
> expiration is handled by
> ofproto_rule_expire(), which will call delete_flow__()...
> 
> The delete_flow__() will first call ofproto_rule_send_removed() which sends
> the flow deletion
> notification to any controller, and then actually deletes the flow...
> 
> In other words, when ovs reports the flow deletion, the flow is valid still
> there...  and we may fail
> to include the final stats (between notifying flow deletion and actually
> deleting the flow in
> datapath)...
> 
> Ben, do you think we should address this?

It's hard to get statistics that are perfect in all cases without
hurting performance.  It's not usually that important.

From Gabe.Black at viavisolutions.com  Thu Aug 27 14:34:41 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Thu, 27 Aug 2015 21:34:41 +0000
Subject: [ovs-discuss] millions of packets going to a flow?
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>

Hi,
I've been running against openstack-dev (master branch) using the stackforge/networking-ovs-dpdk master branch (OVS GIT TAG 1e77bbe565bbf5ae7f4c47f481a4097d666d3d68), using the single-node local.conf file on Ubuntu 15.04.  I've had to patch a few things to get past ERRORs during start:
- disable/purge apparmor
- patch ovs-dpdk-init to find correct qemu group and launch ovs-dpdk with sg
- patch ovs_dvr_neutron_agent.py to change default datapath_type to be netdev
- modify ml2_conf.ini to have [ovs] datapath_type=netdev
- create a symlink between /usr/var/run/openvsitch and /var/run/openvswitch

Everything appears to be working from a horizon point of view, I can launch VMs, create routers/networks, etc.

However, I've tried to figure out how to get two vms using ovs-dpdk to be able to ping eachother (or do anything network related for that matter - like get an ipv4 address (via dhcp), ping the gateway/router, etc), but to no avail.

I'm wondering if there is a flow that is bogus as when I dump the flows:

# ovs-ofctl dump-flows br-int
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=5234.334s, table=0, n_packets=0, n_bytes=0, idle_age=5234, priority=3,in_port=2,dl_vlan=2001 actions=mod_vlan_vid:1,NORMAL
 cookie=0x0, duration=5246.680s, table=0, n_packets=0, n_bytes=0, idle_age=5246, priority=2,in_port=1 actions=drop
 cookie=0x0, duration=5246.613s, table=0, n_packets=0, n_bytes=0, idle_age=5246, priority=2,in_port=2 actions=drop
 cookie=0x0, duration=5246.744s, table=0, n_packets=46828985, n_bytes=2809779780, idle_age=0, priority=0 actions=NORMAL
 cookie=0x0, duration=5246.740s, table=23, n_packets=0, n_bytes=0, idle_age=5246, priority=0 actions=drop
 cookie=0x0, duration=5246.738s, table=24, n_packets=0, n_bytes=0, idle_age=5246, priority=0 actions=drop

There is only one flow that ever gets any packets, and it gets millions of them apparently.  Viewing the number of packets sent on an interface (via ifconfig) doesn't have any interfaces with near that many packets.

Dumping ports doesn't show any stats near those values either:
===========================================================================================
ovs-ofctl dump-ports br-int
OFPST_PORT reply (xid=0x2): 7 ports
  port  6: rx pkts=0, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
           tx pkts=636, bytes=?, drop=0, errs=?, coll=?
  port  4: rx pkts=?, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
           tx pkts=?, bytes=?, drop=?, errs=?, coll=?
  port LOCAL: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=874, bytes=98998, drop=0, errs=0, coll=0
  port  1: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=874, bytes=95570, drop=0, errs=0, coll=0
  port  5: rx pkts=?, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
           tx pkts=?, bytes=?, drop=?, errs=?, coll=?
  port  2: rx pkts=0, bytes=0, drop=0, errs=0, frame=0, over=0, crc=0
           tx pkts=874, bytes=95570, drop=0, errs=0, coll=0
  port  3: rx pkts=?, bytes=?, drop=?, errs=?, frame=?, over=?, crc=?
           tx pkts=?, bytes=?, drop=?, errs=?, coll=?
===========================================================================================

One thing I find odd is that showing the br-int bridge (and all the other bridges for that matter) seem to show the port_down for almost all the interfaces:
===========================================================================================
ovs-ofctl show br-int
OFPT_FEATURES_REPLY (xid=0x2): dpid:00009ab69b50904d
n_tables:254, n_buffers:256
capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP
actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst
 1(int-br-em1): addr:0a:41:20:a8:6b:50
     config:     0
     state:      0
     speed: 0 Mbps now, 0 Mbps max
 2(int-br-p6p1): addr:2a:5d:62:23:0a:60
     config:     0
     state:      0
     speed: 0 Mbps now, 0 Mbps max
 3(tapa32182b8-ee): addr:00:00:00:00:00:00
     config:     PORT_DOWN
     state:      LINK_DOWN
     speed: 0 Mbps now, 0 Mbps max
 4(qr-a510b75f-f7): addr:00:00:00:00:00:00
     config:     PORT_DOWN
     state:      LINK_DOWN
     speed: 0 Mbps now, 0 Mbps max
 5(qr-d2f1d4a0-a9): addr:00:00:00:00:00:00
     config:     PORT_DOWN
     state:      LINK_DOWN
     speed: 0 Mbps now, 0 Mbps max
 6(vhucf0a0213-68): addr:00:00:00:00:00:00
     config:     PORT_DOWN
     state:      LINK_DOWN
     speed: 0 Mbps now, 0 Mbps max
 LOCAL(br-int): addr:9a:b6:9b:50:90:4d
     config:     PORT_DOWN
     state:      LINK_DOWN
     current:    10MB-FD COPPER
     speed: 10 Mbps now, 0 Mbps max
OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0
===========================================================================================

In fact, trying to bring them up (i.e. ovs-ofctl mod-port br-int 3 up) does not change anything for any of the ports other than for the vhost user (vhuXXYYZZ ) ports.  And then it only changes the config state to 0, it doesn't change the state status (that remains showing LINK_DOWN).

Any idea of an area I should be focusing on to debug?  I've seen some posts saying to use ovs-appctl but when I try to use it complains with the message 'cannot read pidfile "/usr/var/run/openvswitch/ovs-vswitchd.pid" (No such process)'.  Even if I copy that file (copied from /opt/stack/log/ovs-vswitchd.pid) to the location it is searching for it still complains with the same message, however strace shows that it did find it, but then I think it tries to query about the lock status on it.  I'm guessing it is resulting in that process being "locked" and that that is the real error.  I don't know if that is a red herring as well.

Anyway, I appreciate all the help you've given!  I hope you or someone on the mailing list might have some hints on where I might look next.

Very Best,
Gabriel Black



From blp at nicira.com  Thu Aug 27 16:13:22 2015
From: blp at nicira.com (Ben Pfaff)
Date: Thu, 27 Aug 2015 16:13:22 -0700
Subject: [ovs-discuss] millions of packets going to a flow?
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
Message-ID: <20150827231322.GH13397@nicira.com>

This might draw better responses on the openstack-dev list.  It doesn't
seem to be primarily about Open vSwitch but rather about OpenStack.

From pchui2012 at gmail.com  Thu Aug 27 16:27:56 2015
From: pchui2012 at gmail.com (hui pang)
Date: Fri, 28 Aug 2015 07:27:56 +0800
Subject: [ovs-discuss] Wrong flow statistics
In-Reply-To: <20150827165312.GF18875@nicira.com>
References: <CAN7rjFkYfXLzQAx+nG1xwNtpcWgbXQrvZjD-QZ0kSkeEWzNHqQ@mail.gmail.com>
 <CAArS4XV+8+dx58h7VD6fjvCrHifOAw7Smsq4BJLqB2NF9r=ALQ@mail.gmail.com>
 <20150827165312.GF18875@nicira.com>
Message-ID: <CAN7rjFnndt3NVzU_j09xSXMjX8-CTm+rPCS1Nn=5jy3bVGzYRg@mail.gmail.com>

Thanks for your reply. I have noticed the procedure of flow expire yet. In
this situation, I think, the packet count of the first rule should smaller
than the other two, say 52, 54, 54. But in my experiment, I also find some
situations in which the packet count of the first rule is bigger than the
other two, e.g., 54, 52, 52. I want to know if there is any explanation
about this? Thanks!

2015-08-28 0:53 GMT+08:00 Ben Pfaff <blp at nicira.com>:

> On Thu, Aug 27, 2015 at 09:48:25AM -0700, Alex Wang wrote:
> > On Thu, Aug 27, 2015 at 5:36 AM, hui pang <pchui2012 at gmail.com> wrote:
> >
> > > Hi,
> > >
> > > I'm attempting to collect packet statistics from flow remove messages.
> But
> > > I found some flow statistics are of no consistence.
> > >
> > > The topology of my experiment is a linear one, which is generated from
> "mn
> > > --topo=linear,5,1".
> > > i.e., h1 -- s1-eth1 -- s1-eth2 -- s2-eth2 -- s2-eth3 -- s3-eth2 --
> s3-eth3
> > > -- s4-eth2 -- s4-eth3 -- s5-eth2 -- s5-eth1 -- h5. (some host are
> ignored).
> > > And in my experiment, packets are forwarded according to its IPv4
> > > destination address.
> > > Firstly, I inject the following rules to assure every IP packets can be
> > > forwarded from h1 to h5 without any PacketIn message being triggered.
> > >
> > >
> ----------------------------------------------------------------------------------------
> > >   switch |                          rule
> > >
> > >
> ----------------------------------------------------------------------------------------
> > >     s1     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:2
> > >     s2     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
> > >     s3     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
> > >     s4     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:3
> > >     s5     |   ip,nw_dst=10.0.0.5,priority=1,actions=output:1
> > >
> > >
> -----------------------------------------------------------------------------------------
> > > Secondly, I use traffic generation tool (nping) to inject traffic from
> h1
> > > to h5 (h1 nping -N -udp -g 2000 -p 3000-3600 -delay 0.2 -c 1
> 10.0.0.5). And
> > > destination port is also used as an identity.
> > > Thirdly, I insert new rules on s5 and s3 to count packets directed to
> h5
> > > and with the tos field set to 24, and the hard timeout of those rule
> is set
> > > to 30 seconds. Besides, those rules have a priority of 2.
> > > Finally, I install a new rule on s1 to set the tos field to 24 for all
> > > traffic toward to 10.0.0.5. Also, this rule have a priority of 2 and
> its
> > > hard timeout is set to 10 seconds.
> > > Those three rules are listed as follows:
> > >
> > >
> ----------------------------------------------------------------------------------------------------------------------------------------
> > >   switch |                          rule
> > >
> > >
> ----------------------------------------------------------------------------------------------------------------------------------------
> > >     s1     |
> > >
> ip,nw_dst=10.0.0.5,priority=2,hardtimeout=10,actions=mod_nw_tos=24,output:2
> > >     s3     |
> > > ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:3
> > >     s5     |
> > > ip,nw_dst=10.0.0.5,nw_tos=24,priority=2,hardtimeout=30,actions=output:1
> > >
> > >
> -----------------------------------------------------------------------------------------------------------------------------------------
> > > In general, those three rules should report the same flow statistics
> after
> > > their expire, but actually, the first rule (on s1) report a different
> (at a
> > > distance of about 1 or 2 packets) packet count and byte count some
> times.
> > > For example, the statistics may be: 52 55 55.
> > >
> >
> > Hey,
> >
> > Here is my understanding,
> >
> > Not sure the version of ovs you used, but say for branch-2.3, the flow
> > expiration is handled by
> > ofproto_rule_expire(), which will call delete_flow__()...
> >
> > The delete_flow__() will first call ofproto_rule_send_removed() which
> sends
> > the flow deletion
> > notification to any controller, and then actually deletes the flow...
> >
> > In other words, when ovs reports the flow deletion, the flow is valid
> still
> > there...  and we may fail
> > to include the final stats (between notifying flow deletion and actually
> > deleting the flow in
> > datapath)...
> >
> > Ben, do you think we should address this?
>
> It's hard to get statistics that are perfect in all cases without
> hurting performance.  It's not usually that important.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150828/2d5777d5/attachment-0001.html>

From snadathu at altera.com  Thu Aug 27 18:09:46 2015
From: snadathu at altera.com (Sundar Nadathur)
Date: Fri, 28 Aug 2015 01:09:46 +0000
Subject: [ovs-discuss] OVS with VLANs
In-Reply-To: <6F84DE007D2BD24A9221FF68E8A09FE0D23151@SJ-ITEXCH02.altera.priv.altera.com>
References: <6F84DE007D2BD24A9221FF68E8A09FE0D23151@SJ-ITEXCH02.altera.priv.altera.com>
Message-ID: <6F84DE007D2BD24A9221FF68E8A09FE0D23487@SJ-ITEXCH02.altera.priv.altera.com>

Without the VLANs, the plain OVS is able to communicate fine with the other hosts (with the same physical NIC as the VLAN case). Please let me know why the VLAN case is not working.

Thanks a lot!

Cheers,
Sundar

From: Sundar Nadathur
Sent: Wednesday, August 26, 2015 6:33 PM
To: 'discuss at openvswitch.org'
Subject: OVS with VLANs

Hi,
   On two hosts running Centos 7.1, I have an eth interface each with VLAN 3 configured on top. These enp1s0.3 interfaces can ping each other.

On a third host, also running Centos 7.1, I have configured an OVS br-int, with enp1s0 as a port. To this, I added an internal port with tag 10:
# ovs-vsctl add-port br-int vlan3 tag=3 -- set interface vlan3 type=internal
# ifconfig vlan3 192.168.3.11 netmask ... up
Now, ifconfig and route commands show valid output, but we cannot ping the other hosts.

If I add enp1s0.3 as the physical interface instead of enp1s0, it makes no difference. If I configure the IP directly on br-int, without a VLAN tag and use enp1s0.3 as physical interface, that doesn't work either. However, if I configure the IP on enp1s0.3, I can then ping the other hosts, as expected.

IOW, no configuration involving OVS is working with VLANs. But the direct physical interface is able to reach out on VLAN 3. The external switch is unmanaged.

In all these cases, the relevant bridge and physical interfaces are "UP, RUNNING" in ifconfig. The 'systemctl status openvswitch' shows it is running.  Both ovsdb-server and ovs-vswitchd are running as root.

What do I need to do to fix this?

Cheers,
Sundar


________________________________

Confidentiality Notice.
This message may contain information that is confidential or otherwise protected from disclosure. If you are not the intended recipient, you are hereby notified that any use, disclosure, dissemination, distribution, or copying of this message, or any attachments, is strictly prohibited. If you have received this message in error, please advise the sender by reply e-mail, and delete the message and any attachments. Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150828/60780175/attachment.html>

From david at dit.upm.es  Thu Aug 27 19:21:22 2015
From: david at dit.upm.es (=?utf-8?Q?David_Fern=C3=A1ndez?=)
Date: Fri, 28 Aug 2015 04:21:22 +0200
Subject: [ovs-discuss] OVS with VLANs
In-Reply-To: <6F84DE007D2BD24A9221FF68E8A09FE0D23151@SJ-ITEXCH02.altera.priv.altera.com>
References: <6F84DE007D2BD24A9221FF68E8A09FE0D23151@SJ-ITEXCH02.altera.priv.altera.com>
Message-ID: <9807ABFF-23B3-4518-A210-79142F193119@dit.upm.es>

Hi Sundar,

Maybe the problem could be that you have to tell your br-int switch that the port that connects to enp1s0 is a trunk interface and carries VLAN 3.

Something like the following command issued in host 3 could do the job:

  ovs-vsctl set port enp1s0 trunk=3

Just in case it is useful, in VNX (Virtual Networks over linuX, http://vnx.dit.upm.es) site we have an example scenario using OVS and VLANs:

http://web.dit.upm.es/vnxwiki/index.php/Vnx-tutorial-openvswitch

In section 4 in that page you can find the ovs-vsctl commands that VNX tool issues to create the scenario and configure VLANs.

Best regards,
David Fernández
Profesor Titular
Dpto. Ingeniería de Sistemas Telemáticos
E.T.S.I. Telecomunicación
Universidad Politécnica de Madrid
e-mail: david at dit.upm.es



> El 27/8/2015, a las 3:32, Sundar Nadathur <snadathu at altera.com> escribió:
> 
> Hi,
>    On two hosts running Centos 7.1, I have an eth interface each with VLAN 3 configured on top. These enp1s0.3 interfaces can ping each other.
> 
> On a third host, also running Centos 7.1, I have configured an OVS br-int, with enp1s0 as a port. To this, I added an internal port with tag 10:
> # ovs-vsctl add-port br-int vlan3 tag=3 -- set interface vlan3 type=internal
> # ifconfig vlan3 192.168.3.11 netmask … up
> Now, ifconfig and route commands show valid output, but we cannot ping the other hosts.
> 
> If I add enp1s0.3 as the physical interface instead of enp1s0, it makes no difference. If I configure the IP directly on br-int, without a VLAN tag and use enp1s0.3 as physical interface, that doesn’t work either. However, if I configure the IP on enp1s0.3, I can then ping the other hosts, as expected.
> 
> IOW, no configuration involving OVS is working with VLANs. But the direct physical interface is able to reach out on VLAN 3. The external switch is unmanaged.
> 
> In all these cases, the relevant bridge and physical interfaces are “UP, RUNNING” in ifconfig. The ‘systemctl status openvswitch’ shows it is running.  Both ovsdb-server and ovs-vswitchd are running as root.
> 
> What do I need to do to fix this?
> 
> Cheers,
> Sundar
> 
> 
> 
> Confidentiality Notice.
> This message may contain information that is confidential or otherwise protected from disclosure. If you are not the intended recipient, you are hereby notified that any use, disclosure, dissemination, distribution, or copying of this message, or any attachments, is strictly prohibited. If you have received this message in error, please advise the sender by reply e-mail, and delete the message and any attachments. Thank you.
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 495 bytes
Desc: Message signed with OpenPGP using GPGMail
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150828/9dee4240/attachment.sig>

From fbl at sysclose.org  Fri Aug 28 06:38:50 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Fri, 28 Aug 2015 10:38:50 -0300
Subject: [ovs-discuss] openvswitch install on centos 6.6 issue
In-Reply-To: <20150826231959.GI2353@x240.home>
References: <0258d284-bd66-4c11-849e-c7a8b72e014c@getmailbird.com>
 <CAHbON5pqG=zqZKbFJjWZ4sFxqYuJwNtW4ptmHTYATJywf-+pCA@mail.gmail.com>
 <570c3c32-7580-4e38-af7a-681196ae4f1f@getmailbird.com>
 <CAHbON5o=jYcWLQUXiq3Zj9EdCHwb1e97_1i4-Q2HzfGBSp0CAw@mail.gmail.com>
 <CAEP_g=8RGnRy82VpsMy-zjVjZBxmfp-QkogDxCLN5p3AwTk2Uw@mail.gmail.com>
 <20150826231959.GI2353@x240.home>
Message-ID: <20150828133850.GA2349@x240.home>

On Wed, Aug 26, 2015 at 08:19:59PM -0300, Flavio Leitner wrote:
> On Tue, Aug 25, 2015 at 04:40:29PM -0700, Jesse Gross wrote:
> > Flavio, there's been a few reports of compilation problems on
> > RHEL/Centos 6. Would it be possible for you to take a look?
> 
> Yup, I will look into this.

Patchset posted:
http://openvswitch.org/pipermail/dev/2015-August/059359.html

Thanks,
fbl


From fbl at sysclose.org  Fri Aug 28 06:52:13 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Fri, 28 Aug 2015 10:52:13 -0300
Subject: [ovs-discuss] openvswitch 2.4.0 Fedora packages
Message-ID: <20150828135213.GG2347@x240.home>

Hi folks,

I've updated the Fedora packages to 2.4.0:

 Distro   -  status
Rawhide   -  available
Fedora 23 -  testing [1]
Fedora 22 -  testing [2]
Fedora 21 -  testing [3]

The status ``testing´´ means people can enable the testing repo,
get the package, test and report feedback on bodhi url listed below.
After 3 good feedbacks, the package is moved to stable repo.

[1] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14366
[2] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14365
[3] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14364

Thanks,
fbl



From Gabe.Black at viavisolutions.com  Fri Aug 28 08:01:52 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Fri, 28 Aug 2015 15:01:52 +0000
Subject: [ovs-discuss] millions of packets going to a flow?
In-Reply-To: <20150827231322.GH13397@nicira.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
 <20150827231322.GH13397@nicira.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC6297C@AMEXMB01.ds.jdsu.net>

Posted there per your suggestion.  

In reality, I'm just trying to find a branch of openstack where I can most easily get two VMs using ovs-dpdk to talk to each other to benchmark performance (both on the same compute node and on two different nodes).

I gave stable-kilo a whirl on Ubuntu/Fedora, but those didn't work following what little documentation I could find on that branch.  I seem to be closest to getting there on Ubuntu on master branch; it has more documentation, but is in development.  Maybe an inquiry on what I am trying to ultimately do better fits on the openstack-dev list.

However, all the commands I show in this inquiry are ovs-xyz commands.  My questions are around how to debug/troubleshoot where the packets are going.  I am new to all of this, but to me this did seem like the most relevant list to post that question. 

Thank you for your time!
Gabe

> -----Original Message-----
> From: Ben Pfaff [mailto:blp at nicira.com]
> Sent: Thursday, August 27, 2015 5:13 PM
> To: Gabe Black
> Cc: Mooney, Sean K; bugs at openvswitch.org
> Subject: Re: [ovs-discuss] millions of packets going to a flow?
> 
> This might draw better responses on the openstack-dev list.  It doesn't seem
> to be primarily about Open vSwitch but rather about OpenStack.

From blp at nicira.com  Fri Aug 28 08:07:31 2015
From: blp at nicira.com (Ben Pfaff)
Date: Fri, 28 Aug 2015 08:07:31 -0700
Subject: [ovs-discuss] millions of packets going to a flow?
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC6297C@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
 <20150827231322.GH13397@nicira.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC6297C@AMEXMB01.ds.jdsu.net>
Message-ID: <20150828150731.GA8690@nicira.com>

On Fri, Aug 28, 2015 at 03:01:52PM +0000, Gabe Black wrote:
> However, all the commands I show in this inquiry are ovs-xyz commands.
> My questions are around how to debug/troubleshoot where the packets
> are going.  I am new to all of this, but to me this did seem like the
> most relevant list to post that question.

Maybe you want this FAQ.

### Q: I have a sophisticated network setup involving Open vSwitch, VMs or
   multiple hosts, and other components.  The behavior isn't what I
   expect.  Help!

A: To debug network behavior problems, trace the path of a packet,
   hop-by-hop, from its origin in one host to a remote host.  If
   that's correct, then trace the path of the response packet back to
   the origin.

   Usually a simple ICMP echo request and reply ("ping") packet is
   good enough.  Start by initiating an ongoing "ping" from the origin
   host to a remote host.  If you are tracking down a connectivity
   problem, the "ping" will not display any successful output, but
   packets are still being sent.  (In this case the packets being sent
   are likely ARP rather than ICMP.)

   Tools available for tracing include the following:

   - "tcpdump" and "wireshark" for observing hops across network
     devices, such as Open vSwitch internal devices and physical
     wires.

   - "ovs-appctl dpif/dump-flows <br>" in Open vSwitch 1.10 and
     later or "ovs-dpctl dump-flows <br>" in earlier versions.
     These tools allow one to observe the actions being taken on
     packets in ongoing flows.

     See ovs-vswitchd(8) for "ovs-appctl dpif/dump-flows"
     documentation, ovs-dpctl(8) for "ovs-dpctl dump-flows"
     documentation, and "Why are there so many different ways to
     dump flows?" above for some background.

   - "ovs-appctl ofproto/trace" to observe the logic behind how
     ovs-vswitchd treats packets.  See ovs-vswitchd(8) for
     documentation.  You can out more details about a given flow
     that "ovs-dpctl dump-flows" displays, by cutting and pasting
     a flow from the output into an "ovs-appctl ofproto/trace"
     command.

   - SPAN, RSPAN, and ERSPAN features of physical switches, to
     observe what goes on at these physical hops.

   Starting at the origin of a given packet, observe the packet at
   each hop in turn.  For example, in one plausible scenario, you
   might:

   1. "tcpdump" the "eth" interface through which an ARP egresses
      a VM, from inside the VM.

   2. "tcpdump" the "vif" or "tap" interface through which the ARP
      ingresses the host machine.

   3. Use "ovs-dpctl dump-flows" to spot the ARP flow and observe
      the host interface through which the ARP egresses the
      physical machine.  You may need to use "ovs-dpctl show" to
      interpret the port numbers.  If the output seems surprising,
      you can use "ovs-appctl ofproto/trace" to observe details of
      how ovs-vswitchd determined the actions in the "ovs-dpctl
      dump-flows" output.

   4. "tcpdump" the "eth" interface through which the ARP egresses
      the physical machine.

   5. "tcpdump" the "eth" interface through which the ARP
      ingresses the physical machine, at the remote host that
      receives the ARP.

   6. Use "ovs-dpctl dump-flows" to spot the ARP flow on the
      remote host that receives the ARP and observe the VM "vif"
      or "tap" interface to which the flow is directed.  Again,
      "ovs-dpctl show" and "ovs-appctl ofproto/trace" might help.

   7. "tcpdump" the "vif" or "tap" interface to which the ARP is
      directed.

   8. "tcpdump" the "eth" interface through which the ARP
      ingresses a VM, from inside the VM.

   It is likely that during one of these steps you will figure out the
   problem.  If not, then follow the ARP reply back to the origin, in
   reverse.

From Gabe.Black at viavisolutions.com  Fri Aug 28 08:32:17 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Fri, 28 Aug 2015 15:32:17 +0000
Subject: [ovs-discuss] millions of packets going to a flow?
In-Reply-To: <20150828150731.GA8690@nicira.com>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
 <20150827231322.GH13397@nicira.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC6297C@AMEXMB01.ds.jdsu.net>
 <20150828150731.GA8690@nicira.com>
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC62A46@AMEXMB01.ds.jdsu.net>

I saw that FAQ prior to posting.  I probably should have mentioned that.  Unfortunately the ovs-appctl does not work and complains of not finding /usr/var/run/openvswitch/ovs-vswitchd.pid.  I tried both coping the pidfile and symlinking it to where ovs-appctl is looking, but it still failed with the same error message.

Running strace when the pid file is there shows that it does finde the file, but it performs a fcntl( ..., F_GETLK, {type=F_UNLCK,...} ...) which to me makes me believe it might be seeing if the file/process is locked and erroring out because it finds it can't unlock it.

The error message ovs-appctl displays is the same for both cases though: _cannot read pidfile "/usr/var/run/openvswitch/ovs-vswitchd.pid"_.
  
I just now out of curiousity tried adding the --pidfile to the ovs-dpdk init script (where it invokes vswitchd daemon, and found that now ovs-appctl works!  

I'll follow that faq again now armed with a working ovs-appctl. I wonder if a bug should be opened against this to add the --pidfile to the ovs-dpdk-init script.

Thanks for taking your time to help me out!   I'll post back with anything else I find that might be an defect.
Gabe



> -----Original Message-----
> From: Ben Pfaff [mailto:blp at nicira.com]
> Sent: Friday, August 28, 2015 9:08 AM
> To: Gabe Black
> Cc: Mooney, Sean K; bugs at openvswitch.org
> Subject: Re: [ovs-discuss] millions of packets going to a flow?
> 
> On Fri, Aug 28, 2015 at 03:01:52PM +0000, Gabe Black wrote:
> > However, all the commands I show in this inquiry are ovs-xyz commands.
> > My questions are around how to debug/troubleshoot where the packets
> > are going.  I am new to all of this, but to me this did seem like the
> > most relevant list to post that question.
> 
> Maybe you want this FAQ.
> 
> ### Q: I have a sophisticated network setup involving Open vSwitch, VMs or
>    multiple hosts, and other components.  The behavior isn't what I
>    expect.  Help!
> 
> A: To debug network behavior problems, trace the path of a packet,
>    hop-by-hop, from its origin in one host to a remote host.  If
>    that's correct, then trace the path of the response packet back to
>    the origin.
> 
>    Usually a simple ICMP echo request and reply ("ping") packet is
>    good enough.  Start by initiating an ongoing "ping" from the origin
>    host to a remote host.  If you are tracking down a connectivity
>    problem, the "ping" will not display any successful output, but
>    packets are still being sent.  (In this case the packets being sent
>    are likely ARP rather than ICMP.)
> 
>    Tools available for tracing include the following:
> 
>    - "tcpdump" and "wireshark" for observing hops across network
>      devices, such as Open vSwitch internal devices and physical
>      wires.
> 
>    - "ovs-appctl dpif/dump-flows <br>" in Open vSwitch 1.10 and
>      later or "ovs-dpctl dump-flows <br>" in earlier versions.
>      These tools allow one to observe the actions being taken on
>      packets in ongoing flows.
> 
>      See ovs-vswitchd(8) for "ovs-appctl dpif/dump-flows"
>      documentation, ovs-dpctl(8) for "ovs-dpctl dump-flows"
>      documentation, and "Why are there so many different ways to
>      dump flows?" above for some background.
> 
>    - "ovs-appctl ofproto/trace" to observe the logic behind how
>      ovs-vswitchd treats packets.  See ovs-vswitchd(8) for
>      documentation.  You can out more details about a given flow
>      that "ovs-dpctl dump-flows" displays, by cutting and pasting
>      a flow from the output into an "ovs-appctl ofproto/trace"
>      command.
> 
>    - SPAN, RSPAN, and ERSPAN features of physical switches, to
>      observe what goes on at these physical hops.
> 
>    Starting at the origin of a given packet, observe the packet at
>    each hop in turn.  For example, in one plausible scenario, you
>    might:
> 
>    1. "tcpdump" the "eth" interface through which an ARP egresses
>       a VM, from inside the VM.
> 
>    2. "tcpdump" the "vif" or "tap" interface through which the ARP
>       ingresses the host machine.
> 
>    3. Use "ovs-dpctl dump-flows" to spot the ARP flow and observe
>       the host interface through which the ARP egresses the
>       physical machine.  You may need to use "ovs-dpctl show" to
>       interpret the port numbers.  If the output seems surprising,
>       you can use "ovs-appctl ofproto/trace" to observe details of
>       how ovs-vswitchd determined the actions in the "ovs-dpctl
>       dump-flows" output.
> 
>    4. "tcpdump" the "eth" interface through which the ARP egresses
>       the physical machine.
> 
>    5. "tcpdump" the "eth" interface through which the ARP
>       ingresses the physical machine, at the remote host that
>       receives the ARP.
> 
>    6. Use "ovs-dpctl dump-flows" to spot the ARP flow on the
>       remote host that receives the ARP and observe the VM "vif"
>       or "tap" interface to which the flow is directed.  Again,
>       "ovs-dpctl show" and "ovs-appctl ofproto/trace" might help.
> 
>    7. "tcpdump" the "vif" or "tap" interface to which the ARP is
>       directed.
> 
>    8. "tcpdump" the "eth" interface through which the ARP
>       ingresses a VM, from inside the VM.
> 
>    It is likely that during one of these steps you will figure out the
>    problem.  If not, then follow the ARP reply back to the origin, in
>    reverse.

From Gabe.Black at viavisolutions.com  Fri Aug 28 08:40:02 2015
From: Gabe.Black at viavisolutions.com (Gabe Black)
Date: Fri, 28 Aug 2015 15:40:02 +0000
Subject: [ovs-discuss] millions of packets going to a flow?
References: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
 <20150827231322.GH13397@nicira.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC6297C@AMEXMB01.ds.jdsu.net>
 <20150828150731.GA8690@nicira.com> 
Message-ID: <9998A334FDE6CC48AB51C9016F467F1F7AC62A78@AMEXMB01.ds.jdsu.net>

Maybe a little premature again... Maybe some of the commands might help, but from what I understand, the appctl datapath commands won't work for datapath_type=netdev, which is what the vhost-user/ovs-dpdk sets the bridges to.  Correct me if I'm wrong, but I guess that means none of the appctl commands in the FAQ will work for me.  Bummer.

Gabe

> -----Original Message-----
> From: Gabe Black
> Sent: Friday, August 28, 2015 9:32 AM
> To: 'Ben Pfaff'
> Cc: Mooney, Sean K; bugs at openvswitch.org
> Subject: RE: [ovs-discuss] millions of packets going to a flow?
> 
> I saw that FAQ prior to posting.  I probably should have mentioned that.
> Unfortunately the ovs-appctl does not work and complains of not finding
> /usr/var/run/openvswitch/ovs-vswitchd.pid.  I tried both coping the pidfile
> and symlinking it to where ovs-appctl is looking, but it still failed with the
> same error message.
> 
> Running strace when the pid file is there shows that it does finde the file, but
> it performs a fcntl( ..., F_GETLK, {type=F_UNLCK,...} ...) which to me makes
> me believe it might be seeing if the file/process is locked and erroring out
> because it finds it can't unlock it.
> 
> The error message ovs-appctl displays is the same for both cases though:
> _cannot read pidfile "/usr/var/run/openvswitch/ovs-vswitchd.pid"_.
> 
> I just now out of curiousity tried adding the --pidfile to the ovs-dpdk init
> script (where it invokes vswitchd daemon, and found that now ovs-appctl
> works!
> 
> I'll follow that faq again now armed with a working ovs-appctl. I wonder if a
> bug should be opened against this to add the --pidfile to the ovs-dpdk-init
> script.
> 
> Thanks for taking your time to help me out!   I'll post back with anything else I
> find that might be an defect.
> Gabe
> 
> 
> 
> > -----Original Message-----
> > From: Ben Pfaff [mailto:blp at nicira.com]
> > Sent: Friday, August 28, 2015 9:08 AM
> > To: Gabe Black
> > Cc: Mooney, Sean K; bugs at openvswitch.org
> > Subject: Re: [ovs-discuss] millions of packets going to a flow?
> >
> > On Fri, Aug 28, 2015 at 03:01:52PM +0000, Gabe Black wrote:
> > > However, all the commands I show in this inquiry are ovs-xyz commands.
> > > My questions are around how to debug/troubleshoot where the packets
> > > are going.  I am new to all of this, but to me this did seem like
> > > the most relevant list to post that question.
> >
> > Maybe you want this FAQ.
> >
> > ### Q: I have a sophisticated network setup involving Open vSwitch, VMs
> or
> >    multiple hosts, and other components.  The behavior isn't what I
> >    expect.  Help!
> >
> > A: To debug network behavior problems, trace the path of a packet,
> >    hop-by-hop, from its origin in one host to a remote host.  If
> >    that's correct, then trace the path of the response packet back to
> >    the origin.
> >
> >    Usually a simple ICMP echo request and reply ("ping") packet is
> >    good enough.  Start by initiating an ongoing "ping" from the origin
> >    host to a remote host.  If you are tracking down a connectivity
> >    problem, the "ping" will not display any successful output, but
> >    packets are still being sent.  (In this case the packets being sent
> >    are likely ARP rather than ICMP.)
> >
> >    Tools available for tracing include the following:
> >
> >    - "tcpdump" and "wireshark" for observing hops across network
> >      devices, such as Open vSwitch internal devices and physical
> >      wires.
> >
> >    - "ovs-appctl dpif/dump-flows <br>" in Open vSwitch 1.10 and
> >      later or "ovs-dpctl dump-flows <br>" in earlier versions.
> >      These tools allow one to observe the actions being taken on
> >      packets in ongoing flows.
> >
> >      See ovs-vswitchd(8) for "ovs-appctl dpif/dump-flows"
> >      documentation, ovs-dpctl(8) for "ovs-dpctl dump-flows"
> >      documentation, and "Why are there so many different ways to
> >      dump flows?" above for some background.
> >
> >    - "ovs-appctl ofproto/trace" to observe the logic behind how
> >      ovs-vswitchd treats packets.  See ovs-vswitchd(8) for
> >      documentation.  You can out more details about a given flow
> >      that "ovs-dpctl dump-flows" displays, by cutting and pasting
> >      a flow from the output into an "ovs-appctl ofproto/trace"
> >      command.
> >
> >    - SPAN, RSPAN, and ERSPAN features of physical switches, to
> >      observe what goes on at these physical hops.
> >
> >    Starting at the origin of a given packet, observe the packet at
> >    each hop in turn.  For example, in one plausible scenario, you
> >    might:
> >
> >    1. "tcpdump" the "eth" interface through which an ARP egresses
> >       a VM, from inside the VM.
> >
> >    2. "tcpdump" the "vif" or "tap" interface through which the ARP
> >       ingresses the host machine.
> >
> >    3. Use "ovs-dpctl dump-flows" to spot the ARP flow and observe
> >       the host interface through which the ARP egresses the
> >       physical machine.  You may need to use "ovs-dpctl show" to
> >       interpret the port numbers.  If the output seems surprising,
> >       you can use "ovs-appctl ofproto/trace" to observe details of
> >       how ovs-vswitchd determined the actions in the "ovs-dpctl
> >       dump-flows" output.
> >
> >    4. "tcpdump" the "eth" interface through which the ARP egresses
> >       the physical machine.
> >
> >    5. "tcpdump" the "eth" interface through which the ARP
> >       ingresses the physical machine, at the remote host that
> >       receives the ARP.
> >
> >    6. Use "ovs-dpctl dump-flows" to spot the ARP flow on the
> >       remote host that receives the ARP and observe the VM "vif"
> >       or "tap" interface to which the flow is directed.  Again,
> >       "ovs-dpctl show" and "ovs-appctl ofproto/trace" might help.
> >
> >    7. "tcpdump" the "vif" or "tap" interface to which the ARP is
> >       directed.
> >
> >    8. "tcpdump" the "eth" interface through which the ARP
> >       ingresses a VM, from inside the VM.
> >
> >    It is likely that during one of these steps you will figure out the
> >    problem.  If not, then follow the ARP reply back to the origin, in
> >    reverse.

From blp at nicira.com  Fri Aug 28 08:41:39 2015
From: blp at nicira.com (Ben Pfaff)
Date: Fri, 28 Aug 2015 08:41:39 -0700
Subject: [ovs-discuss] millions of packets going to a flow?
In-Reply-To: <9998A334FDE6CC48AB51C9016F467F1F7AC62A78@AMEXMB01.ds.jdsu.net>
References: <9998A334FDE6CC48AB51C9016F467F1F7AC62223@AMEXMB01.ds.jdsu.net>
 <20150827231322.GH13397@nicira.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC6297C@AMEXMB01.ds.jdsu.net>
 <20150828150731.GA8690@nicira.com>
 <9998A334FDE6CC48AB51C9016F467F1F7AC62A78@AMEXMB01.ds.jdsu.net>
Message-ID: <20150828154139.GA16531@nicira.com>

On Fri, Aug 28, 2015 at 03:40:02PM +0000, Gabe Black wrote:
> Maybe a little premature again... Maybe some of the commands might
> help, but from what I understand, the appctl datapath commands won't
> work for datapath_type=netdev, which is what the vhost-user/ovs-dpdk
> sets the bridges to.  Correct me if I'm wrong, but I guess that means
> none of the appctl commands in the FAQ will work for me.  Bummer.

The appctl datapath commands do work with datapath_type=netdev.

From mark.d.gray at intel.com  Fri Aug 28 15:23:00 2015
From: mark.d.gray at intel.com (Gray, Mark D)
Date: Fri, 28 Aug 2015 22:23:00 +0000
Subject: [ovs-discuss] openvswitch 2.4.0 Fedora packages
In-Reply-To: <20150828135213.GG2347@x240.home>
References: <20150828135213.GG2347@x240.home>
Message-ID: <738D45BC1F695740A983F43CFE1B7EA9437DF288@IRSMSX108.ger.corp.intel.com>

Hi Flavio
> 
> Hi folks,
> 
> I've updated the Fedora packages to 2.4.0:
> 
>  Distro   -  status
> Rawhide   -  available
> Fedora 23 -  testing [1]
> Fedora 22 -  testing [2]
> Fedora 21 -  testing [3]

Are these rpms? src rpms?

> 
> The status ``testing´´ means people can enable the testing repo, get the
> package, test and report feedback on bodhi url listed below.
> After 3 good feedbacks, the package is moved to stable repo.
> 
> [1] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14366
> [2] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14365
> [3] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14364
> 
> Thanks,
> fbl
> 
> 
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss

From fbl at sysclose.org  Fri Aug 28 16:18:56 2015
From: fbl at sysclose.org (Flavio Leitner)
Date: Fri, 28 Aug 2015 20:18:56 -0300
Subject: [ovs-discuss] openvswitch 2.4.0 Fedora packages
In-Reply-To: <738D45BC1F695740A983F43CFE1B7EA9437DF288@IRSMSX108.ger.corp.intel.com>
References: <20150828135213.GG2347@x240.home>
 <738D45BC1F695740A983F43CFE1B7EA9437DF288@IRSMSX108.ger.corp.intel.com>
Message-ID: <20150828231856.GB2345@x240.home>

On Fri, Aug 28, 2015 at 10:23:00PM +0000, Gray, Mark D wrote:
> Hi Flavio
> > 
> > Hi folks,
> > 
> > I've updated the Fedora packages to 2.4.0:
> > 
> >  Distro   -  status
> > Rawhide   -  available
> > Fedora 23 -  testing [1]
> > Fedora 22 -  testing [2]
> > Fedora 21 -  testing [3]
> 
> Are these rpms? src rpms?

Both.  Open the link below and click on the icon
in the right side of the 'Builds' line.
fbl


> 
> > 
> > The status ``testing´´ means people can enable the testing repo, get the
> > package, test and report feedback on bodhi url listed below.
> > After 3 good feedbacks, the package is moved to stable repo.
> > 
> > [1] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14366
> > [2] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14365
> > [3] https://bodhi.fedoraproject.org/updates/FEDORA-2015-14364
> > 
> > Thanks,
> > fbl
> > 
> > 
> > _______________________________________________
> > discuss mailing list
> > discuss at openvswitch.org
> > http://openvswitch.org/mailman/listinfo/discuss


From dev_raj82 at yahoo.com  Sat Aug 29 10:51:56 2015
From: dev_raj82 at yahoo.com (Nishanth Devarajan)
Date: Sat, 29 Aug 2015 23:21:56 +0530
Subject: [ovs-discuss] Question about the abstract for the Conference 2015
Message-ID: <77033BC6-D591-4E02-86CC-4FD9E4E6E479@yahoo.com>

Hello all,
		In the abstract, can I refer to myself in first person e.g: “Here I present  …” instead of “Here we present….” because I’m the only one presenting (there is no “we") but as you all know its a general rule not to  use “I” anywhere in an abstract. So that’s my question,  I know it sounds really silly but I had to ask.

Thanks,
Nishanth D

From jpettit at nicira.com  Sat Aug 29 11:00:10 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Sat, 29 Aug 2015 11:00:10 -0700
Subject: [ovs-discuss] Question about the abstract for the Conference
	2015
In-Reply-To: <77033BC6-D591-4E02-86CC-4FD9E4E6E479@yahoo.com>
References: <77033BC6-D591-4E02-86CC-4FD9E4E6E479@yahoo.com>
Message-ID: <D7FAB78B-8714-44F7-A2C3-0BFFEC82999A@nicira.com>


> On Aug 29, 2015, at 10:51 AM, Nishanth Devarajan <dev_raj82 at yahoo.com> wrote:
> 
> 		In the abstract, can I refer to myself in first person e.g: “Here I present  …” instead of “Here we present….” because I’m the only one presenting (there is no “we") but as you all know its a general rule not to  use “I” anywhere in an abstract. So that’s my question,  I know it sounds really silly but I had to ask.

Using "I" is fine.  The focus of the conference is technical contribution, so don't worry about formalities.

--Justin



From chenww at hotmail.com  Sat Aug 29 13:40:19 2015
From: chenww at hotmail.com (Chen Weiwen)
Date: Sat, 29 Aug 2015 14:40:19 -0600
Subject: [ovs-discuss] Scary flow forwarding packets across ovs bridges
Message-ID: <SNT149-W55C3FC29B6CCA5064EDB4DCF6D0@phx.gbl>

Dear Experts,
Need your help on OVS to explain this scary flow forwarding on Debian OS with OVS 2.3. You can see a SNAP packet
received on br-ex bridge port 2 got forwarded to br-int and br-data bridges below.
How could this happen?

 

# ovs-dpctl dump-flows

skb_priority(0),in_port(2),eth(src=00:9c:02:79:1b:75,dst=01:14:c2:44:1e:cc),eth_type(0/0xffff),
packets:0, bytes:0, used:never, actions:1,3,5,4

 

# ovs-dpctl show

system at ovs-system:

        lookups: hit:0
missed:3913 lost:0

        flows: 0

        masks:
hit:2009 total:0 hit/pkt:0.51

        port 0:
ovs-system (internal)

        port 1: br-ex
(internal)

        port 2: eth4

        port 3: br-int
(internal)

        port 4:
br-data (internal)

        port 5: eth3

 

# ovs-vsctl show

f53f59be-9e8b-4e65-bc96-8334b25a3510

    Bridge br-ex

        Port br-ex

            Interface
br-ex

                type:
internal

        Port phy-br-ex

            Interface
phy-br-ex

                type:
patch

               
options: {peer=int-br-ex}

        Port
"eth4"

            Interface
"eth4"

    Bridge br-data

        Port
phy-br-data

            Interface
phy-br-data

                type:
patch

               
options: {peer=int-br-data}

        Port
"eth3"

            Interface
"eth3"

        Port br-data

            Interface
br-data

                type:
internal

    Bridge br-int

        fail_mode:
secure

        Port int-br-ex

            Interface
int-br-ex

                type: patch

               
options: {peer=phy-br-ex}

        Port
int-br-data

            Interface
int-br-data

                type:
patch

               
options: {peer=phy-br-data}

        Port br-int

            Interface
br-int

                type:
internal

    ovs_version:
"2.3.0"

 

# ifconfig eth4

eth4      Link encap:Ethernet  HWaddr 52:54:00:5f:13:49

          inet6 addr:
fe80::5054:ff:fe5f:1349/64 Scope:Link

          UP BROADCAST
RUNNING MULTICAST  MTU:1500  Metric:1

          RX
packets:3730 errors:0 dropped:10 overruns:0 frame:0

          TX
packets:79 errors:0 dropped:0 overruns:0 carrier:0

          collisions:0
txqueuelen:1000

          RX
bytes:262680 (256.5 KiB)  TX bytes:6518
(6.3 KiB)

 

# ifconfig eth3

eth3      Link
encap:Ethernet  HWaddr 52:54:00:29:b8:4f

          inet6 addr:
fe80::5054:ff:fe29:b84f/64 Scope:Link

          UP BROADCAST
RUNNING MULTICAST  MTU:1500  Metric:1

          RX
packets:308 errors:0 dropped:28 overruns:0 frame:0

          TX
packets:3672 errors:0 dropped:0 overruns:0 carrier:0

          collisions:0
txqueuelen:1000

Thanks a lot!-weiwen


          RX bytes:24032
(23.4 KiB)  TX bytes:258738 (252.6 KiB) 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150829/93360141/attachment.html>

From jpettit at nicira.com  Sat Aug 29 13:53:15 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Sat, 29 Aug 2015 13:53:15 -0700
Subject: [ovs-discuss] Scary flow forwarding packets across ovs bridges
In-Reply-To: <SNT149-W55C3FC29B6CCA5064EDB4DCF6D0@phx.gbl>
References: <SNT149-W55C3FC29B6CCA5064EDB4DCF6D0@phx.gbl>
Message-ID: <1FF45FD9-7FF6-46E4-9219-4E101186B079@nicira.com>


> On Aug 29, 2015, at 1:40 PM, Chen Weiwen <chenww at hotmail.com> wrote:
> 
> Dear Experts,
> 
> Need your help on OVS to explain this scary flow forwarding on Debian OS with OVS 2.3. You can see a SNAP packet received on br-ex bridge port 2 got forwarded to br-int and br-data bridges below. How could this happen?
>  
> # ovs-dpctl dump-flows
> skb_priority(0),in_port(2),eth(src=00:9c:02:79:1b:75,dst=01:14:c2:44:1e:cc),eth_type(0/0xffff), packets:0, bytes:0, used:never, actions:1,3,5,4
>  
> # ovs-dpctl show
> system at ovs-system:
>         lookups: hit:0 missed:3913 lost:0
>         flows: 0
>         masks: hit:2009 total:0 hit/pkt:0.51
>         port 0: ovs-system (internal)
>         port 1: br-ex (internal)
>         port 2: eth4
>         port 3: br-int (internal)
>         port 4: br-data (internal)
>         port 5: eth3
>  
> # ovs-vsctl show
> f53f59be-9e8b-4e65-bc96-8334b25a3510
>     Bridge br-ex
>         Port br-ex
>             Interface br-ex
>                 type: internal
>         Port phy-br-ex
>             Interface phy-br-ex
>                 type: patch
>                 options: {peer=int-br-ex}
>         Port "eth4"
>             Interface "eth4"
>     Bridge br-data
>         Port phy-br-data
>             Interface phy-br-data
>                 type: patch
>                 options: {peer=int-br-data}
>         Port "eth3"
>             Interface "eth3"
>         Port br-data
>             Interface br-data
>                 type: internal
>     Bridge br-int
>         fail_mode: secure
>         Port int-br-ex
>             Interface int-br-ex
>                 type: patch
>                 options: {peer=phy-br-ex}
>         Port int-br-data
>             Interface int-br-data
>                 type: patch
>                 options: {peer=phy-br-data}
>         Port br-int
>             Interface br-int
>                 type: internal
>     ovs_version: "2.3.0" 

It looks like you have patch ports connecting all those bridges.  You didn't show your OpenFlow tables, but if they just have normal L2 forwarding, I would expect this behavior.

--Justin



From chenww at hotmail.com  Sat Aug 29 14:25:30 2015
From: chenww at hotmail.com (Chen Weiwen)
Date: Sat, 29 Aug 2015 15:25:30 -0600
Subject: [ovs-discuss] Scary flow forwarding packets across ovs bridges
In-Reply-To: <SNT149-W55C3FC29B6CCA5064EDB4DCF6D0@phx.gbl>
References: <SNT149-W55C3FC29B6CCA5064EDB4DCF6D0@phx.gbl>
Message-ID: <SNT149-W30D3F94E9DF0797175F871CF6D0@phx.gbl>


I Think I figured out the reason and will work on it as peer port are configured on switch. No need help for this issue now.
Thanks

-weiwen
From: chenww at hotmail.com
To: discuss at openvswitch.org; chenww at hotmail.com
Subject: Scary flow forwarding packets across ovs bridges
Date: Sat, 29 Aug 2015 14:40:19 -0600




Dear Experts,
Need your help on OVS to explain this scary flow forwarding on Debian OS with OVS 2.3. You can see a SNAP packet
received on br-ex bridge port 2 got forwarded to br-int and br-data bridges below.
How could this happen?

 

# ovs-dpctl dump-flows

skb_priority(0),in_port(2),eth(src=00:9c:02:79:1b:75,dst=01:14:c2:44:1e:cc),eth_type(0/0xffff),
packets:0, bytes:0, used:never, actions:1,3,5,4

 

# ovs-dpctl show

system at ovs-system:

        lookups: hit:0
missed:3913 lost:0

        flows: 0

        masks:
hit:2009 total:0 hit/pkt:0.51

        port 0:
ovs-system (internal)

        port 1: br-ex
(internal)

        port 2: eth4

        port 3: br-int
(internal)

        port 4:
br-data (internal)

        port 5: eth3

 

# ovs-vsctl show

f53f59be-9e8b-4e65-bc96-8334b25a3510

    Bridge br-ex

        Port br-ex

            Interface
br-ex

                type:
internal

        Port phy-br-ex

            Interface
phy-br-ex

                type:
patch

               
options: {peer=int-br-ex}

        Port
"eth4"

            Interface
"eth4"

    Bridge br-data

        Port
phy-br-data

            Interface
phy-br-data

                type:
patch

               
options: {peer=int-br-data}

        Port
"eth3"

            Interface
"eth3"

        Port br-data

            Interface
br-data

                type:
internal

    Bridge br-int

        fail_mode:
secure

        Port int-br-ex

            Interface
int-br-ex

                type: patch

               
options: {peer=phy-br-ex}

        Port
int-br-data

            Interface
int-br-data

                type:
patch

               
options: {peer=phy-br-data}

        Port br-int

            Interface
br-int

                type:
internal

    ovs_version:
"2.3.0"

 

# ifconfig eth4

eth4      Link encap:Ethernet  HWaddr 52:54:00:5f:13:49

          inet6 addr:
fe80::5054:ff:fe5f:1349/64 Scope:Link

          UP BROADCAST
RUNNING MULTICAST  MTU:1500  Metric:1

          RX
packets:3730 errors:0 dropped:10 overruns:0 frame:0

          TX
packets:79 errors:0 dropped:0 overruns:0 carrier:0

          collisions:0
txqueuelen:1000

          RX
bytes:262680 (256.5 KiB)  TX bytes:6518
(6.3 KiB)

 

# ifconfig eth3

eth3      Link
encap:Ethernet  HWaddr 52:54:00:29:b8:4f

          inet6 addr:
fe80::5054:ff:fe29:b84f/64 Scope:Link

          UP BROADCAST
RUNNING MULTICAST  MTU:1500  Metric:1

          RX
packets:308 errors:0 dropped:28 overruns:0 frame:0

          TX
packets:3672 errors:0 dropped:0 overruns:0 carrier:0

          collisions:0
txqueuelen:1000

Thanks a lot!-weiwen


          RX bytes:24032
(23.4 KiB)  TX bytes:258738 (252.6 KiB) 		 	   		   		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150829/1050d277/attachment-0001.html>

From chenww at hotmail.com  Sat Aug 29 19:57:27 2015
From: chenww at hotmail.com (Hotmail)
Date: Sat, 29 Aug 2015 20:57:27 -0600
Subject: [ovs-discuss] Scary flow forwarding packets across ovs bridges
In-Reply-To: <1FF45FD9-7FF6-46E4-9219-4E101186B079@nicira.com>
References: <SNT149-W55C3FC29B6CCA5064EDB4DCF6D0@phx.gbl>
 <1FF45FD9-7FF6-46E4-9219-4E101186B079@nicira.com>
Message-ID: <BLU436-SMTP195D5080050997CD2166624CF6C0@phx.gbl>

Correct. I realize that right after. Thanks. A bug in openstack

Sent from my iPhone

> On Aug 29, 2015, at 2:53 PM, Justin Pettit <jpettit at nicira.com> wrote:
> 
> 
>> On Aug 29, 2015, at 1:40 PM, Chen Weiwen <chenww at hotmail.com> wrote:
>> 
>> Dear Experts,
>> 
>> Need your help on OVS to explain this scary flow forwarding on Debian OS with OVS 2.3. You can see a SNAP packet received on br-ex bridge port 2 got forwarded to br-int and br-data bridges below. How could this happen?
>> 
>> # ovs-dpctl dump-flows
>> skb_priority(0),in_port(2),eth(src=00:9c:02:79:1b:75,dst=01:14:c2:44:1e:cc),eth_type(0/0xffff), packets:0, bytes:0, used:never, actions:1,3,5,4
>> 
>> # ovs-dpctl show
>> system at ovs-system:
>>        lookups: hit:0 missed:3913 lost:0
>>        flows: 0
>>        masks: hit:2009 total:0 hit/pkt:0.51
>>        port 0: ovs-system (internal)
>>        port 1: br-ex (internal)
>>        port 2: eth4
>>        port 3: br-int (internal)
>>        port 4: br-data (internal)
>>        port 5: eth3
>> 
>> # ovs-vsctl show
>> f53f59be-9e8b-4e65-bc96-8334b25a3510
>>    Bridge br-ex
>>        Port br-ex
>>            Interface br-ex
>>                type: internal
>>        Port phy-br-ex
>>            Interface phy-br-ex
>>                type: patch
>>                options: {peer=int-br-ex}
>>        Port "eth4"
>>            Interface "eth4"
>>    Bridge br-data
>>        Port phy-br-data
>>            Interface phy-br-data
>>                type: patch
>>                options: {peer=int-br-data}
>>        Port "eth3"
>>            Interface "eth3"
>>        Port br-data
>>            Interface br-data
>>                type: internal
>>    Bridge br-int
>>        fail_mode: secure
>>        Port int-br-ex
>>            Interface int-br-ex
>>                type: patch
>>                options: {peer=phy-br-ex}
>>        Port int-br-data
>>            Interface int-br-data
>>                type: patch
>>                options: {peer=phy-br-data}
>>        Port br-int
>>            Interface br-int
>>                type: internal
>>    ovs_version: "2.3.0"
> 
> It looks like you have patch ports connecting all those bridges.  You didn't show your OpenFlow tables, but if they just have normal L2 forwarding, I would expect this behavior.
> 
> --Justin
> 
> 

From mark.d.gray at intel.com  Sun Aug 30 14:33:38 2015
From: mark.d.gray at intel.com (Gray, Mark D)
Date: Sun, 30 Aug 2015 21:33:38 +0000
Subject: [ovs-discuss] openvswitch 2.4.0 Fedora packages
In-Reply-To: <20150828231856.GB2345@x240.home>
References: <20150828135213.GG2347@x240.home>
 <738D45BC1F695740A983F43CFE1B7EA9437DF288@IRSMSX108.ger.corp.intel.com>
 <20150828231856.GB2345@x240.home>
Message-ID: <738D45BC1F695740A983F43CFE1B7EA9437E01FE@IRSMSX108.ger.corp.intel.com>

> 
> Both.  Open the link below and click on the icon in the right side of the 'Builds'
> line.
> fbl
> 
Great. Thanks.


From snadathu at altera.com  Sun Aug 30 18:09:18 2015
From: snadathu at altera.com (Sundar Nadathur)
Date: Mon, 31 Aug 2015 01:09:18 +0000
Subject: [ovs-discuss] OVS with VLANs
In-Reply-To: <9807ABFF-23B3-4518-A210-79142F193119@dit.upm.es>
References: <6F84DE007D2BD24A9221FF68E8A09FE0D23151@SJ-ITEXCH02.altera.priv.altera.com>
 <9807ABFF-23B3-4518-A210-79142F193119@dit.upm.es>
Message-ID: <6F84DE007D2BD24A9221FF68E8A09FE0D2751C@SJ-ITEXCH01.altera.priv.altera.com>

Thank you very much, David! That is exactly what I was missing. Now the hosts are pinging each other.

Appreciate your help!

Have a great day.

Cheers,
Sundar

-----Original Message-----
From: David Fernández [mailto:david at dit.upm.es]
Sent: Thursday, August 27, 2015 7:21 PM
To: Sundar Nadathur
Cc: discuss at openvswitch.org
Subject: Re: [ovs-discuss] OVS with VLANs

Hi Sundar,

Maybe the problem could be that you have to tell your br-int switch that the port that connects to enp1s0 is a trunk interface and carries VLAN 3.

Something like the following command issued in host 3 could do the job:

  ovs-vsctl set port enp1s0 trunk=3

Just in case it is useful, in VNX (Virtual Networks over linuX, http://vnx.dit.upm.es) site we have an example scenario using OVS and VLANs:

http://web.dit.upm.es/vnxwiki/index.php/Vnx-tutorial-openvswitch

In section 4 in that page you can find the ovs-vsctl commands that VNX tool issues to create the scenario and configure VLANs.

Best regards,
David Fernández
Profesor Titular
Dpto. Ingeniería de Sistemas Telemáticos E.T.S.I. Telecomunicación Universidad Politécnica de Madrid
e-mail: david at dit.upm.es



> El 27/8/2015, a las 3:32, Sundar Nadathur <snadathu at altera.com> escribió:
>
> Hi,
>    On two hosts running Centos 7.1, I have an eth interface each with VLAN 3 configured on top. These enp1s0.3 interfaces can ping each other.
>
> On a third host, also running Centos 7.1, I have configured an OVS br-int, with enp1s0 as a port. To this, I added an internal port with tag 10:
> # ovs-vsctl add-port br-int vlan3 tag=3 -- set interface vlan3
> type=internal # ifconfig vlan3 192.168.3.11 netmask … up Now, ifconfig
> and route commands show valid output, but we cannot ping the other hosts.
>
> If I add enp1s0.3 as the physical interface instead of enp1s0, it makes no difference. If I configure the IP directly on br-int, without a VLAN tag and use enp1s0.3 as physical interface, that doesn’t work either. However, if I configure the IP on enp1s0.3, I can then ping the other hosts, as expected.
>
> IOW, no configuration involving OVS is working with VLANs. But the direct physical interface is able to reach out on VLAN 3. The external switch is unmanaged.
>
> In all these cases, the relevant bridge and physical interfaces are “UP, RUNNING” in ifconfig. The ‘systemctl status openvswitch’ shows it is running.  Both ovsdb-server and ovs-vswitchd are running as root.
>
> What do I need to do to fix this?
>
> Cheers,
> Sundar
>
>
>
> Confidentiality Notice.
> This message may contain information that is confidential or otherwise protected from disclosure. If you are not the intended recipient, you are hereby notified that any use, disclosure, dissemination, distribution, or copying of this message, or any attachments, is strictly prohibited. If you have received this message in error, please advise the sender by reply e-mail, and delete the message and any attachments. Thank you.
> _______________________________________________
> discuss mailing list
> discuss at openvswitch.org
> http://openvswitch.org/mailman/listinfo/discuss


________________________________

Confidentiality Notice.
This message may contain information that is confidential or otherwise protected from disclosure. If you are not the intended recipient, you are hereby notified that any use, disclosure, dissemination, distribution, or copying of this message, or any attachments, is strictly prohibited. If you have received this message in error, please advise the sender by reply e-mail, and delete the message and any attachments. Thank you.

From dotslash.lu at gmail.com  Mon Aug 31 04:59:44 2015
From: dotslash.lu at gmail.com (Tashi Lu)
Date: Mon, 31 Aug 2015 19:59:44 +0800
Subject: [ovs-discuss] Fwd: Unit tests not passing on CentOS 6.6
In-Reply-To: <CALrtOxqdhCVLoDcDSYcsJGSBEobyzb_xXueKEHyih0t8=bkXMA@mail.gmail.com>
References: <CALrtOxqdhCVLoDcDSYcsJGSBEobyzb_xXueKEHyih0t8=bkXMA@mail.gmail.com>
Message-ID: <CALrtOxpUjb9=LBwEz7LtgmX=z0s0FxEJ7Pnd84wAMM1fDbfY1g@mail.gmail.com>

Hi all,

Unit tests halt after
'1569: database commands -- conditions                 ok'
line when I tried to build ovs following the instructions on
https://github.com/openvswitch/ovs/blob/master/INSTALL.RHEL.md with rpmbuild
-bb rhel/openvswitch.spec. I tried to build the same tar ball on a Ubuntu
box, tests passed successfully.

I tried to install it another way without unit tests, but I encountered
some problems using it. The interfaces created with ovs were lost once the
hosts' network service was restarted.

What might caused these problems? Are these two problems connected?

My environment:
CentOS 6.6(2.6.32-504.el6.x86_64)
lsmod:
Module                  Size  Used by
ip6table_filter        12815  0
ip6_tables             27864  1 ip6table_filter
ebtable_nat            12807  0
ebtables               30984  1 ebtable_nat
ipt_MASQUERADE         12759  3
iptable_nat            13229  1
nf_nat                 25891  2 ipt_MASQUERADE,iptable_nat
nf_conntrack_ipv4      19716  4 iptable_nat,nf_nat
nf_defrag_ipv4         12729  1 nf_conntrack_ipv4
xt_state               12578  1
nf_conntrack           81926  5
ipt_MASQUERADE,iptable_nat,nf_nat,nf_conntrack_ipv4,xt_state
ipt_REJECT             12576  2
xt_CHECKSUM            12549  1
iptable_mangle         12734  1
xt_tcpudp              12603  5
iptable_filter         12810  1
ip_tables              27473  3 iptable_nat,iptable_mangle,iptable_filter
x_tables               29846  12
ip6table_filter,ip6_tables,ebtables,ipt_MASQUERADE,iptable_nat,xt_state,ipt_REJECT,xt_CHECKSUM,iptable_mangle,xt_tcpudp,iptable_filter,ip_tables
bridge                 91179  0
stp                    12931  1 bridge
vesafb                 13844  1
joydev                 17693  0
ppdev                  17113  0
psmouse                87603  0
usbhid                 47199  0
snd_intel8x0           38570  0
snd_ac97_codec        134826  1 snd_intel8x0
ac97_bus               12730  1 snd_ac97_codec
hid                    99559  1 usbhid
parport_pc             32866  0
snd_pcm                97188  2 snd_intel8x0,snd_ac97_codec
serio_raw              13211  0
mac_hid                13253  0
snd_timer              29990  1 snd_pcm
snd                    78855  4
snd_intel8x0,snd_ac97_codec,snd_pcm,snd_timer
soundcore              15091  1 snd
snd_page_alloc         18529  2 snd_intel8x0,snd_pcm
i2c_piix4              13301  0
lp                     17799  0
parport                46562  3 ppdev,parport_pc,lp
e1000                 108476  0

Thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150831/d92d14fb/attachment-0001.html>

From afredette at redhat.com  Mon Aug 31 07:38:18 2015
From: afredette at redhat.com (Andre Fredette)
Date: Mon, 31 Aug 2015 10:38:18 -0400
Subject: [ovs-discuss] ICMP over NAT in Open vSwitch
Message-ID: <55E466DA.4060206@redhat.com>

To do NAPT for ICMP query messages, you need to be able to match on and 
modify the NAT Query Identifier (RFC 5508).

I found a discussion on the subject from a while back 
(http://openvswitch.org/pipermail/discuss/2014-January/012696.html) that 
suggested someone might work on it; However, I can't find any support in 
either the latest OVS or in the OpenFlow spec.

Has any work been done on this?

Thanks,
Andre


From blp at nicira.com  Mon Aug 31 08:23:58 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 31 Aug 2015 08:23:58 -0700
Subject: [ovs-discuss] Fwd: Unit tests not passing on CentOS 6.6
In-Reply-To: <CALrtOxpUjb9=LBwEz7LtgmX=z0s0FxEJ7Pnd84wAMM1fDbfY1g@mail.gmail.com>
References: <CALrtOxqdhCVLoDcDSYcsJGSBEobyzb_xXueKEHyih0t8=bkXMA@mail.gmail.com>
 <CALrtOxpUjb9=LBwEz7LtgmX=z0s0FxEJ7Pnd84wAMM1fDbfY1g@mail.gmail.com>
Message-ID: <20150831152358.GB11406@nicira.com>

On Mon, Aug 31, 2015 at 07:59:44PM +0800, Tashi Lu wrote:
> Unit tests halt after
> '1569: database commands -- conditions                 ok'
> line when I tried to build ovs following the instructions on
> https://github.com/openvswitch/ovs/blob/master/INSTALL.RHEL.md with rpmbuild
> -bb rhel/openvswitch.spec. I tried to build the same tar ball on a Ubuntu
> box, tests passed successfully.

Can you figure out why the tests stop?  What processes are running at
the time?

From blp at nicira.com  Mon Aug 31 08:27:52 2015
From: blp at nicira.com (Ben Pfaff)
Date: Mon, 31 Aug 2015 08:27:52 -0700
Subject: [ovs-discuss] ICMP over NAT in Open vSwitch
In-Reply-To: <55E466DA.4060206@redhat.com>
References: <55E466DA.4060206@redhat.com>
Message-ID: <20150831152752.GC11406@nicira.com>

On Mon, Aug 31, 2015 at 10:38:18AM -0400, Andre Fredette wrote:
> To do NAPT for ICMP query messages, you need to be able to match on and
> modify the NAT Query Identifier (RFC 5508).
> 
> I found a discussion on the subject from a while back
> (http://openvswitch.org/pipermail/discuss/2014-January/012696.html) that
> suggested someone might work on it; However, I can't find any support in
> either the latest OVS or in the OpenFlow spec.
> 
> Has any work been done on this?

I don't know of anyone working on this.

Andrei Andone said in the cited email that he was working on it.
Andrei, did you implement this?

From afredette at redhat.com  Mon Aug 31 08:55:19 2015
From: afredette at redhat.com (Andre Fredette)
Date: Mon, 31 Aug 2015 11:55:19 -0400
Subject: [ovs-discuss] ICMP over NAT in Open vSwitch
In-Reply-To: <20150831152752.GC11406@nicira.com>
References: <55E466DA.4060206@redhat.com> <20150831152752.GC11406@nicira.com>
Message-ID: <55E478E7.8040404@redhat.com>


On 8/31/15 11:27 AM, Ben Pfaff wrote:
> On Mon, Aug 31, 2015 at 10:38:18AM -0400, Andre Fredette wrote:
>> To do NAPT for ICMP query messages, you need to be able to match on and
>> modify the NAT Query Identifier (RFC 5508).
>>
>> I found a discussion on the subject from a while back
>> (http://openvswitch.org/pipermail/discuss/2014-January/012696.html) that
>> suggested someone might work on it; However, I can't find any support in
>> either the latest OVS or in the OpenFlow spec.
>>
>> Has any work been done on this?
> I don't know of anyone working on this.
>
> Andrei Andone said in the cited email that he was working on it.
> Andrei, did you implement this?

It seems like the conntrack-based Stateful NAT described by Thomas Graf 
[1] is the way to go, but I was wondering if anything is available now.

[1] 
http://www.slideshare.net/ThomasGraf5/linuxcon-2015-stateful-nat-with-ovs


From andrei.andone at softvision.ro  Mon Aug 31 09:35:02 2015
From: andrei.andone at softvision.ro (Andrei Andone)
Date: Mon, 31 Aug 2015 19:35:02 +0300
Subject: [ovs-discuss] ICMP over NAT in Open vSwitch
In-Reply-To: <55E478E7.8040404@redhat.com>
References: <55E466DA.4060206@redhat.com> <20150831152752.GC11406@nicira.com>
 <55E478E7.8040404@redhat.com>
Message-ID: <55E48236.1010603@softvision.ro>

Hello Ben,

Unfortunately I didn't have the time to work on this issue, and at this 
point I don't see any spare cycles for me to start working on this.

Regards,
Andrei

On 08/31/2015 06:55 PM, Andre Fredette wrote:
>
> On 8/31/15 11:27 AM, Ben Pfaff wrote:
>> On Mon, Aug 31, 2015 at 10:38:18AM -0400, Andre Fredette wrote:
>>> To do NAPT for ICMP query messages, you need to be able to match on and
>>> modify the NAT Query Identifier (RFC 5508).
>>>
>>> I found a discussion on the subject from a while back
>>> (http://openvswitch.org/pipermail/discuss/2014-January/012696.html) 
>>> that
>>> suggested someone might work on it; However, I can't find any 
>>> support in
>>> either the latest OVS or in the OpenFlow spec.
>>>
>>> Has any work been done on this?
>> I don't know of anyone working on this.
>>
>> Andrei Andone said in the cited email that he was working on it.
>> Andrei, did you implement this?
>
> It seems like the conntrack-based Stateful NAT described by Thomas 
> Graf [1] is the way to go, but I was wondering if anything is 
> available now.
>
> [1] 
> http://www.slideshare.net/ThomasGraf5/linuxcon-2015-stateful-nat-with-ovs
>

-- 

*Andrei Andone*

*SOFTVISION* | Sos. Națională, Nr. 23 Iași, Romania

*Email: * andrei.andone at softvision.ro 
<mailto:andrei.andone at softvision.ro> | *Web: * www.softvision.ro 
<http://www.softvision.ro>

The content of this communication is classified as SOFTVISION 
Confidential and Proprietary Information.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150831/dfd3d594/attachment.html>

From jpettit at nicira.com  Mon Aug 31 10:26:47 2015
From: jpettit at nicira.com (Justin Pettit)
Date: Mon, 31 Aug 2015 10:26:47 -0700
Subject: [ovs-discuss] ICMP over NAT in Open vSwitch
In-Reply-To: <55E478E7.8040404@redhat.com>
References: <55E466DA.4060206@redhat.com> <20150831152752.GC11406@nicira.com>
 <55E478E7.8040404@redhat.com>
Message-ID: <5EA3F66E-8C9E-46B1-A139-7A6F53E8AD05@nicira.com>


> On Aug 31, 2015, at 8:55 AM, Andre Fredette <afredette at redhat.com> wrote:
> 
> 
> On 8/31/15 11:27 AM, Ben Pfaff wrote:
>> On Mon, Aug 31, 2015 at 10:38:18AM -0400, Andre Fredette wrote:
>>> To do NAPT for ICMP query messages, you need to be able to match on and
>>> modify the NAT Query Identifier (RFC 5508).
>>> 
>>> I found a discussion on the subject from a while back
>>> (http://openvswitch.org/pipermail/discuss/2014-January/012696.html) that
>>> suggested someone might work on it; However, I can't find any support in
>>> either the latest OVS or in the OpenFlow spec.
>>> 
>>> Has any work been done on this?
>> I don't know of anyone working on this.
>> 
>> Andrei Andone said in the cited email that he was working on it.
>> Andrei, did you implement this?
> 
> It seems like the conntrack-based Stateful NAT described by Thomas Graf [1] is the way to go, but I was wondering if anything is available now.
> 
> [1] http://www.slideshare.net/ThomasGraf5/linuxcon-2015-stateful-nat-with-ovs

Thomas made some progress and had a working prototype, but there were some corner cases.  Jarno has started thinking about NAT support for OVS and has looked at Thomas's code.  I don't want to commit to any timelines, but it's something that we're going to need for OVN before too long, so I'd expect to see some progress on it.

--Justin



From ben at skyportsystems.com  Mon Aug 31 20:40:50 2015
From: ben at skyportsystems.com (Ben Warren)
Date: Mon, 31 Aug 2015 20:40:50 -0700
Subject: [ovs-discuss] conntrack feature detection
Message-ID: <79CC97AE-B3A1-4A5B-A072-EBF0376D2700@skyportsystems.com>

Hi,

It’s exciting to see conntrack support being accepted in the Linux kernel.  We’ve been building based on the justinpettit/ovs tree and so far it works like a charm. Nice work!

Two questions:
1. Is there a way, apart from parsing the output of ‘ovs-ofctl —version’ to determine if the installed .ko supports conntrack?  I looked through /proc and /sys and didn’t see anything, but am pretty good at missing things.
2. Any idea when the changes will be merged into ovs mainline?  I expect “as soon as we can”, but just wondering...

thanks,
Ben
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 3583 bytes
Desc: not available
URL: <http://openvswitch.org/pipermail/discuss/attachments/20150831/2fa5f1f9/attachment.bin>

